Fecha 09/01/2026

NORMAS OBLIGATORIAS DE DESARROLLO Y PROCESO ESTÁNDAR DE TRABAJO
==============================================================

Este documento define las REGLAS ABSOLUTAS, el PROCESO ESTÁNDAR
y el PROTOCOLO DE CODE REVIEW que deben cumplirse en TODOS
los proyectos sin excepción.

NO HAY INTERPRETACIONES.
NO HAY ATAJOS.
NO HAY EXCEPCIONES.


================================================================
A. NORMAS OBLIGATORIAS DE DESARROLLO
================================================================

A.1 CONTROL DE VERSIONES Y DOCUMENTACIÓN
----------------------------------------

1. Cualquier cambio realizado DEBE reflejarse:
   - En el número de versión visible en `index.html`
   - En los servicios de Apps Script correspondientes

2. Antes y después de cualquier desarrollo es OBLIGATORIO:
   - Leer y analizar README.md
   - Leer y analizar Instrucciones.txt
   - Leer y analizar ChangesLogs.txt
   - Actualizar estos archivos si el cambio lo amerita

3. ChangesLogs.txt:
   - Cada entrada DEBE indicar:
     - Archivo modificado
     - Número de línea afectado
     - Descripción objetiva del cambio
   - PROHIBIDO:
     - Asumir éxito
     - Usar términos como:
       "Se corrigió", "Se arregló", "Se solucionó"
   - NO inventar fechas:
     - Usar como referencia la fecha de la última entrada existente

4. PROHIBIDO utilizar frases de resumen como:
   - "(Sin cambios)"
   - "No aplica"
   - "Ya estaba correcto"
   En CUALQUER archivo de código, documentación o reglamento.


A.2 CALIDAD Y DISCIPLINA DE CÓDIGO
----------------------------------

1. Todo código nuevo o modificado DEBE incluir comentarios
   explicando su propósito.

2. PROHIBIDO eliminar o modificar el bloque de reglas
   extendidas dentro de Instrucciones.txt.

3. PROHIBIDO revertir commits SIN solicitud explícita
   del Project Manager (PM), salvo lo definido
   en el Protocolo de Code Review.

4. PROHIBIDO usar:
   - Herramientas de búsqueda rápida
   - Edición masiva
   - Suposiciones
   TODA revisión debe ser:
   - Archivo por archivo
   - Línea por línea

5. AUDITORÍA OBLIGATORIA:
   - Cada archivo DEBE auditarse ANTES de cualquier modificación,
     por mínima que sea.
   - Durante la auditoría:
     - NO se repara nada
     - TODO hallazgo se registra en Auditoría.txt
     - Luego se convierte en tarea en Instrucciones.txt

6. PROHIBIDO duplicar bloques de código.
   La auditoría inicial existe para prevenirlo.

7. NO asumir que un fix registrado en ChangesLogs.txt fue exitoso.


A.3 PROCESO DE APROBACIÓN
-------------------------

1. PROHIBIDO marcar tareas como COMPLETADAS
   sin revisión y aprobación del Project Manager.

2. Si una tarea:
   - Introduce errores -> Marcar como EN REVISIÓN
   - No cumple el objetivo -> REQUIERE NUEVA REVISIÓN

3. Las tareas ejecutadas SIEMPRE se marcan como:
   - PENDIENTE DE REVISIÓN POR EL PM


================================================================
B. PROCESO ESTÁNDAR DE TRABAJO (OBLIGATORIO)
================================================================

Este flujo aplica a TODA tarea, corrección,
mejora o cambio solicitado.


FLUJO OBLIGATORIO
------------------

1. AUDITORÍA INICIAL
   - Auditar el archivo o archivos involucrados
   - Archivo por archivo
   - Línea por línea
   - NO modificar código

2. REGISTRO DE HALLAZGOS
   - Registrar TODOS los hallazgos en Auditoría.txt
   - Crear nueva entrada o actualizar la existente
   - PROHIBIDO eliminar información previa

3. HALLAZGOS FUERA DE LA TAREA
   - Si el hallazgo NO pertenece a la tarea:
     a) Resolverlo en el MISMO commit SOLO si es seguro
     b) Si no es posible:
        - Registrar nueva tarea en Instrucciones.txt
        - Referenciar en Auditoría.txt

4. EJECUCIÓN DE LA TAREA
   - Realizar ÚNICAMENTE lo solicitado
   - Respetar TODAS las reglas vigentes

5. VERIFICACIÓN FUNCIONAL
   - Confirmar que:
     - La tarea cumple su objetivo
     - No rompe otras funciones
     - No altera flujos existentes

6. VERIFICACIÓN COMPLEMENTARIA
   - Revisar dependencias
   - Revisar llamadas internas y externas
   - Detectar efectos colaterales

7. REVISIÓN FINAL DE CÓDIGO
   - Revisión completa nuevamente
   - Línea por línea
   - Función por función

8. REGISTRO EN CHANGESLOGS.TXT
   - Descripción objetiva del cambio
   - Archivo y líneas afectadas
   - SIN asumir éxito

9. ACTUALIZACIÓN DE INSTRUCCIONES.TXT
   - Mover la tarea a:
     "TAREAS PENDIENTES DE REVISIÓN"

10. COMMIT
    - SOLO después de completar TODOS los pasos
    - El commit debe reflejar EXACTAMENTE
      lo documentado


================================================================
C. PROTOCOLO DE RESULTADO DE CODE REVIEW
================================================================

Este protocolo SE INTEGRA al flujo estándar
y tiene prioridad cuando aplica.


FLUJO DE ANÁLISIS
------------------

1. LECTURA COMPLETA DEL CODE REVIEW
   - Leer TODO el informe
   - No omitir secciones

2. SAFETY & SIDE EFFECTS
   - Se considera FUENTE DE VERDAD PRINCIPAL
   - SOLO se ignora si el Code Review
     solicita explícitamente revertir cambios


TRATAMIENTO DE REVERSIÓN
------------------------

3. EVALUACIÓN OBLIGATORIA

   a) CAMBIOS "OUT OF SCOPE"
      - Verificar si pertenecen a:
        - Tareas anteriores
        - Commits previos

      - Si pertenecen a tareas anteriores:
        -> IGNORAR solicitud de reversión
        -> CONTINUAR con el commit actual

   b) CAMBIOS DE LA TAREA ACTUAL
      - Si los cambios NO solicitados
        fueron introducidos durante
        la tarea actual:
        -> REALIZAR reversión
        -> Registrar el motivo


IMPACTO EN EL FLUJO
-------------------

4. REINICIO DEL CICLO
   - Toda observación que implique cambios:
     -> REINICIA el ciclo completo
        desde la AUDITORÍA INICIAL
   - El reinicio NO afecta:
     - Commits anteriores
     - Tareas aprobadas
     - Cambios fuera de alcance


DOCUMENTACIÓN OBLIGATORIA
--------------------------

Toda acción derivada del Code Review
DEBE quedar registrada en:
- Auditoría.txt
- ChangesLogs.txt
- Instrucciones.txt (si aplica)


================================================================
REGLA FINAL ABSOLUTA
================================================================

SI NO SE AUDITA, NO SE CAMBIA.
SI NO SE REGISTRA, NO EXISTE.

El incumplimiento de CUALQUIER paso
invalida el proceso completo.

-Tareas Pendientes-

[PENDIENTE REVISION POR EL MP] Implementar Sistema de Inbox (Tarea 18)

Origen: Requerimiento de Funcionalidad
Prioridad: ALTA
Área: Frontend | UI/UX
Descripción:
Implementar un modal de "Inbox" completamente funcional para la gestión de feedback de usuarios (reportes de problemas y formularios de contacto).
Alcance:
- Creación de la UI para listar y detallar mensajes.
- Integración con el `services/feedback/feedback.js` para obtener, responder y resolver items.
- Lógica de visibilidad basada en roles de usuario (`Supervisor`, `Gefe`, `Desarrollador`).

---

[PENDIENTE REVISION POR EL MP] Implementar Modal de Herramientas de Desarrollador (Tarea 19)

Origen: Requerimiento de Mantenimiento
Prioridad: MEDIA
Área: Frontend | Herramientas
Descripción:
Implementar la estructura base para un modal de "Herramientas de Desarrollador" para facilitar futuras tareas de migración y mantenimiento.
Alcance:
- Creación del modal y la UI base.
- Lógica de visibilidad restringida al rol `Desarrollador`.

---

[TAREA] Centralizar la Lógica de Autorización de Backend

Origen: Auditoría Técnica Forense v2.0
Prioridad: CRÍTICA
Área: Arquitectura | Seguridad

Descripción:
El código para validar sesiones de usuario y verificar roles está duplicado en múltiples servicios de backend (ej. `services/users/users.js`, `services/utilities/utilities.js`). Esta inconsistencia representa un riesgo de seguridad y una pesadilla de mantenimiento.

Alcance:
- Crear un único servicio o librería compartida para manejar toda la lógica de autorización.
- Refactorizar todos los servicios existentes para que utilicen este nuevo componente centralizado.
- NO incluye la modificación de la lógica de frontend, solo el consumo del nuevo servicio.

Notas:
- Riesgo si no se ejecuta: Una brecha de seguridad si una política de permisos no se actualiza en todos los servicios a la vez.

---

[TAREA] Refactorizar Frontend para Separar Lógica de Presentación

Origen: Auditoría Técnica Forense v2.0
Prioridad: ALTA
Área: Frontend

Descripción:
El archivo `index.html` contiene una cantidad masiva de código JavaScript inline, mezclando la lógica de la aplicación con la estructura del DOM. Esto hace que el código sea frágil y difícil de mantener.

Alcance:
- Extraer todo el código JavaScript inline del `index.html` a archivos `.js` modulares y cohesivos.
- Reducir la dependencia de selectores de ID y clase en JavaScript, favoreciendo el uso de atributos `data-*` para desacoplar la lógica del estilo.
- NO incluye rediseñar la interfaz de usuario, solo refactorizar el código subyacente.

Notas:
- Riesgo si no se ejecuta: El mantenimiento del frontend se volverá cada vez más costoso y propenso a errores, ralentizando el desarrollo de nuevas funcionalidades.

---

[TAREA] Implementar Estrategia de Caché Granular para el Catálogo

Origen: Auditoría Técnica Forense v2.0
Prioridad: ALTA
Área: Performance | Backend

Descripción:
El servicio de catálogo (`services/catalog/catalog.js`) ha deshabilitado el almacenamiento en caché porque el conjunto de datos completo excede el límite de 100 KB de Google Apps Script. Esto causa que cada carga de la aplicación sea lenta, ya que debe leer y procesar toda la base de datos cada vez.

Alcance:
- Diseñar e implementar una estrategia de caché que no exceda los límites de tamaño. Esto podría implicar cachear subconjuntos de datos (ej. por categoría o marca) en lugar del catálogo completo.
- El frontend deberá ser actualizado para ensamblar los datos cacheados granularmente.
- NO incluye la optimización de otras consultas de la base de datos.

Notas:
- Riesgo si no se ejecuta: Tiempos de carga deficientes persistirán, afectando negativamente la experiencia del usuario.

---

[TAREA] Abstraer la Capa de Acceso a Datos del Backend

Origen: Auditoría Técnica Forense v2.0
Prioridad: MEDIA
Área: Arquitectura | Backend

Descripción:
La lógica de negocio en todos los servicios de backend está fuertemente acoplada a la estructura de la hoja de Google Sheets, utilizando índices de columna numéricos hardcodeados (ej. `row[COLS_CORTES.marca - 1]`). Esto hace que el sistema sea extremadamente frágil a cualquier cambio en la base de datos.

Alcance:
- Crear una capa de abstracción de datos (un "mapper" o "repositorio") que traduzca las filas de la hoja de cálculo a objetos JavaScript de una manera centralizada.
- Refactorizar todos los servicios para que utilicen esta capa de abstracción en lugar de acceder directamente a los índices de las columnas.
- NO incluye cambiar el esquema de la base de datos.

Notas:
- Riesgo si no se ejecuta: Un simple cambio como insertar una nueva columna en Google Sheets podría romper toda la aplicación de maneras impredecibles.

---

[TAREA] Implementar Bloqueo Concurrente para Operaciones Críticas

Origen: Auditoría Técnica Forense v2.0
Prioridad: MEDIA
Área: Backend | Arquitectura

Descripción:
Operaciones como registrar un "like" (`handleRecordLike` en `services/feedback/feedback.js`) no son atómicas, lo que crea una condición de carrera. Si dos usuarios realizan la misma acción simultáneamente, se pueden perder datos.

Alcance:
- Utilizar el `LockService` de Google Apps Script para envolver las operaciones de lectura-modificación-escritura en un bloqueo exclusivo.
- Aplicar este patrón a todas las operaciones identificadas como no atómicas, como los contadores.
- NO incluye una revisión exhaustiva de todas las operaciones del sistema, solo las más críticas ya identificadas.

Notas:
- Riesgo si no se ejecuta: La integridad de los datos generados por el usuario (likes, contadores, etc.) no es fiable.

---

[TAREA] Formalizar y Documentar la API de Microservicios

Origen: Auditoría Técnica Forense v2.0
Prioridad: BAJA
Área: Arquitectura | Documentación

Descripción:
La comunicación entre el frontend y el backend se basa en un contrato de API implícito y no documentado. Esto dificulta la incorporación de nuevos desarrolladores y aumenta la probabilidad de errores por expectativas desalineadas entre el cliente y el servidor.

Alcance:
- Crear documentación para cada endpoint de cada microservicio.
- La documentación debe especificar la `action` esperada, la estructura del `payload` de la solicitud y el formato de la respuesta JSON.
- NO incluye la creación de un nuevo sistema de API, solo documentar el existente.

Notas:
- Riesgo si no se ejecuta: El mantenimiento a largo plazo será más lento y costoso debido a la falta de una referencia clara de la API.

---
**NUEVAS TAREAS (AUDITORÍA 11/01/2024)**
---

[TAREA] Mejorar Calidad de Imagen en Modal de Relay

Origen: Reporte de Tareas
Prioridad: BAJA
Área: Frontend | UI

Descripción:
La imagen de la configuración del Relay en el modal de detalle se muestra en baja resolución.

Acciones:
1.  **Modificar `ui.js`:** En la función `renderRelayInfoModal`, al llamar a `getImageUrl`, añadir el parámetro `size` con un valor de `1000` para solicitar una versión de mayor calidad de la imagen.

---

[TAREA] Reparar Funcionalidad de Botones en Gestión de Usuarios

Origen: Auditoría 11/01/2024
Prioridad: CRÍTICA
Área: Frontend | `users.html`

Descripción:
Los botones "Editar", "Eliminar" y "Cambiar Contraseña" no funcionan debido a un conflicto de ámbito de JavaScript. Las funciones son inaccesibles para los atributos `onclick` del HTML porque el script es un módulo.

Acciones:
1.  **Refactorizar `users.html`:** Modificar la función `renderUserTable` para que los `event listeners` de los botones "Editar" y "Eliminar" se adjunten mediante `button.addEventListener('click', ...)`.
2.  **Añadir Enlace de Retorno:** Incluir un enlace `<a>` en la parte superior de `users.html` que permita al usuario volver fácilmente al catálogo (`index.html`).

---

[TAREA] Corregir Apariencia del Encabezado en Modal de Detalles

Origen: Auditoría 11/01/2024
Prioridad: MEDIA
Área: Frontend | `ui.js`

Descripción:
El logo de la marca aparece a la derecha del título del vehículo, en lugar de a la izquierda como se especifica.

Acciones:
1.  **Modificar `ui.js`:** En la función `mostrarDetalleModal`, reordenar la lógica para que el elemento `img` del logo se añada al `titleContainer` antes que el elemento que contiene el `h2` del título.

---

[TAREA] Ajustar Tamaño de Imágenes en Modal de Detalles

Origen: Auditoría 11/01/2024
Prioridad: BAJA
Área: Frontend | `style.css`

Descripción:
Las imágenes dentro del modal de detalles no tienen el tamaño correcto: la del vehículo es muy grande y la del corte no es responsiva.

Acciones:
1.  **Modificar `style.css`:**
    *   Ajustar la regla `.img-vehiculo-modal` para reducir su tamaño (ej. `width: 50%; max-width: 200px;`).
    *   Añadir una `@media query` para que la clase `.img-corte` tenga un `width: 80%` en pantallas con un ancho máximo de `600px`.

---

[TAREA] Implementar Lógica de Visualización para Corte Recomendado

Origen: Auditoría 11/01/2024
Prioridad: MEDIA
Área: Frontend | `ui.js`

Descripción:
El corte con más votos ("Corte Recomendado") se muestra incorrectamente dentro de un acordeón. Debe estar siempre visible y expandido.

Acciones:
1.  **Modificar `ui.js`:** En `mostrarDetalleModal`, cambiar el bucle de renderizado de secciones. Primero, renderizar el contenido del corte recomendado directamente en el DOM (sin usar `createAccordionSection`). Luego, iterar sobre el resto de los cortes y secciones para crear los acordeones correspondientes.

---

[TAREA] Implementar Funcionalidad Completa para Configuración de Relay

Origen: Auditoría 11/01/2024
Prioridad: ALTA
Área: Frontend | `ui.js`

Descripción:
La sección de "Configuración de Relay" es solo texto estático. Debe ser un componente interactivo que muestre "Sin Relay" si no hay datos o un botón que abra un modal secundario con el diagrama.

Acciones:
1.  **Modificar `ui.js`:** Dentro de la función que renderiza el contenido de los cortes (actualmente `createAccordionSection`):
    *   Implementar una lógica condicional para el valor `configRelay`.
    *   Si el valor es nulo o "Sin Relay", mostrar el texto "Sin Relay".
    *   Si hay un valor, crear un elemento `<button>` con el nombre de la configuración como texto.
    *   Añadir un `addEventListener` a ese botón que, al ser presionado, busque los detalles del relay en `catalogData.relay` y llame a una función (ej. `mostrarDetalleRelayModal`) para mostrar la imagen y detalles en un segundo modal sobre el modal actual.

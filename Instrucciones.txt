=================================================
 INSTRUCTIVO DEL PROYECTO GPSpedia 2.0
=================================================
**Versión del Documento:** 3.3
**Fecha de Actualización:** 2024-08-19

Este documento detalla las normas de desarrollo, el estado de las tareas pendientes y el flujo de trabajo para el proyecto GPSpedia 2.0.

Para un análisis detallado del sistema, los hallazgos de la auditoría y las recomendaciones estratégicas, consulte el archivo `Auditoria.txt`.

---------------------------------
NORMAS OBLIGATORIAS DE DESARROLLO
---------------------------------

**A. Control de Versiones y Documentación:**
1.  **Actualización de Versión:** Cualquier cambio debe reflejarse en el número de versión visible en `index.html` y en los servicios de Apps Script.
2.  **Consulta y Actualización de Documentación:** Antes y después de cualquier desarrollo, se deben consultar y actualizar `README.md`, `INSTRUCTIVO.TXT` y `CHANGESLOGS.txt`.
3.  **Detalle en `CHANGESLOGS.txt`:** Cada entrada debe especificar el archivo y número de línea modificado.

**B. Calidad del Código:**
1.  **Comentarios:** Todo código nuevo o modificado debe tener un comentario explicando su propósito.

**C. Proceso de Aprobación:**
1.  **Verificación Post-Commit:** Una tarea solo se considera completada después de un commit y la validación explícita del Project Manager.

---------------------------------
SISTEMA DE VERSIONAMIENTO HÍBRIDO
---------------------------------

El proyecto utiliza un sistema de dos niveles:

1.  **Versión Global (Pública):**
    *   **Formato:** `vMAJOR.MINOR.PATCH` (ej. `v3.2.7`).
    *   **Función:** Representa el estado general del proyecto. Se actualiza en `ChangesLogs.txt` y `index.html` en cada `submit`.

2.  **Versión de Componente (Interna):**
    *   **Formato:** `ARQUITECTURA.ARCHIVO.EDICION` (ej. `2.1.0`).
    *   **Función:** Rastrea la madurez de cada archivo de código (`.html`, `.gs`, `.js`).
    *   **Reglas:**
        *   **Frontend (arq. `2`):** `index.html`, `api-manager.js`, etc., inician en `2.0.0`.
        *   **Backend (arq. `1`):** Cada microservicio (`auth.js`, etc.) inicia en `1.0.0`.
    *   **Ubicación:** Debe registrarse en un comentario en la cabecera de cada archivo.

---------------------------------
PROCESO DE TRABAJO POR FASES
---------------------------------

Para organizar el desarrollo y asegurar la calidad, el trabajo se dividirá en fases. Cada fase se enfocará en un conjunto específico de tareas y culminará en un commit.

1.  **Asignación de Tareas:** Se define un conjunto de tareas (ej. "Ajustes de UI en `index.html`").
2.  **Desarrollo y Commit:** Se realizan todos los cambios de código necesarios para completar la fase.
3.  **Revisión Post-Commit:** El Project Manager revisa los cambios.
    *   **Si es satisfactorio:** Se marca la tarea como completada en `README.md` y `INSTRUCTIVO.TXT`. Se registra el éxito en `CHANGESLOGS.txt`.
    *   **Si NO es satisfactorio:** Se registra el problema en `CHANGESLOGS.txt` y se crea una nueva tarea para solucionarlo. No se marcan las tareas como completadas.
4.  **Nuevas Solicitudes:** Cualquier nueva implementación o cambio solicitado se agregará primero a la lista de pendientes en `README.md` y `INSTRUCTIVO.TXT` sin marcar. Solo se marcarán como completadas después de un ciclo de desarrollo y una revisión post-commit exitosa.

---------------------------------
ESTADO ACTUAL DEL PROYECTO (CHECKLIST)
---------------------------------

### Tareas Completadas Recientemente
- [X] **Estandarización de la Base de Datos del Backend:** Se ha verificado y actualizado toda la capa de microservicios.
- [X] **Resolución del Bug Crítico "Pantalla Blanca":** Se refactorizó el frontend (`index.html`) para alinearlo con la nueva estructura de datos.
- [X] **Implementación del Sistema de Notificación de Errores:** Se añadió un sistema de notificaciones globales en `index.html` y `api-manager.js`.
- [X] **Refactorización del Acceso a Datos del Backend:** Se han actualizado todos los microservicios para utilizar un mapa de columnas fijo.
- [X] **Corrección del Bug de Sesión de Usuario:** Se solucionó un problema en `users.html` que impedía la correcta visualización de la información del usuario.
- [X] **Reparación del Formulario de Contacto:** Se corrigió el error "Acción no definida".
- [X] **Corrección de Visualización en Tutoriales:** Se solucionó un bug que provocaba que el texto de los tutoriales se mostrara como "undefined".
- [X] **Refactorización del Flujo de Escritura:** Se ha verificado que el flujo de trabajo de 3 etapas está implementado en `add_cortes.html`.
- [X] **Lógica de Ordenamiento de Cortes:** Se ha verificado que el backend (`catalog.js`) ordena los cortes por utilidad.
- [X] **Sistema de Navegación Jerárquico:** Se ha verificado que la lógica de navegación paso a paso está implementada en `catalog.js`.
- [X] **Orden Personalizado de Categorías:** Se ha verificado que el backend (`catalog.js`) implementa el orden personalizado para las categorías.
- [X] **Modo Oscuro Automático:** Se ha verificado que `index.html` contiene la media query para el modo oscuro.
- [X] **Layout de 3 Columnas:** Se ha verificado que el CSS en `index.html` define un layout de 3 columnas.

### Bugs y Regresiones Críticas
- [ ] **Carga de Información en Modal:** No se muestran los datos de los cortes secundarios (`corte2`, `corte3`), ni la información de apertura, cables de alimentación o logos de marca en el modal de detalle.
- [ ] **Inconsistencias de Versionamiento:** Sincronizar la versión global y las versiones de componentes en todos los archivos.
- [ ] **Funcionalidad de Comentarios de Feedback:** La UI para mostrar los últimos comentarios y sus respuestas no está implementada.

### Revisiones de UI/UX
- [ ] **Rediseño de Botones de Feedback:** Ajustar el CSS de los botones para que coincidan con el diseño especificado (sin fondo por defecto).
- [ ] **Estilo de Logos de Marca:** Los logos de las marcas se muestran como tarjetas en lugar de iconos sin fondo.
- [ ] **Reorganización de Secciones Principales:** Alterar el orden a: 1. "Últimos Agregados", 2. "Búsqueda por Marca", 3. "Búsqueda por Categoría".

### Nuevas Funcionalidades
- [ ] **Sistema de Gestión de Feedback (Inbox):** Desarrollar una interfaz para que Supervisores/Jefes gestionen los problemas reportados.
- [ ] **Carga Optimizada de Imágenes (Lazy Load):** Implementar carga progresiva de imágenes.
- [ ] **Soporte para Rango de Años (Feedback-driven):** Implementar la lógica de `suggestYear`.
- [ ] **Debugging Integral:** Implementar un sistema de debugging en backend y frontend accesible por rol.

### Deuda Técnica y Mejoras
- [ ] **Script de Migración de Timestamps:** Implementar un script de ejecución única para rellenar el campo `timestamp`.
- [ ] **Script de Migración de Rango de Años:** Implementar el script de ejecución única para poblar `anoDesde` y `anoHasta`.

---
### **Plan de Implementación Técnica: Tareas Adicionales**

Esta sección detalla los requerimientos para un nuevo conjunto de funcionalidades críticas centradas en la migración de datos y la mejora de la lógica de negocio para la gestión de rangos de años y timestamps.

#### **1. Nuevo Microservicio: `GPSpedia-Utilities` (Ejecución Única)**

Se creará un nuevo proyecto de Google Apps Script, independiente de los microservicios existentes, con el único propósito de realizar una migración y corrección de datos en la hoja `Cortes` de la base de datos. Este script se ejecutará una sola vez y contendrá dos funciones principales:

**A. Función 1: Migración de Rango de Años**
*   **Objetivo:** Procesar la columna `anoDesde`, que actualmente contiene rangos de texto (ej. "2016-2022") o años únicos (ej. "2006"), para poblar correctamente las columnas `anoDesde` y `anoHasta` con valores numéricos individuales.
*   **Lógica de Ejecución:**
    1.  El script iterará sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leerá el valor de la celda en la columna `anoDesde`.
    3.  **Si el valor contiene un guion (`-`):**
        *   Se dividirá la cadena de texto en dos partes.
        *   Se identificarán los dos valores numéricos, determinando cuál es el menor y cuál es el mayor.
        *   El valor numérico **menor** se escribirá de nuevo en la columna `anoDesde` de esa fila, sobrescribiendo el rango de texto.
        *   El valor numérico **mayor** se escribirá en la columna `anoHasta` de la misma fila.
    4.  **Si el valor es un único número de 4 dígitos (ej. "2006"):**
        *   El valor de `anoDesde` no se modificará.
        *   El mismo valor se copiará a la columna `anoHasta` de la misma fila.

**B. Función 2: Migración de Timestamps desde Metadatos de Google Drive**
*   **Objetivo:** Rellenar la columna `timestamp` en la hoja `Cortes` utilizando la fecha de creación del archivo de imagen del vehículo almacenado en Google Drive.
*   **Lógica de Ejecución:**
    1.  El script iterará sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leerá la URL en la columna `imagenVehiculo`.
    3.  **Si existe una URL:**
        *   Se extraerá el `ID` del archivo de Google Drive de la URL.
        *   Utilizando el servicio `DriveApp` de Apps Script, se obtendrá el objeto de archivo (`File`) correspondiente a ese ID.
        *   Se accederá a los metadatos del archivo para obtener su fecha de creación (`dateCreated`).
        *   La fecha se formateará al estándar `DD/MM/AAAA`.
        *   La fecha formateada se escribirá en la columna `timestamp` de la fila correspondiente.

---

#### **2. Modificaciones a Servicios Existentes (Lógica Continua)**

**A. Servicio `GPSpedia-Feedback`: Lógica de Expansión de Rango de Años**
*   **Objetivo:** Mejorar la funcionalidad del botón "Útil" para que los usuarios puedan sugerir que un corte aplica a un año fuera del rango establecido, expandiendo dinámicamente la aplicabilidad del registro.
*   **Lógica de Backend:**
    1.  El frontend enviará el `ID` del vehículo y el `año sugerido` por el usuario al backend.
    2.  El backend verificará si el `año sugerido` ya se encuentra dentro del rango `[anoDesde, anoHasta]`. Si es así, no se realizará ninguna acción.
    3.  **Lógica de Anti-colisión de Generaciones:**
        *   Antes de realizar cualquier cambio, el sistema buscará en toda la hoja `Cortes` si existe **otro registro** con la misma `marca`, `modelo` y `tipoEncendido`.
        *   Esta comprobación es crucial para evitar que los rangos de diferentes generaciones de un mismo modelo se solapen incorrectamente.
    4.  **Actualización del Rango:**
        *   Si el `año sugerido` es **menor** que `anoDesde` y no hay colisión, el valor de `anoDesde` se actualizará al `año sugerido`.
        *   Si el `año sugerido` es **mayor** que `anoHasta` y no hay colisión, el valor de `anoHasta` se actualizará al `año sugerido`.
*   **Manejo de Casos de Múltiples Generaciones (Ejemplo Técnico):**
    *   **Escenario:** El usuario indica que el corte para una **Honda CR-V (2016-2022)** también fue útil para un modelo **2026**.
    *   **Proceso:**
        1.  El sistema detecta que `2026` está fuera del rango `2016-2022`.
        2.  Realiza una búsqueda y encuentra otro registro para **Honda CR-V** con un rango de `2023-2025`.
        3.  En lugar de modificar el registro original (`2016-2022`), el sistema identifica que `2026` es una extensión lógica del segundo registro (`2023-2025`).
        4.  La columna `anoHasta` del **segundo registro** se actualiza a `2026`.

**B. Servicio `GPSpedia-Write`: Gestión de Timestamps y Lógica Frontend**
*   **Objetivo:** Asegurar que la columna `timestamp` se actualice siempre que se realice una modificación significativa en un registro y que el frontend utilice esta información para mostrar el contenido más reciente.
*   **Lógica de Backend (`write.js`):**
    1.  Al crear un **vehículo completamente nuevo**, se registrará la fecha actual en la columna `timestamp`.
    2.  Al añadir un **nuevo corte** a un vehículo ya existente, la columna `timestamp` de esa fila se actualizará con la fecha actual.
    3.  Al añadir **información suplementaria** (ej. detalles de apertura, videoguía), la columna `timestamp` también se actualizará con la fecha actual.
*   **Lógica de Frontend (`index.html`):**
    1.  La sección "Últimos Agregados" deberá obtener los datos del catálogo y ordenarlos en base a la columna `timestamp` en orden descendente antes de renderizarlos.
    2.  Las tarjetas de vehículo en esta sección deberán indicar qué tipo de información se agregó o actualizó recientemente (ej. "Nuevo Vehículo", "Corte Adicional", "Info. de Apertura"). Esto podría requerir una lógica adicional o un nuevo campo en la respuesta de la API.
---
### Arquitectura de la Base de Datos

#### Arquitectura v2.0 (Canónica)
- **ID de Google Sheet:** `1M6zAVch_EGKGGRXIo74Nbn_ihH1APZ7cdr2kNdWfiDs`
- **Principio de Diseño:** Estructura granular y robusta, explícita y a prueba de errores de formato.

A continuación se detalla la estructura de cada hoja en la base de datos. Los nombres de las columnas deben coincidir **exactamente** con los especificados.

##### 1. Hoja: `Users`
- **Columnas:** `ID`, `Nombre_Usuario`, `Password`, `Privilegios`, `Telefono`, `Correo_Electronico`, `SessionToken`.

##### 2. Hoja: `Cortes`
- **Columnas:** `id`, `categoria`, `marca`, `modelo`, `versionesAplicables`, `anoDesde`, `anoHasta`, `tipoEncendido`, `imagenVehiculo`, `videoGuiaDesarmeUrl`, `contadorBusqueda`, `tipoCorte1`, `ubicacionCorte1`, `colorCableCorte1`, `configRelay1`, `imgCorte1`, `utilCorte1`, `colaboradorCorte1`, `tipoCorte2`, `ubicacionCorte2`, `colorCableCorte2`, `configRelay2`, `imgCorte2`, `utilCorte2`, `colaboradorCorte2`, `tipoCorte3`, `ubicacionCorte3`, `colorCableCorte3`, `configRelay3`, `imgCorte3`, `utilCorte3`, `colaboradorCorte3`, `apertura`, `imgApertura`, `cableAlimen`, `imgCableAlimen`, `timestamp`, `notaImportante`.

##### 3. Hoja: `LogosMarca`
- **Columnas:** `id`, `nombreMarca`, `urlLogo`, `fabricanteNombre`.

##### 4. Hoja: `Tutorial`
- **Columnas:** `ID`, `Tema`, `Imagen`, `comoIdentificarlo`, `dondeEncontrarlo`, `Detalles`, `Video`.

##### 5. Hoja: `Relay`
- **Columnas:** `ID`, `configuracion`, `funcion`, `vehiculoDondeSeUtiliza`, `pin30Entrada`, `pin85BobinaPositivo`, `pin86bobinaNegativo`, `pin87aComunCerrado`, `pin87ComunmenteAbierto`, `imagen`, `observacion`.

##### 6. Hoja: `ActiveSessions`
- **Columnas:** `ID_Usuario`, `Usuario`, `ActiveSessions`, `date`, `Logs`.

##### 7. Hoja: `Feedbacks`
- **Columnas:** `ID`, `Usuario`, `ID_vehiculo`, `Problema`, `Respuesta`, `Se resolvio`, `Responde`, `Reporte de util`.

##### 8. Hoja: `Contactanos`
- **Columnas:** `Contacto_ID`, `User_ID`, `Asunto`, `Mensaje`, `Respuesta_mensaje`, `ID_usuario_responde`.

##### 9. Hoja: `Logs`
- **Columnas:** `Timestamp`, `Level`, `Message`, `Data`.

##### 10. Hoja: `ActividadUsuario`
- **Columnas:** `id`, `timestamp`, `idUsuario`, `nombreUsuario`, `tipoActividad`, `idElementoAsociado`, `detalle`.

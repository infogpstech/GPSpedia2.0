=================================================
 INSTRUCTIVO DEL PROYECTO GPSpedia 2.0
=================================================
**Versi칩n del Documento:** 3.3
**Fecha de Actualizaci칩n:** 2024-08-19

Este documento detalla las normas de desarrollo, el estado de las tareas pendientes y el flujo de trabajo para el proyecto GPSpedia 2.0.

Para un an치lisis detallado del sistema, los hallazgos de la auditor칤a y las recomendaciones estrat칠gicas, consulte el archivo `Auditoria.txt`.

---------------------------------
NORMAS OBLIGATORIAS DE DESARROLLO
---------------------------------

**A. Control de Versiones y Documentaci칩n:**
1.  **Actualizaci칩n de Versi칩n:** Cualquier cambio debe reflejarse en el n칰mero de versi칩n visible en `index.html` y en los servicios de Apps Script.
2.  **Consulta y Actualizaci칩n de Documentaci칩n:** Antes y despu칠s de cualquier desarrollo, se deben consultar y actualizar `README.md`, `INSTRUCTIVO.TXT` y `CHANGESLOGS.txt`.
3.  **Detalle en `CHANGESLOGS.txt`:** Cada entrada debe especificar el archivo y n칰mero de l칤nea modificado.

**B. Calidad del C칩digo:**
1.  **Comentarios:** Todo c칩digo nuevo o modificado debe tener un comentario explicando su prop칩sito.

**C. Proceso de Aprobaci칩n:**
1.  **Verificaci칩n Post-Commit:** Una tarea solo se considera completada despu칠s de un commit y la validaci칩n expl칤cita del Project Manager.

---------------------------------
SISTEMA DE VERSIONAMIENTO H칈BRIDO
---------------------------------

El proyecto utiliza un sistema de dos niveles:

1.  **Versi칩n Global (P칰blica):**
    *   **Formato:** `vMAJOR.MINOR.PATCH` (ej. `v3.2.7`).
    *   **Funci칩n:** Representa el estado general del proyecto. Se actualiza en `ChangesLogs.txt` y `index.html` en cada `submit`.

2.  **Versi칩n de Componente (Interna):**
    *   **Formato:** `ARQUITECTURA.ARCHIVO.EDICION` (ej. `2.1.0`).
    *   **Funci칩n:** Rastrea la madurez de cada archivo de c칩digo (`.html`, `.gs`, `.js`).
    *   **Reglas:**
        *   **Frontend (arq. `2`):** `index.html`, `api-manager.js`, etc., inician en `2.0.0`.
        *   **Backend (arq. `1`):** Cada microservicio (`auth.js`, etc.) inicia en `1.0.0`.
    *   **Ubicaci칩n:** Debe registrarse en un comentario en la cabecera de cada archivo.

---------------------------------
PROCESO DE TRABAJO POR FASES
---------------------------------

Para organizar el desarrollo y asegurar la calidad, el trabajo se dividir치 en fases. Cada fase se enfocar치 en un conjunto espec칤fico de tareas y culminar치 en un commit.

1.  **Asignaci칩n de Tareas:** Se define un conjunto de tareas (ej. "Ajustes de UI en `index.html`").
2.  **Desarrollo y Commit:** Se realizan todos los cambios de c칩digo necesarios para completar la fase.
3.  **Revisi칩n Post-Commit:** El Project Manager revisa los cambios.
    *   **Si es satisfactorio:** Se marca la tarea como completada en `README.md` y `INSTRUCTIVO.TXT`. Se registra el 칠xito en `CHANGESLOGS.txt`.
    *   **Si NO es satisfactorio:** Se registra el problema en `CHANGESLOGS.txt` y se crea una nueva tarea para solucionarlo. No se marcan las tareas como completadas.
4.  **Nuevas Solicitudes:** Cualquier nueva implementaci칩n o cambio solicitado se agregar치 primero a la lista de pendientes en `README.md` y `INSTRUCTIVO.TXT` sin marcar. Solo se marcar치n como completadas despu칠s de un ciclo de desarrollo y una revisi칩n post-commit exitosa.

---------------------------------
ESTADO ACTUAL DEL PROYECTO (CHECKLIST)
---------------------------------

### Tareas Completadas Recientemente
- [X] **Estandarizaci칩n de la Base de Datos del Backend:** Se ha verificado y actualizado toda la capa de microservicios (`auth`, `catalog`, `users`, `write`, `feedback`) para asegurar que todos apunten exclusivamente a la base de datos can칩nica v2.0.
- [X] **Resoluci칩n del Bug Cr칤tico "Pantalla Blanca":** Se refactoriz칩 el frontend (`index.html`) para alinearlo con la nueva estructura de datos `camelCase` del backend v2.0.
- [X] **Implementaci칩n del Sistema de Notificaci칩n de Errores:** Se a침adi칩 un sistema de notificaciones globales en `index.html` y `api-manager.js`.
- [X] **Refactorizaci칩n del Acceso a Datos del Backend:** Se han actualizado todos los microservicios para utilizar un mapa de columnas fijo.
- [X] **Correcci칩n del Bug de Sesi칩n de Usuario:** Se solucion칩 un problema en `users.html` que imped칤a la correcta visualizaci칩n de la informaci칩n del usuario en sesi칩n.
- [X] **Reparaci칩n del Formulario de Contacto:** Se corrigi칩 el error "Acci칩n no definida" en el formulario de "Cont치ctanos".
- [X] **Correcci칩n de Visualizaci칩n en Tutoriales:** Se solucion칩 un bug en `index.html` que provocaba que el texto de los tutoriales se mostrara como "undefined".

### Bugs y Regresiones Cr칤ticas
- [ ] **L칩gica del Modal de Detalle:** El modal de detalle actualmente solo carga la informaci칩n del primer corte, ignorando los datos de `corte2` y `corte3`.
- [ ] **Carga de Im치genes en Modal:** Las im치genes asociadas a la apertura, cable de alimentaci칩n y configuraci칩n del relay no se est치n mostrando en el modal.
- [ ] **Carga de Logos en Modal:** El logo de la marca del veh칤culo no se est치 cargando y mostrando correctamente dentro del modal.
- [ ] **Refactorizaci칩n del Flujo de Escritura:** Implementar el nuevo flujo de trabajo de 3 etapas para a침adir/actualizar cortes.
- [ ] **Inconsistencias de Versionamiento:** Sincronizar la versi칩n global y las versiones de componentes en todos los archivos.
- [ ] **Visibilidad de Cortes:** Asegurar que las tres opciones de corte sean visibles en el modal si existen los datos.

### Revisiones de UI/UX
- [ ] **Redise침o de Botones de Feedback:** Reemplazar los botones "S칤/No" por un sistema de pulgares (游녨/游녩) y a침adir botones para "Sugerir un a침o" y "Reportar un problema".
- [ ] **Reorganizaci칩n de Secciones Principales:** Alterar el orden a: 1. "칔ltimos Agregados", 2. "B칰squeda por Marca", 3. "B칰squeda por Categor칤a".
- [ ] **Layout de "칔ltimos Agregados":** Modificar el layout para que muestre los resultados en un formato de 3 columnas.
- [ ] **Visualizaci칩n de Marcas con Logos:** En "B칰squeda por Marca", reemplazar los nombres de las marcas por sus respectivos logos.

### Nuevas Funcionalidades
- [ ] **Sistema de Navegaci칩n Jer치rquico:** Implementar un flujo de navegaci칩n guiado (Marca -> Modelo -> A침o).
- [ ] **Sistema de Gesti칩n de Feedback (Inbox):** Desarrollar una interfaz para que Supervisores/Jefes gestionen los problemas reportados por los usuarios.
- [ ] **Implementaci칩n de Modo Oscuro:** A침adir una paleta de colores alternativa y un interruptor para activarlo/desactivarlo.
- [ ] **Debugging Integral:** Implementar un sistema de debugging en backend y frontend accesible por rol.
- [ ] **Carga Optimizada de Im치genes (Lazy Load):** Implementar carga progresiva de im치genes para mejorar el rendimiento.
- [X] **Soporte para Rango de A침os (Feedback-driven):** Implementar la l칩gica de `suggestYear` en el backend y la UI correspondiente.
- [ ] **Sistema de Versionamiento H칤brido:** Aplicar el nuevo sistema de versionamiento a todos los componentes del c칩digo fuente.

### Deuda T칠cnica y Mejoras
- [ ] **Script de Migraci칩n de Timestamps:** Implementar un script de ejecuci칩n 칰nica para rellenar el campo `timestamp` en los registros existentes.
- [ ] **Script de Migraci칩n de Rango de A침os:** Implementar el script de ejecuci칩n 칰nica para poblar `anoDesde` y `anoHasta`.

---
### **Plan de Implementaci칩n T칠cnica: Tareas Adicionales**

Esta secci칩n detalla los requerimientos para un nuevo conjunto de funcionalidades cr칤ticas centradas en la migraci칩n de datos y la mejora de la l칩gica de negocio para la gesti칩n de rangos de a침os y timestamps.

#### **1. Nuevo Microservicio: `GPSpedia-Utilities` (Ejecuci칩n 칔nica)**

Se crear치 un nuevo proyecto de Google Apps Script, independiente de los microservicios existentes, con el 칰nico prop칩sito de realizar una migraci칩n y correcci칩n de datos en la hoja `Cortes` de la base de datos. Este script se ejecutar치 una sola vez y contendr치 dos funciones principales:

**A. Funci칩n 1: Migraci칩n de Rango de A침os**
*   **Objetivo:** Procesar la columna `anoDesde`, que actualmente contiene rangos de texto (ej. "2016-2022") o a침os 칰nicos (ej. "2006"), para poblar correctamente las columnas `anoDesde` y `anoHasta` con valores num칠ricos individuales.
*   **L칩gica de Ejecuci칩n:**
    1.  El script iterar치 sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leer치 el valor de la celda en la columna `anoDesde`.
    3.  **Si el valor contiene un guion (`-`):**
        *   Se dividir치 la cadena de texto en dos partes.
        *   Se identificar치n los dos valores num칠ricos, determinando cu치l es el menor y cu치l es el mayor.
        *   El valor num칠rico **menor** se escribir치 de nuevo en la columna `anoDesde` de esa fila, sobrescribiendo el rango de texto.
        *   El valor num칠rico **mayor** se escribir치 en la columna `anoHasta` de la misma fila.
    4.  **Si el valor es un 칰nico n칰mero de 4 d칤gitos (ej. "2006"):**
        *   El valor de `anoDesde` no se modificar치.
        *   El mismo valor se copiar치 a la columna `anoHasta` de la misma fila.

**B. Funci칩n 2: Migraci칩n de Timestamps desde Metadatos de Google Drive**
*   **Objetivo:** Rellenar la columna `timestamp` en la hoja `Cortes` utilizando la fecha de creaci칩n del archivo de imagen del veh칤culo almacenado en Google Drive.
*   **L칩gica de Ejecuci칩n:**
    1.  El script iterar치 sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leer치 la URL en la columna `imagenVehiculo`.
    3.  **Si existe una URL:**
        *   Se extraer치 el `ID` del archivo de Google Drive de la URL.
        *   Utilizando el servicio `DriveApp` de Apps Script, se obtendr치 el objeto de archivo (`File`) correspondiente a ese ID.
        *   Se acceder치 a los metadatos del archivo para obtener su fecha de creaci칩n (`dateCreated`).
        *   La fecha se formatear치 al est치ndar `DD/MM/AAAA`.
        *   La fecha formateada se escribir치 en la columna `timestamp` de la fila correspondiente.

---

#### **2. Modificaciones a Servicios Existentes (L칩gica Continua)**

**A. Servicio `GPSpedia-Feedback`: L칩gica de Expansi칩n de Rango de A침os**
*   **Objetivo:** Mejorar la funcionalidad del bot칩n "칔til" para que los usuarios puedan sugerir que un corte aplica a un a침o fuera del rango establecido, expandiendo din치micamente la aplicabilidad del registro.
*   **L칩gica de Backend:**
    1.  El frontend enviar치 el `ID` del veh칤culo y el `a침o sugerido` por el usuario al backend.
    2.  El backend verificar치 si el `a침o sugerido` ya se encuentra dentro del rango `[anoDesde, anoHasta]`. Si es as칤, no se realizar치 ninguna acci칩n.
    3.  **L칩gica de Anti-colisi칩n de Generaciones:**
        *   Antes de realizar cualquier cambio, el sistema buscar치 en toda la hoja `Cortes` si existe **otro registro** con la misma `marca`, `modelo` y `tipoEncendido`.
        *   Esta comprobaci칩n es crucial para evitar que los rangos de diferentes generaciones de un mismo modelo se solapen incorrectamente.
    4.  **Actualizaci칩n del Rango:**
        *   Si el `a침o sugerido` es **menor** que `anoDesde` y no hay colisi칩n, el valor de `anoDesde` se actualizar치 al `a침o sugerido`.
        *   Si el `a침o sugerido` es **mayor** que `anoHasta` y no hay colisi칩n, el valor de `anoHasta` se actualizar치 al `a침o sugerido`.
*   **Manejo de Casos de M칰ltiples Generaciones (Ejemplo T칠cnico):**
    *   **Escenario:** El usuario indica que el corte para una **Honda CR-V (2016-2022)** tambi칠n fue 칰til para un modelo **2026**.
    *   **Proceso:**
        1.  El sistema detecta que `2026` est치 fuera del rango `2016-2022`.
        2.  Realiza una b칰squeda y encuentra otro registro para **Honda CR-V** con un rango de `2023-2025`.
        3.  En lugar de modificar el registro original (`2016-2022`), el sistema identifica que `2026` es una extensi칩n l칩gica del segundo registro (`2023-2025`).
        4.  La columna `anoHasta` del **segundo registro** se actualiza a `2026`.

**B. Servicio `GPSpedia-Write`: Gesti칩n de Timestamps y L칩gica Frontend**
*   **Objetivo:** Asegurar que la columna `timestamp` se actualice siempre que se realice una modificaci칩n significativa en un registro y que el frontend utilice esta informaci칩n para mostrar el contenido m치s reciente.
*   **L칩gica de Backend (`write.js`):**
    1.  Al crear un **veh칤culo completamente nuevo**, se registrar치 la fecha actual en la columna `timestamp`.
    2.  Al a침adir un **nuevo corte** a un veh칤culo ya existente, la columna `timestamp` de esa fila se actualizar치 con la fecha actual.
    3.  Al a침adir **informaci칩n suplementaria** (ej. detalles de apertura, videogu칤a), la columna `timestamp` tambi칠n se actualizar치 con la fecha actual.
*   **L칩gica de Frontend (`index.html`):**
    1.  La secci칩n "칔ltimos Agregados" deber치 obtener los datos del cat치logo y ordenarlos en base a la columna `timestamp` en orden descendente antes de renderizarlos.
    2.  Las tarjetas de veh칤culo en esta secci칩n deber치n indicar qu칠 tipo de informaci칩n se agreg칩 o actualiz칩 recientemente (ej. "Nuevo Veh칤culo", "Corte Adicional", "Info. de Apertura"). Esto podr칤a requerir una l칩gica adicional o un nuevo campo en la respuesta de la API.
---
### Arquitectura de la Base de Datos

#### Arquitectura v2.0 (Can칩nica)
- **ID de Google Sheet:** `1M6zAVch_EGKGGRXIo74Nbn_ihH1APZ7cdr2kNdWfiDs`
- **Principio de Dise침o:** Estructura granular y robusta, expl칤cita y a prueba de errores de formato.

A continuaci칩n se detalla la estructura de cada hoja en la base de datos. Los nombres de las columnas deben coincidir **exactamente** con los especificados.

##### 1. Hoja: `Users`
- **Columnas:** `ID`, `Nombre_Usuario`, `Password`, `Privilegios`, `Telefono`, `Correo_Electronico`, `SessionToken`.

##### 2. Hoja: `Cortes`
- **Columnas:** `id`, `categoria`, `marca`, `modelo`, `versionesAplicables`, `anoDesde`, `anoHasta`, `tipoEncendido`, `imagenVehiculo`, `videoGuiaDesarmeUrl`, `contadorBusqueda`, `tipoCorte1`, `ubicacionCorte1`, `colorCableCorte1`, `configRelay1`, `imgCorte1`, `utilCorte1`, `colaboradorCorte1`, `tipoCorte2`, `ubicacionCorte2`, `colorCableCorte2`, `configRelay2`, `imgCorte2`, `utilCorte2`, `colaboradorCorte2`, `tipoCorte3`, `ubicacionCorte3`, `colorCableCorte3`, `configRelay3`, `imgCorte3`, `utilCorte3`, `colaboradorCorte3`, `apertura`, `imgApertura`, `cableAlimen`, `imgCableAlimen`, `timestamp`, `notaImportante`.

##### 3. Hoja: `LogosMarca`
- **Columnas:** `id`, `nombreMarca`, `urlLogo`, `fabricanteNombre`.

##### 4. Hoja: `Tutorial`
- **Columnas:** `ID`, `Tema`, `Imagen`, `comoIdentificarlo`, `dondeEncontrarlo`, `Detalles`, `Video`.

##### 5. Hoja: `Relay`
- **Columnas:** `ID`, `configuracion`, `funcion`, `vehiculoDondeSeUtiliza`, `pin30Entrada`, `pin85BobinaPositivo`, `pin86bobinaNegativo`, `pin87aComunCerrado`, `pin87ComunmenteAbierto`, `imagen`, `observacion`.

##### 6. Hoja: `ActiveSessions`
- **Columnas:** `ID_Usuario`, `Usuario`, `ActiveSessions`, `date`, `Logs`.

##### 7. Hoja: `Feedbacks`
- **Columnas:** `ID`, `Usuario`, `ID_vehiculo`, `Problema`, `Respuesta`, `Se resolvio`, `Responde`, `Reporte de util`.

##### 8. Hoja: `Contactanos`
- **Columnas:** `Contacto_ID`, `User_ID`, `Asunto`, `Mensaje`, `Respuesta_mensaje`, `ID_usuario_responde`.

##### 9. Hoja: `Logs`
- **Columnas:** `Timestamp`, `Level`, `Message`, `Data`.

##### 10. Hoja: `ActividadUsuario`
- **Columnas:** `id`, `timestamp`, `idUsuario`, `nombreUsuario`, `tipoActividad`, `idElementoAsociado`, `detalle`.

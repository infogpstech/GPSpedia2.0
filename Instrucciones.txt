=================================================
 INSTRUCTIVO DEL PROYECTO GPSpedia 2.0
=================================================
**Versión del Documento:** 4.0
**Fecha de Actualización:** 2024-08-20

Este documento detalla las normas de desarrollo, el estado de las tareas pendientes y el flujo de trabajo para el proyecto GPSpedia 2.0.

Para un análisis detallado del sistema, los hallazgos de la auditoría y las recomendaciones estratégicas, consulte el archivo `Auditoria.txt`.

---------------------------------
NORMAS OBLIGATORIAS DE DESARROLLO
---------------------------------

**A. Control de Versiones y Documentación:**
1.  **Actualización de Versión:** Cualquier cambio debe reflejarse en el número de versión visible en `index.html` y en los servicios de Apps Script.
2.  **Consulta y Actualización de Documentación:** Antes y después de cualquier desarrollo, se deben consultar y actualizar `README.md`, `INSTRUCTIVO.TXT` y `changeslogs.txt`.
3.  **Detalle en `changeslogs.txt`:** Cada entrada debe especificar el archivo y número de línea modificado.

**B. Calidad del Código:**
1.  **Comentarios:** Todo código nuevo o modificado debe tener un comentario explicando su propósito.

**C. Proceso de Aprobación:**
1.  **Verificación Post-Commit:** Una tarea solo se considera completada después de un commit y la validación explícita del Project Manager.

---------------------------------
NUEVO SISTEMA DE VERSIONAMIENTO SEMÁNTICO (X.YY.ZZ)
---------------------------------
**Fecha de Implementación:** 2024-08-20

A partir de esta fecha, el proyecto abandona el sistema de versionamiento híbrido y adopta un **único sistema de versionamiento global** basado en SemVer, con un formato estricto para garantizar la coherencia y la trazabilidad.

**REINICIO DE VERSIONADO:** El versionado del proyecto se ha reiniciado y comienza en **`2.00.00`**.

#### Formato Estricto: `X.YY.ZZ`
- **X (Arquitectura / Major):** Representa cambios mayores que rompen la compatibilidad.
- **Y (Funcionalidad / Minor):** Representa nuevas funcionalidades compatibles con versiones anteriores.
- **Z (Parche / Patch):** Representa correcciones de bugs y ajustes menores.

#### Reglas de Incremento (OBLIGATORIAS):
1.  **Incremento de `X` (Major):**
    - **SOLO** se incrementa si un cambio rompe la compatibilidad con la API o el flujo de trabajo anterior. Un cambio de `X` es un evento significativo y debe ser justificado por una alteración fundamental en el sistema.

2.  **Incremento de `Y` (Minor):**
    - Se incrementa para nuevas funcionalidades (features) que son **compatibles** con la versión anterior.
    - `Y` **NO** se incrementa hasta que `Z` haya completado su ciclo de `00` a `99`.
    - El contador `Y` utiliza dos dígitos (ej. `01`, `02`, ..., `99`).

3.  **Incremento de `Z` (Patch):**
    - Se incrementa para cada corrección de bug (fix), ajuste de estilo (style), mejora de rendimiento (perf) o refactorización (refactor) que **no introduce nueva funcionalidad**.
    - `Z` se incrementa de `00` a `99`. Después de `2.00.99`, la siguiente versión es `2.01.00`.
    - El contador `Z` utiliza dos dígitos (ej. `01`, `02`, ..., `99`).

#### Prohibiciones de Versionamiento:
- **NO** se debe incrementar la versión por "intenciones" o trabajo no completado.
- **NO** se debe incrementar la versión por cada `commit`. Un `commit` puede contener varios parches, pero solo justifica un incremento.
- **NO** se debe incrementar la versión por limpieza de código o refactors que no tienen un impacto verificable en el comportamiento.
- **TODA** entrada en `changeslogs.txt` debe corresponder a un cambio real y verificable en el código. Las "versiones fantasma" o afirmaciones falsas están estrictamente prohibidas.

---------------------------------
PROCESO DE TRABAJO POR FASES
---------------------------------

Para organizar el desarrollo y asegurar la calidad, el trabajo se dividirá en fases. Cada fase se enfocará en un conjunto específico de tareas y culminará en un commit.

1.  **Asignación de Tareas:** Se define un conjunto de tareas (ej. "Ajustes de UI en `index.html`").
2.  **Desarrollo y Commit:** Se realizan todos los cambios de código necesarios para completar la fase.
3.  **Revisión Post-Commit:** El Project Manager revisa los cambios.
    *   **Si es satisfactorio:** Se marca la tarea como completada en `README.md` y `INSTRUCTIVO.TXT`. Se registra el éxito en `changeslogs.txt`.
    *   **Si NO es satisfactorio:** Se registra el problema en `changeslogs.txt` y se crea una nueva tarea para solucionarlo. No se marcan las tareas como completadas.
4.  **Nuevas Solicitudes:** Cualquier nueva implementación o cambio solicitado se agregará primero a la lista de pendientes en `README.md` y `INSTRUCTIVO.TXT` sin marcar. Solo se marcarán como completadas después de un ciclo de desarrollo y una revisión post-commit exitosa.

---------------------------------
ESTADO ACTUAL DEL PROYECTO (CHECKLIST)
---------------------------------
**Última Actualización:** 1-01-2026

Esta sección documenta el estado actual de las tareas de desarrollo. Todas las tareas marcadas como `[Falta Revisión]` deben ser validadas por el Project Manager.

### Bugs y Regresiones Críticas

1. **Optimizacion pendiente** de la carga del catalogo. [PENDIENTE]
al actualizar la plataforma tarda en mostrar la información. 
2.  **Reducción de espacio vertical de las Imágenes en Modal:**
    - **Orden de Imágenes:** `[COMPLETADO]`
    - **Layout ajuste del width mas grande, height auto y Espacio Vertical:** `[Pendiente]`
3.  **Ajustes esteticos de Logos en Modal
- Imagen del logo sin bordes, fondo transparente y drop-shadows directo en la imagen del logo de marca:** `[Pendiente]`
4.  **Refactorización del Flujo de Escritura:** `[Falta Revisión]`
- Se ha completado la refactorización del flujo de adición de cortes en `add_cortes.html`, implementando la lógica de anti-duplicados con una interfaz de botones inline, mejorando la UX y corrigiendo bugs de visualización.
5.  **Inconsistencias de Versionamiento:** `[RESUELTO]` - El sistema de versionamiento ha sido reiniciado y normalizado.

### Revisiones de UI/UX

6.  **Rediseño de Botones de Feedback:** `[Completo]` - Se redujo el tamaño de los botones en un 10%. Pendiente la revisión de la lógica de backend.
7.  **Navegación para Carrusel de 'Categorías':** `[Completado]` - Se refactorizó la lógica de botones para que sea reutilizable en todos los carruseles.
8.  **Creación del Carrusel 'Marcas de motos':** `[PENDIENTE]` - Se intenta añadir, sin embago en cada intento causa que el catalogo "No se pudo cargar el catálogo. crearCarrusel is not defined"

### Nuevas Funcionalidades

9.  **Sistema de Navegación Jerárquico:** `[ ] Pendiente` - Implementar el flujo de navegación guiado completo: Categoría -> Marca -> Modelo -> Versión/Tipo Encendido -> Año.
10.  **Sistema de Gestión de Feedback (Inbox):** `[ ] Pendiente` - La interfaz del Inbox está creada, pero se necesita implementar la lógica de backend en el servicio `GPSpedia-Feedback`.
11. **Visibilidad de la Consola de Debugging:** `[Pendiente]` 
- la consola de depuracion se nuestra al actualizar la pagina
12. **Carga Optimizada de Imágenes (Lazy Load):** `[ ] Pendiente` - Implementar la carga progresiva de imágenes y utilizar URLs de thumbnails con tamaños específicos.
13. **Lógica de Gestión de Años:** `[ ] Pendiente` - Falta implementar la lógica de backend para registrar los votos, la hoja de cálculo para almacenar dichos votos y mejorar la presentación del `alert`.
se almacenara en la hoja de 'Feedbacks' en la columna 'anoSugerido'
14. **Ordenamiento por Utilidad:** `[ ] Pendiente de Verificación` - Verificar si el backend (`GPSpedia-Catalog`) ordena los cortes por popularidad. Si no existe, se debe construir.
15. **Expansión de Rango de Años por Feedback:** `[ ] Pendiente de Verificación` - Verificar si la lógica de backend que expande el rango de años existe. Si no, se debe construir.
16. **Modal de Relay Anidado:** `[ ] Pendiente` - Implementar la lógica para validar el caso "Sin Relay".
17. **Dashboard de Desempeño:** `[ ] Falta Implementar` - Crear la nueva sección para Supervisores.
18. **Edición "In-Modal":** `[ ] Falta Implementar` - Permitir la edición de datos desde el modal de detalles.

---
### **Plan de Implementación Técnica: Tareas Adicionales**

Esta sección detalla los requerimientos para un nuevo conjunto de funcionalidades críticas centradas en la migración de datos y la mejora de la lógica de negocio para la gestión de rangos de años y timestamps.

#### **1. Nuevo Microservicio: `GPSpedia-Utilities` (Ejecución Única)**

[Resuelto] Se creará un nuevo proyecto de Google Apps Script, independiente de los microservicios existentes, con el único propósito de realizar una migración y corrección de datos en la hoja `Cortes` de la base de datos. Este script se ejecutará una sola vez y contendrá dos funciones principales:

**A. Función 1: Migración de Rango de Años**
*   **Objetivo:** Procesar la columna `anoDesde`, que actualmente contiene rangos de texto (ej. "2016-2022") o años únicos (ej. "2006"), para poblar correctamente las columnas `anoDesde` y `anoHasta` con valores numéricos individuales.
*   **Lógica de Ejecución:**
    1.  El script iterará sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leerá el valor de la celda en la columna `anoDesde`.
    3.  **Si el valor contiene un guion (`-`):**
        *   Se dividirá la cadena de texto en dos partes.
        *   Se identificarán los dos valores numéricos, determinando cuál es el menor y cuál es el mayor.
        *   El valor numérico **menor** se escribirá de nuevo en la columna `anoDesde` de esa fila, sobrescribiendo el rango de texto.
        *   El valor numérico **mayor** se escribirá en la columna `anoHasta` de la misma fila.
    4.  **Si el valor es un único número de 4 dígitos (ej. "2006"):**
        *   El valor de `anoDesde` no se modificará.
        *   El mismo valor se copiará a la columna `anoHasta` de la misma fila.

**B. Función 2: Migración de Timestamps desde Metadatos de Google Drive**
*   **Objetivo:** Rellenar la columna `timestamp` en la hoja `Cortes` utilizando la fecha de creación del archivo de imagen del vehículo almacenado en Google Drive.
*   **Lógica de Ejecución:**
    1.  El script iterará sobre cada fila de la hoja `Cortes`.
    2.  Para cada fila, leerá la URL en la columna `imagenVehiculo`.
    3.  **Si existe una URL:**
        *   Se extraerá el `ID` del archivo de Google Drive de la URL.
        *   Utilizando el servicio `DriveApp` de Apps Script, se obtendrá el objeto de archivo (`File`) correspondiente a ese ID.
        *   Se accederá a los metadatos del archivo para obtener su fecha de creación (`dateCreated`).
        *   La fecha se formateará al estándar `DD/MM/AAAA`.
        *   La fecha formateada se escribirá en la columna `timestamp` de la fila correspondiente.

---

#### **2. Modificaciones a Servicios Existentes (Lógica Continua)**

**A. Servicio `GPSpedia-Feedback`: Lógica de Expansión de Rango de Años**
[PENDIENTE]
*   **Objetivo:** Mejorar la funcionalidad del botón "Útil" para que los usuarios puedan sugerir que un corte aplica a un año fuera del rango establecido, expandiendo dinámicamente la aplicabilidad del registro.
*   **Lógica de Backend:**
    1.  El frontend enviará el `ID` del vehículo y el `año sugerido` por el usuario al backend.
    2.  El backend verificará si el `año sugerido` ya se encuentra dentro del rango `[anoDesde, anoHasta]`. Si es así, no se realizará ninguna acción.
    3.  **Lógica de Anti-colisión de Generaciones:**
        *   Antes de realizar cualquier cambio, el sistema buscará en toda la hoja `Cortes` si existe **otro registro** con la misma `marca`, `modelo` y `tipoEncendido`.
        *   Esta comprobación es crucial para evitar que los rangos de diferentes generaciones de un mismo modelo se solapen incorrectamente.
    4.  **Actualización del Rango:**
        *   Si el `año sugerido` es **menor** que `anoDesde` y no hay colisión, el valor de `anoDesde` se actualizará al `año sugerido`.
        *   Si el `año sugerido` es **mayor** que `anoHasta` y no hay colisión, el valor de `anoHasta` se actualizará al `año sugerido`.
*   **Manejo de Casos de Múltiples Generaciones (Ejemplo Técnico):**
    *   **Escenario:** El usuario indica que el corte para una **Honda CR-V (2016-2022)** también fue útil para un modelo **2026**.
    *   **Proceso:**
        1.  El sistema detecta que `2026` está fuera del rango `2016-2022`.
        2.  Realiza una búsqueda y encuentra otro registro para **Honda CR-V** con un rango de `2023-2025`.
        3.  En lugar de modificar el registro original (`2016-2022`), el sistema identifica que `2026` es una extensión lógica del segundo registro (`2023-2025`).
        4.  La columna `anoHasta` del **segundo registro** se actualiza a `2026`.

**B. Servicio `GPSpedia-Write`: Gestión de Timestamps y Lógica Frontend**
[EN PROCESO]
*   **Objetivo:** Asegurar que la columna `timestamp` se actualice siempre que se realice una modificación significativa en un registro y que el frontend utilice esta información para mostrar el contenido más reciente. [EL FRONTEND YA NUESTRA LOS ULTIMOS CORTES POR ORDEN DE FECHA]
*   **Lógica de Backend (`write.js`):**
    1.  Al crear un **vehículo completamente nuevo**, se registrará la fecha actual en la columna `timestamp`.[PENDIENTE]
    2.  Al añadir un **nuevo corte** a un vehículo ya existente, la columna `timestamp` de esa fila se actualizará con la fecha actual.[Pendiente]
    3.  Al añadir **información suplementaria** (ej. detalles de apertura, videoguía), la columna `timestamp` también se actualizará con la fecha actual.[Pendiente]
*   **Lógica de Frontend (`index.html`):**
    1.  La sección "Últimos Agregados" deberá obtener los datos del catálogo y ordenarlos en base a la columna `timestamp` en orden descendente antes de renderizarlos.[IMPLEMENTADO]
    2.  Las tarjetas de vehículo en esta sección deberán indicar qué tipo de información se agregó o actualizó recientemente (ej. "Nuevo Vehículo", "Corte Adicional", "Info. de Apertura"). Esto podría requerir una lógica adicional o un nuevo campo en la respuesta de la API.
[pendiente]
---
### Arquitectura de la Base de Datos

#### Arquitectura v2.0 (Canónica)
- **ID de Google Sheet:** `1M6zAVch_EGKGGRXIo74Nbn_ihH1APZ7cdr2kNdWfiDs`
- **Principio de Diseño:** Estructura granular y robusta, explícita y a prueba de errores de formato.

A continuación se detalla la estructura de cada hoja en la base de datos. Los nombres de las columnas deben coincidir **exactamente** con los especificados.

##### 1. Hoja: `Users`
- **Columnas:** `ID`, `Nombre_Usuario`, `Password`, `Privilegios`, `Telefono`, `Correo_Electronico`, `SessionToken`.

##### 2. Hoja: `Cortes`
- **Columnas:** `id`, `categoria`, `marca`, `modelo`, `versionesAplicables`, `anoDesde`, `anoHasta`, `tipoEncendido`, `imagenVehiculo`, `videoGuiaDesarmeUrl`, `contadorBusqueda`, `tipoCorte1`, `ubicacionCorte1`, `colorCableCorte1`, `configRelay1`, `imgCorte1`, `utilCorte1`, `colaboradorCorte1`, `tipoCorte2`, `ubicacionCorte2`, `colorCableCorte2`, `configRelay2`, `imgCorte2`, `utilCorte2`, `colaboradorCorte2`, `tipoCorte3`, `ubicacionCorte3`, `colorCableCorte3`, `configRelay3`, `imgCorte3`, `utilCorte3`, `colaboradorCorte3`, `apertura`, `imgApertura`, `cableAlimen`, `imgCableAlimen`, `timestamp`, `notaImportante`.

##### 3. Hoja: `LogosMarca`
- **Columnas:** `id`, `nombreMarca`, `urlLogo`, `fabricanteNombre`.

##### 4. Hoja: `Tutorial`
- **Columnas:** `ID`, `Tema`, `Imagen`, `comoIdentificarlo`, `dondeEncontrarlo`, `Detalles`, `Video`.

##### 5. Hoja: `Relay`
- **Columnas:** `ID`, `configuracion`, `funcion`, `vehiculoDondeSeUtiliza`, `pin30Entrada`, `pin85BobinaPositivo`, `pin86bobinaNegativo`, `pin87aComunCerrado`, `pin87ComunmenteAbierto`, `imagen`, `observacion`.

##### 6. Hoja: `ActiveSessions`
- **Columnas:** `ID_Usuario`, `Usuario`, `ActiveSessions`, `date`, `Logs`.

##### 7. Hoja: `Feedbacks`
- **Columnas:** `ID`, `Usuario`, `ID_vehiculo`, `Problema`, `Respuesta`, `Se resolvio`, `Responde`, `Reporte de util`, 'anoSugerido'

##### 8. Hoja: `Contactanos`
- **Columnas:** `Contacto_ID`, `User_ID`, `Asunto`, `Mensaje`, `Respuesta_mensaje`, `ID_usuario_responde`.

##### 9. Hoja: `Logs`
- **Columnas:** `Timestamp`, `Level`, `Message`, `Data`.

##### 10. Hoja: `ActividadUsuario`
- **Columnas:** `id`, `timestamp`, `idUsuario`, `nombreUsuario`, `tipoActividad`, `idElementoAsociado`, `detalle`.

---------------------------------
TAREAS PENDIENTES DERIVADAS DE AUDITORÍA
---------------------------------

**A. Inconsistencias Arquitectónicas y Bugs Críticos de Backend**

1.  **BUG (`services/auth/auth.js`):** La lógica de validación de sesión (`handleValidateSession`) no consulta la hoja `ActiveSessions`, lo que puede llevar a aceptar sesiones que ya han sido invalidadas por un nuevo inicio de sesión.
2.  **DEUDA TÉCNICA (`services/auth/auth.js`):** El servicio devuelve `MimeType.JSON`, lo que genera un riesgo de CORS. Debe estandarizarse para devolver `MimeType.TEXT`.
3.  **BUG (`services/users/users.js`):** La comparación de contraseñas para el login (`auth.js`) es case-insensitive, mientras que para el cambio de contraseña (`users.js`) es case-sensitive. Esto debe unificarse para evitar que los usuarios no puedan cambiar su contraseña.
4.  **DEUDA TÉCNICA (`services/catalog/catalog.js`):** El servicio tiene una inconsistencia de MimeType (`doGet` devuelve JSON, `doPost` devuelve TEXT). Debe estandarizarse a `TEXT`.
5.  **DEUDA TÉCNICA (`services/catalog/catalog.js` y `services/write/write.js`):** La función `handleCheckVehicle` está duplicada en ambos servicios. Se debe eliminar una de las dos y centralizar la lógica.
6.  **REGRESIÓN (`services/write/write.js`):** El archivo contiene el código `previousRowRange.copyTo(newRowRange)` que, según `changeslogs.txt`, causa una regresión crítica y debería haber sido eliminado en un rollback.
7.  **BUG (`services/feedback/feedback.js`):** El archivo contiene dos implementaciones duplicadas y conflictivas de `handleRecordLike` y `handleSuggestYear`. Se debe eliminar el código duplicado.
8.  **BUG (`services/feedback/feedback.js`):** El servicio devuelve `MimeType.JSON`, lo que provocará fallos de CORS en producción. Debe estandarizarse a `TEXT`.
9.  **DEUDA TÉCNICA (`services/feedback/feedback.js`):** El servicio utiliza una hoja no documentada (`SugerenciasAño`). Su uso debe ser formalizado en la documentación de la arquitectura o eliminado.
10. **BUG (`services/users/users.js`):** La función `doPost` del servicio no devuelve ninguna respuesta, lo que hace que todas las operaciones de gestión de usuarios fallen en el frontend. La función debe ser completada para que devuelva la variable `response`.
11. **BUG (`services/utilities/utilities.js`):** La funcionalidad de migración es inoperable porque la llamada desde el frontend (`index.html`) no pasa el objeto `session` requerido para la autorización. La llamada en el frontend debe ser corregida.

**B. Inconsistencias y Bugs de Frontend**

12. **DEUDA TÉCNICA (`api-manager.js`):** La acción `checkVehicle` se enruta a `CATALOG`, pero también existe en `WRITE`. Se debe definir una única fuente de verdad para esta acción.
13. **INCOMPLETO (`add_cortes.html`):** La función `handleSuggestion` llama a la acción `getSuggestion`, pero esta no está registrada en el `ACTION_TO_SERVICE_MAP` de `api-manager.js`.
14. **INCONSISTENCIA (`changeslogs.txt` vs. `service-worker.js`):** El changelog menciona una corrección en el archivo `service-worker.js`, pero este archivo no existe en el repositorio.

**C. Sincronización de Versiones**

15. **DEUDA TÉCNICA (Todos los archivos):** Los números de versión en las cabeceras de los archivos y en las respuestas `doGet` de los servicios backend no están sincronizados con la versión global definida en `changeslogs.txt`.

=================================================
 INSTRUCCIONES Y TAREAS PENDIENTES - GPSpedia
=================================================
**Versión del Documento:** 1.0 (Post-Auditoría)
**Fecha de Generación:** 2024-08-20

Este documento convierte los hallazgos de `Auditoria.txt` en una lista de tareas accionables para estabilizar y mejorar el proyecto.

---------------------------------
MÓDULO: ARQUITECTURA GENERAL Y DOCUMENTACIÓN
---------------------------------

### Archivo: N/A (Proyecto General)

- **Tarea 1: Refactorizar Arquitectura Frontend**
  - **Urgencia:** Alta
  - **Tipo:** Deuda Técnica Crítica
  - **Descripción:** Rediseñar la arquitectura de `index.html`, `add_cortes.html` y `users.html` para separar HTML, CSS y JavaScript en archivos independientes. Implementar un framework ligero o un patrón modular para gestionar el estado de la aplicación de forma estructurada, eliminando la dependencia de variables globales y la manipulación directa del DOM.
  - **Impacto Potencial:** Reducción drástica de la complejidad, facilidad de mantenimiento, menor riesgo de regresiones y mejora del rendimiento.

- **Tarea 2: Unificar y Limpiar Documentación**
  - **Urgencia:** Media
  - **Tipo:** Inconsistencia
  - **Descripción:**
    1.  Eliminar el archivo obsoleto `ChangesLogstxt`.
    2.  Auditar y actualizar el `README.md` para que el estado de las tareas (`[X]`, `[ ]`) refleje la realidad del código.
    3.  Estandarizar el sistema de versionamiento y asegurar que se aplique consistentemente en todos los archivos y en `ChangesLogs.txt`.
  - **Impacto Potencial:** La documentación se vuelve una fuente fiable, facilitando el onboarding de nuevos desarrolladores y la planificación de futuras funcionalidades.

- **Tarea 3: Implementar Caché en Backend**
  - **Urgencia:** Alta
  - **Tipo:** Deuda Técnica (Rendimiento)
  - **Descripción:** Implementar un mecanismo de caché en el lado del servidor (Google Apps Script) para todas las operaciones de lectura (`getCatalogData`, `getUsers`, etc.). Utilizar `CacheService` de Apps Script para almacenar temporalmente los resultados de `getDataRange().getValues()` y evitar lecturas repetitivas e ineficientes de la hoja de cálculo.
  - **Impacto Potencial:** Mejora radical del rendimiento y la velocidad de respuesta de la aplicación, especialmente en la carga inicial.

---------------------------------
MÓDULO: FRONTEND
---------------------------------

### Archivo: `api-manager.js`

- **Tarea 4: Dinamizar Configuración de API**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica
  - **Descripción:** Modificar el `api-manager.js` para que cargue las URLs de los servicios y el mapa de acciones desde un objeto de configuración centralizado o un endpoint dedicado, en lugar de tenerlos codificados.
  - **Impacto Potencial:** Facilita la gestión de diferentes entornos (desarrollo, producción) y la adición de nuevos microservicios o acciones.

### Archivo: `index.html`

- **Tarea 5: Corregir Lógica de Sesión**
  - **Urgencia:** Alta
  - **Tipo:** Inconsistencia Funcional
  - **Descripción:** Refactorizar la lógica de `checkSession` para que, después de validar el token con el backend, se actualice el `localStorage` con la información más reciente del usuario. La aplicación debe confiar únicamente en el estado validado por el backend en cada carga.
  - **Impacto Potencial:** Elimina condiciones de carrera y asegura que el estado de la sesión en el frontend sea siempre consistente con el del backend.

- **Tarea 6: Eliminar Código Muerto (IndexedDB)**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica
  - **Descripción:** Eliminar por completo el código relacionado con la inicialización y uso de IndexedDB, ya que no se está utilizando y añade complejidad innecesaria.
  - **Impacto Potencial:** Código más limpio y ligero.

### Archivo: `users.html`

- **Tarea 7: Corregir Mapeo de Datos de Usuario**
  - **Urgencia:** Crítica
  - **Tipo:** Bug
  - **Descripción:** Modificar el JavaScript de `users.html` para que acceda a las propiedades del objeto de usuario utilizando los nombres correctos devueltos por el backend (`PascalCase_With_Underscores`, ej. `user.Nombre_Usuario`), en lugar de `camelCase`.
  - **Impacto Potencial:** Soluciona el bug crítico que impide mostrar los datos de los usuarios en la tabla de gestión y en los modales de edición.

---------------------------------
MÓDULO: BACKEND (MICROSERVICIOS)
---------------------------------

### Archivo: `services/auth/auth.js`

- **Tarea 8: Implementar Almacenamiento Seguro de Contraseñas**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:**
    1.  Eliminar la conversión a `.toLowerCase()` en la comparación de contraseñas.
    2.  Implementar un mecanismo de hashing para las contraseñas. Se debe añadir una utilidad de hashing (ej. SHA-256 con un salt) y migrar las contraseñas existentes a su formato hasheado. La comparación debe hacerse sobre los hashes, no sobre el texto plano.
  - **Impacto Potencial:** Mejora fundamental de la seguridad de las cuentas de usuario.

- **Tarea 9: Refactorizar Validación de Sesión**
  - **Urgencia:** Media
  - **Tipo:** Ineficiencia
  - **Descripción:** Modificar `handleValidateSession` para que consulte la hoja `ActiveSessions` en lugar de leer toda la hoja `Users`. Esto alinea la función con su propósito lógico.
  - **Impacto Potencial:** Validación de sesión mucho más rápida y eficiente.

### Archivo: `services/catalog/catalog.js`

- **Tarea 10: Separar Responsabilidades del Servicio**
  - **Urgencia:** Media
  - **Tipo:** Deuda Técnica
  - **Descripción:** Refactorizar `handleGetCatalogData`. Mover la lógica de negocio (ordenamiento de cortes, transformación de URLs) a funciones auxiliares o incluso a un servicio de "transformación" separado si la complejidad aumenta. El handler principal solo debe ser responsable de obtener y devolver los datos.
  - **Impacto Potencial:** Servicio más limpio, fácil de mantener y testear.

### Archivo: `services/feedback/feedback.js`

- **Tarea 11: Eliminar Código Duplicado**
  - **Urgencia:** Media
  - **Tipo:** Deuda Técnica
  - **Descripción:** Identificar y eliminar la función `handleRecordLike` duplicada, unificando la lógica en una sola implementación.
  - **Impacto Potencial:** Reduce la confusión y el riesgo de aplicar correcciones en un solo lugar.

- **Tarea 12: Corregir `MimeType` de Respuesta**
  - **Urgencia:** Crítica
  - **Tipo:** Bug
  - **Descripción:** Cambiar el `MimeType` de la respuesta del `doPost` de `ContentService.MimeType.JSON` a `ContentService.MimeType.TEXT`.
  - **Impacto Potencial:** Soluciona el error `Failed to fetch` que actualmente impide que toda la funcionalidad del "Inbox" (reportes, contacto) funcione.

- **Tarea 13: Refactorizar Búsquedas en Hoja de Cálculo**
  - **Urgencia:** Baja
  - **Tipo:** Ineficiencia
  - **Descripción:** Investigar métodos más eficientes para encontrar una fila por ID que no requieran leer toda la hoja de cálculo, como `TextFinder` o la creación de un índice en una propiedad del script, si es aplicable para lecturas menos frecuentes. Aplicar esta optimización a `handleRecordLike` y `handleAssignCollaborator`.
  - **Impacto Potencial:** Mejora del rendimiento en operaciones de escritura de feedback.

### Archivo: `services/users/users.js`

- **Tarea 14: Corregir Falla de Seguridad en Permisos**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:** Refactorizar TODAS las funciones de CRUD (`handleCreateUser`, `handleUpdateUser`, `handleDeleteUser`) para que la validación de permisos se base en una sesión verificada del *solicitante* en el backend, no en un parámetro (`creatorRole`, `updaterRole`) enviado desde el cliente. Se debe requerir un `sessionToken` en el payload y validarlo antes de proceder.
  - **Impacto Potencial:** Cierra una vulnerabilidad crítica que permite la escalada de privilegios.

- **Tarea 15: Corregir Inconsistencia en Cambio de Contraseña**
  - **Urgencia:** Media
  - **Tipo:** Bug
  - **Descripción:** Modificar la comparación de la `currentPassword` en `handleChangePassword` para que sea `case-insensitive` (`.toLowerCase()`), haciéndola consistente con la lógica de `login`.
  - **Dependencias:** Depende de la Tarea 8. La comparación debe hacerse sobre el hash, no sobre el texto plano. Una vez implementado el hashing, esta tarea debe asegurar que el proceso de verificación sea consistente.
  - **Impacto Potencial:** Soluciona el bug que impide a los usuarios cambiar su contraseña si la escriben con una capitalización diferente.

### Archivo: `services/write/write.js`

- **Tarea 16: Simular Transacciones y Mejorar Manejo de Errores**
  - **Urgencia:** Alta
  - **Tipo:** Riesgo de Datos
  - **Descripción:** Refactorizar `handleAddOrUpdateCut` para simular una transacción. Primero, intentar todas las operaciones propensas a fallos (creación de carpetas, subida de archivos) y solo si TODAS tienen éxito, proceder con la escritura en la hoja de cálculo. Implementar `try...catch` robustos en cada paso y una lógica de `rollback` manual (ej. eliminar el archivo subido si la escritura en la hoja falla).
  - **Impacto Potencial:** Reduce drásticamente el riesgo de corrupción y datos inconsistentes.

- **Tarea 17: Unificar Lógica de `handleCheckVehicle`**
  - **Urgencia:** Media
  - **Tipo:** Inconsistencia
  - **Descripción:** Eliminar la implementación de `handleCheckVehicle` de uno de los servicios (`catalog.js` o `write.js`) y asegurar que el `api-manager.js` siempre enrute esta acción al servicio correcto que la contiene.
  - **Impacto Potencial:** Asegura un comportamiento consistente de la funcionalidad anti-duplicados.

### Archivo: `services/utilities/utilities.js`

- **Tarea 18: Hacer Scripts de Migración Idempotentes**
  - **Urgencia:** Alta
  - **Tipo:** Riesgo de Datos
  - **Descripción:** Modificar `handleMigrateYearRanges` y `handleMigrateTimestamps` para que verifiquen el estado de una fila antes de intentar modificarla. Por ejemplo, `handleMigrateYearRanges` no debería procesar una fila si `anoHasta` ya tiene un valor, y `handleMigrateTimestamps` no debería ejecutarse si `timestamp` ya está poblado.
  - **Impacto Potencial:** Previene la corrupción de datos si los scripts se ejecutan accidentalmente más de una vez.

- **Tarea 19: Corregir Falla de Seguridad en Autorización**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:** Reemplazar la función `authorize` actual. La nueva implementación debe recibir un `sessionToken` (no todo el objeto `session`), buscar ese token en la hoja `ActiveSessions` para encontrar el `userId`, y luego buscar el rol de ese `userId` en la hoja `Users`. La autorización debe basarse en este rol verificado en el backend.
  - **Impacto Potencial:** Cierra la vulnerabilidad que permite la ejecución no autorizada de acciones de migración destructivas.

### Archivo: `Code.gs` (Legacy)

- **Tarea 20: Corregir Configuración de Fallback**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica / Bug
  - **Descripción:**
    1.  Actualizar el `SPREADSHEET_ID` para que apunte a la DB v2.0, o eliminarlo si ya no es necesario para el logging.
    2.  Modificar el `switch` en el `doPost` para que, en el `default` case, devuelva un error claro que indique que la acción debe ser manejada por un microservicio, en lugar de un "Acción desconocida" genérico. Esto mejorará la depuración del `api-manager.js`.
  - **Impacto Potencial:** Mejora la claridad en la depuración y elimina configuraciones obsoletas.

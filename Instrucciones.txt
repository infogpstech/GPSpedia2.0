NORMAS OBLIGATORIAS DE DESARROLLO
---------------------------------

**A. Control de Versiones y Documentación:**
1.  **Actualización de Versión:** Cualquier cambio debe reflejarse en el número de versión visible en `index.html` y en los servicios de Apps Script.
2.  **Consulta y Actualización de Documentación:** Antes y después de cualquier desarrollo, se deben consultar y actualizar `README.md`, `Instrucciones.txt` y `ChangesLogs.txt`.
3.  **Detalle en `ChangesLogs.txt`:** Cada entrada debe especificar el archivo y número de línea modificado.

**B. Calidad del Código:**
1.  **Comentarios:** Todo código nuevo o modificado debe tener un comentario explicando su propósito.
2. **prohibido eliminar el bloque que describe mas reglas en Instrucciones.txt
3.**prohibido resumir o utilizar sumarizacion "(Sin Cambios)" EN NINGUN ARCHIVO DE CODIGO, DOCUMENTACIÓN O DE REGLAMENTO.
4. PROHIBIDO REVERTIR COMMITS SIN LA SOLICITUD DEL PM.
5. PROHIBIDO USAR HERRAMIENTAS BUSQUEDA, EDICION RAPIDA, TODA BUSQUESA, REVISION DEBE SER LINEA POR LINEA DE ARCHIVO POR ARCHIVO.
6. OBLIGATORIO AUDITAR CADA ARCHIVO DE CODIGO ANTES DE CUALQUIER MODIFICACION POR MUY PEQUEÑA QUE SEA CADA HALLAZGO NO DEBE SER REPARADO EN EL MOMENTO DE AUDITORIA, DEBE DE REGISTRARSE EN Auditoria.txt Y DESPUES PLANTEARSE COMO UNA NUEVA TAREA EN Instrucciones.txt.
7. PROHIBIDO DUPLICAR BLOQUES DE CODIGO, POR ELLO ES LA AUDITORIA INICIAL.
8. PROHIBIDO INVENTARSE LA FECHA EN ChangesLogs.txt USAR DE REFERENCIA LA FECHA DE LA ULTIMA ENTRADA DE ChangesLogs.txt
9. No asumir que cualquier fix registrado en ChangesLogs.txt fue exitoso.
10. NO registrar como EXITO Cualquier Fix aplicado en el codigo, toda entrada debe evitar asumir arreglar fallas y evitar utilizar terminos como "Se corrigio, se arreglo,..etc"

**C. Proceso de Aprobación:**
1.  **PROHIBIDO marcar tareas como “completadas” sin revisión del Project Manager.**
2.  **PROHIBIDO asumir que un cambio resolvió un problema.**
3.  **SOLO describir qué se cambió o qué se debe cambiar.**
4.  Si una tarea introduce nuevos errores: Marcar como **EN REVISIÓN**.
5.  Si la tarea no funciona o no cumple: REQUIERE **NUEVA REVISIÓN**.
6. si una tarea se realizo no marcarla como COMPLETADA, marcarla como PENDIENTE REVISION POR EL MP.


PROCESO ESTÁNDAR DE TRABAJO
===========================================================

Este protocolo define los PASOS OBLIGATORIOS que todo desarrollador debe
seguir en TODOS los proyectos, sin excepción.


FLUJO OBLIGATORIO DE TRABAJO
----------------------------

1. AUDITORÍA INICIAL DEL ARCHIVO
   - Auditar el archivo o archivos involucrados en la tarea.
   - La auditoría DEBE realizarse:
     - Archivo por archivo
     - Línea por línea
   - NO modificar código durante esta fase.

2. REGISTRO DE HALLAZGO
   - Registrar TODOS los hallazgos en Auditoría.txt.
   - Crear una nueva entrada para el archivo auditado.
   - Si ya existe una auditoría previa del mismo archivo:
     -> Actualizar la entrada existente
     -> NO eliminar información previa.

3. HALLAZGO FUERA DE la TAREA ORIGINAL
   - Si se detectan problemas NO relacionados directamente
     con la tarea asignada:
     a) Resolverlos en el MISMO commit de la tarea,
        SOLO si es técnicamente posible y seguro.
     b) Si NO es posible resolverlos:
        -> Registrar la nueva tarea en Instrucciones.txt
        -> Agregar referencia al hallazgo en Auditoría.txt

4. EJECUCIÓN DE la TAREA
   - Realizar ÚNICAMENTE los cambios solicitados por la tarea
     sobre el código.
   - Respetar todas las normas definidas en Instrucciones.txt.

5. VERIFICACIÓN FUNCIONAL
   - Verificar que los cambios realizados:
     - Cumplen el objetivo de la tarea
     - NO rompen otras funciones del archivo
     - NO afectan flujos de información existentes

6. VERIFICACIÓN COMPLEMENTARIA
   - Revisar:
     - Dependencias
     - Funciones relacionadas
     - Llamadas internas o externas
   - Confirmar que no se introdujeron efectos colaterales.

7. REVISIÓN FINAL DEL CÓDIGO
   - Revisar nuevamente el archivo completo modificado:
     - Línea por línea
     - Función por función
   - Validar coherencia, legibilidad y cumplimiento de reglas.

8. REGISTRO EN CHANGESLOGS.TXT
   - Registrar los cambios realizados indicando:
     - Archivo(s) modificado(s)
     - Línea(s) afectada(s)
     - Descripción objetiva del cambio
   - NO asumir éxito
   - NO usar términos como:
     - "Se corrigió"
     - "Se arregló"
     - "Se solucionó"

9. ACTUALIZACIÓN DE INSTRUCCIONES.TXT
   - Mover la tarea ejecutada al bloque:
     -> "TAREAS PENDIENTES DE REVISIÓN"
   - NO marcar la tarea como completada.

10. COMMIT
    - Realizar el commit SOLO después de cumplir
      todos los pasos anteriores.
    - El commit debe reflejar exactamente:
      - Lo documentado en ChangesLogs.txt
      - El estado actualizado de Instrucciones.txt


REGLA FINAL
-----------
Si un paso NO fue ejecutado, el proceso se considera INCOMPLETO.
NO se permiten atajos, omisiones ni reinterpretaciones.

---
# ESTADO DE TAREAS
---

## -- TAREAS COMPLETADAS --

[COMPLETADA] Corrección Integral de Múltiples Regresiones Críticas
Origen: Reporte de PM (Post-Fallo de Despliegue)
Prioridad: MÁXIMA
Área: Full Stack (auth, users, frontend)
Descripción:
Se implementó una corrección integral para un conjunto de regresiones interconectadas. El trabajo incluyó:
1.  **Objeto de Sesión:** Se corrigió `services/auth/auth.js` para incluir el `Nombre_Completo` en la sesión.
2.  **Condición de Carrera:** Se rectificó la secuencia de arranque en `auth.js` para cargar datos antes de renderizar.
3.  **Manejo de Errores:** Se añadió un estado por defecto en `auth.js` para prevenir fallos fatales.
4.  **Seguridad:** Se refactorizó `services/users/users.js` y `users.html` para usar `sessionToken` en lugar de `privilegios` para la autorización.
Archivos Afectados: `services/auth/auth.js`, `services/users/users.js`, `auth.js`, `users.html`.

---

[COMPLETADA] Implementar Estrategia de Caché Granular para el Catálogo
Origen: Auditoría Técnica Forense v2.0
Prioridad: ALTA
Área: Performance | Backend
Descripción:
El servicio de catálogo (`services/catalog/catalog.js`) ha deshabilitado el almacenamiento en caché porque el conjunto de datos completo excede el límite de 100 KB de Google Apps Script. Esto causa que cada carga de la aplicación sea lenta, ya que debe leer y procesar toda la base de datos cada vez.
Alcance:
- Diseñar e implementar una estrategia de caché que no exceda los límites de tamaño. Esto podría implicar cachear subconjuntos de datos (ej. por categoría o marca) en lugar del catálogo completo.
- El frontend deberá ser actualizado para ensamblar los datos cacheados granularmente.
- NO incluye la optimización de otras consultas de la base de datos.

---

## -- TAREAS EN PROGRESO O CON OBSERVACIONES --

[EN PROGRESO] Implementar Sistema de Inbox (Tarea 18)
Origen: Requerimiento de Funcionalidad
Prioridad: ALTA
Área: Frontend | UI/UX
Descripción:
Implementación funcional completada. Pendiente revisión de estilos y lógica final para la gestión de feedback de usuarios (reportes de problemas y formularios de contacto).
Alcance:
- Creación de la UI para listar y detallar mensajes.
- Integración con el `services/feedback/feedback.js` para obtener, responder y resolver items.
- Lógica de visibilidad basada en roles de usuario (`Supervisor`, `Gefe`, `Desarrollador`).

---

[EN PROGRESO] Investigar Falta de "Nombre Completo" en la Sección "Mi Perfil"
Origen: Reporte de PM
Prioridad: MEDIA
Área: Backend | `services/auth/auth.js`
Descripción:
El "Nombre Completo" del usuario no aparece en la sección "Mi Perfil" de `users.html`, incluso si está presente en la base de datos. La causa probable es que la función de `login` en `services/auth/auth.js` no incluye este campo en el objeto de usuario que se devuelve al frontend y se guarda en la sesión. Se debe auditar y corregir el servicio de autenticación para que devuelva el objeto de usuario completo.

---

## -- TAREAS PENDIENTES DE REVISIÓN POR EL PM --

[PENDIENTE REVISION POR EL MP] Actualización Final de Endpoint del Servicio de Usuarios
Origen: Requerimiento de Configuración (Post-Investigación)
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizó la URL del microservicio de `USERS` en `api-manager.js` para apuntar al endpoint definitivo y verificado (`...LUydhEW_Ng/exec`), proporcionado por el Project Manager tras una investigación exhaustiva.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Actualización de Endpoints de AUTH y USERS
Origen: Requerimiento de Configuración
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizaron las URLs de los microservicios de `AUTH` y `USERS` en `api-manager.js` para apuntar a los nuevos endpoints de producción desplegados por el Project Manager.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Actualización de Endpoint del Servicio de Usuarios (Iteración 4)
Origen: Requerimiento de Configuración
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizó por cuarta vez la URL del microservicio de `USERS` en `api-manager.js` para apuntar al nuevo endpoint de producción desplegado por el Project Manager.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Corrección de Regresión Crítica y Bug Persistente en Módulo de Usuarios
Origen: Reporte de PM (Post-Revisión)
Prioridad: CRÍTICA
Área: Backend | Users
Descripción:
Se corrigió la regresión "create on edit" que duplicaba usuarios y se solucionó el bug que impedía guardar el "Nombre Completo".
Archivos Afectados: `services/users/users.js`.

---

[PENDIENTE REVISION POR EL MP] Actualización de Endpoint del Servicio de Usuarios (Iteración 3)
Origen: Requerimiento de Configuración
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizó por tercera vez la URL del microservicio de `USERS` en `api-manager.js` para apuntar al nuevo endpoint de producción desplegado por el Project Manager.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Corrección Definitiva de Bug en Guardado de "Nombre Completo"
Origen: Reporte de PM (Post-Revisión)
Prioridad: CRÍTICA
Área: Backend | Users
Descripción:
Se implementó la corrección definitiva para el bug persistente que impedía guardar el "Nombre Completo" al editar un usuario. La causa raíz fue un conflicto de `case-sensitivity` en la lógica de `handleUpdateUser` que impedía el mapeo correcto del campo.
Archivos Afectados: `services/users/users.js`.

---

[PENDIENTE REVISION POR EL MP] Actualización de Endpoint del Servicio de Usuarios (Iteración 2)
Origen: Requerimiento de Configuración
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizó por segunda vez la URL del microservicio de `USERS` en `api-manager.js` para apuntar al nuevo endpoint de producción desplegado por el Project Manager.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Corrección de Bug en Guardado de "Nombre Completo"
Origen: Reporte de PM (Post-Revisión)
Prioridad: CRÍTICA
Área: Backend | Users
Descripción:
Se corrigió un bug que impedía que el campo "Nombre Completo" se guardara al crear o editar un usuario. La causa raíz fue que el backend (`services/users/users.js`) ignoraba silenciosamente el campo en las funciones `handleCreateUser` y `handleUpdateUser`.
Archivos Afectados: `services/users/users.js`.

---

[PENDIENTE REVISION POR EL MP] Actualización de Endpoint del Servicio de Usuarios
Origen: Requerimiento de Configuración
Prioridad: CRÍTICA
Área: Configuración | Frontend
Descripción:
Se actualizó la URL del microservicio de `USERS` en `api-manager.js` para apuntar al nuevo endpoint de producción desplegado por el Project Manager.
Archivos Afectados: `api-manager.js`.

---

[PENDIENTE REVISION POR EL MP] Corrección de Regresiones Críticas en Módulo de Usuarios (Tareas 24, 25, 26)
Origen: Reporte de Regresión Post-Implementación
Prioridad: CRÍTICA
Área: Backend, Frontend | Users
Descripción:
Se corrigieron tres bugs críticos que surgieron tras la implementación de la funcionalidad "Nombre Completo":
1.  **Bug de Visualización:** El `SessionToken` se mostraba en lugar del nombre completo. (Causa: Mapeo de columnas incorrecto en `services/users/users.js`).
2.  **Bug de Actualización:** La edición de usuarios fallaba. (Causa: Conflicto de `case-sensitivity` en la propiedad `ID` del usuario entre frontend y backend).
3.  **Bug de Eliminación:** La eliminación de usuarios fallaba. (Causa: Síntoma secundario del mapeo de columnas incorrecto que afectaba la integridad de los datos).
Archivos Afectados: `services/users/users.js`.

---

## -- TAREAS PENDIENTES (BACKLOG) --

[TAREA] Refactorizar Frontend para Separar Lógica de Presentación
Origen: Auditoría Técnica Forense v2.0
Prioridad: ALTA
Área: Frontend
Descripción:
El archivo `index.html` contiene una cantidad masiva de código JavaScript inline, mezclando la lógica de la aplicación con la estructura del DOM. Esto hace que el código sea frágil y difícil de mantener.
Alcance:
- Extraer todo el código JavaScript inline del `index.html` a archivos `.js` modulares y cohesivos.
- Reducir la dependencia de selectores de ID y clase en JavaScript, favoreciendo el uso de atributos `data-*` para desacoplar la lógica del estilo.
- NO incluye rediseñar la interfaz de usuario, solo refactorizar el código subyacente.

---

[TAREA] Abstraer la Capa de Acceso a Datos del Backend
Origen: Auditoría Técnica Forense v2.0
Prioridad: MEDIA
Área: Arquitectura | Backend
Descripción:
La lógica de negocio en todos los servicios de backend está fuertemente acoplada a la estructura de la hoja de Google Sheets, utilizando índices de columna numéricos hardcodeados (ej. `row[COLS_CORTES.marca - 1]`). Esto hace que el sistema sea extremadamente frágil a cualquier cambio en la base de datos.
Alcance:
- Crear una capa de abstracción de datos (un "mapper" o "repositorio") que traduzca las filas de la hoja de cálculo a objetos JavaScript de una manera centralizada.
- Refactorizar todos los servicios para que utilicen esta capa de abstracción en lugar de acceder directamente a los índices de las columnas.
- NO incluye cambiar el esquema de la base de datos.

---

[TAREA] Mejorar Calidad de Imagen en Modal de Relay
Origen: Reporte de Tareas
Prioridad: BAJA
Área: Frontend | UI
Descripción:
La imagen de la configuración del Relay en el modal de detalle se muestra en baja resolución.
Acciones:
1.  **Modificar `ui.js`:** En la función `renderRelayInfoModal`, al llamar a `getImageUrl`, añadir el parámetro `size` con un valor de `1000` para solicitar una versión de mayor calidad de la imagen.

---

[TAREA] Reparar Funcionalidad de Botones en Gestión de Usuarios
Origen: Auditoría 11/01/2024
Prioridad: CRÍTICA
Área: Frontend | `users.html`
Descripción:
Los botones "Editar", "Eliminar" y "Cambiar Contraseña" no funcionan debido a un conflicto de ámbito de JavaScript. Las funciones son inaccesibles para los atributos `onclick` del HTML porque el script es un módulo.
Acciones:
1.  **Refactorizar `users.html`:** Modificar la función `renderUserTable` para que los `event listeners` de los botones "Editar" y "Eliminar" se adjunten mediante `button.addEventListener('click', ...)`.
2.  **Añadir Enlace de Retorno:** Incluir un enlace `<a>` en la parte superior de `users.html` que permita al usuario volver fácilmente al catálogo (`index.html`).

---

[TAREA] Corregir Apariencia del Encabezado en Modal de Detalles
Origen: Auditoría 11/01/2024
Prioridad: MEDIA
Área: Frontend | `ui.js`
Descripción:
El logo de la marca aparece a la derecha del título del vehículo, en lugar de a la izquierda como se especifica.
Acciones:
1.  **Modificar `ui.js`:** En la función `mostrarDetalleModal`, reordenar la lógica para que el elemento `img` del logo se añada al `titleContainer` antes que el elemento que contiene el `h2` del título.

---

[TAREA] Ajustar Tamaño de Imágenes en Modal de Detalles
Origen: Auditoría 11/01/2024
Prioridad: BAJA
Área: Frontend | `style.css`
Descripción:
Las imágenes dentro del modal de detalles no tienen el tamaño correcto: la del vehículo es muy grande y la del corte no es responsiva.
Acciones:
1.  **Modificar `style.css`:**
    *   Ajustar la regla `.img-vehiculo-modal` para reducir su tamaño (ej. `width: 50%; max-width: 200px;`).
    *   Añadir una `@media query` para que la clase `.img-corte` tenga un `width: 80%` en pantallas con un ancho máximo de `600px`.

---

[TAREA] Implementar Lógica de Visualización para Corte Recomendado
Origen: Auditoría 11/01/2024
Prioridad: MEDIA
Área: Frontend | `ui.js`
Descripción:
El corte con más votos ("Corte Recomendado") se muestra incorrectamente dentro de un acordeón. Debe estar siempre visible y expandido.
Acciones:
1.  **Modificar `ui.js`:** En `mostrarDetalleModal`, cambiar el bucle de renderizado de secciones. Primero, renderizar el contenido del corte recomendado directamente en el DOM (sin usar `createAccordionSection`). Luego, iterar sobre el resto de los cortes y secciones para crear los acordeones correspondientes.

---

[TARE] Implementar Funcionalidad Completa para Configuración de Relay
Origen: Auditoría 11/01/2024
Prioridad: ALTA
Área: Frontend | `ui.js`
Descripción:
La sección de "Configuración de Relay" es solo texto estático. Debe ser un componente interactivo que muestre "Sin Relay" si no hay datos o un botón que abra un modal secundario con el diagrama.
Acciones:
1.  **Modificar `ui.js`:** Dentro de la función que renderiza el contenido de los cortes (actualmente `createAccordionSection`):
    *   Implementar una lógica condicional para el valor `configRelay`.
    *   Si el valor es nulo o "Sin Relay", mostrar el texto "Sin Relay".
    *   Si hay un valor, crear un elemento `<button>` con el nombre de la configuración como texto.
    *   Añadir un `addEventListener` a ese botón que, al ser presionado, busque los detalles del relay en `catalogData.relay` y llame a una función (ej. `mostrarDetalleRelayModal`) para mostrar la imagen y detalles en un segundo modal sobre el modal actual.

---

[TAREA] Investigar Comportamiento Anormal de Carga del Catálogo
Origen: Reporte de PM
Prioridad: ALTA
Área: Frontend | `index.html`
Descripción:
Tras el último despliegue, el catálogo de vehículos no se carga al refrescar la página. Los datos solo aparecen después de que el usuario interactúa con un botón de sección (ej. "Categorías"). Se debe investigar la causa raíz de este comportamiento de carga diferida no intencional.

---

[TAREA] Investigar Error "Failed to fetch" Intermitente en Módulo de Usuarios
Origen: Reporte de PM
Prioridad: MEDIA
Área: Frontend | `users.html`
Descripción:
Al cargar la página de gestión de usuarios, a veces aparece un error "Failed to fetch" de forma repentina, aunque el contenido de la página parece cargarse correctamente. Se debe investigar la causa de esta solicitud de red fallida para asegurar que no haya efectos secundarios ocultos.

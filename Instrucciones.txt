**Versión del Documento:** 1.1 (Post-Arquitectura)
**Fecha de Generación:** 2024-08-20
=================================================

NORMAS OBLIGATORIAS DE DESARROLLO
---------------------------------

**A. Control de Versiones y Documentación:**
1.  **Actualización de Versión:** Cualquier cambio debe reflejarse en el número de versión visible en `index.html` y en los servicios de Apps Script.
2.  **Consulta y Actualización de Documentación:** Antes y después de cualquier desarrollo, se deben consultar y actualizar `README.md`, `Instrucciones.txt` y `ChangesLogs.txt`.
3.  **Detalle en `ChangesLogs.txt`:** Cada entrada debe especificar el archivo y número de línea modificado.

**B. Calidad del Código:**
1.  **Comentarios:** Todo código nuevo o modificado debe tener un comentario explicando su propósito.

**C. Proceso de Aprobación:**
1.  **PROHIBIDO marcar tareas como “completadas” sin revisión del Project Manager.**
2.  **PROHIBIDO asumir que un cambio resolvió un problema.**
3.  **SOLO describir qué se cambió o qué se debe cambiar.**
4.  Si una tarea introduce nuevos errores: Marcar como **EN REVISIÓN**.
5.  Si la tarea no funciona o no cumple: Marcar como **REQUIERE NUEVA REVISIÓN**.
6.  **No inferir que un cambio fue exitoso.**
7.  **No usar términos como "se corrigió" antes de ser confirmado por el PM.**

 INSTRUCCIONES Y TAREAS PENDIENTES - GPSpedia
=================================================

Este documento convierte los hallazgos de `Auditoria.txt` en una lista de tareas accionables para estabilizar y mejorar el proyecto.

---------------------------------
MÓDULO: ARQUITECTURA GENERAL Y DOCUMENTACIÓN
---------------------------------

### Archivo: N/A (Proyecto General)

- **Tarea 1: Refactorizar Arquitectura Frontend**
  - **Urgencia:** Alta
  - **Tipo:** Deuda Técnica Crítica
  - **Descripción:** Rediseñar la arquitectura de `index.html`, `add_cortes.html` y `users.html` para separar HTML, CSS y JavaScript en archivos independientes. Implementar un framework ligero o un patrón modular para gestionar el estado de la aplicación de forma estructurada, eliminando la dependencia de variables globales y la manipulación directa del DOM.
  - **Impacto Potencial:** Reducción drástica de la complejidad, facilidad de mantenimiento, menor riesgo de regresiones y mejora del rendimiento.

- **Tarea 2: Unificar y Limpiar Documentación**
  - **Urgencia:** Media
  - **Tipo:** Inconsistencia
  - **Descripción:**
    1.  Eliminar el archivo obsoletos `ChangesLogstxt`.
    2.  Auditar y actualizar el `README.md` para que el estado de las tareas (`[X]`, `[ ]`) refleje la realidad del código.
    3.  Estandarizar el sistema de versionamiento y asegurar que se aplique consistentemente en todos los archivos y en `ChangesLogs.txt`.
  - **Impacto Potencial:** La documentación se vuelve una fuente fiable, facilitando el onboarding de nuevos desarrolladores y la planificación de futuras funcionalidades.

- **Tarea 3: Implementar Caché en Backend**
  - **Urgencia:** Alta
  - **Tipo:** Deuda Técnica (Rendimiento)
  - **Descripción:** Implementar un mecanismo de caché en el lado del servidor (Google Apps Script) para todas las operaciones de lectura (`getCatalogData`, `getUsers`, etc.). Utilizar `CacheService` de Apps Script para almacenar temporalmente los resultados de `getDataRange().getValues()` y evitar lecturas repetitivas e ineficientes de la hoja de cálculo.
  - **Impacto Potencial:** Mejora radical del rendimiento y la velocidad de respuesta de la aplicación, especialmente en la carga inicial.

---------------------------------
MÓDULO: FRONTEND
---------------------------------

### Archivo: `api-manager.js`

- **Tarea 4: Dinamizar Configuración de API**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica
  - **Descripción:** Modificar el `api-manager.js` para que cargue las URLs de los servicios y el mapa de acciones desde un objeto de configuración centralizado o un endpoint dedicado, en lugar de tenerlos codificados.
  - **Impacto Potencial:** Facilita la gestión de diferentes entornos (desarrollo, producción) y la adición de nuevos microservicios o acciones.

### Archivo: `index.html`

- **Tarea 5: Corregir Lógica de Sesión**
  - **Urgencia:** Alta
  - **Tipo:** Inconsistencia Funcional
  - **Descripción:** Refactorizar la lógica de `checkSession` para que, después de validar el token con el backend, se actualice el `localStorage` con la información más reciente del usuario. La aplicación debe confiar únicamente en el estado validado por el backend en cada carga.
  - **Impacto Potencial:** Elimina condiciones de carrera y asegura que el estado de la sesión en el frontend sea siempre consistente con el del backend.

- **Tarea 6: Eliminar Código Muerto (IndexedDB)**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica
  - **Descripción:** Eliminar por completo el código relacionado con la inicialización y uso de IndexedDB, ya que no se está utilizando y añade complejidad innecesaria.
  - **Impacto Potencial:** Código más limpio y ligero.

### Archivo: `users.html`

- **Tarea 7: Corregir Mapeo de Datos de Usuario**
  - **Urgencia:** Crítica
  - **Tipo:** Bug
  - **Descripción:** Modificar el JavaScript de `users.html` para que acceda a las propiedades del objeto de usuario utilizando los nombres correctos devueltos por el backend (`PascalCase_With_Underscores`, ej. `user.Nombre_Usuario`), en lugar de `camelCase`.
  - **Impacto Potencial:** Soluciona el bug crítico que impide mostrar los datos de los usuarios en la tabla de gestión y en los modales de edición.

---------------------------------
MÓDULO: BACKEND (MICROSERVICIOS)
---------------------------------

### Archivo: `services/auth/auth.js`

- **Tarea 8: Implementar Almacenamiento Seguro de Contraseñas**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:**
    1.  Eliminar la conversión a `.toLowerCase()` en la comparación de contraseñas.
    2.  Implementar un mecanismo de hashing para las contraseñas. Se debe añadir una utilidad de hashing (ej. SHA-256 con un salt) y migrar las contraseñas existentes a su formato hasheado. La comparación debe hacerse sobre los hashes, no sobre el texto plano.
  - **Impacto Potencial:** Mejora fundamental de la seguridad de las cuentas de usuario.

- **Tarea 9: Refactorizar Validación de Sesión**
  - **Urgencia:** Media
  - **Tipo:** Ineficiencia
  - **Descripción:** Modificar `handleValidateSession` para que consulte la hoja `ActiveSessions` en lugar de leer toda la hoja `Users`. Esto alinea la función con su propósito lógico.
  - **Impacto Potencial:** Validación de sesión mucho más rápida y eficiente.

### Archivo: `services/catalog/catalog.js`

- **Tarea 10: Separar Responsabilidades del Servicio**
  - **Urgencia:** Media
  - **Tipo:** Deuda Técnica
  - **Descripción:** Refactorizar `handleGetCatalogData`. Mover la lógica de negocio (ordenamiento de cortes, transformación de URLs) a funciones auxiliares o incluso a un servicio de "transformación" separado si la complejidad aumenta. El handler principal solo debe ser responsable de obtener y devolver los datos.
  - **Impacto Potencial:** Servicio más limpio, fácil de mantener y testear.

### Archivo: `services/feedback/feedback.js`

- **Tarea 11: Eliminar Código Duplicado**
  - **Urgencia:** Media
  - **Tipo:** Deuda Técnica
  - **Descripción:** Identificar y eliminar la función `handleRecordLike` duplicada, unificando la lógica en una sola implementación.
  - **Impacto Potencial:** Reduce la confusión y el riesgo de aplicar correcciones en un solo lugar.

- **Tarea 12: Corregir `MimeType` de Respuesta**
  - **Urgencia:** Crítica
  - **Tipo:** Bug
  - **Descripción:** Cambiar el `MimeType` de la respuesta del `doPost` de `ContentService.MimeType.JSON` a `ContentService.MimeType.TEXT`.
  - **Impacto Potencial:** Soluciona el error `Failed to fetch` que actualmente impide que toda la funcionalidad del "Inbox" (reportes, contacto) funcione.

- **Tarea 13: Refactorizar Búsquedas en Hoja de Cálculo**
  - **Urgencia:** Baja
  - **Tipo:** Ineficiencia
  - **Descripción:** Investigar métodos más eficientes para encontrar una fila por ID que no requieran leer toda la hoja de cálculo, como `TextFinder` o la creación de un índice en una propiedad del script, si es aplicable para lecturas menos frecuentes. Aplicar esta optimización a `handleRecordLike` y `handleAssignCollaborator`.
  - **Impacto Potencial:** Mejora del rendimiento en operaciones de escritura de feedback.

### Archivo: `services/users/users.js`

- **Tarea 14: Corregir Falla de Seguridad en Permisos**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:** Refactorizar TODAS las funciones de CRUD (`handleCreateUser`, `handleUpdateUser`, `handleDeleteUser`) para que la validación de permisos se base en una sesión verificada del *solicitante* en el backend, no en un parámetro (`creatorRole`, `updaterRole`) enviado desde el cliente. Se debe requerir un `sessionToken` en el payload y validarlo antes de proceder.
  - **Impacto Potencial:** Cierra una vulnerabilidad crítica que permite la escalada de privilegios.

- **Tarea 15: Corregir Inconsistencia en Cambio de Contraseña**
  - **Urgencia:** Media
  - **Tipo:** Bug
  - **Descripción:** Modificar la comparación de la `currentPassword` en `handleChangePassword` para que sea `case-insensitive` (`.toLowerCase()`), haciéndola consistente con la lógica de `login`.
  - **Dependencias:** Depende de la Tarea 8. La comparación debe hacerse sobre el hash, no sobre el texto plano. Una vez implementado el hashing, esta tarea debe asegurar que el proceso de verificación sea consistente.
  - **Impacto Potencial:** Soluciona el bug que impide a los usuarios cambiar su contraseña si la escriben con una capitalización diferente.

### Archivo: `services/write/write.js`

- **Tarea 16: Simular Transacciones y Mejorar Manejo de Errores**
  - **Urgencia:** Alta
  - **Tipo:** Riesgo de Datos
  - **Descripción:** Refactorizar `handleAddOrUpdateCut` para simular una transacción. Primero, intentar todas las operaciones propensas a fallos (creación de carpetas, subida de archivos) y solo si TODAS tienen éxito, proceder con la escritura en la hoja de cálculo. Implementar `try...catch` robustos en cada paso y una lógica de `rollback` manual (ej. eliminar el archivo subido si la escritura en la hoja falla).
  - **Impacto Potencial:** Reduce drásticamente el riesgo de corrupción y datos inconsistentes.

- **Tarea 17: Unificar Lógica de `handleCheckVehicle`**
  - **Urgencia:** Media
  - **Tipo:** Inconsistencia
  - **Descripción:** Eliminar la implementación de `handleCheckVehicle` de uno de los servicios (`catalog.js` o `write.js`) y asegurar que el `api-manager.js` siempre enrute esta acción al servicio correcto que la contiene.
  - **Impacto Potencial:** Asegura un comportamiento consistente de la funcionalidad anti-duplicados.

### Archivo: `services/utilities/utilities.js`

- **Tarea 18: Hacer Scripts de Migración Idempotentes**
  - **Urgencia:** Alta
  - **Tipo:** Riesgo de Datos
  - **Descripción:** Modificar `handleMigrateYearRanges` y `handleMigrateTimestamps` para que verifiquen el estado de una fila antes de intentar modificarla. Por ejemplo, `handleMigrateYearRanges` no debería procesar una fila si `anoHasta` ya tiene un valor, y `handleMigrateTimestamps` no debería ejecutarse si `timestamp` ya está poblado.
  - **Impacto Potencial:** Previene la corrupción de datos si los scripts se ejecutan accidentalmente más de una vez.

- **Tarea 19: Corregir Falla de Seguridad en Autorización**
  - **Urgencia:** Crítica
  - **Tipo:** Riesgo de Seguridad
  - **Descripción:** Reemplazar la función `authorize` actual. La nueva implementación debe recibir un `sessionToken` (no todo el objeto `session`), buscar ese token en la hoja `ActiveSessions` para encontrar el `userId`, y luego buscar el rol de ese `userId` en la hoja `Users`. La autorización debe basarse en este rol verificado en el backend.
  - **Impacto Potencial:** Cierra la vulnerabilidad que permite la ejecución no autorizada de acciones de migración destructivas.

### Archivo: `Code.gs` (Legacy)

- **Tarea 20: Corregir Configuración de Fallback**
  - **Urgencia:** Baja
  - **Tipo:** Deuda Técnica / Bug
  - **Descripción:**
    1.  Actualizar el `SPREADSHEET_ID` para que apunte a la DB v2.0, o eliminarlo si ya no es necesario para el logging.
    2.  Modificar el `switch` en el `doPost` para que, en el `default` case, devuelva un error claro que indique que la acción debe ser manejada por un microservicio, en lugar de un "Acción desconocida" genérico. Esto mejorará la depuración del `api-manager.js`.
  - **Impacto Potencial:** Mejora la claridad en la depuración y elimina configuraciones obsoletas.

---------------------------------
NUEVAS TAREAS CRÍTICAS (AÑADIDO 2026-01-04)
---------------------------------

### MÓDULO: FEEDBACK Y MANEJO DE DATOS

- **Tarea 21: Corregir Bugs Críticos en Servicio de Feedback**
  - **Urgencia:** Prioridad Alta
  - **Tipo:** Bug Crítico (Corrupción de Datos)
  - **Descripción:** Se han detectado múltiples fallos en la forma en que el servicio de feedback guarda los datos:
    1.  **ID de Usuario Faltante:** El ID del usuario no se está guardando en la hoja de cálculo de `Feedbacks` o `Contactenos`.
    2.  **Fórmula de ID Rota:** La fórmula oficial para generar IDs (`C-` para Contacto, `F-` para Feedback, `L-` para Logs) no se está heredando al crear nuevas filas.
    3.  **Correo Electrónico Faltante:** En el formulario de "Contáctanos", el correo del usuario no se guarda.
  - **Requerimiento Técnico:** Asegurar que la herencia de fórmulas funcione. Si `copyTo()` no es suficiente, la fórmula debe ser replicada explícitamente desde el backend.
  - **Impacto Potencial:** Restaura la integridad de los datos, permitiendo trazar quién reporta un problema o envía un mensaje.

- **Tarea 22: Corregir Herencia de ID en Servicio de Escritura (Cortes)**
  - **Urgencia:** Crítica
  - **Tipo:** Bug Crítico (Corrupción de Datos)
  - **Descripción:** Similar a la Tarea 21, el servicio `write` no hereda la fórmula del ID (`="V-"&TEXTO(FILA()-1,"000")`) al crear una nueva fila de corte.
  - **Impacto Potencial:** Restaura la capacidad de generar IDs únicos y correctos para nuevos cortes de vehículos.

- **Tarea 23: Corregir Bugs Críticos en Servicio de Usuarios**
  - **Urgencia:** Crítica
  - **Tipo:** Bug
  - **Descripción:**
    1.  **Cambio de Contraseña Inoperante:** El botón "Cambiar Contraseña" en la UI no ejecuta ninguna acción.
    2.  **Creación de Usuario Rota:** La creación de nuevos usuarios sigue fallando.
    3.  **Fórmula de ID Rota:** La fórmula para los IDs de usuario (`="U-"&TEXTO(FILA()-1,"000")`) no se está heredando correctamente.
  - **Impacto Potencial:** Restaura funcionalidades básicas y críticas de la gestión de usuarios.

### MÓDULO: ARQUITECTURA FRONTEND Y GESTIÓN DE IMÁGENES

- **Tarea 24: Reestructuración Urgente del Frontend**
  - **Urgencia:** Crítica
  - **Tipo:** Deuda Técnica Crítica
  - **Descripción:** El frontend debe ser separado inmediatamente en archivos HTML, CSS y JavaScript por funcionalidad o componente. Esto es un requisito no negociable para la mantenibilidad y aplica a todas las páginas, incluyendo `add_cortes.html`.
  - **Impacto Potencial:** Reduce drásticamente la complejidad del código, facilita futuras modificaciones y disminuye el riesgo de regresiones.

- **Tarea 25: Implementar Proxy de Imágenes en Backend**
  - **Urgencia:** No Negociable
  - **Tipo:** Requerimiento de Arquitectura
  - **Descripción:** Diseñar e implementar una solución para manejar las imágenes de Google Drive a través de un proxy en el backend.
    1.  **Backend:** Crear una ruta que reciba un `fileId`, obtenga el archivo de Drive y devuelva el `blob` con su `Content-Type` correcto.
    2.  **Normalización de Datos:** El backend solo debe enviar el `fileId` al frontend. Si existen URLs completas en la base de datos, deben ser normalizadas para extraer y guardar únicamente el ID.
    3.  **Frontend:** Todas las etiquetas `<img>` deben apuntar al endpoint del backend (ej. `/image?img=<fileId>`). Toda la lógica de conversión de URLs de Drive debe ser eliminada del frontend.
  - **Restricción:** El frontend NO debe recibir URLs directas de Google Drive. El tamaño de las imágenes debe ser controlado exclusivamente por CSS, sin usar parámetros de URL (`=w...`, `sz`, etc.).
  - **Impacto Potencial:** Centraliza la lógica de imágenes, mejora la seguridad al no exponer URLs directas y permite un control de renderizado más robusto.

- **Tarea 26: Corregir y Rediseñar Estilos de Imágenes**
  - **Urgencia:** Alta
  - **Tipo:** Bug Visual / UX
  - **Descripción:** Aplicar correcciones de estilo específicas al modal de detalles del vehículo:
    1.  **Logo de Marca:** Debe estar a la izquierda del nombre del modelo, sin contenedor, fondo o borde, y con un efecto `drop-shadow`.
    2.  **Imagen del Vehículo:** Sin contenedor, tamaño reducido en un 10% y centrado.
    3.  **Layout de Escritorio (Modal):**
        *   Imagen del vehículo a la izquierda (máx. 200px de ancho).
        *   Imagen del corte recomendado a la derecha de la información del vehículo.
        *   Imágenes de cortes, apertura y alimentación deben tener el mismo ancho (`width: 100%`) y altura automática para ocupar todo el espacio horizontal disponible en su contenedor.
        *   En un contenedor separado a la derecha, mostrar las imágenes de los cortes verticalmente, sin exceder los 300px de ancho total, mientras la información del modal permanece a la izquierda.
  - **Impacto Potencial:** Mejora significativamente la presentación visual y la experiencia de usuario en una de las vistas más importantes de la aplicación.

### MÓDULO: FLUJO DE USUARIO

- **Tarea 27: Implementación de Fase 3 en `add_cortes.html`**
  - **Urgencia:** Alta
  - **Tipo:** Funcionalidad Inconclusa
  - **Descripción:** La Fase 3 del formulario de añadir cortes está mal implementada y debe ser reconstruida según las especificaciones del `README.md`.
    1.  **Flujo Opcional:** El usuario debe poder presionar "Terminar" para cerrar el formulario si no desea añadir información suplementaria.
    2.  **Componentes:** La UI debe incluir secciones para "Apertura" y "Alimentación", cada una con campos para color de cable, ubicación, un botón para subir imagen (no URL) y una vista previa de la imagen.
    3.  **Backend:** El backend debe manejar la subida de estas imágenes a Drive, renombrarlas y guardar la información en la fila correcta del vehículo (heredado de la Fase 1).
  - **Impacto Potencial:** Completa un flujo de usuario crítico que actualmente está roto.

---------------------------------
SEGUIMIENTO DE REVISIONES DE CÓDIGO
---------------------------------

### Revisión v4.7.2 (2026-01-04)

- **Tarea 28: Corregir Renderizado y Estilo del Catálogo Principal**
  - **Estado:** [PENDIENTE]
  - **Nota del PM:** [FRACASO] Ningun cambio percibido en el aspecto del catalogo, se recomienda realizar de nuevo esta tarea para rectificar y corregir según la necesidad y directriz de la tarea. Carrusel aun no se renderiza, el logo de marca aun se presenta a la izquieda y aun esta en un contenedor circular con fondo y bordes contradiciendo los requerimientos de la tarea. La imagenes de los cortes y la demas información (apertura y cable de alimentación) deben de tener el mismo ancho y cin altura automática, en dispositivos moviles debe de cubrir todo el ancho del modal mientras que en escritorio debe de mantenerse en una presentacion lateral. a la izquierda la imagen del vehiculo con la demas informacion abajo, mientras que las imágenes a la derecha desplazables verticalmente.

- **Tarea 29: Corregir Visualización de Videos en Modal de Tutoriales**
  - **Estado:** [COMPLETADO]
  - **Nota del PM:** [RESUELTO] La lógica de fallback (`item.Video` -> `item.videoGuia`) ha solucionado la regresión.

- **Tarea 30: Corregir Visualización de Diagrama en Modal de Relay**
  - **Estado:** [COMPLETADO]
  - **Nota del PM:** [RESUELTO] La corrección del selector de imágenes ha restaurado la funcionalidad.

- **Tarea 31: Ajustar Layout de Logo en Modal de Vehículo**
  - **Estado:** [NECESITA NUEVA REVISION]
  - **Nota del PM:** EL LOGO NO DEBE DE TENER CONTENEDOR, FONDO, MARCO O BORDE, AL LADO IZQUIEDO DEL NOMBRE DEL MODELO. El logo de marca seguido de el nombre del vehículo debe estar en el extreno izquierdo del encabezado, actualmente están separados, corregir cualquier registro que contradiga está característica instrucciones.txt o README.md.

- **Tarea 32: Corregir Posicionamiento de Botones de Feedback**
  - **Estado:** [COMPLETADO]
  - **Nota del PM:** [RESUELTO] Los botones "Útil" y "Reportar" ahora se posicionan correctamente.

### Revisión v4.7.3 (2026-01-04)

- **Tarea 33: Corregir Mapeo de Datos de Usuario (Regresión)**
  - **Estado:** [PENDIENTE]
  - **Nota del PM:** [FRACASO] Ocurre el error de 'Failed to fetch' que imposibilita el uso y la gestión de usuarios.
  - **Observaciones de Auditoría (2026-01-04):** El archivo `services/users/users.js` carece de la función `doPost`, que es el punto de entrada para todas las solicitudes. Esta ausencia es la causa directa del error 'Failed to fetch', ya que el servicio no puede procesar ni responder a ninguna solicitud.

### Revisión v4.7.1 (2026-01-04)

- **Tarea 34: Corregir Funcionalidad de Sugerencia de Año e Inbox**
  - **Estado:** [NECESITA REVISION]
  - **Nota del PM:** Ocurre el error de "Error inesperado: update Is not defined".

### Revisión v4.6.9 (2026-01-04)

- **Tarea 35: Corregir Herencia de Fórmula de ID en Creación de Vehículos**
  - **Estado:** [PENDIENTE]
  - **Nota del PM:** [FRACASO] La nueva fila insertada es incapaz de captar la fórmula del ID de la fila anterior. Quizás sea necesario inyectar la fórmula directamente desde el backend.

### Feedback Adicional

- **Tarea 36: Corregir Botones de Respuesta en Inbox**
  - **Estado:** [PENDIENTE]
  - **Nota del PM:** Los botones de responder en inbox no funcionan. No tienen ninguna acción.

---------------------------------
TAREAS DE ARQUITECTURA FINAL
---------------------------------

### MÓDULO: Backend Refactor

- **Tarea 37: Expandir `catalog-service`**
  - **Urgencia:** Alta
  - **Tipo:** Arquitectura
  - **Descripción:** Centralizar toda la lógica de preparación de datos del catálogo. Añadir funciones para normalizar, ordenar y preparar datos para modales y carruseles. El servicio solo debe devolver `imageId`, nunca URLs de Drive.

- **Tarea 38: Crear `image-service` (Proxy)**
  - **Urgencia:** Crítica
  - **Tipo:** Arquitectura / Seguridad
  - **Descripción:** Implementar un nuevo microservicio que actúe como un proxy seguro para las imágenes de Google Drive. Debe exponer un único endpoint `GET /image?fileId=XXXX` que devuelva el blob de la imagen, ocultando las URLs de Drive al frontend.

- **Tarea 39: Refactorizar `write-service`**
  - **Urgencia:** Alta
  - **Tipo:** Arquitectura / Integridad de Datos
  - **Descripción:** Reforzar el servicio para que sea el único responsable de generar y controlar los IDs de todos los nuevos registros (Cortes, Feedback, Contacto, Logs, Usuarios) mediante la inyección de fórmulas en la hoja de cálculo.

- **Tarea 40: Refactorizar `feedback-service`**
  - **Urgencia:** Media
  - **Tipo:** Arquitectura
  - **Descripción:** Asegurar que el servicio guarde correctamente el `userId` y el `timestamp` en todos los envíos de feedback y contacto.

### MÓDULO: Frontend Refactor

- **Tarea 41: Modularizar Estructura de Archivos Frontend**
  - **Urgencia:** Crítica
  - **Tipo:** Arquitectura
  - **Descripción:** Reestructurar el frontend en la nueva arquitectura de carpetas: `/js/api`, `/js/state`, `/js/ui`, `/js/utils`, y `/css`. Separar toda la lógica en los archivos correspondientes (`catalogApi.js`, `appState.js`, `catalogRender.js`, etc.).

- **Tarea 42: Centralizar Estado en `appState.js`**
  - **Urgencia:** Alta
  - **Tipo:** Arquitectura
  - **Descripción:** Eliminar variables globales y gestionar todo el estado de la aplicación (vehículo actual, marca seleccionada, estado del modal) a través del módulo `appState.js`.

- **Tarea 43: Aislar Lógica de API**
  - **Urgencia:** Alta
  - **Tipo:** Arquitectura
  - **Descripción:** Mover todas las llamadas `fetch` y la lógica de comunicación con el backend a los módulos dedicados en `/js/api/`. El resto de la aplicación interactuará con estos módulos, no directamente con `fetch`.

- **Tarea 44: Aislar Manipulación del DOM**
  - **Urgencia:** Alta
  - **Tipo:** Arquitectura
  - **Descripción:** Crear un módulo `/js/utils/dom.js` con helpers para la manipulación del DOM. El resto de los módulos de UI (`catalogRender.js`, `modal.js`) usarán estos helpers en lugar de manipular el DOM directamente.

- **Tarea 45: Implementar `imageApi.js`**
  - **Urgencia:** Crítica
  - **Tipo:** Arquitectura
  - **Descripción:** Crear el módulo `imageApi.js` cuya única función, `getImageUrl(fileId)`, construirá la URL que apunta al nuevo `image-service` en el backend (ej. `/image?fileId=xxx`), eliminando toda la lógica de URLs de Google Drive del frontend.

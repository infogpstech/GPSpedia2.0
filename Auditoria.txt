# Auditor√≠a de Salud de Servicios Backend - GPSpedia

**Fecha de Auditor√≠a:** 2026-01-08
**Auditor:** Jules
**Versi√≥n Global del Proyecto Analizada:** 7.3.0

## 1. Resumen Ejecutivo

Esta auditor√≠a presenta un an√°lisis funcional de cada microservicio del backend de GPSpedia. El objetivo es verificar la salud de cada servicio, identificar errores funcionales, y detectar violaciones de las reglas arquitect√≥nicas definidas en la documentaci√≥n del proyecto (`README.md`).

**Hallazgos Clave:**

1.  **Violaci√≥n Cr√≠tica de `Content-Type`:** M√∫ltiples servicios (`auth`, `feedback`) devuelven respuestas de error con `Content-Type: application/json` en lugar del `text/plain` requerido. Esto es una violaci√≥n arquitect√≥nica cr√≠tica que puede causar que el frontend falle silenciosamente debido a errores de CORS, haciendo que la depuraci√≥n sea extremadamente dif√≠cil.
2.  **Vulnerabilidad de Sesi√≥n en `auth` Service:** El servicio de autenticaci√≥n (`auth`) valida las sesiones de usuario contra la hoja `Users` en lugar de la hoja `ActiveSessions`. Esto crea una grave vulnerabilidad de seguridad donde un token de sesi√≥n, aunque ya no est√© activo, podr√≠a ser considerado v√°lido.
3.  **Condici√≥n de Carrera en `feedback` Service:** La funci√≥n `handleRecordLike` en el servicio `feedback` no es at√≥mica. Es susceptible a una condici√≥n de carrera que puede llevar a la p√©rdida de datos (likes) si dos usuarios realizan la acci√≥n simult√°neamente.
4.  **L√≥gica de Autorizaci√≥n Duplicada y Deficiente:** La l√≥gica para verificar los permisos de un usuario est√° duplicada en m√∫ltiples servicios (`users`, `utilities`). La implementaci√≥n en `utilities` es particularmente deficiente, ya que no valida la sesi√≥n contra la hoja `ActiveSessions`, creando otra posible vulnerabilidad.
5.  **C√≥digo Muerto en `utilities` Service:** El servicio de utilidades contiene funciones de migraci√≥n de datos (`handleMigrateYearRanges`, `handleMigrateTimestamps`) que ya han sido ejecutadas y ahora representan c√≥digo muerto, aumentando la complejidad innecesaria del codebase.

A continuaci√≥n se detalla el an√°lisis de cada servicio.

---

## 2. Auditor√≠a por Servicio

### üîπ `auth` (`services/auth/auth.js`) - üî¥ **CR√çTICO**

-   **`doGet` (Debug Endpoint):** **FALLA.** Devuelve `Content-Type: application/json`, violando la regla arquitect√≥nica de `text/plain`.
-   **`doPost` (Router Principal):** **FALLA.** En caso de error, devuelve `Content-Type: application/json`.
-   **`handleLogin`:** **PASA.** La l√≥gica es robusta y maneja correctamente la creaci√≥n de sesiones y los l√≠mites por rol.
-   **`handleValidateSession`:** üî¥ **FALLA CR√çTICA.** La funci√≥n valida el token de sesi√≥n contra la hoja `Users`, pero la l√≥gica de gesti√≥n de sesiones (incluyendo la eliminaci√≥n de sesiones antiguas) opera sobre la hoja `ActiveSessions`. Esto crea una desincronizaci√≥n peligrosa: un usuario podr√≠a haber sido desconectado por el gestor de sesiones, pero `handleValidateSession` seguir√≠a reportando la sesi√≥n como v√°lida. **Esto es una vulnerabilidad de seguridad.**

### üîπ `catalog` (`services/catalog/catalog.js`) - ‚úÖ **SALUDABLE**

-   **`doGet` (Debug Endpoint):** **FALLA.** Devuelve `Content-Type: application/json`, una inconsistencia menor.
-   **`doPost` (Router Principal):** **PASA.** Devuelve `Content-Type: text/plain` y maneja errores correctamente.
-   **`handleGetCatalogData`:** **PASA.** La l√≥gica para buscar, procesar, y dar forma a los datos de m√∫ltiples hojas es compleja pero funciona correctamente. El ordenamiento de cortes por "likes" y de categor√≠as por popularidad est√° bien implementado.
-   **Performance:** **PASA.** El servicio deshabilita intencionadamente el cacheo con una explicaci√≥n clara, lo cual es un trade-off aceptado.
-   **Otras Acciones:** **PASA.** `handleGetDropdownData`, `handleGetSuggestion`, y `handleGetNavigationData` est√°n bien implementadas.

### üîπ `feedback` (`services/feedback/feedback.js`) - ‚ö†Ô∏è **REQUIERE ATENCI√ìN**

-   **`doGet` (Debug Endpoint):** **PASA.** Funciona correctamente y devuelve `Content-Type: text/plain`.
-   **`doPost` (Router Principal):** **FALLA.** Al recibir una acci√≥n desconocida, devuelve un error con `Content-Type: application/json`.
-   **`handleRecordLike`:** ‚ö†Ô∏è **FALLA (Condici√≥n de Carrera).** La operaci√≥n de leer, incrementar y escribir el contador de "likes" no es at√≥mica. Se debe usar `LockService` de Google Apps Script para prevenir la p√©rdida de datos bajo carga concurrente.
-   **Otras Acciones:** **PASA.** `handleReportProblem`, `handleSendContactForm`, y `handleSuggestYear` (incluida su compleja l√≥gica anti-colisi√≥n) est√°n bien implementadas. Las funciones del sistema de "Inbox" tambi√©n son correctas.

### üîπ `imagen` (`services/imagen/image.js`) - ‚úÖ **SALUDABLE**

-   **`doGet`:** **PASA.** El servicio funciona como un proxy seguro y eficiente. La estrategia de cacheo es robusta, con un manejo de errores excelente que no interrumpe la funcionalidad principal si la cach√© falla.
-   **Manejo de Errores:** **FALLA (Menor).** La funci√≥n `createErrorResponse` devuelve errores con `Content-Type: application/json`, una violaci√≥n menor de la arquitectura.

### üîπ `users` (`services/users/users.js`) - ‚úÖ **SALUDABLE**

-   **`doGet` y `doPost`:** **PASA.** Ambos endpoints est√°n bien estructurados y devuelven `Content-Type: text/plain`.
-   **L√≥gica de Autorizaci√≥n (`getVerifiedRole`):** **PASA.** Esta funci√≥n es un ejemplo de buena implementaci√≥n. Valida correctamente el token de sesi√≥n contra la hoja `ActiveSessions`, previniendo la vulnerabilidad presente en el servicio `auth`.
-   **Acciones CRUD:** **PASA.** Todas las acciones (`handleCreateUser`, `handleUpdateUser`, `handleDeleteUser`) implementan de forma segura una jerarqu√≠a de roles estricta, previniendo la escalada de privilegios.
-   **Observaci√≥n:** La l√≥gica de `getVerifiedRole` es excelente, pero est√° duplicada. Deber√≠a ser centralizada.

### üîπ `utilities` (`services/utilities/utilities.js`) - ‚ö†Ô∏è **REQUIERE ATENCI√ìN**

-   **`doGet` y `doPost`:** **PASA.** Ambos endpoints est√°n correctamente implementados.
-   **L√≥gica de Autorizaci√≥n (`authorize`):** ‚ö†Ô∏è **FALLA (Vulnerabilidad).** Al igual que el servicio `auth`, esta funci√≥n valida al usuario bas√°ndose √∫nicamente en su rol en la hoja `Users`, sin verificar el token de sesi√≥n contra `ActiveSessions`. Esto significa que un usuario con un token de sesi√≥n expirado podr√≠a ejecutar estas funciones de utilidad si su rol no ha sido revocado.
-   **C√≥digo Muerto:** **FALLA.** Las funciones `handleMigrateYearRanges` y `handleMigrateTimestamps` son scripts de migraci√≥n que ya no se necesitan. Deben ser eliminadas para reducir la complejidad del c√≥digo.

### üîπ `write` (`services/write/write.js`) - ‚úÖ **SALUDABLE**

-   **`doGet` y `doPost`:** **PASA.** Todos los endpoints est√°n bien implementados y siguen los est√°ndares arquitect√≥nicos.
-   **L√≥gica de Escritura (`handleAddOrUpdateCut`):** **PASA.** La l√≥gica para manejar veh√≠culos nuevos y existentes es robusta. Usa `copyTo` para heredar f√≥rmulas y `setValues` para escrituras eficientes, lo cual es una best practice. El uso de `Utilities.sleep()` es un workaround necesario y aceptado.
-   **Manejo de Archivos:** **PASA.** La creaci√≥n de carpetas jer√°rquicas en Google Drive y el manejo de subidas de im√°genes (tanto base64 como URL) son robustos.
-   **Otras Acciones:** **PASA.** `handleCheckVehicle` (anti-duplicaci√≥n) y `handleAddSupplementaryInfo` est√°n bien implementadas.

---

## 3. Conclusiones y Plan de Acci√≥n Recomendado

La auditor√≠a revela que, si bien la mayor√≠a de los servicios son funcionalmente robustos, existen serias inconsistencias arquitect√≥nicas y vulnerabilidades de seguridad que deben ser abordadas con alta prioridad.

**Plan de Acci√≥n Sugerido:**

1.  **Hotfix Inmediato (Prioridad CR√çTICA):**
    *   **Corregir `Content-Type`:** Modificar todos los servicios (`auth`, `feedback`, `imagen`) para que devuelvan `Content-Type: text/plain` en TODAS sus respuestas, especialmente en los casos de error.
    *   **Corregir `handleValidateSession`:** Refactorizar la funci√≥n en `services/auth/auth.js` para que valide los tokens de sesi√≥n exclusivamente contra la hoja `ActiveSessions`.

2.  **Mejoras de Estabilidad (Prioridad ALTA):**
    *   **Implementar `LockService`:** Envolver la l√≥gica de `handleRecordLike` en `services/feedback/feedback.js` con un `LockService` para prevenir condiciones de carrera.
    *   **Centralizar Autorizaci√≥n:** Crear una librer√≠a de Google Apps Script compartida que contenga una √∫nica y robusta funci√≥n de `getVerifiedRole`. Refactorizar los servicios `users` y `utilities` para que usen esta librer√≠a, y eliminar sus implementaciones duplicadas.

3.  **Limpieza de C√≥digo (Prioridad MEDIA):**
    *   **Eliminar C√≥digo Muerto:** Remover las funciones de migraci√≥n (`handleMigrateYearRanges`, `handleMigrateTimestamps`) del servicio `utilities`.

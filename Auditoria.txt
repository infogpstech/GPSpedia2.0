**AUDITORÍA DEL SISTEMA GPSpedia v2.0**

**FECHA DE AUDITORÍA:** 2024-07-30

**AUDITOR:** Jules

---

### **INCIDENTE: Corrección Definitiva de Regresión en Generación de IDs Basada en Fórmulas**

**1. RESUMEN DEL INCIDENTE:**
   - Una implementación previa destinada a refactorizar la generación de IDs para que utilizara fórmulas de la hoja de cálculo (`=ROW()-1`) falló, causando una regresión crítica.
   - Los servicios afectados fueron `GPSpedia-Users` (`handleCreateUser`) y `GPSpedia-Feedback` (`logUserActivity`).
   - El servicio `GPSpedia-Write` no estaba afectado, ya que su implementación era diferente y correcta.

**2. ANÁLISIS DE LA CAUSA RAÍZ:**
   - La implementación fallida seguía la secuencia:
     1. `previousRow.copyTo(newRow)`: Esto heredaba correctamente la fórmula del ID.
     2. `newRow.clearContent()`: Esto limpiaba el contenido, pero preservaba la fórmula.
     3. `newRow.setValues([...])`: **Este fue el paso erróneo.** Al aplicar `setValues` a la fila completa, se sobrescribía la fórmula en la primera celda (la del ID) con un valor vacío (`''`), impidiendo que el ID se generara.

**3. ACCIONES CORRECTIVAS REALIZADAS:**
   - Se realizó una refactorización definitiva en las funciones afectadas para asegurar la preservación de la fórmula del ID.
   - **Lógica Implementada:**
     1.  Se mantiene el `previousRow.copyTo(newRow)` para heredar todas las propiedades, incluyendo la fórmula del ID en la columna 1.
     2.  Se eliminaron los pasos `clearContent()` y `setValues()` aplicados a la fila completa.
     3.  En su lugar, se obtiene un `range` específico que abarca **únicamente las columnas de datos** (desde la columna 2 hasta el final).
     4.  Se utiliza `setValues()` **solo sobre este rango de datos**, escribiendo la información del nuevo registro sin tocar ni sobrescribir la columna 1.

**4. SERVICIOS AFECTADOS Y CORREGIDOS:**
   - `services/users/users.js`: La función `handleCreateUser` fue refactorizada con la nueva lógica.
   - `services/feedback/feedback.js`: La función `logUserActivity` fue refactorizada con la nueva lógica.

**5. ESTADO:**
   - **COMPLETADO:** La regresión ha sido solucionada de manera definitiva. La nueva lógica garantiza que la creación de registros en todas las tablas relevantes herede y conserve la fórmula de generación de ID, asegurando la integridad de los datos.

---

**AUDITORÍA DEL SISTEMA GPSpedia v2.0**

**FECHA DE AUDITORÍA:** 2024-07-29

**AUDITOR:** Jules

---

### **INCIDENTE: Regresión Crítica - Servicio `USERS` Inutilizable ("Failed to fetch")**

**1. RESUMEN DEL PROBLEMA:**
   - Tras una corrección anterior (V8.4.7) destinada a solucionar un problema con el guardado del campo "Nombre Completo", el microservicio `USERS` ha dejado de funcionar por completo, devolviendo un error genérico "Failed to fetch" en el frontend.
   - Este error indica que el backend está sufriendo un crash fatal que le impide devolver cualquier tipo de respuesta, sea de éxito o de error.

**2. ANÁLISIS DE CAUSA RAÍZ (RCA):**
   - **Auditoría de `ChangesLogs.txt`:** Se confirmó que las versiones V8.4.5 y V8.4.7 se enfocaron en refactorizar la función `handleUpdateUser` para solucionar un problema de `case-sensitivity`.
   - **Auditoría de `services/users/users.js`:** Un análisis línea por línea del código reveló que la causa de la regresión no estaba en `handleUpdateUser`, sino en una función auxiliar introducida en el mismo período: `getNewUserId`.
   - **El Bug Crítico:** La implementación de `getNewUserId` era la siguiente:
     ```javascript
     function getNewUserId(sheet) {
         const ids = sheet.getRange(2, COLS_USERS.ID, sheet.getLastRow() - 1, 1).getValues().flat();
         const maxId = ids.reduce((max, id) => Math.max(max, parseInt(id) || 0), 0);
         return maxId + 1;
     }
     ```
     El problema reside en `sheet.getLastRow() - 1`. Si la hoja de cálculo "Users" solo contiene la fila de encabezado (o está vacía), `getLastRow()` devuelve `1`. La expresión se evalúa a `1 - 1 = 0`. El método `sheet.getRange()` de Google Apps Script **no acepta `0` como un número de filas válido**; requiere un entero mayor o igual a 1.
   - **Conclusión:** Esta llamada a `getRange` con un argumento inválido provoca un **error fatal no capturado** que detiene la ejecución de todo el script del servicio, resultando en la ausencia de respuesta al frontend ("Failed to fetch").

**3. SOLUCIÓN PROPUESTA:**
   - Se debe añadir una **cláusula de guarda (guard clause)** al inicio de la función `getNewUserId`.
   - La nueva lógica comprobará si la hoja de cálculo tiene menos de 2 filas (es decir, está vacía o solo tiene encabezado). Si es así, devolverá `1` como el primer ID de usuario, evitando por completo la llamada problemática a `getRange`.
   - Este cambio hace que la función sea robusta y resiliente a hojas de cálculo vacías, eliminando la causa del crash del servicio.

**4. ESTADO:**
   - **PENDIENTE DE CORRECCIÓN:** La causa raíz ha sido identificada y la solución está definida.

---

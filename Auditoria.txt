**AUDITORÍA TÉCNICA - GESTIÓN DE USUARIOS (PHASE 5)**

**Archivo: users.html**
- **Estado de Listeners:** El listener del botón `change-password-btn` está correctamente definido dentro de `setupEventListeners`. Sin embargo, si `displayProfile()` falla o hay un error de sintaxis previo, los listeners no se adjuntan.
- **Acceso a Variables:** `currentUser` es una variable global. Se inicializa en `DOMContentLoaded`.
- **Posible Falla de Modal:** El uso de `passwordModal.style.display = 'block'` depende de que la variable `passwordModal` (capturada en el scope de `setupEventListeners`) sea válida.
- **Validación de ID:** Se utiliza `const userId = currentUser.ID || currentUser.id;`.

**Archivo: services/users/users.js (Backend)**
- **Lógica de Comparación:** Se utiliza `String(data[i][COLS_USERS.ID - 1]) === String(userId)`. Esto es correcto para evitar problemas de tipos.
- **Seguridad:** La comparación de contraseñas es ahora case-sensitive: `storedPassword !== currentPassword`.

**Hallazgos Pendientes de Verificar:**
1. ¿Se abre realmente el modal al hacer clic? Si no, hay un error de JS silencioso.
2. ¿La petición llega al backend? Si llega y falla, el error debe estar en la lógica de búsqueda de fila o en los permisos.
3. El usuario reporta que "aún no funciona". Esto sugiere que la acción de clic no produce el resultado esperado (abrir modal o procesar cambio).

**Conclusión:**
La auditoría no revela errores lógicos evidentes en el código actual, lo que sugiere una falla de entorno o un error de ejecución no capturado. Se requiere depuración dinámica.

**AUDITORÍA LÍNEA POR LÍNEA - TAREA RBAC (04/02/2026)**

**Archivo: users.html**
- L125-129: `displayProfile()` solo visualiza datos. Falta botón/lógica para "Cambiar Nombre" en perfil propio.
- L249: `openUserModal()` no deshabilita el campo `username-modal` al editar. Incumple "Ningún usuario puede cambiar su nombre de usuario".
- L268-270: `availableRoles` para 'Gefe' incluye 'Gefe'. Debe ser solo 'Supervisor' y 'Tecnico'.
- L271: `availableRoles` para 'Supervisor' es 'Tecnico'. Correcto.
- L290: `handleUserFormSubmit` permite enviar un nuevo `Nombre_Usuario` en actualizaciones.

**Archivo: services/users/users.js**
- L144: `handleGetUsers` no filtra por rol. Retorna todos los usuarios. Incumple visibilidad restringida por rol.
- L173: `allowedRoles` para 'Gefe' permite crear 'Gefe'. Debe ser solo 'Supervisor' y 'Tecnico'.
- L209: `canUpdate` para 'Gefe' permite editar casi todo. Debe ser solo 'Supervisor' y 'Tecnico'.
- L218: `handleUpdateUser` permite cambiar `Nombre_Usuario`. Incumple restricción global.
- L245: `canDelete` para 'Gefe' permite eliminar casi todo. Debe ser solo 'Supervisor' y 'Tecnico'.
- L274: `handleChangePassword` no valida que el usuario que cambia la contraseña sea el mismo que el del `userId` o un admin con permisos. (Aunque el frontend envía el ID propio).

**Hallazgos Críticos:**
1. El filtrado de la tabla de usuarios debe ser tanto en Backend (seguridad) como en Frontend (UX).
2. Se debe implementar `changeName` en el backend y frontend para cumplir con "Todos los roles pueden: Cambiar su propio nombre".

**AUDITORÍA POST-CODE REVIEW (04/02/2026)**
- Hallazgo: Duplicación de lógica de validación de sesión en `handleUpdateProfile`.
- Solución: Crear función helper `getVerifiedSession(sessionToken)` que retorne un objeto con `userId` y `role`.
- Hallazgo: `handleChangePassword` no valida propiedad de la cuenta.
- Solución: Implementar validación cruzada entre `sessionToken` y `userId` en el backend.
- Hallazgo: Archivos .bak en el repositorio.
- Solución: Eliminar antes del submit final.

**AUDITORÍA FINAL CRÍTICA (04/02/2026) - HALLAZGOS JULES**
1. **API-CONFIG ERROR:** `updateProfile` falta en `ACTION_TO_SERVICE_MAP`. Error fatal al intentar editar nombre de perfil.
2. **CASING ERROR:** La instrucción especifica `Tecnico_exterior`. Se está usando `Tecnico_Exterior` (E mayúscula).
3. **ID GENERATION RISK:** `handleCreateUser` no tiene `LockService`. Riesgo de colisión de ID en creación concurrente.
4. **ROLE REDUNDANCY:** 'Gefe' y 'Jefe' están ambos en código. Se mantendrán por compatibilidad pero se priorizará 'Jefe' en la UI si es posible (se mantiene soporte dual en backend).

**AUDITORÍA TÉCNICA - ACTUALIZACIÓN ENDPOINT USERS (04/02/2026)**
- Archivo: api-config.js
- Hallazgo: Se requiere actualizar el endpoint de USERS al nuevo URL proporcionado.
- Riesgo: Si el nuevo microservicio tiene un contrato distinto al auditado en la tarea anterior, las funciones de RBAC podrían fallar. Se asume que el contrato se mantiene igual.
- Versión: Se incrementará la versión global a v4.9.24.

**AUDITORÍA LÍNEA POR LÍNEA - TAREA ANIMACIONES DE CARGA (04/02/2026)**

**Archivo: users.html**
- Hallazgo: `users.html` no carga `style.css`, por lo que no tiene acceso a `.btn-loading`.
- Solución: Copiar estilos de `.btn-loading` y `spin-button` al bloque `<style>` de `users.html`.
- L389: `handleUserFormSubmit` - Falta lógica de estado de carga en el botón de submit.
- L422: `deleteUser` - Falta lógica de estado de carga en el botón de eliminar.
- L461: `handleChangePasswordSubmit` - Falta lógica de estado de carga en el botón de submit.
- L486: `handleEditNameSubmit` - Falta lógica de estado de carga en el botón de submit.

**Hallazgos Críticos:**
1. Los botones de eliminar son dinámicos, por lo que se debe pasar la referencia del botón a la función `deleteUser` o manejarla localmente.

**AUDITORÍA LÍNEA POR LÍNEA - CARGA OPTIMIZADA DE IMÁGENES (15/05/2024)**

**Archivo: ui.js**
- L12: `getImageUrl` usa tamaño default 400. Tiene optimización Retina para < 600.
- L112: `crearCarrusel` (Categorías) usa default 400. Debe usar SMALL.
- L143: `crearCarrusel` (Marcas Vehículos) usa default 400. Debe usar SMALL.
- L158: `crearCarrusel` (Marcas Motos) usa default 400. Debe usar SMALL.
- L189: `mostrarMarcas` usa default 400 y `loading="lazy"`. Debe usar SMALL.
- L214: `mostrarModelosPorMarca` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L274: `mostrarModelos` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L306: `mostrarTiposEncendido` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L336: `mostrarVersiones` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L371: `mostrarVersionesEquipamiento` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L416: `mostrarResultadosDeBusqueda` (Marcas) usa default 400. Debe usar SMALL.
- L433: `mostrarResultadosDeBusqueda` (Modelos) usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L469: `mostrarDetalleModal` (Logo) usa default 400. Puede usar SMALL.
- L510: `mostrarDetalleModal` (Vehículo) usa default 400. Debe usar MEDIUM.
- L576: `renderCutContent` (Corte) usa default 400. Debe usar MEDIUM.
- L583: Lightbox usa la misma URL que el modal. Debe usar LARGE y cargar solo on-click.
- L686: `renderRelayInfoModal` usa 1200.
- L855: `createAccordionSection` (Corte/Apertura/Cable) usa 1200 para la vista de modal. Debe usar MEDIUM para el modal y LARGE para el lightbox.
- L942: `mostrarUltimosAgregados` usa default 400 y `loading="lazy"`. Debe usar SMALL.
- L1043: `mostrarTutorialesGrid` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L1066: `mostrarRelayGrid` usa default 400. Falta `loading="lazy"`. Debe usar SMALL.
- L1126: `mostrarDetalleRelayModal` usa default 400. Debe usar MEDIUM.

**Hallazgos Críticos:**
1. Inconsistencia en el uso de `loading="lazy"` en las tarjetas del catálogo.
2. Imágenes de alta resolución (1200) se están cargando en los acordeones del modal de detalle antes de que el usuario las expanda o use el lightbox.
3. El lightbox no tiene su propia lógica de carga de alta resolución, reutiliza la URL del modal (que es de baja/media calidad).

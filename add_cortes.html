<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agregar Nuevo Corte - GPS Lock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-v2-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #ecf0f1;
            --card-background: #ffffff;
            --text-color: #34495e;
            --light-gray: #bdc3c7;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            color-scheme: light;
        }

        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        header { padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .header-branding { display: flex; align-items: center; gap: 15px; }
        .app-logo { max-width: 76px; height: auto; border-radius: 8px; }
        h1.app-title { margin: 0; font-size: 1.8em; color: #333; }
        main { flex-grow: 1; background-color: #f4f4f4; padding: 20px; }
        .form-container { background-color: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto; }
        .form-phase { display: none; }
        .form-phase.active { display: block; animation: fadeIn 0.5s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2, h3 { text-align: center; color: var(--secondary-color) !important; margin-bottom: 25px; }
        h3 { text-align: left; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--light-gray); padding-bottom: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { color: #34495e !important; display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--light-gray); border-radius: 8px; box-sizing: border-box; font-size: 1em; transition: border-color 0.3s; color: var(--text-color); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
        textarea { resize: vertical; min-height: 100px; }
        .form-actions { display: flex; justify-content: space-between; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; flex-grow: 1; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #f1f1f1; color: var(--text-color); border: 1px solid var(--light-gray); }
        .btn-secondary:hover { background-color: #e5e5e5; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #loading-overlay.visible { opacity: 1; visibility: visible; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom file input */
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; border: 1px solid var(--light-gray); border-radius: 8px; padding: 12px; background-color: #f9f9f9; text-align: center; cursor: pointer; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .file-input-wrapper .file-input-label { color: var(--text-color); }
        .file-input-wrapper .file-name { display: block; margin-top: 8px; font-style: italic; color: var(--primary-color); font-size: 0.9em; }
        .image-preview { display: none; max-width: 100%; max-height: 200px; margin-top: 15px; border-radius: 8px; border: 1px solid var(--light-gray); object-fit: contain; }
        .image-preview.visible { display: block; }
        .footer { text-align: center; padding: 20px 0; margin-top: auto; background-color: #333; color: #fff; font-size: 0.9em; width: 100%; }

        /* Verification Phase & Accordion Styles */
        .verification-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--light-gray); }
        .verification-header img { width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--light-gray); }
        .verification-header-info { flex-grow: 1; }
        .verification-header-info p { margin: 5px 0; font-size: 1.1em; }
        .verification-header-info strong { color: var(--secondary-color); }

        .accordion-button { background-color: #f7f7f7; color: var(--secondary-color); cursor: pointer; padding: 15px 20px; width: 100%; border: none; border-bottom: 1px solid var(--light-gray); text-align: left; outline: none; font-size: 1.1em; font-weight: 600; transition: background-color 0.3s; display: flex; justify-content: space-between; align-items: center; }
        .accordion-button:hover, .accordion-button.active { background-color: #e9e9e9; }
        .accordion-button i { transition: transform 0.3s; }
        .accordion-button.active i { transform: rotate(-180deg); }
        .accordion-panel { padding: 0 18px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .accordion-panel.show { padding: 15px 18px; }
        .accordion-content { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .accordion-content p { margin: 0; align-self: flex-start; }
        .accordion-content img { max-width: 100%; border-radius: 8px; border: 1px solid var(--light-gray); }

    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div></div>

    <div class="app-container">
        <header class="header-container">
            <div class="header-branding">
                <a href="index.html"><img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo"></a>
                <h1 class="app-title">Agregar Nuevo</h1>
            </div>
            <div id="header-controls" style="display: flex; align-items: center; gap: 15px; margin-left: auto;">
                <span id="welcome-message" style="color: #333; font-weight: bold; text-align: right;"></span>
                <button id="logout-button" style="background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">Cerrar Sesión</button>
            </div>
        </header>

        <main>
            <div class="form-container">
                <!-- FASE 1: INFORMACIÓN DEL VEHÍCULO -->
                <div id="phase-1" class="form-phase active">
                    <h2>Información del Vehículo</h2>
                    <form id="vehicle-check-form">
                        <div class="form-group"><label for="categoria">Categoría</label><select id="categoria" name="categoria" required></select></div>
                        <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca" name="marca" required></div>
                        <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo" name="modelo" required></div>
                        <div class="form-group"><label for="anio">Año (Generación)</label><input type="text" id="anio" name="anio" placeholder="Ej: 2015 o 2015-2018" required></div>
                        <div class="form-group"><label for="tipo-encendido">Tipo de Encendido</label><select id="tipo-encendido" name="tipo-encendido" required></select></div>
                        <div class="form-actions">
                           <button type="button" onclick="window.location.href='index.html'" class="btn btn-secondary">Cancelar</button>
                           <button type="submit" class="btn btn-primary">Continuar</button>
                        </div>
                    </form>
                </div>

                <!-- FASE 2: VERIFICACIÓN -->
                <div id="phase-2" class="form-phase">
                    <h2>Vehículo Encontrado</h2>
                    <div id="verification-data"></div>
                    <p>El vehículo ya existe en la base de datos. ¿Qué deseas hacer?</p>
                    <div id="verification-actions" class="form-actions" style="flex-direction: column;"></div>
                </div>

                <!-- FASE 3: AGREGAR INFORMACIÓN -->
                <div id="phase-3" class="form-phase">
                    <h2 id="phase-3-title">Agregar Nuevo Vehículo</h2>
                    <form id="add-info-form">
                        <div id="new-vehicle-photo-group" class="form-group" style="display: none;">
                            <label for="imagenVehiculo">Foto del Vehículo</label>
                            <div class="file-input-wrapper">
                                <span class="file-input-label">Seleccionar imagen...</span>
                                <input type="file" id="imagenVehiculo" name="imagenVehiculo" accept="image/*">
                                <span class="file-name"></span>
                            </div>
                            <img id="preview-imagenVehiculo" class="image-preview" alt="Vista previa de la imagen del vehículo">
                        </div>
                        <div id="nuevo-corte-group">
                           <h3>Nuevo Corte</h3>
                           <div class="form-group"><label for="tipo-corte">Tipo de Corte</label><select id="tipo-corte" name="tipo-corte"></select></div>
                           <div class="form-group"><label for="descripcion-corte">Descripción del Corte</label><textarea id="descripcion-corte" name="descripcion-corte" placeholder="Color del cable, ubicación..."></textarea></div>
                           <div class="form-group">
                               <label for="imagenCorte">Foto del Corte</label>
                               <div class="file-input-wrapper">
                                   <span class="file-input-label">Seleccionar imagen...</span>
                                   <input type="file" id="imagenCorte" name="imagenCorte" accept="image/*"><span class="file-name"></span>
                               </div>
                               <img id="preview-imagenCorte" class="image-preview" alt="Vista previa de la imagen del corte">
                           </div>
                        </div>
                        <div id="apertura-group">
                            <h3>Apertura de Puertas</h3>
                            <div class="form-group"><label for="apertura-desc">Descripción</label><textarea id="apertura-desc" name="apertura-desc" placeholder="Color del cable, ubicación..."></textarea></div>
                            <div class="form-group">
                               <label for="imagenApertura">Foto de Apertura</label>
                               <div class="file-input-wrapper">
                                   <span class="file-input-label">Seleccionar imagen...</span>
                                   <input type="file" id="imagenApertura" name="imagenApertura" accept="image/*"><span class="file-name"></span>
                               </div>
                               <img id="preview-imagenApertura" class="image-preview" alt="Vista previa de la imagen de apertura">
                            </div>
                        </div>
                        <div id="alimentacion-group">
                             <h3>Cables de Alimentación</h3>
                             <div class="form-group"><label for="alimentacion-desc">Descripción</label><textarea id="alimentacion-desc" name="alimentacion-desc" placeholder="Colores de cables 12v, GND, IGN, ubicación..."></textarea></div>
                             <div class="form-group">
                               <label for="imagenAlimentacion">Foto de Alimentación</label>
                               <div class="file-input-wrapper">
                                   <span class="file-input-label">Seleccionar imagen...</span>
                                   <input type="file" id="imagenAlimentacion" name="imagenAlimentacion" accept="image/*"><span class="file-name"></span>
                               </div>
                               <img id="preview-imagenAlimentacion" class="image-preview" alt="Vista previa de la imagen de alimentación">
                           </div>
                        </div>
                        <div class="form-group"><label for="notas">Notas Adicionales</label><textarea id="notas" name="notas"></textarea></div>
                        <div class="form-actions">
                            <button type="button" id="back-to-phase-1" class="btn btn-secondary">Atrás</button>
                            <button type="submit" class="btn btn-primary">Guardar Registro</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
        <footer class="footer">Gpspedia 2025© todos los derechos reservados.</footer>
    </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKVpz7S1_dCeOgNov0WBm46RbVKU7it-8RLA9vde6ZzbfYMz0LWtvPgHK4yHT4G7GG/exec";
const SESSION_KEY = 'gpsepedia_session';
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB

const state = {
    vehicleInfo: {},
    existingData: null,
    rowIndex: null,
    filePromises: {},
    colaborador: ''
};

async function postToAction(action, payload = {}) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, payload })
        });
        if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.details ? `${result.message}: ${result.details.message}` : result.message);
        return result;
    } catch (error) {
        console.error(`Error en la acción '${action}':`, error);
        alert(`Error en la acción '${action}': ${error.message}`);
        throw error;
    }
}

async function init() {
    const sessionData = localStorage.getItem(SESSION_KEY);
    if (sessionData) {
        const user = JSON.parse(sessionData);
        document.getElementById('welcome-message').innerHTML = `Bienvenido,<br>${user.nombre}`;
        state.colaborador = user.nombre;
    } else {
        window.location.href = 'index.html';
        return;
    }

    toggleLoading(true);
    try {
        const data = await postToAction('getDropdownData');
        populateSelect('categoria', data.dropdowns.categoria);
        populateSelect('tipo-encendido', data.dropdowns.tipoDeEncendido);
        populateSelect('tipo-corte', data.dropdowns.tipoDeCorte);
    } catch (error) {
        alert('No se pudieron cargar las opciones del formulario. Inténtalo de nuevo.');
    } finally {
        toggleLoading(false);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    document.getElementById('vehicle-check-form').addEventListener('submit', handlePhase1Submit);
    document.getElementById('add-info-form').addEventListener('submit', handlePhase3Submit);
    document.getElementById('back-to-phase-1').addEventListener('click', () => showPhase(1));
    document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.removeItem(SESSION_KEY);
        window.location.href = 'index.html';
    });
    document.querySelectorAll('input[type=file]').forEach(input => input.addEventListener('change', handleFileSelection));
});

function handleFileSelection(e) {
    const file = e.target.files[0];
    const inputId = e.target.id;
    const previewImg = document.getElementById(`preview-${inputId}`);
    const fileNameSpan = e.target.closest('.file-input-wrapper').querySelector('.file-name');

    delete state.filePromises[inputId];
    fileNameSpan.textContent = '';
    previewImg.src = '';
    previewImg.classList.remove('visible');

    if (file) {
        if (file.size > MAX_FILE_SIZE) {
            alert(`El archivo es demasiado grande (Máx 5MB).`);
            e.target.value = '';
            return;
        }
        fileNameSpan.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => {
            previewImg.src = event.target.result;
            previewImg.classList.add('visible');
        };
        reader.readAsDataURL(file);
        state.filePromises[inputId] = fileToBase64(file).then(base64String => ({
            name: file.name, mimeType: file.type, data: base64String.split(',')[1]
        }));
    }
}

async function handlePhase1Submit(e) {
    e.preventDefault();
    toggleLoading(true);
    const formData = new FormData(e.target);
    state.vehicleInfo = Object.fromEntries(formData.entries());

    try {
        const res = await postToAction('checkVehicle', state.vehicleInfo);
        if (res.exists) {
            state.existingData = res.data;
            state.rowIndex = res.rowIndex;
            setupVerificationPhase();
            showPhase(2);
        } else {
            state.existingData = null;
            state.rowIndex = -1;
            setupDataEntryPhase(true);
            showPhase(3);
        }
    } catch (error) {
        // Error already handled in postToAction
    } finally {
        toggleLoading(false);
    }
}

async function handlePhase3Submit(e) {
    e.preventDefault();
    toggleLoading(true);
    let resolvedFiles = {};
    try {
        const fileEntries = await Promise.all(
            Object.entries(state.filePromises).map(async ([key, promise]) => [key, await promise])
        );
        resolvedFiles = Object.fromEntries(fileEntries);
    } catch (error) {
        alert('Hubo un error al procesar las imágenes.');
        toggleLoading(false);
        return;
    }

    const additionalInfo = {
        nuevoCorte: { tipo: document.getElementById('tipo-corte').value, descripcion: document.getElementById('descripcion-corte').value },
        apertura: document.getElementById('apertura-desc').value,
        alimentacion: document.getElementById('alimentacion-desc').value,
        notas: document.getElementById('notas').value
    };

    const payload = {
        vehicleInfo: { ...state.vehicleInfo, rowIndex: state.rowIndex, colaborador: state.colaborador },
        additionalInfo,
        files: resolvedFiles
    };

    try {
        const data = await postToAction('addCorte', payload);
        alert('¡Éxito! ' + data.message);
        window.location.href = 'index.html';
    } catch (error) {
        // Error already handled in postToAction
    } finally {
        toggleLoading(false);
    }
}

// Resto de funciones auxiliares (generateAccordionTitles, setupVerificationPhase, etc.) sin cambios significativos en su lógica interna.
function generateAccordionTitles(data) {
    const cuts = [
        { type: data.tipoDeCorte, desc: data.descripcionDelCorte, img: data.imagenDelCorte },
        { type: data.tipoDeCorte2, desc: data.descripcionDelSegundoCorte, img: data.imagenDeCorte2 },
        { type: data.tipoDeCorte3, desc: data.descripcionDelCorte3, img: data.imagenDeCorte3 }
    ];
    const cutCounts = cuts.reduce((acc, cut) => {
        if (cut.type) acc[cut.type] = (acc[cut.type] || 0) + 1;
        return acc;
    }, {});
    const cutTitles = {};
    return cuts.filter(cut => cut.desc).map(cut => {
        let title = `Corte a ${cut.type}`;
        if (cutCounts[cut.type] > 1) {
            cutTitles[cut.type] = (cutTitles[cut.type] || 0) + 1;
            title += ` ${cutTitles[cut.type]}`;
        }
        return { title, desc: cut.desc, img: cut.img };
    });
}

function setupVerificationPhase() {
    const data = state.existingData;
    const container = document.getElementById('verification-data');
    container.innerHTML = '';
    const header = document.createElement('div');
    header.className = 'verification-header';
    let vehicleImgHtml = data.imagenDelVehiculo ? `<img src="${convertirAGoogleThumbnail(data.imagenDelVehiculo)}" alt="Foto del vehículo">` : '<div style="width: 200px; height: 150px; background: #eee; display:flex; align-items:center; justify-content:center; border-radius: 8px;">Sin foto</div>';
    header.innerHTML = `
        ${vehicleImgHtml}
        <div class="verification-header-info">
            <p><strong>Marca:</strong> ${data.marca || 'N/A'}</p>
            <p><strong>Modelo:</strong> ${data.modelo || 'N/A'}</p>
            <p><strong>Año:</strong> ${data.anoGeneracion || 'N/A'}</p>
            <p><strong>Encendido:</strong> ${data.tipoDeEncendido || 'N/A'}</p>
        </div>`;
    container.appendChild(header);
    const accordionContainer = document.createElement('div');
    container.appendChild(accordionContainer);
    const dynamicCutSections = generateAccordionTitles(data);
    const otherSections = [
        { title: 'Apertura', desc: data.apertura, img: data.imagenDeLaApertura },
        { title: 'Alimentación', desc: data.cablesDeAlimentacion, img: data.imagenDeLosCablesDeAlimentacion },
        { title: 'Nota Importante', desc: data.notaImportante, img: null }
    ];
    [...dynamicCutSections, ...otherSections].forEach(section => {
        if (section.desc) {
            accordionContainer.appendChild(createAccordionItem(section.title, section.desc, section.img));
        }
    });
    setupAccordionListeners();

    const actionsContainer = document.getElementById('verification-actions');
    actionsContainer.innerHTML = '';
    const hasAllCuts = data.descripcionDelCorte && data.descripcionDelSegundoCorte && data.descripcionDelCorte3;
    if (!hasAllCuts) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.textContent = 'Agregar Nuevo Corte';
        btn.onclick = () => { setupDataEntryPhase(false, { corte: true, apertura: false, alimentacion: false, notas: false }); showPhase(3); };
        actionsContainer.appendChild(btn);
    }
    const hasApertura = data.apertura;
    const hasAlimentacion = data.cablesDeAlimentacion;
    if (!hasApertura || !hasAlimentacion) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.textContent = 'Agregar Info Adicional (Apertura/Alimentación)';
        btn.onclick = () => { setupDataEntryPhase(false, { corte: false, apertura: !hasApertura, alimentacion: !hasAlimentacion, notas: true }); showPhase(3); };
        actionsContainer.appendChild(btn);
    }
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.textContent = 'Cancelar / Es un Duplicado';
    cancelBtn.onclick = () => window.location.reload();
    actionsContainer.appendChild(cancelBtn);
}

function createAccordionItem(title, description, imageUrl) {
    const item = document.createElement('div');
    const btn = document.createElement('button');
    btn.className = 'accordion-button';
    btn.innerHTML = `${title} <i class="fa-solid fa-chevron-down"></i>`;
    const panel = document.createElement('div');
    panel.className = 'accordion-panel';
    let contentHtml = `<p>${String(description).replace(/\n/g, '<br>')}</p>`;
    if (imageUrl) {
        contentHtml += `<img src="${convertirAGoogleThumbnail(imageUrl)}" alt="Detalle de ${title}">`;
    }
    panel.innerHTML = `<div class="accordion-content">${contentHtml}</div>`;
    item.appendChild(btn);
    item.appendChild(panel);
    return item;
}

function setupAccordionListeners() {
    document.querySelectorAll('.accordion-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const isActive = this.classList.contains('active');
            document.querySelectorAll('.accordion-button').forEach(otherBtn => {
                otherBtn.classList.remove('active');
                otherBtn.nextElementSibling.style.maxHeight = null;
            });
            if (!isActive) {
                this.classList.add('active');
                const panel = this.nextElementSibling;
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
    });
}

function setupDataEntryPhase(isNewVehicle, sections = { corte: true, apertura: true, alimentacion: true, notas: true }) {
    document.getElementById('add-info-form').reset();
    document.querySelectorAll('.file-name').forEach(span => span.textContent = '');
    document.querySelectorAll('.image-preview').forEach(img => { img.src = ''; img.classList.remove('visible'); });
    state.filePromises = {};
    document.getElementById('phase-3-title').textContent = isNewVehicle ? 'Agregar Nuevo Vehículo' : 'Agregar Información Adicional';
    document.getElementById('new-vehicle-photo-group').style.display = isNewVehicle ? 'block' : 'none';
    document.getElementById('nuevo-corte-group').style.display = sections.corte ? 'block' : 'none';
    document.getElementById('apertura-group').style.display = sections.apertura ? 'block' : 'none';
    document.getElementById('alimentacion-group').style.display = sections.alimentacion ? 'block' : 'none';
}

function showPhase(phaseNumber) {
    document.querySelectorAll('.form-phase').forEach(p => p.classList.remove('active'));
    document.getElementById(`phase-${phaseNumber}`).classList.add('active');
}

function toggleLoading(show) {
    document.getElementById('loading-overlay').classList.toggle('visible', show);
}

function populateSelect(id, options) {
    const select = document.getElementById(id);
    if (!select || !Array.isArray(options)) return;
    select.innerHTML = '<option value="">Seleccione...</option>';
    options.forEach(option => {
        if (option) {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
        }
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

function convertirAGoogleThumbnail(url) {
    if (!url) return "https://placehold.co/400x300/cccccc/333333?text=Sin+Imagen";
    const idMatch = String(url).match(/id=([a-zA-Z0-9_-]+)|\/d\/([a-zA-Z0-9_-]+)/);
    return idMatch ? `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1] || idMatch[2]}` : url;
}
</script>
</body>
</html>

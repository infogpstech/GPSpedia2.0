<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agregar Nuevo - GPSpedia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-lightbox-gallery/dist/lightbox.min.css" />
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #007bff; margin-bottom: 15px; font-size: 1.5em; }
        h2 { font-size: 1.3em; color: #333; }
        p { margin-top: 0; margin-bottom: 10px; font-size: 0.9em; }
        .container { padding: 20px; }
        .form-phase { display: none; }
        .form-phase.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 0.85em; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.9em; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.2); outline: none; }
        .btn-container { text-align: right; margin-top: 20px; }
        .btn { padding: 8px 18px; border: none; border-radius: 6px; background-color: #007bff; color: white; font-size: 0.9em; cursor: pointer; transition: background-color 0.3s; }
        .btn:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .back-link { display: inline-block; margin-bottom: 15px; color: #007bff; text-decoration: none; font-weight: bold; font-size: 0.9em; }
        .back-link:hover { text-decoration: underline; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .match-card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; transition: box-shadow 0.2s, border-color 0.2s; display: flex; align-items: flex-start; gap: 12px; }
        .match-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); border-color: #007bff; }
        .match-card-img { width: 150px; height: auto; border-radius: 6px; object-fit: cover; }
        .match-card-info { flex-grow: 1; }
        .match-card-info p { margin: 0 0 4px 0; font-size: 0.9em; } /* Reducido margen inferior */
        .match-card-info h4 { margin: 0 0 8px 0; color: #0056b3; } /* Reducido margen inferior */
        .match-vehicle-img { width: 120px; height: auto; border-radius: 6px; object-fit: cover; align-self: center; } /* Aumentado 20% */
        .match-cuts-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; } /* Reducido espacio */
        .match-cut-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 10px; } /* Reducido margen inferior */
        .match-cut-item a { display: block; flex-shrink: 0; }
        .match-cut-img { width: 216px; height: 144px; border-radius: 6px; object-fit: cover; border: 1px solid #ccc; } /* Aumentado 20% */
        .match-cut-details { font-size: 0.85em; } /* Ligeramente reducido para compactar */
        .match-cut-details p { margin-bottom: 4px; }
        .suggestion { font-size: 0.85em; color: #666; margin-top: 5px; }
        .suggestion a { color: #007bff; text-decoration: none; cursor: pointer; }
        .suggestion a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div></div>
    <div class="container">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Catálogo</a>
        <h1>Agregar Nuevo Corte</h1>

        <!-- Fase 1: Verificación de Duplicados -->
        <div id="stage-1" class="form-phase active">
            <h2>Paso 1: Verificar Vehículo</h2>
            <p>Introduce los datos básicos para comprobar si ya existe un registro similar.</p>
            <form id="form-phase-1">
                <div class="form-grid">
                    <div class="form-group"><label for="categoria">Categoría</label><select id="categoria" name="categoria" required></select></div>
                    <div class="form-group">
                        <label for="marca">Marca</label>
                        <input type="text" id="marca" name="marca" required>
                        <div class="suggestion" id="marca-suggestion"></div>
                    </div>
                    <div class="form-group">
                        <label for="modelo">Modelo</label>
                        <input type="text" id="modelo" name="modelo" required>
                        <div class="suggestion" id="modelo-suggestion"></div>
                    </div>
                    <div class="form-group"><label for="anoDesde">Año</label><input type="number" id="anoDesde" name="anoDesde" required></div>
                    <div class="form-group"><label for="tipoEncendido">Tipo de Encendido</label><select id="tipoEncendido" name="tipoEncendido" required></select></div>
                    <div class="form-group"><label for="versionesAplicables">Versión de Equipamiento (Opcional)</label><input type="text" id="versionesAplicables" name="versionesAplicables" placeholder="Ej: Frontier, NP300"></div>
                </div>
                <div class="btn-container">
                    <button type="submit" class="btn">Verificar</button>
                </div>
            </form>
        </div>

        <!-- Fase 1.5: Mostrar Coincidencias -->
        <div id="stage-1-5" class="form-phase">
            <h2>Paso 1.5: Se Encontraron Coincidencias</h2>
            <p>Este modelo ya tiene estos cortes, ¿quieres agregar uno nuevo?</p>
            <div id="matches-container"></div>
            <div class="btn-container" style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="window.location.href='index.html'" class="btn btn-secondary">Sí, es el mismo corte (cancelar)</button>
                <div>
                    <button id="add-new-cut-btn" class="btn">Es uno nuevo</button>
                    <button id="add-supplementary-btn" class="btn">Agregar información adicional</button>
                </div>
            </div>
        </div>

        <!-- Fase 2: Agregar Información del Corte -->
        <div id="stage-2" class="form-phase">
            <h2 id="stage-2-title">Paso 2: Agregar Información del Corte</h2>
            <form id="form-phase-2">
                <div class="form-grid">
                    <div class="form-group"><label for="tipoCorte1">Tipo de Corte</label><select id="tipoCorte1" name="tipoCorte1" required></select></div>
                    <div class="form-group"><label for="ubicacionCorte1">Ubicación del Corte</label><input type="text" id="ubicacionCorte1" name="ubicacionCorte1"></div>
                    <div class="form-group"><label for="colorCableCorte1">Color(es) de Cable</label><input type="text" id="colorCableCorte1" name="colorCableCorte1"></div>
                    <div class="form-group"><label for="imgCorte1">URL de Imagen del Corte</label><input type="text" id="imgCorte1" name="imgCorte1"></div>
                </div>
                <div class="btn-container">
                    <button onclick="history.back()" class="btn btn-secondary" type="button">Atrás</button>
                    <button type="submit" class="btn">Guardar y Continuar</button>
                </div>
            </form>
        </div>

        <!-- Fase 3: Agregar Información Suplementaria -->
        <div id="stage-3" class="form-phase">
            <h2>Paso 3: Información Suplementaria (Opcional)</h2>
            <p>Registro guardado con éxito. Ahora puedes añadir imágenes y notas adicionales.</p>
            <form id="form-phase-3">
                 <div class="form-grid">
                    <div class="form-group"><label for="imagenVehiculo">URL de Imagen del Vehículo</label><input type="text" id="imagenVehiculo" name="imagenVehiculo"></div>
                    <div class="form-group"><label for="configRelay1">Configuración de Relay</label><select id="configRelay1" name="configRelay1"></select></div>
                    <div class="form-group"><label for="videoGuiaDesarmeUrl">URL de Video Guía de Desarme</label><input type="text" id="videoGuiaDesarmeUrl" name="videoGuiaDesarmeUrl"></div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="notaImportante">Nota Importante</label>
                    <textarea id="notaImportante" name="notaImportante" rows="4"></textarea>
                </div>
                <div class="btn-container">
                     <button type="submit" class="btn">Finalizar y Guardar</button>
                </div>
            </form>
            <div class="btn-container" style="text-align: center; margin-top: 20px;">
                <a href="add_cortes.html" class="btn btn-secondary">Agregar Otro Vehículo</a>
            </div>
        </div>

    </div>
    <script src="api-manager.js"></script>
    <script>
        const SESSION_KEY = 'gpsepedia_session';
        const state = {
            vehicleInfo: {},
            matches: [],
            selectedVehicleId: null,
            colaborador: ''
        };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const sessionData = localStorage.getItem(SESSION_KEY);
            if (!sessionData) {
                alert("Tu sesión ha expirado. Serás redirigido a la página de inicio de sesión.");
                window.location.href = 'index.html';
                return;
            }
            const user = JSON.parse(sessionData);
            state.colaborador = user.Nombre_Usuario;

            toggleLoading(true);
            try {
                const data = await routeAction('getDropdownData');
                populateSelect('categoria', data.dropdowns.categoria);
                populateSelect('tipoEncendido', data.dropdowns.tipoDeEncendido);
                populateSelect('tipoCorte1', data.dropdowns.tipoDeCorte);
                populateSelect('configRelay1', data.dropdowns.configRelay);
            } catch (error) {
                alert(`No se pudieron cargar las opciones del formulario: ${error.message}`);
            } finally {
                toggleLoading(false);
            }

            document.getElementById('form-phase-1').addEventListener('submit', handlePhase1Submit);
            document.getElementById('form-phase-2').addEventListener('submit', handleAddOrUpdateCut);
            document.getElementById('form-phase-3').addEventListener('submit', handlePhase3Submit);

            document.getElementById('marca').addEventListener('blur', (e) => handleSuggestion(e.target, 'marca'));
            document.getElementById('modelo').addEventListener('blur', (e) => handleSuggestion(e.target, 'modelo'));

            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.phase) {
                    showPhase(event.state.phase, true);
                } else {
                    // Si no hay estado, es el inicio, mostramos la fase 1
                    showPhase(1, true);
                }
            });

            // Estado inicial
            if (!history.state) {
                history.replaceState({ phase: 1 }, "Paso 1", "#phase1");
            }
        }

        async function handleSuggestion(inputElement, field) {
            const term = inputElement.value.trim();
            const suggestionContainer = document.getElementById(`${field}-suggestion`);
            suggestionContainer.innerHTML = '';

            if (term.length < 3) return;

            try {
                const result = await routeAction('getSuggestion', { term, field });
                if (result.suggestion) {
                    suggestionContainer.innerHTML = `Quizás quisiste decir: <a onclick="applySuggestion('${field}', '${result.suggestion}')">${result.suggestion}</a>`;
                }
            } catch (error) {
                console.error(`Error al obtener sugerencia para ${field}:`, error);

            }
        }

        function applySuggestion(field, suggestion) {
            document.getElementById(field).value = suggestion;
            document.getElementById(`${field}-suggestion`).innerHTML = '';
        }

        function convertirAGoogleThumbnail(url, size = 1000) {
            if (!url) return `https://placehold.co/${size/2}x${size/3}/cccccc/333333?text=Sin+Imagen`;

            const idMatch = String(url).match(/file\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)|\/d\/([a-zA-Z0-9_-]+)/);

            if (idMatch) {
                const fileId = idMatch[1] || idMatch[2] || idMatch[3];
                return `https://drive.google.com/thumbnail?sz=w${size}&id=${fileId}`;
            }
            return url;
        }

        function toggleLoading(isLoading) {
            document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">Selecciona una opción</option>';
            if (options) {
                options.forEach(option => {
                    if (option) select.innerHTML += `<option value="${option}">${option}</option>`;
                });
            }
        }

        function showPhase(phaseNumber, isPoppingState = false) {
            document.querySelectorAll('.form-phase').forEach(p => p.classList.remove('active'));
            const stageId = `stage-${String(phaseNumber).replace('.', '-')}`;
            const element = document.getElementById(stageId);
            if(element) {
                element.classList.add('active');
            }

            if (!isPoppingState) {
                const url = `#phase${phaseNumber}`;
                history.pushState({ phase: phaseNumber }, `Paso ${phaseNumber}`, url);
            }
        }

        async function handlePhase1Submit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            state.vehicleInfo = Object.fromEntries(formData.entries());

            toggleLoading(true);
            try {
                const result = await routeAction('checkVehicle', state.vehicleInfo);
                state.matches = result.matches;
                if (result.matches.length > 0) {
                    displayMatches(result.matches);
                    showPhase(1.5);
                } else {
                    proceedToPhase2(null);
                }
            } catch (error) {
                alert(`Error al verificar el vehículo: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            container.innerHTML = '';

            // Since the buttons operate on the matched vehicle, we'll use the first match's ID.
            const primaryMatchId = matches.length > 0 ? matches[0].id : null;

            if (primaryMatchId) {
                document.getElementById('add-new-cut-btn').onclick = () => proceedToPhase2(primaryMatchId);
                document.getElementById('add-supplementary-btn').onclick = () => proceedToPhase3(primaryMatchId);
            }

            matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'match-card';
                // Card is now for information only, no onclick.
                const yearRange = match.anoHasta ? `${match.anoDesde} - ${match.anoHasta}` : match.anoDesde;

                const mainInfoContainer = document.createElement('div');
                mainInfoContainer.style.cssText = "display: flex; gap: 15px; width: 100%;";

                const vehicleImgHtml = `<img src="${convertirAGoogleThumbnail(match.imagenVehiculo, 120)}" alt="Imagen del Vehículo" class="match-vehicle-img" onerror="this.src='https://via.placeholder.com/120?text=Vehículo';">`;

                // Remove the explicit button from the card's inner HTML
                const infoHtml = `
                    <div class="match-card-info">
                        <h4>${match.marca} ${match.modelo}</h4>
                        <p><strong>Año:</strong> ${yearRange}</p>
                        <p><strong>Encendido:</strong> ${match.tipoEncendido || 'N/A'}</p>
                        <p><strong>Versiones:</strong> ${match.versionesAplicables || 'N/A'}</p>
                    </div>
                `;
                mainInfoContainer.innerHTML = infoHtml + vehicleImgHtml;

                const cutsSection = document.createElement('div');
                cutsSection.className = 'match-cuts-section';
                let hasCuts = false;
                for (let i = 1; i <= 3; i++) {
                    const imgUrl = match['imgCorte' + i];
                    if (imgUrl) {
                        hasCuts = true;
                        const cutItem = document.createElement('div');
                        cutItem.className = 'match-cut-item';

                        const thumbnailUrl = convertirAGoogleThumbnail(imgUrl, 400); // Thumbnail optimizado
                        const fullImageUrl = convertirAGoogleThumbnail(imgUrl, 2000); // Alta resolución para zoom

                        const link = document.createElement('a');
                        // Apply the thumbnail conversion to the href for the lightbox
                        link.href = convertirAGoogleThumbnail(imgUrl, 2000);
                        link.className = 'lightbox-trigger';
                        link.innerHTML = `<img src="${thumbnailUrl}" alt="Corte ${i}" class="match-cut-img" onerror="this.src='https://via.placeholder.com/216x144?text=Corte';">`;

                        const details = document.createElement('div');
                        details.className = 'match-cut-details';
                        details.innerHTML = `
                            <p><strong>Tipo:</strong> ${match['tipoCorte' + i] || 'N/A'}</p>
                            <p><strong>Ubicación:</strong> ${match['ubicacionCorte' + i] || 'N/A'}</p>
                            <p><strong>Color de Cable:</strong> ${match['colorCableCorte' + i] || 'N/A'}</p>
                        `;

                        cutItem.appendChild(link);
                        cutItem.appendChild(details);
                        cutsSection.appendChild(cutItem);
                    }
                }

                if (!hasCuts) {
                    cutsSection.innerHTML = '<p style="font-size: 0.9em; text-align: center; margin: 10px 0;">No hay cortes registrados para este vehículo.</p>';
                }

                const cardContent = document.createElement('div');
                cardContent.style.width = '100%';
                cardContent.appendChild(mainInfoContainer);
                cardContent.appendChild(cutsSection);

                card.appendChild(cardContent);
                container.appendChild(card);
            });

            // Re-initialize SimpleLightbox after new content is added to the DOM.
            // A small delay ensures the DOM has finished rendering.
            setTimeout(() => {
                if (typeof SimpleLightbox !== 'undefined') {
                    // It's safer to destroy any previous instance before creating a new one.
                    if (window.lightboxInstance) {
                        window.lightboxInstance.destroy();
                    }
                    window.lightboxInstance = new SimpleLightbox({elements: '#matches-container .match-cut-item a'});
                }
            }, 100);
        }

        function proceedToPhase2(vehicleId) {
            state.selectedVehicleId = vehicleId;
            const title = document.getElementById('stage-2-title');
            if (vehicleId) {
                const match = state.matches.find(m => m.id === vehicleId);
                title.textContent = `Paso 2: Agregar nuevo corte a ${match.marca} ${match.modelo}`;
            } else {
                title.textContent = "Paso 2: Agregar Información del Corte";
            }
            document.getElementById('form-phase-2').reset();
            showPhase(2);
        }

        function proceedToPhase3(vehicleId) {
            state.selectedVehicleId = vehicleId;
            const titleElement = document.querySelector('#stage-3 h2');
            if (vehicleId) {
                const match = state.matches.find(m => m.id === vehicleId);
                if(titleElement) titleElement.textContent = `Paso 3: Agregar información a ${match.marca} ${match.modelo}`;
            } else {
                if(titleElement) titleElement.textContent = "Paso 3: Información Suplementaria (Opcional)";
            }
            document.getElementById('form-phase-3').reset();
            showPhase(3);
        }

        async function handleAddOrUpdateCut(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const cutInfo = Object.fromEntries(formData.entries());

            const payload = {
                vehicleInfo: state.vehicleInfo,
                cutInfo: cutInfo,
                colaborador: state.colaborador,
                existingVehicleId: state.selectedVehicleId
            };

            toggleLoading(true);
            try {
                const result = await routeAction('addCorte', payload);
                if (result.status === 'success') {
                    state.selectedVehicleId = result.vehicleId; // Update with the definitive ID
                    alert('Corte guardado con éxito. Ahora puedes agregar información suplementaria.');
                    showPhase(3);
                } else {
                    throw new Error(result.message || 'Error desconocido al guardar.');
                }
            } catch (error) {
                alert(`Error al guardar el corte: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        async function handlePhase3Submit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const supplementaryInfo = Object.fromEntries(formData.entries());

            const payload = {
                vehicleId: state.selectedVehicleId,
                supplementaryInfo: supplementaryInfo
            };

            toggleLoading(true);
            try {
                const result = await routeAction('addSupplementaryInfo', payload);
                if (result.status === 'success') {
                    alert('Información adicional guardada con éxito.');
                } else {
                    throw new Error(result.message || 'Error desconocido al guardar.');
                }
            } catch (error) {
                alert(`Error al guardar la información suplementaria: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/simple-lightbox-gallery/dist/lightbox.min.js"></script>
</body>
</html>

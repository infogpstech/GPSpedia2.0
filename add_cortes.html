<!-- GPSpedia Frontend Component | Version: 3.0.0 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agregar Nuevo - GPSpedia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* General Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 15px; color: #343a40; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        h1, h2 { text-align: center; color: #007bff; margin-bottom: 20px; font-weight: 600; }
        h2 { font-size: 1.4em; color: #495057; }
        p { margin-top: 0; margin-bottom: 15px; font-size: 0.95em; color: #6c757d; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; font-weight: 500; font-size: 0.9em; }
        .back-link:hover { text-decoration: underline; }

        /* Form & Layout */
        .form-phase { display: none; }
        .form-phase.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        label { margin-bottom: 6px; font-weight: 500; font-size: 0.8em; color: #495057; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-size: 0.95em; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #80bdff; box-shadow: 0 0 0 3px rgba(0,123,255,0.25); outline: none; }
        .btn-container { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn { padding: 12px 22px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0069d9; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }

        /* Stage 1.5 - Matches */
        #matches-container .match-card { border: 1px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        .match-card-header { display: flex; gap: 15px; align-items: flex-start; }
        .match-card-img { width: 120px; height: 90px; object-fit: cover; border-radius: 8px; background-color: #eee; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .match-card-info { flex-grow: 1; }
        .match-card h4 { margin: 0 0 5px; color: #007bff; }
        .match-cuts-info { background: #f1f3f5; padding: 10px; border-radius: 8px; font-size: 0.85em; }
        .match-cuts-info h5 { margin: 0 0 8px; font-size: 1em; color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 4px; }
        .cut-item { margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .cut-item i { color: #28a745; font-size: 0.9em; }

        .inline-actions { margin-top: 10px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .inline-actions p { font-weight: 500; margin-bottom: 12px; color: #495057; }
        .inline-actions .btn { margin: 5px; }

        /* Stage 3 - Accordion */
        .accordion-item { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .accordion-header { background-color: #f8f9fa; padding: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header i { transition: transform 0.3s; }
        .accordion-content { padding: 15px; border-top: 1px solid #dee2e6; display: none; }
        .accordion-item.active .accordion-header i { transform: rotate(180deg); }

        /* Image Handling */
        .image-upload-group { display: flex; align-items: center; gap: 15px; }
        .image-preview { width: 100px; height: 75px; border: 2px dashed #ced4da; border-radius: 8px; object-fit: cover; cursor: pointer; }
        .image-preview:not([src]), .image-preview[src=""] { display: none; }
        .image-preview[src] { display: block; }
        .upload-label { cursor: pointer; }

        /* Utilities */
        #loading-overlay { /* ... */ }
        .spinner { /* ... */ }
        .suggestion { /* ... */ }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div></div>
    <div class="container">
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Catálogo</a>
        <h1>Agregar Nuevo Registro</h1>

        <!-- STAGE 1: VEHICLE VERIFICATION -->
        <div id="stage-1" class="form-phase active">
            <h2>Paso 1: Verificar Vehículo</h2>
            <p>Introduce los datos para comprobar si el vehículo ya existe.</p>
            <form id="form-stage-1">
                <div class="form-grid">
                    <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca" required><div class="suggestion" id="marca-suggestion"></div></div>
                    <div class="form-group"><label for="modelo">Modelo</label><input type="text" id="modelo" required><div class="suggestion" id="modelo-suggestion"></div></div>
                    <div class="form-group"><label for="anoDesde">Año</label><input type="text" id="anoDesde" required placeholder="Ej: 2023 o 2021-2024"></div>
                    <div class="form-group"><label for="tipoEncendido">Tipo de Encendido</label><select id="tipoEncendido" required></select></div>
                    <div class="form-group full-width"><label for="categoria">Categoría</label><select id="categoria" required></select></div>
                    <div class="form-group full-width"><label for="versionesAplicables">Versión de Equipamiento (Opcional)</label><input type="text" id="versionesAplicables" placeholder="Ej: Frontier, NP300"></div>
                </div>
                <div class="btn-container"><button type="submit" class="btn btn-primary">Verificar</button></div>
            </form>
        </div>

        <!-- STAGE 1.5: DISPLAY MATCHES -->
        <div id="stage-1-5" class="form-phase">
            <div id="matches-container"></div>
        </div>

        <!-- STAGE 2: ADD NEW CUT -->
        <div id="stage-2" class="form-phase">
            <h2 id="stage-2-title"></h2>
            <form id="form-stage-2">
                <div id="new-vehicle-fields">
                    <div class="form-group full-width">
                        <label>Imagen del Vehículo</label>
                        <div class="image-upload-group">
                             <img id="imagenVehiculo_preview" class="image-preview" onclick="this.nextElementSibling.click()">
                             <label for="imagenVehiculo" class="upload-label btn btn-secondary">Subir Imagen</label>
                             <input type="file" id="imagenVehiculo" style="display:none;" accept="image/*">
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="tipoCorte1">Tipo de Corte</label><select id="tipoCorte1" required></select></div>
                    <div class="form-group"><label for="configRelay1">Configuración de Relay</label><select id="configRelay1" required></select></div>
                    <div class="form-group full-width"><label for="ubicacionCorte1">Ubicación del Corte</label><textarea id="ubicacionCorte1" rows="3"></textarea></div>
                    <div class="form-group full-width"><label for="colorCableCorte1">Color(es) de Cable</label><input type="text" id="colorCableCorte1"></div>
                    <div class="form-group full-width">
                        <label>Imagen del Corte</label>
                        <div class="image-upload-group">
                           <img id="imgCorte1_preview" class="image-preview" onclick="this.nextElementSibling.click()">
                           <label for="imgCorte1" class="upload-label btn btn-secondary">Subir Imagen</label>
                           <input type="file" id="imgCorte1" style="display:none;" accept="image/*" required>
                        </div>
                    </div>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-secondary" onclick="window.showPhase(state.matches.length > 0 ? '1-5' : 1)">Volver</button>
                    <button type="submit" class="btn btn-primary">Continuar</button>
                </div>
            </form>
        </div>

        <!-- STAGE 3: ADD SUPPLEMENTARY INFO -->
        <div id="stage-3" class="form-phase">
            <h2>Paso 3: Información Suplementaria (Opcional)</h2>
            <p>El corte ha sido guardado. Puedes añadir detalles adicionales o finalizar.</p>
            <form id="form-stage-3">
                <div class="accordion">
                    <div class="accordion-item" id="apertura-accordion">
                        <div class="accordion-header"><span>Agregar Apertura</span><i class="fas fa-chevron-down"></i></div>
                        <div class="accordion-content form-grid">
                            <div class="form-group full-width"><label for="apertura">Detalle de Apertura</label><textarea id="apertura" rows="3"></textarea></div>
                            <div class="form-group full-width"><label>Imagen de Apertura</label><div class="image-upload-group"><img id="imgApertura_preview" class="image-preview" onclick="this.nextElementSibling.click()"><label for="imgApertura" class="btn btn-secondary">Subir</label><input type="file" id="imgApertura" style="display:none;" accept="image/*"></div></div>
                        </div>
                    </div>
                    <div class="accordion-item" id="alimentacion-accordion">
                        <div class="accordion-header"><span>Cable de Alimentación</span><i class="fas fa-chevron-down"></i></div>
                        <div class="accordion-content form-grid">
                            <div class="form-group full-width"><label for="cableAlimen">Detalle de Alimentación</label><textarea id="cableAlimen" rows="3"></textarea></div>
                            <div class="form-group full-width"><label>Imagen de Alimentación</label><div class="image-upload-group"><img id="imgCableAlimen_preview" class="image-preview" onclick="this.nextElementSibling.click()"><label for="imgCableAlimen" class="btn btn-secondary">Subir</label><input type="file" id="imgCableAlimen" style="display:none;" accept="image/*"></div></div>
                        </div>
                    </div>
                    <div class="accordion-item" id="nota-accordion">
                        <div class="accordion-header"><span>Agregar Nota Importante</span><i class="fas fa-chevron-down"></i></div>
                        <div class="accordion-content form-grid">
                            <div class="form-group full-width"><label for="notaImportante">Nota</label><textarea id="notaImportante" rows="3"></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="btn-container"><button type="submit" class="btn btn-primary">Guardar y Finalizar</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        // COMPONENT VERSION: 3.0.1
        import { routeAction } from './api-config.js';
        const SESSION_KEY = 'gpsepedia_session';
        const state = {
            vehicleInfo: {},
            matches: [],
            selectedVehicleId: null,
            colaborador: ''
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

        // Expose to window for inline onclicks in navigation
        window.showPhase = showPhase;

        async function init() {
            const sessionData = localStorage.getItem(SESSION_KEY);
            if (!sessionData) {
                alert("Tu sesión ha expirado. Por favor, inicia sesión de nuevo.");
                window.location.href = 'index.html';
                return;
            }
            state.colaborador = JSON.parse(sessionData).Nombre_Usuario;

            await populateAllDropdowns();
            setupEventListeners();
        }

        async function populateAllDropdowns() {
            toggleLoading(true);
            try {
                const { dropdowns } = await routeAction('getDropdownData');
                populateSelect('categoria', dropdowns.categoria);
                populateSelect('tipoEncendido', dropdowns.tipoDeEncendido);
                populateSelect('tipoCorte1', dropdowns.tipoDeCorte);
                populateSelect('configRelay1', dropdowns.configRelay, "Corte a ignición");
            } catch (error) {
                alert(`Error al cargar datos del formulario: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        function setupEventListeners() {
            // Form submissions
            document.getElementById('form-stage-1').addEventListener('submit', handleStage1Submit);
            document.getElementById('form-stage-2').addEventListener('submit', handleStage2Submit);
            document.getElementById('form-stage-3').addEventListener('submit', handleStage3Submit);

            // Suggestions
            document.getElementById('marca').addEventListener('blur', (e) => handleSuggestion(e.target, 'marca'));
            document.getElementById('modelo').addEventListener('blur', (e) => handleSuggestion(e.target, 'modelo'));

            // Image previews
            setupImagePreview('imagenVehiculo', 'imagenVehiculo_preview');
            setupImagePreview('imgCorte1', 'imgCorte1_preview');
            setupImagePreview('imgApertura', 'imgApertura_preview');
            setupImagePreview('imgCableAlimen', 'imgCableAlimen_preview');

            // Accordion
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const item = header.parentElement;
                    item.classList.toggle('active');
                    const content = header.nextElementSibling;
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        }

        // --- STAGE 1: VEHICLE VERIFICATION ---
        async function handleStage1Submit(e) {
            e.preventDefault();
            const form = e.target;
            state.vehicleInfo = {
                marca: form.querySelector('#marca').value,
                modelo: form.querySelector('#modelo').value,
                anoDesde: form.querySelector('#anoDesde').value,
                tipoEncendido: form.querySelector('#tipoEncendido').value,
                categoria: form.querySelector('#categoria').value,
                versionesAplicables: form.querySelector('#versionesAplicables').value,
            };

            toggleLoading(true);
            try {
                const response = await routeAction('checkVehicle', state.vehicleInfo);
                if (response.status === 'error') throw new Error(response.message);

                state.matches = response.matches || [];
                if (state.matches.length > 0) {
                    displayMatches(state.matches);
                    showPhase('1-5');
                } else {
                    proceedToStage2(null); // No matches, proceed to create new vehicle
                }
            } catch (error) {
                alert(`Error al verificar: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        async function handleSuggestion(input, field) {
            const container = document.getElementById(`${field}-suggestion`);
            container.innerHTML = '';
            if (input.value.length < 3) return;
            try {
                const { suggestion } = await routeAction('getSuggestion', { term: input.value, field });
                if (suggestion) {
                    container.innerHTML = `Quizás quisiste decir: <a onclick="applySuggestion('${field}', '${suggestion}')">${suggestion}</a>`;
                }
            } catch (e) { console.error(e); }
        }

        function applySuggestion(field, suggestion) {
            document.getElementById(field).value = suggestion;
            document.getElementById(`${field}-suggestion`).innerHTML = '';
        }

        // --- STAGE 1.5: DISPLAY MATCHES ---
        function getImageUrl(url, size = 1000) {
            if (!url) return '';
            const match = url.match(/id=([^&]+)/);
            const fileId = match ? match[1] : url;
            if (fileId.length > 50 || fileId.includes('/')) return url;
            return `https://lh3.googleusercontent.com/d/${fileId}=s${size}`;
        }

        function formatCutInfo(match) {
            let cutsHtml = '';
            for (let i = 1; i <= 3; i++) {
                const type = match[`tipoCorte${i}`];
                if (type) {
                    cutsHtml += `<div class="cut-item"><i class="fas fa-check-circle"></i> <span>Corte ${i}: ${type}</span></div>`;
                }
            }
            return cutsHtml || '<p>No hay cortes registrados aún.</p>';
        }

        function displayMatches(matches) {
            const container = document.getElementById('matches-container');
            container.innerHTML = '<h2>Vehículos Similares Encontrados</h2><p>Hemos encontrado registros que coinciden con tu búsqueda. Selecciona una opción:</p>';

            matches.forEach(match => {
                const yearRange = (match.anoHasta && match.anoHasta != match.anoDesde) ? `${match.anoDesde} - ${match.anoHasta}` : match.anoDesde;
                const card = document.createElement('div');
                card.className = 'match-card';

                const vehicleImg = getImageUrl(match.imagenVehiculo, 400);

                card.innerHTML = `
                    <div class="match-card-header">
                        <img src="${vehicleImg}" class="match-card-img" onerror="this.src='https://via.placeholder.com/120x90?text=Sin+Imagen'">
                        <div class="match-card-info">
                            <h4>${match.marca} ${match.modelo} (${yearRange})</h4>
                            <p><strong>Encendido:</strong> ${match.tipoEncendido}</p>
                            <div class="match-cuts-info">
                                <h5>Cortes Existentes:</h5>
                                ${formatCutInfo(match)}
                            </div>
                        </div>
                    </div>
                    <div class="inline-actions">
                        <p>¿Qué deseas hacer con este vehículo?</p>
                        <button class="btn btn-secondary btn-back-stage1">Volver</button>
                        <button class="btn btn-primary btn-add-cut" data-id="${match.id}">Agregar Nuevo Corte</button>
                        <button class="btn btn-primary btn-add-info" data-id="${match.id}">Info. Adicional</button>
                    </div>
                `;
                container.appendChild(card);
            });

            const newVehicleOption = document.createElement('div');
            newVehicleOption.className = 'inline-actions';
            newVehicleOption.innerHTML = `
                <p>¿Ninguno coincide con lo que buscas?</p>
                <button class="btn btn-secondary btn-back-stage1">Corregir Datos</button>
                <button class="btn btn-primary btn-create-new">Crear Vehículo Nuevo</button>
            `;
            container.appendChild(newVehicleOption);

            // Attach listeners manually since it's a module
            container.querySelectorAll('.btn-back-stage1').forEach(btn => btn.onclick = () => showPhase(1));
            container.querySelectorAll('.btn-add-cut').forEach(btn => btn.onclick = () => proceedToStage2(btn.dataset.id));
            container.querySelectorAll('.btn-add-info').forEach(btn => btn.onclick = () => proceedToStage3(btn.dataset.id));
            container.querySelector('.btn-create-new').onclick = () => proceedToStage2(null);
        }

        // --- STAGE 2: ADD NEW CUT ---
        function proceedToStage2(vehicleId) {
            state.selectedVehicleId = vehicleId;
            const form = document.getElementById('form-stage-2');
            form.reset();
            resetImagePreviews();

            const title = document.getElementById('stage-2-title');
            const newVehicleFields = document.getElementById('new-vehicle-fields');
            const newVehicleImageInput = document.getElementById('imagenVehiculo');

            if (vehicleId) {
                const match = state.matches.find(m => m.id === vehicleId);
                title.textContent = `Paso 2: Agregar Corte a ${match.marca} ${match.modelo}`;
                newVehicleFields.style.display = 'none';
                newVehicleImageInput.required = false;
            } else {
                title.textContent = 'Paso 2: Agregar Vehículo y Corte';
                newVehicleFields.style.display = 'block';
                newVehicleImageInput.required = true;
            }
            showPhase(2);
        }

        async function handleStage2Submit(e) {
            e.preventDefault();
            toggleLoading(true);

            const cutData = {
                tipoCorte1: document.getElementById('tipoCorte1').value,
                configRelay1: document.getElementById('configRelay1').value,
                ubicacionCorte1: document.getElementById('ubicacionCorte1').value,
                colorCableCorte1: document.getElementById('colorCableCorte1').value,
                imgCorte1: await fileToBase64(document.getElementById('imgCorte1').files[0]),
            };

            const vehicleData = state.selectedVehicleId ? null : {
                ...state.vehicleInfo,
                imagenVehiculo: await fileToBase64(document.getElementById('imagenVehiculo').files[0]),
            };

            try {
                const result = await routeAction('addOrUpdateCut', {
                    vehicleId: state.selectedVehicleId,
                    vehicleData,
                    cutData,
                    colaborador: state.colaborador
                });
                state.selectedVehicleId = result.vehicleId;
                alert("Corte guardado exitosamente.");
                proceedToStage3(result.vehicleId);
            } catch(error) {
                alert(`Error al guardar el corte: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // --- STAGE 3: SUPPLEMENTARY INFO ---
        function proceedToStage3(vehicleId) {
            state.selectedVehicleId = vehicleId;
            document.getElementById('form-stage-3').reset();
            resetImagePreviews();
            showPhase(3);
        }

        async function handleStage3Submit(e) {
            e.preventDefault();
            toggleLoading(true);

            const payload = {
                vehicleId: state.selectedVehicleId,
                apertura: document.getElementById('apertura').value,
                cableAlimen: document.getElementById('cableAlimen').value,
                notaImportante: document.getElementById('notaImportante').value,
                imgApertura: await fileToBase64(document.getElementById('imgApertura').files[0]),
                imgCableAlimen: await fileToBase64(document.getElementById('imgCableAlimen').files[0]),
            };

            try {
                await routeAction('addSupplementaryInfo', payload);
                alert("Información guardada. Serás redirigido.");
                window.location.href = 'index.html';
            } catch(error) {
                alert(`Error al guardar: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // --- UI & UTILITY HELPERS ---
        function showPhase(phaseId) {
            document.querySelectorAll('.form-phase').forEach(p => p.classList.remove('active'));
            document.getElementById(`stage-${phaseId}`).classList.add('active');
        }

        function toggleLoading(isLoading) {
            document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
        }

        function populateSelect(id, options, defaultValue = "") {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">Selecciona...</option>';
            if (options) {
                options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`);
            }
            if (defaultValue) select.value = defaultValue;
        }

        function setupImagePreview(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            input.addEventListener('change', () => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { preview.src = e.target.result; };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = '';
                }
            });
        }

        function resetImagePreviews() {
            document.querySelectorAll('.image-preview').forEach(img => img.src = '');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) resolve(null);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>

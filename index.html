<!-- GPSpedia Frontend Component | Version: 4.2.0 -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSpedia | Cat√°logo T√©cnico</title>
<link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w256">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Estilos Globales */
html {
    height: 100%;
}
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    min-height: 100%;
}
h1 { margin: 10px 0; }
h2, h3, h4 {
    margin: 6px 0;
    font-weight: 600;
}
h2 { font-size: 1.2rem; }
h3 { font-size: 1.1rem; }
h4 { font-size: 1.0rem; }

.sticky-header {
    position: sticky;
    top: 0;
    background: #f4f4f4;
    z-index: 1100;
    padding: 10px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.dark-mode .sticky-header {
    background: #121212;
}

.search-and-menu-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}
.search-and-menu-container .search-container {
    flex-grow: 1;
    margin-bottom: 0;
}
.side-menu-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.side-menu-logo {
    height: 32px;
    width: 32px;
    border-radius: 5px;
}
.side-menu-username {
    margin: 0;
    color: #007bff;
}
.btn {
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}
.btn-danger {
    background-color: #dc3545;
    color: white;
}
.btn-padded {
    padding: 8px 12px;
}
.container {
    padding: 20px;
    max-width: 1240px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    flex: 1 0 auto;
}
.backBtn {
    margin-bottom: 15px;
    cursor: pointer;
    color: #007bff;
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}
.backBtn:hover {
    background: #e9f7ff;
}

/* --- ESTILOS DEL ENCABEZADO (Header) --- */
.header-container {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Ajustado para espaciar los elementos */
    flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
    margin-bottom: 20px;
    gap: 15px; /* Espacio entre el logo/t√≠tulo y los controles */
    transition: all 0.35s ease-in-out;
}

.header-branding {
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.35s ease-in-out;
}

.app-logo {
    max-width: 96px;
    height: auto;
    border-radius: 8px;
    /* margin-right ya no es necesario gracias a 'gap' */
    transition: all 0.35s ease-in-out;
}
h1.app-title {
    text-align: left;
    margin: 0;
    font-size: 2.2em;
    color: #333;
    transition: all 0.35s ease-in-out;
}

#header-controls {
    transition: all 0.35s ease-in-out;
}

#install-button {
    display: none; /* Oculto por defecto, JS lo mostrar√° */
    position: fixed; /* Fijo en la pantalla */
    top: 20px;       /* Distancia desde arriba */
    right: 20px;      /* Distancia desde la derecha */
    z-index: 1001;   /* Por encima de otros elementos */
    padding: 10px 20px;
    font-size: 1em;
    font-weight: bold;
    color: #fff;
    background-color: #28a745; /* Verde para la acci√≥n de instalar */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    white-space: nowrap;
}

#install-button:hover {
    background-color: #218838;
    transform: scale(1.05); /* Efecto de zoom ligero */
}

@media (max-width: 680px) {
    .header-container {
        flex-direction: column; /* Apila los elementos verticalmente */
        align-items: center; /* Centra los elementos */
        justify-content: center;
    }
    .header-branding {
        justify-content: center;
        width: 100%;
    }
    h1.app-title {
        font-size: 1.8em;
    }
    #header-controls {
        margin-left: 0; /* Resetea el margen */
        width: 100%;
        justify-content: center; /* Centra los botones */
    }
}

@media (max-width: 480px) {
    #install-button {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.9em;
    }
    #header-controls {
        flex-direction: column; /* Apila el saludo y el bot√≥n de cerrar sesi√≥n */
        align-items: center;
    }
}

/* --- ESTILOS DEL BUSCADOR --- */
.search-container {
    position: relative; /* Contenedor para el bot√≥n de limpiar */
    margin-bottom: 30px;
    padding: 10px 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    transition: all 0.35s ease-in-out;
}

#clear-search-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
}

.search-container.has-text #clear-search-btn {
    opacity: 1;
    pointer-events: all;
}

body.search-active .search-container.has-text #clear-search-btn {
    right: 35px; /* Ajuste de posici√≥n cuando la b√∫squeda est√° activa */
}


.search-container input[type="text"] {
    width: 100%;
    padding: 12px 40px 12px 15px; /* Aumentado padding derecho para el bot√≥n X */
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1em;
    transition: all 0.35s ease-in-out;
}
.search-container input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}

/* --- ESTILOS DEL MEN√ö HAMBURGUESA --- */
#hamburger-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #333;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}
#hamburger-btn:hover {
    background-color: #e0e0e0;
}
#side-menu {
    position: fixed;
    top: 0;
    right: -300px; /* Inicia fuera de la pantalla */
    width: 280px;
    height: 100%;
    background-color: #fff;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 2500;
    transition: right 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
}
#side-menu.open {
    right: 0;
}
#menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2400;
}
#menu-overlay.open {
    display: block;
}
#side-menu nav a {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    text-decoration: none;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}
#side-menu nav a:hover {
    background-color: #f7f7f7;
}
#side-menu nav a i {
    width: 20px; /* Ancho fijo para alinear iconos */
    text-align: center;
    color: #007bff;
}

/* --- ESTILOS DE B√öSQUEDA ACTIVA --- */
body.search-active .app-title,
body.search-active #header-controls,
body.search-active .section-selector,
body.search-active .footer {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px);
    max-height: 0; /* Colapsa el espacio vertical */
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    border: none !important;
}

body.search-active .container {
    padding-top: 80px; /* Crea espacio para la barra de b√∫squeda fija */
    transition: padding-top 0.35s ease-in-out;
}

body.search-active .search-container {
    position: fixed;
    top: 15px;
    left: 0;
    right: 0;
    padding: 0 20px;
    margin: 0;
    max-width: 100%;
    z-index: 1500;
}

body.search-active #searchInput {
    padding-left: 55px; /* Espacio para el logo */
    height: 48px;
    box-sizing: border-box;
}

body.search-active .app-logo {
    position: fixed;
    top: 22px;       /* 15px (search-container top) + 7px (para centrar) */
    left: 30px;      /* 20px (search-container padding) + 10px (margen interno) */
    max-width: 34px;
    z-index: 1501;   /* Por encima del input */
}


/* --- ESTILOS DE LA SELECCI√ìN DE SECCI√ìN --- */
.section-selector {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    transition: all 0.35s ease-in-out;
    flex-wrap: wrap;
    gap: 10px;
}
.section-btn {
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px 16px; /* Padding reducido */
    margin: 0;
    cursor: pointer;
    font-size: 0.9em; /* Fuente ligeramente reducida */
    transition: background-color 0.3s, color 0.3s;
}
.section-btn.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}
.section-btn:hover:not(.active) {
    background-color: #e0e0e0;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}


/* Estilos de la Cuadr√≠cula */
.grid {
    display: grid;
    gap: 20px;
    /* Usar auto-fit para un dise√±o m√°s robusto y responsivo que se ajusta
       autom√°ticamente al n√∫mero de columnas seg√∫n el espacio disponible. */
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
}

/* La media query para 2 columnas ya no es necesaria con auto-fit. */

@media (max-width: 600px) {
    .grid {
        /* En pantallas muy peque√±as, podemos ajustar el gap si es necesario.
           El layout de una columna se manejar√° autom√°ticamente por minmax. */
        gap: 15px;
    }
}

/* Estilos de la Tarjeta (Card) */
@keyframes card-enter {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.card {
    position: relative;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 100%;
    /* justify-self: center; */ /* Eliminado para permitir que la tarjeta ocupe el espacio */
    /* Animaci√≥n de entrada */
    opacity: 0; /* Estado inicial para la animaci√≥n */
    animation: card-enter 0.5s ease-out forwards;
}
.animacion-ejecutada .card {
    /* Deshabilita la animaci√≥n si el contenedor ya la ejecut√≥ */
    animation: none;
    opacity: 1; /* Asegura que la tarjeta sea visible */
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* --- ESTILOS PARA TARJETAS DE LOGO (ICONOS) --- */
.grid .logo-card {
    background: transparent;
    border: none;
    box-shadow: none;
    cursor: pointer;
    padding: 10px;
    text-align: center;
    transition: transform 0.2s ease;
    width: 120px;
    justify-self: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
.grid .logo-card:hover {
    transform: scale(1.1);
}
.logo-card img {
    width: 100%;
    height: 80px;
    object-fit: contain;
    display: block;
}
.logo-card .logo-name {
    font-size: 0.9em;
    font-weight: bold;
    color: #333;
}
.dark-mode .logo-card .logo-name {
    color: #e0e0e0;
}

/* --- ESTILOS DE SKELETON LOADER --- */
.skeleton-grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, 140px);
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
}
.skeleton-card {
    background: #e0e0e0;
    border-radius: 12px;
    width: 140px;
    height: 188px; /* Altura total de la tarjeta real */
    position: relative;
    overflow: hidden;
}
.skeleton-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 150%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: loading-shimmer 1.5s infinite;
}
@keyframes loading-shimmer {
    0% {
        left: -150%;
    }
    100% {
        left: 150%;
    }
}
.card img {
    width: 100%;
    height: 120px;
    object-fit: contain;
    display: block;
    border-radius: 0;
}
.overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
    color: #fff;
    padding: 10px 8px 8px 8px;
    font-size: 0.9em;
    line-height: 1.3;
    font-weight: bold;
    border-radius: 0;
    z-index: 10;
}

/* --- ESTILOS DEL MODAL DE LOGIN --- */
#login-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

#login-modal .modal-content {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 40px;
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    text-align: center;
    color: #f0f0f0;
}

#login-modal h2 {
    margin-bottom: 25px;
    font-size: 2em;
    font-weight: 300;
}

#login-modal .form-group {
    margin-bottom: 20px;
    text-align: left;
}

#login-modal label {
    display: block;
    margin-bottom: 8px;
    font-weight: 300;
    color: #ccc;
}

#login-modal input {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #fff;
    font-size: 1em;
    box-sizing: border-box;
}

#login-modal input:focus {
    outline: none;
    border-color: rgba(0, 123, 255, 0.5);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}

#login-modal button {
    width: 100%;
    padding: 12px;
    background: #007bff;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

#login-modal button:hover {
    background: #0056b3;
}

/* Modal */
#modalDetalle {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background: rgba(0, 0, 0, 0.6); /* Ligeramente m√°s claro */
    color: #000;
    z-index: 1600; /* Aumentado para estar sobre la barra de b√∫squeda */
    display: flex; /* Usar flex para centrar */
    align-items: center;
    justify-content: center;
    /* Transiciones para la aparici√≥n */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#modalDetalle.visible {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
}

#detalleCompleto {
    background: #fff;
    padding: 30px;
    width: 90%;
    max-width: 800px; /* Ancho m√°ximo para el modal */
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    max-height: 90vh;
    overflow-y: auto;
    /* Transici√≥n para el efecto de escalado */
    transform: scale(0.95);
    transition: transform 0.3s ease;
}

#modalDetalle.visible #detalleCompleto {
    transform: scale(1);
}

#detalleCompleto img {
    display: block;
    width: auto; /* Ancho autom√°tico para mantener proporci√≥n */
    max-width: 100%;
    max-height: 300px; /* L√≠mite de altura en lugar de altura fija */
    margin: 15px auto;
    cursor: pointer;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Sombra m√°s pronunciada */
}
.img-vehiculo {
    max-height: 200px !important; /* L√≠mite de altura m√°s peque√±o */
}
/* Regla espec√≠fica para la imagen dentro del modal de Relay para evitar que sea demasiado grande. */
#relayDetalleCompleto img {
    max-height: 250px;
}
#detalleCompleto h4 {
    color: #007bff;
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
}

/* --- ESTILOS PARA SECCIONES DESPLEGABLES (ACORDE√ìN) --- */
.accordion-btn {
    background-color: #f0f0f0;
    color: #007bff; /* Color de texto azul */
    cursor: pointer;
    padding: 15px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 1.1em;
    font-weight: bold;
    transition: background-color 0.3s ease;
    border-radius: 8px;
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.accordion-btn:hover, .accordion-btn.active {
    background-color: #e0e0e0;
}
.accordion-arrow {
    transition: transform 0.3s ease;
    width: 20px;
    height: 20px;
}
.accordion-btn.active .accordion-arrow {
    transform: rotate(180deg); /* Flecha hacia arriba */
}
.panel-desplegable {
    padding: 0 18px;
    background-color: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    border-bottom: 1px solid #eee;
}

/* Lightbox */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Un poco m√°s suave */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1700; /* Aumentado para estar sobre el modal de detalles */
    /* Transiciones */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.lightbox.visible {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
}

.lightbox img {
    max-width: 95%;
    max-height: 95%;
    border-radius: 8px; /* Bordes redondeados sutiles */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    /* Transici√≥n para el efecto de zoom */
    transform: scale(0.95);
    transition: transform 0.3s ease;
}

.lightbox.visible img {
    transform: scale(1);
}

.footer {
    text-align: center;
    padding: 20px 0;
    margin-top: 40px;
    background-color: #333;
    color: #fff;
    font-size: 0.9em;
    display: none; /* Oculto por defecto */
    width: 100%;
    transition: all 0.35s ease-in-out;
}
.footer-links {
    margin-top: 10px; /* Added margin to separate from copyright */
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}
.footer-links a {
    color: #a0cfff;
    text-decoration: none;
    transition: color 0.2s;
    font-size: 0.8em; /* Adjusted to be smaller than the main footer text */
    cursor: pointer; /* Make it look clickable */
}
/* --- ESTILOS PARA MODALES DE INFORMACI√ìN --- */
.info-modal {
    display: none; position: fixed; z-index: 2100; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    align-items: center; justify-content: center;
}
.info-modal-content {
    background-color: #fff; margin: auto; padding: 25px; border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25); width: 90%; max-width: 700px;
    max-height: 90vh; overflow-y: auto; position: relative;
}
.info-close-btn {
    color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px;
    font-weight: bold; cursor: pointer;
}
/* Estilos para el formulario de contacto */
#contact-form .form-group {
    margin-bottom: 15px;
}
#contact-form label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}
#contact-form input,
#contact-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
#contact-form button {
    background-color: #007bff;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
}
#contact-form button:hover {
    background-color: #0056b3;
}
.footer-links a:hover {
    color: #fff;
    text-decoration: underline;
}
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f4f4f4;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000; /* Por encima de todo */
    transition: opacity 0.5s ease-out;
}
#splash-screen img {
    max-width: 150px;
    border-radius: 15px;
    animation: pulse 1.5s infinite ease-in-out;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* --- ESTILOS DEL TOAST DE ERROR GLOBAL --- */
#error-toast {
    display: none; /* Oculto por defecto */
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #dc3545; /* Rojo de error */
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 4000; /* Por encima de todo */
    font-size: 1em;
    max-width: 90%;
    text-align: center;
}
.feedback-btn {
    background: none;
    border: none;
    box-shadow: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9em;
    color: #555;
    padding: 5px;
    border-radius: 5px;
    transition: background-color 0.2s, color 0.2s;
}
#detalleCompleto .feedback-btn:hover {
    background-color: #f0f0f0;
}
#detalleCompleto .feedback-btn.util-btn.pressed {
    background-color: #007bff;
    color: #fff;
    font-weight: bold;
}
.dark-mode #detalleCompleto .feedback-btn {
    color: #bbb;
}
.dark-mode #detalleCompleto .feedback-btn:hover {
    background-color: #333;
}
.dark-mode #detalleCompleto .feedback-btn.util-btn.pressed {
    background-color: #0056b3;
    color: #fff;
}
.feedback-btn.report-btn {
    color: #dc3545;
}
.inbox-item-actions button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    align-self: flex-start; /* Alinea los botones a la izquierda */
    transition: background-color 0.2s;
}
.inbox-item-actions button:hover {
    background-color: #0056b3;
}
.inbox-item-actions .delete-btn {
    background-color: #dc3545; /* Rojo para eliminar */
    margin-left: auto; /* Empuja el bot√≥n de eliminar a la derecha */
}
.inbox-item-actions .delete-btn:hover {
    background-color: #c82333;
}

/* --- ESTILOS DEL SISTEMA DE NOTIFICACIONES --- */
#notification-bell {
    position: relative;
    cursor: pointer;
    font-size: 20px;
    color: #333;
}
.dark-mode #notification-bell {
    color: #e0e0e0;
}
#notification-badge {
    position: absolute;
    top: -5px;
    right: -10px;
    background: red;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    display: none; /* Oculto por defecto */
}
#notification-dropdown {
    display: none;
    position: absolute;
    top: 50px;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    width: 350px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 2600; /* Por encima del men√∫ lateral */
}
.dark-mode #notification-dropdown {
    background: #2c2c2c;
    border-color: #444;
}
.notification-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    font-size: 0.9em;
}
.dark-mode .notification-item {
    border-bottom-color: #444;
}
.notification-item:last-child {
    border-bottom: none;
}
#notification-footer {
    padding: 10px;
    text-align: center;
    background: #f7f7f7;
}
.dark-mode #notification-footer {
    background: #333;
}
#mark-all-read-btn {
    background: none;
    border: none;
    color: #007bff;
    cursor: pointer;
    font-weight: bold;
}


.report-section textarea {
    width: 100%;
    box-sizing: border-box;
    margin-top: 10px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
}
.report-section button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
}
.comments-section {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
.comment {
    font-size: 0.8em;
    margin-bottom: 10px;
}
.comment .user {
    font-weight: bold;
    color: #333;
}
.comment .text {
    color: #555;
}
.comment .response {
    margin-left: 15px;
    padding-left: 10px;
    border-left: 2px solid #007bff;
    margin-top: 5px;
}
.comment .responder {
    font-weight: bold;
    color: #0056b3;
}

@media (prefers-color-scheme: dark) {
    body {
        background: #121212;
        color: #e0e0e0;
    }
    .card, #side-menu, #detalleCompleto, .info-modal-content {
        background: #1e1e1e;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    h1.app-title, h2, h3, h4, #side-menu nav a {
        color: #e0e0e0;
    }
    .search-container input[type="text"], #contact-form input, #contact-form textarea {
        background: #2c2c2c;
        border-color: #444;
        color: #e0e0e0;
    }
    .section-btn {
        background-color: #333;
        border-color: #555;
        color: #e0e0e0;
    }
    .section-btn.active {
        background-color: #007bff;
        color: #fff;
        border-color: #007bff;
    }
    #hamburger-btn {
        color: #e0e0e0;
    }
    .accordion-btn {
        background-color: #2a2a2a;
        color: #00aaff;
    }
    .accordion-btn:hover, .accordion-btn.active {
        background-color: #383838;
    }
    .panel-desplegable {
        background-color: #1e1e1e;
        border-bottom-color: #333;
    }
    #detalleCompleto h4 {
        border-bottom-color: #333;
    }
    .footer {
        background-color: #1e1e1e;
        color: #aaa;
    }
}
</style>
</head>
<body>
<!-- Contenedor de la Consola de Depuraci√≥n -->
<div id="debug-console" style="display: none; position: fixed; bottom: 10px; right: 10px; width: 450px; height: 350px; background-color: rgba(20, 20, 30, 0.9); color: #00ff00; border: 1px solid #00ff00; border-radius: 8px; z-index: 9999; display: flex; flex-direction: column; font-family: 'Courier New', Courier, monospace; box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); backdrop-filter: blur(5px);">
    <div id="debug-header" style="padding: 8px; background-color: #00ff00; color: #14141e; font-weight: bold; cursor: move; border-top-left-radius: 7px; border-top-right-radius: 7px; display: flex; justify-content: space-between; align-items: center;">
        <span>GPSpedia Debug Console</span>
        <div>
            <button id="debug-clear" style="background:none; border:none; color:#14141e; cursor:pointer; font-size: 14px; margin-right: 5px;">[Clear]</button>
            <button id="debug-close" style="background:none; border:none; color:#14141e; cursor:pointer; font-size: 16px;">[X]</button>
        </div>
    </div>
    <div id="debug-log" style="flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 13px; line-height: 1.4;"></div>
    <div id="debug-resize-handle" style="height: 10px; background-color: #00ff00; cursor: ns-resize;"></div>
</div>
<!-- Notificaci√≥n de Error Global -->
<div id="error-toast"></div>

<!-- Side Menu (Hamburger) -->
<div id="menu-overlay"></div>
<div id="side-menu">
    <div style="padding: 20px; border-bottom: 1px solid #eee; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w64" alt="Logo" style="height: 32px; width: 32px; border-radius: 5px;">
        <h3 id="menu-username" style="margin: 0; color: #007bff;"></h3>
    </div>
    <nav>
        <a href="#" id="menu-cortes" class="menu-link"><i class="fa-solid fa-car-on"></i> Cortes</a>
        <a href="add_cortes.html" class="menu-link"><i class="fa-solid fa-plus-circle"></i> Agregar Nuevo</a>
        <a href="#" id="menu-tutoriales" class="menu-link"><i class="fa-solid fa-book-open"></i> Tutoriales</a>
        <a href="#" id="menu-relay" class="menu-link"><i class="fa-solid fa-microchip"></i> Configuraci√≥n Relay</a>
        <a href="users.html" class="menu-link"><i class="fa-solid fa-users-cog"></i> Mi Perfil / Usuarios</a>
        <a href="#" id="menu-inbox" class="menu-link" style="display: none;"><i class="fa-solid fa-inbox"></i> Inbox de Reportes</a>
        <a href="#" id="dev-tools-btn" class="menu-link"><i class="fa-solid fa-code"></i> Desarrollador</a>
    </nav>
    <div style="margin-top: auto; padding: 20px;">
        <button id="side-menu-logout-button" style="width: 100%; background: #dc3545; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">Cerrar Sesi√≥n</button>
    </div>
</div>

<!-- Splash Screen -->
<div id="splash-screen">
    <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w512" alt="Logo de GPSpedia">
</div>

<!-- Login Modal -->
<div id="login-modal" style="display: none;">
    <div class="modal-content">
        <img src="icon-v3-512x512.png" alt="Logo de GPSpedia" style="max-width: 120px; margin-bottom: 20px;">
        <h2>Iniciar Sesi√≥n</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Usuario</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <button type="submit">Acceder</button>
            <p id="login-error" style="color: red; display: none;"></p>
        </form>
        <a href="#" id="forgot-password-link" style="color: #a0cfff; text-decoration: none; margin-top: 15px; display: inline-block;">¬øOlvidaste tu contrase√±a?</a>
    </div>
</div>

<div class="container" style="display: none;">

  <div class="header-container">
      <div class="header-branding" style="flex-direction: column; align-items: flex-start;">
          <div style="display: flex; align-items: center;">
              <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
              <h1 class="app-title">GPSpedia</h1>
          </div>
          <div id="welcome-message-container" style="padding-left: 10px;">
             <span id="welcome-message" style="display: none; color: #333; font-weight: bold; font-size: 0.8em;"></span>
          </div>
      </div>
      <div id="header-controls" style="display: flex; align-items: center; gap: 15px; position: relative;">
          <div id="notification-bell" style="display: none;">
              <i class="fa-solid fa-bell"></i>
              <span id="notification-badge"></span>
          </div>
          <div id="notification-dropdown">
              <div id="notification-list"></div>
              <div id="notification-footer">
                  <button id="mark-all-read-btn">Marcar todo como le√≠do</button>
              </div>
          </div>
          <button id="logout-button" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">Cerrar Sesi√≥n</button>
      </div>
  </div>

  <!-- El bot√≥n de instalaci√≥n se mueve fuera del header-controls para que no se oculte con la b√∫squeda -->
  <button id="install-button" style="display: none;">Instalar Aplicaci√≥n</button>

  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
      <div class="search-container" style="flex-grow: 1;">
          <input type="text" id="searchInput" placeholder="Buscar Corte..." oninput="filtrarContenido(this.value)">
          <button id="clear-search-btn" title="Limpiar b√∫squeda">&times;</button>
      </div>
      <button id="hamburger-btn"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="section-selector">
      <button id="btn-cortes" class="section-btn active" onclick="mostrarSeccion('cortes')">Cortes</button>
      <button id="btn-tutoriales" class="section-btn" onclick="mostrarSeccion('tutoriales')">Tutoriales</button>
      <button id="btn-relay" class="section-btn" onclick="mostrarSeccion('relay')">Relay</button>
  </div>

  <div id="contenido" class="content-section"></div>
  <div id="contenido-tutoriales" class="content-section" style="display: none;"></div>
  <div id="contenido-relay" class="content-section" style="display: none;"></div>
</div>

<div id="modalDetalle">
  <div id="detalleCompleto"></div>
</div>

<div id="lightbox" class="lightbox" onclick="cerrarLightbox()">
  <img id="lightboxImg" src="">
</div>

<!-- ========= MODAL DE SEGUNDO NIVEL (PARA RELAY) ========= -->
<div id="modalRelay" class="info-modal">
    <div class="info-modal-content" id="relayDetalleCompleto">
        <!-- El contenido del detalle del Relay se inyectar√° aqu√≠ con JavaScript -->
    </div>
</div>

<!-- ========= MODAL DE DESARROLLADOR ========= -->
<div id="dev-modal" class="info-modal">
    <div class="info-modal-content" style="max-width: 900px; display: flex; gap: 20px;">
        <span class="info-close-btn">&times;</span>
        <!-- Panel de Control -->
        <div id="dev-controls" style="width: 250px; border-right: 1px solid #ccc; padding-right: 20px;">
            <h4>Herramientas de Migraci√≥n</h4>
            <button id="migrate-years-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Migrar A√±os</button>
            <button id="migrate-timestamps-btn" class="btn btn-primary" style="width: 100%;">Migrar Timestamps</button>
            <div id="migration-status" style="margin-top: 15px; font-size: 0.9em;"></div>
        </div>
        <!-- Contenedor para la Consola -->
        <div id="dev-console-container" style="flex-grow: 1; min-height: 400px;">
             <!-- La consola de depuraci√≥n se mover√° aqu√≠ con JS -->
        </div>
    </div>
</div>

<!-- ========= MODAL DE INBOX DE REPORTES ========= -->
<div id="inbox-modal" class="info-modal">
    <div class="info-modal-content" style="max-width: 800px;">
        <span class="info-close-btn">&times;</span>
        <h2>Inbox de Reportes</h2>
        <div id="inbox-content"></div>
    </div>
</div>


<!-- ========= MODALES DE INFORMACI√ìN ========= -->
<div id="about-us-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Sobre Nosotros</h2>
    <p>GPSpedia es una plataforma especializada en la consulta t√©cnica y estandarizada de informaci√≥n vehicular, orientada a t√©cnicos, instaladores y profesionales que trabajan con sistemas de rastreo, seguridad y control vehicular.</p>
    <p>Nuestro objetivo es facilitar el acceso r√°pido y confiable a informaci√≥n pr√°ctica, reduciendo errores en campo y optimizando los tiempos de instalaci√≥n mediante una base de conocimiento clara, visual y en constante evoluci√≥n.</p>
    <p>La informaci√≥n que se presenta en GPSpedia es el resultado de una recopilaci√≥n estructurada de datos t√©cnicos provenientes de m√∫ltiples fuentes de libre acceso, experiencias pr√°cticas y aportes colaborativos. No reclamamos derechos de autor sobre dicha informaci√≥n t√©cnica; su prop√≥sito es educativo, operativo y de apoyo profesional.</p>
    <hr>
    <h4>¬øQu√© ofrece GPSpedia?</h4>
    <p><strong>üîß Informaci√≥n de cortes vehiculares:</strong> Identificaci√≥n de puntos de corte el√©ctrico e ignici√≥n. Detalles claros sobre ubicaci√≥n, color del cable y tipo de corte recomendado.</p>
    <p><strong>üöó Tipos de cortes disponibles:</strong> Paro de motor (apagado remoto) y apertura de puertas.</p>
    <hr>
    <h4>Configuraciones de Relay</h4>
    <p>GPSpedia incluye una secci√≥n dedicada a configuraciones de relay, donde se explican de forma visual y descriptiva la funci√≥n de cada pin, su uso recomendado y diagramas claros para facilitar la correcta conexi√≥n.</p>
    <hr>
    <h4>Tutoriales y gu√≠as visuales</h4>
    <p>Ofrecemos tutoriales paso a paso y gu√≠as visuales para la ubicaci√≥n de m√≥dulos, desarme b√°sico de interiores y reconocimiento de cableado.</p>
    <hr>
    <h4>Enfoque colaborativo y mejora continua</h4>
    <p>GPSpedia evoluciona constantemente gracias a la retroalimentaci√≥n de sus usuarios, lo que permite mejorar la precisi√≥n de la informaci√≥n y ampliar la cobertura de marcas y modelos.</p>
  </div>
</div>

<div id="contact-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Cont√°ctanos</h2>
    <p>Si tienes sugerencias, problemas con la plataforma o necesitas soporte t√©cnico, por favor utiliza este formulario. Tu feedback es importante para nosotros.</p>
    <form id="contact-form">
      <div class="form-group">
        <label for="contact-name">Nombre</label>
        <input type="text" id="contact-name" required>
      </div>
      <div class="form-group">
        <label for="contact-email">Correo Electr√≥nico</label>
        <input type="email" id="contact-email" required>
      </div>
      <div class="form-group">
        <label for="contact-message">Mensaje</label>
        <textarea id="contact-message" rows="4" required></textarea>
      </div>
      <button type="submit" class="btn">Enviar Mensaje</button>
    </form>
  </div>
</div>

<div id="faq-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Preguntas Frecuentes (FAQ)</h2>
    <div class="accordion">
      <div class="accordion-item"><div class="accordion-header">¬øGPSpedia es un sistema de rastreo GPS?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>No. GPSpedia no rastrea veh√≠culos ni gestiona dispositivos. Es una plataforma informativa y de consulta t√©cnica.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øLa informaci√≥n tiene derechos de autor?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>La informaci√≥n t√©cnica presentada es una compilaci√≥n de datos de libre acceso y conocimiento pr√°ctico, organizada con fines educativos y profesionales. GPSpedia no reclama autor√≠a exclusiva sobre dicha informaci√≥n.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øPuedo usar esta informaci√≥n en instalaciones reales?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. El contenido est√° pensado para apoyo t√©cnico, pero siempre se recomienda que las instalaciones sean realizadas por personal capacitado y siguiendo buenas pr√°cticas de seguridad el√©ctrica.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øIncluye informaci√≥n para diferentes tipos de veh√≠culos?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. La plataforma contempla distintas categor√≠as vehiculares, como autom√≥viles, camiones, motocicletas y equipos especiales, seg√∫n disponibilidad de informaci√≥n.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øLa informaci√≥n se actualiza?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. GPSpedia est√° dise√±ada para crecer y mejorar continuamente, incorporando nuevos datos, correcciones y ampliaciones conforme se valida su uso en campo.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øGPSpedia ense√±a c√≥mo instalar dispositivos?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>GPSpedia no sustituye la capacitaci√≥n profesional, pero ofrece referencias t√©cnicas, diagramas y gu√≠as que facilitan el trabajo de t√©cnicos con experiencia.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øC√≥mo obtengo una cuenta?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>Para solicitar acceso, completa el formulario disponible en la secci√≥n ‚ÄúCont√°ctanos‚Äù. Nuestro equipo revisar√° la solicitud y te brindar√° seguimiento conforme al uso profesional de la plataforma.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øQu√© hacer si no est√° la informaci√≥n de un veh√≠culo?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>Si un veh√≠culo no cuenta a√∫n con informaci√≥n espec√≠fica, GPSpedia ofrece tutoriales descriptivos y material audiovisual que facilitan la identificaci√≥n de cables de corte, puntos de ignici√≥n y configuraciones comunes.</p></div></div>
    </div>
  </div>
</div>

<script src="api-manager.js"></script>
<script>
// --- SISTEMA DE DEPURACI√ìN AVANZADO DEL FRONTEND ---

// La consola de depuraci√≥n ahora se controla mediante un modal, por lo que no la mostramos al inicio.
const isDebugMode = new URLSearchParams(window.location.search).has('debug');
const debugConsole = document.getElementById('debug-console');

// if (isDebugMode) {
//     debugConsole.style.display = 'flex';
// }

/**
 * Registra un mensaje en la consola de depuraci√≥n del frontend.
 * @param {string} type - El tipo de log (p.ej., 'API_REQUEST', 'API_RESPONSE', 'ERROR', 'INFO').
 * @param {string} message - El mensaje principal a registrar.
 * @param {object} data - Un objeto con datos adicionales para mostrar.
 */
function debugLog(type, message, data) {
    if (!isDebugMode) return;

    const logEntry = document.createElement('div');
    logEntry.style.marginBottom = '10px';
    logEntry.style.borderBottom = '1px dashed #333';
    logEntry.style.paddingBottom = '10px';

    const timestamp = new Date().toLocaleTimeString();
    let color = '#00ff00'; // Verde por defecto
    if (type.includes('ERROR') || type.includes('FAIL')) {
        color = '#ff4136'; // Rojo para errores
    } else if (type.includes('REQUEST')) {
        color = '#7FDBFF'; // Azul claro para peticiones
    } else if (type.includes('RESPONSE')) {
        color = '#39CCCC'; // Turquesa para respuestas
    }

    let html = `<strong style="color: ${color};">[${type}]</strong> <span style="color: #aaa;">${timestamp}</span><br/>${message}`;

    if (data) {
        // Formatear el objeto de datos como un JSON bonito
        const jsonData = JSON.stringify(data, null, 2);
        html += `<pre style="background-color: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px; margin-top: 5px; color: #fff; white-space: pre-wrap; word-wrap: break-word;">${jsonData}</pre>`;
    }

    logEntry.innerHTML = html;
    const debugLogDiv = document.getElementById('debug-log');
    debugLogDiv.appendChild(logEntry);
    debugLogDiv.scrollTop = debugLogDiv.scrollHeight; // Auto-scroll hacia abajo
}

// L√≥gica para hacer la consola arrastrable y redimensionable
const header = document.getElementById('debug-header');
const resizeHandle = document.getElementById('debug-resize-handle');
const closeButton = document.getElementById('debug-close');
const clearButton = document.getElementById('debug-clear');

let isDragging = false;
let isResizing = false;
let initialX, initialY, initialWidth, initialHeight;
let offsetX, offsetY;

header.addEventListener('mousedown', (e) => {
    isDragging = true;
    const rect = debugConsole.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    document.body.style.userSelect = 'none'; // Evitar seleccionar texto mientras se arrastra
});

resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    initialHeight = debugConsole.offsetHeight;
    initialY = e.clientY;
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        debugConsole.style.left = `${e.clientX - offsetX}px`;
        debugConsole.style.top = `${e.clientY - offsetY}px`;
        // Eliminar bottom y right para que no interfieran con el posicionamiento
        debugConsole.style.bottom = 'auto';
        debugConsole.style.right = 'auto';
    }
    if (isResizing) {
        const newHeight = initialHeight - (e.clientY - initialY);
        debugConsole.style.height = `${newHeight}px`;
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
    isResizing = false;
    document.body.style.userSelect = 'auto';
});

closeButton.addEventListener('click', () => {
    debugConsole.style.display = 'none';
});

clearButton.addEventListener('click', () => {
    document.getElementById('debug-log').innerHTML = '';
});

// Sobrescribir window.onerror para capturar todos los errores de JS
window.onerror = function(message, source, lineno, colno, error) {
    debugLog('JAVASCRIPT_ERROR', `Error no capturado: ${message}`, {
        source: `${source}:${lineno}:${colno}`,
        stack: error ? error.stack : 'No disponible'
    });
    // Devuelve false para que el error tambi√©n se muestre en la consola del navegador
    return false;
};


// --- L√ìGICA DE DEPURACI√ìN REMOTA (SE MANTIENE PERO AHORA TAMBI√âN LOGUEA LOCALMENTE) ---
function remoteLog(level, message, data = {}) {
    // Loguear en la nueva consola de depuraci√≥n local
    debugLog(`REMOTE_${level}`, message, data);

    // Non-blocking call to the backend logger
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'logFrontend', payload: { level, message, data } }),
        keepalive: true // Ensure the request is sent even if the page is closing
    }).catch(error => {
        debugLog('REMOTE_FAIL', 'Fallo al enviar log remoto', { error: error.message });
    });
}

// --- L√ìGICA DE INDEXEDDB ---
const DB_NAME = 'gpsepedia-db';
const DB_VERSION = 2; // Incremented version to update schema
const CATALOG_STORE = 'catalog';

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(CATALOG_STORE)) {
                db.createObjectStore(CATALOG_STORE, { keyPath: 'id' });
            }
        };
        request.onsuccess = (event) => {
            resolve(event.target.result);
        };
        request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.errorCode);
            reject(event.target.errorCode);
        };
    });
}

async function saveDataToDB(data) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([CATALOG_STORE], 'readwrite');
        const store = transaction.objectStore(CATALOG_STORE);
        // Clear old data
        store.clear();
        const request = store.put({ id: 'full-catalog', ...data });

        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

async function getDataFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([CATALOG_STORE], 'readonly');
        const store = transaction.objectStore(CATALOG_STORE);
        const request = store.get('full-catalog');

        request.onsuccess = (event) => {
            resolve(event.target.result);
        };
        request.onerror = (event) => reject(event.target.error);
    });
}


// --- L√ìGICA DE DATOS Y API ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpIFH1nX2BZEjAKbpq9HJpEGNlo_0LqD1CwxWsWFo5J0AJDdbfMrKpcsAV4ZFJzFWd/exec";
const SESSION_KEY = 'gpsepedia_session';

// --- L√ìGICA DE AUTENTICACI√ìN Y SESI√ìN ---

function sanitizeInput(input) {
    if (typeof input !== 'string') return '';
    // Prevenir inyecci√≥n de f√≥rmulas de Excel escapando caracteres iniciales peligrosos
    let sanitized = input.trim();
    if (['=', '+', '-', '@', '\t', '\r'].includes(sanitized.charAt(0))) {
        sanitized = "'" + sanitized;
    }
    // La sanitizaci√≥n de SQL se elimin√≥ para evitar la alteraci√≥n de contrase√±as
    // con caracteres especiales, que estaba causando fallos de autenticaci√≥n.
    return sanitized;
}

const SESSION_ID_KEY = 'gpsepedia_session_id';
// La funci√≥n postToAction ahora es reemplazada por routeAction del api-manager.js
async function postToAction(action, payload = {}) {
    debugLog('API_REQUEST', `Ejecutando acci√≥n: ${action}`, payload);

    try {
        // Usamos el nuevo enrutador
        const result = await routeAction(action, payload);
        debugLog('API_RESPONSE', `Respuesta recibida para: ${action}`, result);
        return result;
    } catch (error) {
        debugLog('API_ERROR', `Error en la acci√≥n: ${action}`, {
            name: error.name,
            message: error.message,
            stack: error.stack
        });

        let userMessage = `Error inesperado: ${error.message}`;
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            userMessage = "Fallo de conexi√≥n con el servidor. Por favor, verifica tu conexi√≥n a internet e int√©ntalo de nuevo. Si el problema persiste, contacta al administrador.";
        } else if (error.message.includes('JSON')) {
            userMessage = "La respuesta del servidor no es v√°lida. Por favor, contacta al administrador.";
        } else if (error.message.includes('Credenciales inv√°lidas')) {
            userMessage = "El usuario o la contrase√±a son incorrectos.";
        }

        const loginErrorElement = document.getElementById('login-error');
        if (loginErrorElement && loginErrorElement.offsetParent !== null) {
            // Solo muestra el error en el modal de login si est√° visible
            loginErrorElement.textContent = userMessage;
            loginErrorElement.style.display = 'block';
        } else {
            // Si no, usa el sistema de notificaci√≥n global
            showGlobalError(userMessage);
        }

        throw error; // Re-lanzar el error
    }
}

let errorToastTimeout;
function showGlobalError(message) {
    const toast = document.getElementById('error-toast');
    if (!toast) return;

    toast.textContent = message;
    toast.style.display = 'block';

    // Limpiar cualquier timeout anterior para resetear el timer
    if (errorToastTimeout) {
        clearTimeout(errorToastTimeout);
    }

    // Ocultar el toast despu√©s de 7 segundos
    errorToastTimeout = setTimeout(() => {
        toast.style.display = 'none';
    }, 7000);
}

async function checkSession() {
    remoteLog('INFO', 'checkSession started');
    const sessionData = localStorage.getItem(SESSION_KEY);
    if (sessionData) {
        remoteLog('INFO', 'Session data found in localStorage.');
        try {
            const user = JSON.parse(sessionData);
            remoteLog('INFO', 'Attempting to validate session for user.', { userId: user.ID });
            const result = await postToAction('validateSession', { userId: user.ID, sessionToken: user.SessionToken });

            if (result.valid) {
                remoteLog('INFO', 'Session is valid. Initializing app.');
                await initializeAppData(user);
            } else {
                remoteLog('WARN', 'Session is invalid according to backend. Logging out.');
                logout("Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n de nuevo.");
            }
        } catch (error) {
            remoteLog('ERROR', 'Error during session validation.', { error: error.message, stack: error.stack });
            showLoginHideApp();
        }
    } else {
        remoteLog('INFO', 'No session data found. Showing login.');
        showLoginHideApp();
    }
}

async function login(username, password) {
    try {
        const result = await postToAction('login', { username, password });
        // La respuesta de login ahora contiene el objeto 'user' completo, incluyendo el nuevo SessionToken.
        // Al guardar este objeto, estamos actualizando el token en localStorage autom√°ticamente.
        localStorage.setItem(SESSION_KEY, JSON.stringify(result.user));
        await initializeAppData(result.user);
    } catch (error) {
        // El error ya se muestra en postToAction
    }
}

function renderContentFromData(data) {
    if (!data) {
        debugLog('RENDER_ERROR', 'renderContentFromData fue llamado sin datos.');
        document.getElementById('contenido').innerHTML = `<p style="color:red; text-align:center;">Ocurri√≥ un error al procesar los datos.</p>`;
        return;
    }
    datosOriginales = data.cortes || [];
    datosTutoriales = data.tutoriales || [];
    datosRelay = data.relay || [];
    datosLogos = data.logos || [];
    // Limpiar el contenido antes de renderizar para evitar duplicados
    document.getElementById('contenido').innerHTML = '';
    mostrarUltimosAgregados();
    mostrarCategorias();
    lazyLoadImages(); // Re-run lazy loader after new content is added
}

async function initializeAppData(user) {
    hideLoginShowApp();
    document.getElementById('welcome-message').textContent = `Bienvenido, ${user.Nombre_Usuario}`;
    document.getElementById('welcome-message').style.display = 'block';

    showSkeletonLoader(document.getElementById('contenido'));

    try {
        // 1. Network-first attempt
        debugLog('CACHE_STRATEGY', 'Intentando obtener datos de la red...');
        const result = await postToAction('getCatalogData');
        const freshData = result.data;

        debugLog('CACHE_STRATEGY', 'Datos obtenidos de la red exitosamente.');
        renderContentFromData(freshData);

        // 2. Update cache in the background
        saveDataToDB(freshData)
            .then(() => debugLog('CACHE_STRATEGY', 'Cache de IndexedDB actualizado.'))
            .catch(err => debugLog('CACHE_ERROR', 'No se pudo actualizar el cache.', { error: err.message }));

    } catch (networkError) {
        // 3. Fallback to cache
        debugLog('CACHE_STRATEGY', 'Fallo en la red, intentando obtener datos del cache...', { error: networkError.message });
        showGlobalError("Fallo de conexi√≥n. Mostrando datos locales.");

        try {
            const cachedDataContainer = await getDataFromDB();
            if (cachedDataContainer && cachedDataContainer.cortes) {
                // The data is nested inside the container object, without the 'id' property.
                const { id, ...cachedData } = cachedDataContainer;
                debugLog('CACHE_STRATEGY', 'Datos cargados desde el cache exitosamente.');
                renderContentFromData(cachedData);
            } else {
                throw new Error('No hay datos en el cache.');
            }
        } catch (cacheError) {
            debugLog('CACHE_ERROR', 'Fallo al cargar desde el cache.', { error: cacheError.message });
            document.getElementById('contenido').innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar el cat√°logo. Por favor, revisa tu conexi√≥n a internet e int√©ntalo de nuevo.</p>`;
            // Rethrow the error to be caught by the caller (checkSession)
            throw cacheError;
        }
    }
}

function logout(reason = null) {
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem(SESSION_ID_KEY);

    showLoginHideApp(reason);
}

function showLoginHideApp(reason = null) {
    // La l√≥gica de visibilidad es cr√≠tica y debe ejecutarse sin interrupciones.
    try {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.style.display = 'none';

        const container = document.querySelector('.container');
        if (container) container.style.display = 'none';

        const footer = document.querySelector('.footer');
        if (footer) footer.style.display = 'none';

        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) welcomeMsg.style.display = 'none';

        const loginModal = document.getElementById('login-modal');
        if (loginModal) loginModal.style.display = 'flex';

        const loginError = document.getElementById('login-error');
        if (loginError) {
            if (reason) {
                loginError.textContent = reason;
                loginError.style.display = 'block';
            } else {
                loginError.style.display = 'none';
            }
        }

        const usernameInput = document.getElementById('username');
        if (usernameInput) usernameInput.value = '';

        const passwordInput = document.getElementById('password');
        if (passwordInput) passwordInput.value = '';

    } catch (e) {
        // Si incluso la l√≥gica de visibilidad falla, loguear localmente.
        debugLog('CRITICAL_ERROR', 'Fallo al modificar la visibilidad de los elementos base.', { error: e.message, stack: e.stack });
    }

    // El logging es secundario y se a√≠sla para que no interrumpa el renderizado.
    try {
        remoteLog('INFO', 'showLoginHideApp finalizado.', { reason });
    } catch (e) {
        // El fallo de remoteLog ya se captura internamente, no es necesario hacer nada aqu√≠.
    }
}

function hideLoginShowApp() {
    remoteLog('INFO', 'hideLoginShowApp called');
    // Ocultar splash y login
    const splash = document.getElementById('splash-screen');
    splash.style.opacity = '0';
    setTimeout(() => {
        splash.style.display = 'none';
    }, 500); // Coincide con la transici√≥n de opacidad

    document.getElementById('login-modal').style.display = 'none';
    remoteLog('INFO', 'Login modal display style set to none.');

    // Mostrar contenido principal y footer
    document.querySelector('.container').style.display = 'block';
    const footer = document.querySelector('.footer');
    if (footer) footer.style.display = 'block';

    // Cargar nombre de usuario en el men√∫ lateral
    const menuUsername = document.getElementById('menu-username');
    const session = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (menuUsername && session && session.Nombre_Usuario) {
        menuUsername.textContent = session.Nombre_Usuario;
    }

    // Show inbox for supervisors and jefes
    const inboxLink = document.getElementById('menu-inbox');
    if (inboxLink && session && (session.Privilegios === 'Supervisor' || session.Privilegios === 'Jefe' || session.Privilegios === 'Desarrollador')) {
        inboxLink.style.display = 'flex';
    }

    // Initialize notifications for all users
    initializeNotifications();
}

// --- L√ìGICA DEL SISTEMA DE NOTIFICACIONES ---

async function initializeNotifications() {
    const bell = document.getElementById('notification-bell');
    const badge = document.getElementById('notification-badge');
    const dropdown = document.getElementById('notification-dropdown');
    const list = document.getElementById('notification-list');
    const markAllReadBtn = document.getElementById('mark-all-read-btn');

    // Solo mostrar la campana si el elemento existe (evita errores si el HTML cambia)
    if (!bell) return;

    try {
        const result = await routeAction('getUnreadNotifications');
        if (result.status === 'success' && result.data) {
            const notifications = result.data;
            bell.style.display = 'block'; // Mostrar la campana

            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.style.display = 'block';
                list.innerHTML = ''; // Limpiar lista anterior
                notifications.forEach(n => {
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.textContent = n.message;
                    list.appendChild(item);
                });
            } else {
                badge.style.display = 'none';
                list.innerHTML = '<div class="notification-item">No tienes notificaciones nuevas.</div>';
            }
        }
    } catch (error) {
        console.error("Error fetching notifications:", error);
        bell.style.display = 'none'; // Ocultar si hay un error
    }

    bell.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    markAllReadBtn.addEventListener('click', async () => {
        try {
            await routeAction('markNotificationsAsRead');
            badge.style.display = 'none';
            list.innerHTML = '<div class="notification-item">No tienes notificaciones nuevas.</div>';
            setTimeout(() => { dropdown.style.display = 'none'; }, 500); // Ocultar dropdown despu√©s de un momento
        } catch (error) {
            alert('Error al marcar las notificaciones como le√≠das.');
        }
    });

    // Cerrar dropdown si se hace clic fuera
    document.addEventListener('click', (e) => {
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
}


document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = sanitizeInput(document.getElementById('username').value);
    const password = document.getElementById('password').value; // Eliminado sanitizeInput
    login(username, password);
});

document.getElementById('forgot-password-link').addEventListener('click', (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const message = encodeURIComponent(`Hola, necesito recuperar mi contrase√±a. Mi nombre de usuario es: ${username}`);
    const whatsappUrl = `https://wa.me/50488422786?text=${message}`;
    window.open(whatsappUrl, '_blank');
});

// Listener para detectar cambios de sesi√≥n en otras pesta√±as
window.addEventListener('storage', (event) => {
    if (event.key === 'session_update' || event.key === SESSION_ID_KEY) {
        checkSession();
    }
});

function showSkeletonLoader(container) {
    let skeletonHTML = '<div class="skeleton-grid">';
    for (let i = 0; i < 10; i++) { // Muestra 10 tarjetas esqueleto
        skeletonHTML += '<div class="skeleton-card"></div>';
    }
    skeletonHTML += '</div>';
    container.innerHTML = skeletonHTML;
}

// --- VARIABLES GLOBALES DE DATOS ---
let datosOriginales = [], datosFiltrados = [], datosTutoriales = [], datosRelay = [];
let estado = { nivel: "categorias", categoria: null, marca: null, modelo: null };
let appOpenedFromLink = false;

const backSvg = '<svg style="width:20px;height:20px;margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>';

// La funci√≥n syncAndFetchData ha sido eliminada. La carga de datos ahora se centraliza en initializeAppData.

function mostrarSeccion(seccion) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput.value !== '') {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));

    const containerId = `contenido${seccion === 'cortes' ? '' : '-' + seccion}`;
    const renderFunction = {
        cortes: mostrarCategorias,
        tutoriales: mostrarContenidoTutoriales,
        relay: mostrarContenidoRelay
    }[seccion];

    document.getElementById(containerId).style.display = 'block';
    document.getElementById(`btn-${seccion}`).classList.add('active');

    if (renderFunction) {
        renderFunction();
    }
}

function irAPaginaPrincipal() {
    mostrarSeccion('cortes');
}

function mostrarContenidoTutoriales() {
    const cont = document.getElementById("contenido-tutoriales");
    cont.innerHTML = "<h4>Tutoriales</h4>";
    const grid = document.createElement("div");
    grid.className = "grid"; // Asegurarse de que el contenedor tiene la clase 'grid'
    if (!datosTutoriales || datosTutoriales.length === 0) {
        cont.innerHTML += "<p>No hay tutoriales disponibles.</p>";
        return;
    }

    datosTutoriales.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarDetalleTutorial(item);

        const img = document.createElement("img");
        img.dataset.src = convertirAGoogleThumbnail(item.Imagen); // Lazy load
        img.alt = item.Tema;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = item.Tema;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
    lazyLoadImages();
}

function mostrarContenidoRelay() {
    const cont = document.getElementById("contenido-relay");
    cont.innerHTML = "<h4>Configuraci√≥n del Relay</h4>";
    const grid = document.createElement("div");
    grid.className = "grid";
    if (!datosRelay || datosRelay.length === 0) {
        cont.innerHTML += "<p>No hay configuraciones de relay disponibles.</p>";
        return;
    }

    datosRelay.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarDetalleRelay(item);

        const img = document.createElement("img");
        img.dataset.src = convertirAGoogleThumbnail(item.imagen); // Lazy load
        img.alt = item.configuracion;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = item.configuracion;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
    lazyLoadImages();
}

function crearElementoDetalle(label, value) {
    if (!value) return null;
    const p = document.createElement("p");
    p.innerHTML = `<strong>${label}:</strong> ${value.replace(/\n/g, '<br>')}`;
    return p;
}

function crearImagenDetalle(label, value, container, extraClass = '') {
    if (!value) return;
    const h = document.createElement("h4");
    h.textContent = label;
    container.appendChild(h);
    const img = document.createElement("img");
    img.src = convertirAGoogleThumbnail(value);
    img.alt = label;
    if (extraClass) img.classList.add(extraClass);
    img.onclick = () => mostrarLightbox(value);
    container.appendChild(img);
}

function crearVideoDetalle(label, value, container) {
    if (!value) return;
    const videoId = extractYouTubeId(String(value).trim());
    if (!videoId) return;

    const h = document.createElement("h4");
    h.textContent = label;
    container.appendChild(h);

    const iframeContainer = document.createElement("div");
    iframeContainer.style.cssText = "position:relative; padding-bottom:56.25%; height:0; margin-bottom:20px;";
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    iframe.title = label;
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.cssText = "border:none; position:absolute; top:0; left:0; width:100%; height:100%;";
    iframe.dataset.originalSrc = iframe.src;
    iframeContainer.appendChild(iframe);
    container.appendChild(iframeContainer);
}

const uiState = { isModalOpen: false, isSearchActive: false };

window.addEventListener('popstate', (event) => {
    const state = event.state || {};
    if (uiState.isModalOpen && !state.modal) {
        cerrarModalVisualmente();
    } else if (uiState.isSearchActive && !state.search) {
        uiState.isSearchActive = false;
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        searchInput.blur();
        document.body.classList.remove('search-active');
    }
});

function pushState(state) {
    history.pushState(state, '');
}

function crearBotonCompartir(seccion, id, titulo) {
    const shareBtn = document.createElement("button");
    shareBtn.textContent = "Compartir";
    shareBtn.className = "shareBtn";
    shareBtn.style.cssText = "color:white; background:#007bff; border:none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;";
    const shareUrl = `${window.location.origin}${window.location.pathname}?seccion=${seccion}&id=${id}`;

    shareBtn.onclick = async () => {
        const shareData = { title: 'GPSpedia Detalle', text: `Mira este detalle: ${titulo}`, url: shareUrl };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(shareUrl);
                shareBtn.textContent = '¬°Enlace Copiado!';
                setTimeout(() => { shareBtn.textContent = 'Compartir'; }, 2000);
            }
        } catch (err) {
            console.error('Error al compartir/copiar:', err);
            alert('No se pudo compartir o copiar el enlace.');
        }
    };
    return shareBtn;
}

function mostrarDetalleTutorial(item) {
    pushState({ modal: true, type: 'tutorial', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = "";

    // Header
    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;";
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";
    headerDiv.appendChild(closeBtn);
    headerDiv.appendChild(crearBotonCompartir('tutoriales', item.id, item.tema));
    cont.appendChild(headerDiv);

    const title = document.createElement("h2");
    title.textContent = item.tema;
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "C√≥mo identificarlo", value: item.comoIdentificarlo },
        { label: "D√≥nde encontrarlo", value: item.dondeEncontrarlo },
        { label: "Detalles", value: item.detalles }
    ];
    campos.forEach(c => {
        const p = crearElementoDetalle(c.label, c.value);
        if (p) cont.appendChild(p);
    });

    crearImagenDetalle("Imagen", item.imagen, cont);
    crearVideoDetalle("Video Gu√≠a", item.video, cont);
    document.getElementById("modalDetalle").classList.add("visible");
}

function mostrarDetalleRelay(item) {
    pushState({ modal: true, type: 'relay', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = "";

    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;";
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";
    headerDiv.appendChild(closeBtn);
    headerDiv.appendChild(crearBotonCompartir('relay', item.id, item.configuracion));
    cont.appendChild(headerDiv);

    const title = document.createElement("h2");
    title.textContent = `Detalle de: ${item.configuracion}`;
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "Funci√≥n", value: item.funcion },
        { label: "Veh√≠culo donde se utiliza", value: item.vehiculoDondeSeUtiliza },
        { label: "PIN 30 (entrada)", value: item.pin30Entrada },
        { label: "PIN 85 (bobina +)", value: item.pin85Bobina },
        { label: "PIN 86 (bobina - )", value: item.pin86Bobina },
        { label: "PIN 87a (comun cerrado)", value: item.pin87aComunCerrado },
        { label: "PIN 87 (Comunmente Abierto)", value: item.pin87ComunmenteAbierto },
        { label: "Observaci√≥n", value: item.observacion }
    ];
    campos.forEach(c => {
        const p = crearElementoDetalle(c.label, c.value);
        if (p) cont.appendChild(p);
    });
    crearImagenDetalle("Imagen", item.imagen, cont);
    const relayImg = cont.querySelector('img[alt="Imagen"]');
    if (relayImg) {
        relayImg.style.maxHeight = '250px';
    }
    document.getElementById("modalDetalle").classList.add("visible");
}

function getLogoUrlForMarca(marca, categoria) {
    if (!datosLogos || !marca) return null;

    // Normalizar el nombre de la marca eliminando par√©ntesis y guiones
    const normalize = (str) => str.toLowerCase().replace(/[\(\)-]/g, '');
    const normalizedMarca = normalize(marca);

    let searchNames = [normalizedMarca];
    if (categoria) {
        // Ejemplo: si categoria es "Motocicleta", buscar√° "hondamotocicleta" y luego "honda"
        searchNames.unshift(normalize(`${marca}${categoria}`));
    }

    for (const name of searchNames) {
        const logoEntry = datosLogos.find(logo => normalize(logo.nombreMarca) === name);
        if (logoEntry && logoEntry.urlLogo) {
            return convertirAGoogleThumbnail(logoEntry.urlLogo, 'logo');
        }
    }

    return null;
}

/**
 * Convierte una variedad de URLs de Google Drive a un formato de thumbnail directo.
 * Es compatible con enlaces de vista, previsualizaci√≥n, uc, open, y googleusercontent.
 * @param {string} url - La URL de Google Drive a convertir.
 * @param {string} [type='image'] - El tipo de imagen ('image', 'logo', o un tama√±o espec√≠fico como 'w2000').
 * @returns {string} La URL del thumbnail, la URL original, o un placeholder.
 */
function convertirAGoogleThumbnail(url, type = 'image') {
    if (!url || typeof url !== 'string' || url.trim() === '') {
        // Para logos, no mostrar placeholder, solo una cadena vac√≠a.
        return type === 'logo' ? '' : "https://placehold.co/280x200/cccccc/333333?text=Sin+Imagen";
    }

    let fileId = null;
    const regexPatterns = [
        // Patrones m√°s espec√≠ficos primero para mayor precisi√≥n
        // Formatos: /file/d/ID, /d/ID
        /(?:\/file\/d\/|\/d\/)([a-zA-Z0-9_-]{25,})/,
        // Formato: open?id=ID
        /open\?id=([a-zA-Z0-9_-]{25,})/,
        // Formato: uc?id=ID
        /uc\?id=([a-zA-Z0-9_-]{25,})/,
        // Formato: googleusercontent.com/d/ID
        /googleusercontent\.com\/d\/([a-zA-Z0-9_-]{25,})/,
        // Fallback para cualquier otro par√°metro ?id=ID o &id=ID
        /[?&]id=([a-zA-Z0-9_-]{25,})/
    ];

    for (const pattern of regexPatterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
            fileId = match[1];
            break;
        }
    }

    if (fileId) {
        let size = 'w1000'; // Default size
        if (type === 'logo') {
            size = 'w256';
        } else if (type && !type.startsWith('w')) { // A specific size is requested, e.g., '200'
            size = `w${type}`;
        } else if (type) { // A full size parameter is passed, e.g., 'w2000'
            size = type;
        }
        return `https://drive.google.com/thumbnail?sz=${size}&id=${fileId}`;
    }

    // Si no se pudo extraer un ID pero la URL parece v√°lida, devolverla tal cual.
    if (url.startsWith('http')) {
        return url;
    }

    // Si no es convertible ni una URL v√°lida, devolver placeholder (o vac√≠o para logos).
    return type === 'logo' ? '' : "https://placehold.co/280x200/cccccc/333333?text=Sin+Imagen";
}

function mostrarLightbox(src) {
    const lightboxImg = document.getElementById("lightboxImg");
    lightboxImg.src = ""; // Limpiar imagen anterior para evitar flashes
    // Usar la nueva funci√≥n robusta para obtener la URL de alta resoluci√≥n
    const finalUrl = convertirAGoogleThumbnail(src, 'w2000');
    lightboxImg.src = finalUrl;
    document.getElementById("lightbox").classList.add("visible");
}

function cerrarModal() {
    cerrarModalVisualmente();
    if (history.state && history.state.modal) {
        history.back();
    }
    if (appOpenedFromLink) {
        appOpenedFromLink = false;
        history.pushState({}, '', window.location.pathname);
        checkSession();
    }
}

function cerrarModalVisualmente() {
    const modal = document.getElementById("modalDetalle");
    if (!modal.classList.contains("visible")) return;

    const detalleCont = document.getElementById("detalleCompleto");
    detalleCont.querySelectorAll('iframe').forEach(iframe => { if (iframe.src) iframe.src = ''; });
    modal.classList.remove("visible");
    uiState.isModalOpen = false;
}

function cerrarLightbox() { document.getElementById("lightbox").classList.remove("visible"); }

function extractYouTubeId(url) {
    if (!url) return null;
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

function mostrarDetalleModal(item) {
    pushState({ modal: true, type: 'corte', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = ""; // Limpiar contenido anterior

    // --- Header del Modal ---
    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";

    const yearRange = item.anoHasta && item.anoHasta !== item.anoDesde ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
    const titulo = `${item.marca} ${item.modelo} ${yearRange || ''}`;
    const shareBtn = crearBotonCompartir('cortes', item.id, titulo);

    headerDiv.appendChild(closeBtn);
    headerDiv.appendChild(shareBtn);
    cont.appendChild(headerDiv);

    // --- T√≠tulo y Logo ---
    const titleContainer = document.createElement('div');
    titleContainer.style.position = 'relative'; // Contenedor relativo para el logo absoluto
    const titleH2 = document.createElement("h2");
    titleH2.textContent = `Detalle de ${titulo}`;
    titleH2.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px; margin-right: 110px;"; // Espacio para el logo
    titleContainer.appendChild(titleH2);

    const logoUrl = getLogoUrlForMarca(item.marca, item.categoria);
    if (logoUrl) {
        const logoImg = document.createElement("img");
        logoImg.src = logoUrl;
        logoImg.style.cssText = "position: absolute; top: -5px; right: 0; height: 50px; width: auto; max-width: 100px; object-fit: contain;";
        titleContainer.appendChild(logoImg);
    }
    cont.appendChild(titleContainer);

    // --- Nota Importante y Imagen del Veh√≠culo ---
    if (item.notaImportante) {
        const p = document.createElement("p");
        p.innerHTML = `<strong style="color:red;">Nota Importante:</strong> <span style="color:#cc0000; font-weight: bold;">${item.notaImportante}</span>`;
        cont.appendChild(p);
    }
    crearImagenDetalle("Veh√≠culo", item.imagenVehiculo, cont, 'img-vehiculo');

    // --- L√≥gica de Recopilaci√≥n y Ordenamiento de Cortes ---
    const cortes = [];
    for (let i = 1; i <= 3; i++) {
        if (item[`tipoCorte${i}`]) {
            cortes.push({
                index: i, tipo: item[`tipoCorte${i}`], util: parseInt(item[`utilCorte${i}`], 10) || 0,
                ubicacion: item[`ubicacionCorte${i}`], colorCable: item[`colorCableCorte${i}`],
                imgCorte: item[`imgCorte${i}`], configRelay: item[`configRelay${i}`],
                colaborador: item[`colaboradorCorte${i}`]
            });
        }
    }
    cortes.sort((a, b) => b.util - a.util);

    // --- Renderizar Corte Recomendado (si existe) ---
    if (cortes.length > 0) {
        const recomendado = cortes.shift(); // El m√°s popular se saca del array
        const panel = document.createElement("div");
        panel.className = "panel-visible";
        const h4 = document.createElement('h4');
        h4.innerHTML = `<i class="fa-solid fa-star" style="color: #FFD700;"></i> Corte Recomendado: ${recomendado.tipo}`;
        h4.style.marginTop = '20px';
        cont.appendChild(h4);
        renderizarContenidoCorte(panel, recomendado, item.id);
        cont.appendChild(panel);
    }

    // --- Preparar Acordeones para el resto de la informaci√≥n ---
    const acordeonItems = [];
    cortes.forEach(corte => {
        acordeonItems.push({
            titulo: `Corte Alternativo: ${corte.tipo} (√ötil: ${corte.util})`,
            renderFn: (panel) => renderizarContenidoCorte(panel, corte, item.id)
        });
    });
    if (item.apertura || item.imgApertura) {
        acordeonItems.push({
            titulo: "Informaci√≥n de Apertura",
            renderFn: (panel) => {
                if (item.apertura) panel.appendChild(crearElementoDetalle("Detalle", item.apertura));
                crearImagenDetalle("Imagen de Apertura", item.imgApertura, panel);
            }
        });
    }
    if (item.videoGuiaDesarmeUrl) {
        acordeonItems.push({
            titulo: "Video Gu√≠a de Desarme",
            renderFn: (panel) => {
                crearVideoDetalle("Video Gu√≠a", item.videoGuiaDesarmeUrl, panel);
            }
        });
    }
    if (item.cableAlimen || item.imgCableAlimen) {
        acordeonItems.push({
            titulo: "Informaci√≥n de Alimentaci√≥n",
            renderFn: (panel) => {
                if (item.cableAlimen) panel.appendChild(crearElementoDetalle("Cable de Alimentaci√≥n", item.cableAlimen));
                crearImagenDetalle("Imagen de Alimentaci√≥n", item.imgCableAlimen, panel);
            }
        });
    }

    // --- Renderizar Acordeones ---
    if (acordeonItems.length > 0) {
        const acordeonContainer = document.createElement('div');
        acordeonContainer.style.marginTop = '20px';
        acordeonItems.forEach(ac => {
            const btn = document.createElement("button");
            btn.className = "accordion-btn";
            btn.innerHTML = `${ac.titulo} <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
            const panel = document.createElement("div");
            panel.className = "panel-desplegable";
            ac.renderFn(panel);
            acordeonContainer.appendChild(btn);
            acordeonContainer.appendChild(panel);
        });
        cont.appendChild(acordeonContainer);
    }

    // --- Mostrar Modal ---
    document.getElementById("modalDetalle").classList.add("visible");
}

function renderizarContenidoCorte(panel, corte, vehicleId) {
    if (corte.ubicacion || corte.colorCable) {
        const p = document.createElement("p");
        p.innerHTML = `<strong>Ubicaci√≥n:</strong> ${corte.ubicacion || 'N/A'}<br><strong>Color(es) de Cable:</strong> ${corte.colorCable || 'N/A'}`;
        panel.appendChild(p);
    }

    if (corte.configRelay) {
        const relayInfo = datosRelay.find(r => r.configuracion === corte.configRelay);
        if (relayInfo) {
            const p = document.createElement("p");
            p.innerHTML = `<strong>Configuraci√≥n Relay:</strong> <a href="#" onclick="event.preventDefault(); mostrarDetalleRelayEnModal('${relayInfo.ID}')">${corte.configRelay}</a>`;
            panel.appendChild(p);
        } else {
             panel.appendChild(crearElementoDetalle("Configuraci√≥n Relay", corte.configRelay));
        }
    }

    crearImagenDetalle("Imagen del Corte", corte.imgCorte, panel);

    const footerModal = document.createElement("div");
    footerModal.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px;";
    const colaboradorInfo = document.createElement("div");
    colaboradorInfo.style.cssText = "font-size: 0.8em; color: #555;";
    colaboradorInfo.innerHTML = `Agregado por: <strong>${corte.colaborador || 'N/A'}</strong>`;
    const feedbackContainer = document.createElement("div");
    feedbackContainer.style.cssText = "display: flex; gap: 10px; flex-wrap: wrap;";
    const utilBtn = document.createElement("button");
    utilBtn.className = "feedback-btn util-btn";
    utilBtn.innerHTML = `<i class="fa-solid fa-thumbs-up"></i> √ötil <span class="util-count">(${corte.util})</span>`;
    utilBtn.onclick = () => handleLike(vehicleId, corte.index, utilBtn);
    feedbackContainer.appendChild(utilBtn);
    const reportBtn = document.createElement("button");
    reportBtn.className = "feedback-btn report-btn";
    reportBtn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Reportar`;
    reportBtn.onclick = () => toggleReportSection(vehicleId, corte.index);
    feedbackContainer.appendChild(reportBtn);
    footerModal.appendChild(colaboradorInfo);
    footerModal.appendChild(feedbackContainer);
    panel.appendChild(footerModal);
    const reportSection = document.createElement("div");
    reportSection.id = `report-section-${vehicleId}-${corte.index}`;
    reportSection.className = 'report-section';
    reportSection.style.display = 'none';
    reportSection.innerHTML = `
        <textarea id="report-input-${vehicleId}-${corte.index}" placeholder="Describe el problema o deja un comentario..."></textarea>
        <button onclick="handleReportSubmit('${vehicleId}', ${corte.index})">Enviar</button>
        <div class="comments-section" id="comments-section-${vehicleId}-${corte.index}"></div>
    `;
    panel.appendChild(reportSection);
}

function mostrarDetalleRelayEnModal(relayId) {
    const relayItem = datosRelay.find(r => r.ID == relayId);
    if (!relayItem) return;

    const cont = document.getElementById("relayDetalleCompleto");
    cont.innerHTML = ""; // Limpiar

    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;";
    const title = document.createElement("h3");
    title.textContent = `Detalle de Relay: ${relayItem.configuracion}`;
    const closeBtn = document.createElement("span");
    closeBtn.innerHTML = "&times;";
    closeBtn.className = "info-close-btn";
    closeBtn.onclick = () => document.getElementById("modalRelay").style.display = 'none';
    headerDiv.appendChild(title);
    headerDiv.appendChild(closeBtn);
    cont.appendChild(headerDiv);

    const campos = [
        { label: "Funci√≥n", value: relayItem.funcion },
        { label: "PIN 30 (Entrada)", value: relayItem.pin30Entrada },
        { label: "PIN 85 (Bobina +)", value: relayItem.pin85BobinaPositivo },
        { label: "PIN 86 (Bobina -)", value: relayItem.pin86bobinaNegativo },
        { label: "PIN 87a (Com√∫n Cerrado)", value: relayItem.pin87aComunCerrado },
        { label: "PIN 87 (Com√∫nmente Abierto)", value: relayItem.pin87ComunmenteAbierto },
        { label: "Observaci√≥n", value: relayItem.observacion }
    ];
    campos.forEach(c => {
        if (c.value) cont.appendChild(crearElementoDetalle(c.label, c.value));
    });
    crearImagenDetalle("Diagrama", relayItem.imagen, cont);

    document.getElementById("modalRelay").style.display = 'flex';
}

function filtrarContenido(textoBusqueda) {
    const busqueda = textoBusqueda.toLowerCase().trim();
    if (!busqueda) {
        datosFiltrados = [];
        estado.nivel = "categorias";
        mostrarCategorias();
        return;
    }
    const palabrasBusqueda = busqueda.split(' ').filter(p => p);
    datosFiltrados = datosOriginales.filter(item => {
        const itemTexto = `${item.categoria} ${item.marca} ${item.modelo} ${item.anoDesde} ${item.anoHasta} ${item.tipoEncendido} ${item.versionesAplicables}`.toLowerCase();
        return palabrasBusqueda.every(palabra => itemTexto.includes(palabra));
    });

    if (datosFiltrados.length > 0) {
        mostrarResultadosBusquedaMarca(busqueda);
    } else {
        document.getElementById("contenido").innerHTML = `<p style="text-align:center; padding: 20px;">No se encontraron resultados para "${textoBusqueda}".</p>`;
    }
    estado.nivel = "busqueda";
}

function mostrarResultadosBusquedaMarca(busquedaTexto) {
    const cont = document.getElementById("contenido");
    if (datosFiltrados.length === 1) {
        mostrarDetalleModal(datosFiltrados[0]);
        const yearRange = datosFiltrados[0].anoHasta ? `${datosFiltrados[0].anoDesde} - ${datosFiltrados[0].anoHasta}` : datosFiltrados[0].anoDesde;
        cont.innerHTML = `<h4>Resultado Exacto Encontrado</h4><p>Abriendo detalle de ${datosFiltrados[0].modelo} ${yearRange || ''}.</p>`;
        return;
    }
    cont.innerHTML = `<h4>Resultados de b√∫squeda para: "${busquedaTexto}"</h4>`;
    const marcasUnicas = [...new Set(datosFiltrados.map(item => item.marca))].sort();
    const grid = document.createElement("div"); grid.className = "grid";
    marcasUnicas.forEach(marca => {
        const ejemplo = datosFiltrados.find(item => item.marca === marca && item.imagenVehiculo) || datosFiltrados.find(item => item.marca === marca);
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarResultadosBusquedaModelo(busquedaTexto, marca);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(ejemplo.imagenVehiculo); img.alt = `Marca ${marca}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay"; overlay.innerHTML = marca; card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaModelo(busquedaTexto, marcaFiltro) {
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaMarca('${busquedaTexto}')">${backSvg} Volver a Marcas</span>
                      <h4>Modelos de ${marcaFiltro} (B√∫squeda: "${busquedaTexto}")</h4>`;
    const modelosFiltrados = datosFiltrados.filter(item => item.marca === marcaFiltro);
    const modelosUnicos = [...new Map(modelosFiltrados.map(item => [item.modelo, item])).values()].sort((a,b) => a.modelo.localeCompare(b.modelo));

    const grid = document.createElement("div"); grid.className = "grid";
    modelosUnicos.forEach(ejemplo => {
        const versiones = modelosFiltrados.filter(item => item.modelo === ejemplo.modelo);
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => (versiones.length === 1) ? mostrarDetalleModal(ejemplo) : mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, ejemplo.modelo);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(ejemplo.imagenVehiculo); img.alt = `Modelo ${ejemplo.modelo}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        if (versiones.length === 1) {
            const yearRange = ejemplo.anoHasta ? `${ejemplo.anoDesde} - ${ejemplo.anoHasta}` : ejemplo.anoDesde;
            overlay.innerHTML = `<div>${ejemplo.modelo}</div><div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${yearRange || ''} ${ejemplo.tipoEncendido || ''}</div>`;
        } else {
            overlay.innerHTML = `<div>${ejemplo.modelo}</div><div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
        }
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modeloFiltro) {
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaModelo('${busquedaTexto}', '${marcaFiltro}')">${backSvg} Volver a Modelos (${modeloFiltro})</span>
                      <h4>Cortes/A√±os de ${modeloFiltro}</h4>`;
    const versiones = datosFiltrados.filter(item => item.marca === marcaFiltro && item.modelo === modeloFiltro);
    const grid = document.createElement("div"); grid.className = "grid";
    versiones.forEach(item => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleModal(item);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(item.imagenVehiculo); img.alt = `Corte ${item.anoDesde}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
        overlay.innerHTML = `<div style="font-weight:bold;">${yearRange || modeloFiltro}</div><div style="font-size:0.8em; opacity:0.8;">${item.tipoEncendido || ''}</div>`;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarCategorias() {
    handleNavigationClick('categoria', {});
}

async function handleNavigationClick(nivel, filtros) {
    const cont = document.getElementById("contenido");
    showSkeletonLoader(cont);

    try {
        const result = await postToAction('getNavigationData', { nivel: nivel, filtros: filtros });

        if (result.status === 'success') {
            const { data, nextNivel } = result;

            // Si el backend nos salta al nivel final, mostramos el detalle directamente
            if (nextNivel === 'final' && data.length === 1) {
                const vehicle = datosOriginales.find(item => item.id == data[0].id);
                mostrarDetalleModal(vehicle);
                return;
            }

            renderNavigationGrid(nivel, data, nextNivel, filtros);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        cont.innerHTML = `<p style="color:red; text-align:center;">Error al cargar la navegaci√≥n: ${error.message}</p>`;
    }
}

function renderNavigationGrid(currentNivel, data, nextNivel, filtros) {
    const cont = document.getElementById("contenido");
    let titulo = `Seleccione ${currentNivel.charAt(0).toUpperCase() + currentNivel.slice(1)}`;
    let backFunction = '';

    // L√≥gica mejorada para el bot√≥n "Volver"
    const buildFilterString = (filterObj) => JSON.stringify(filterObj).replace(/"/g, "'");

    const backLinks = {
        marca: () => `handleNavigationClick('categoria', {})`,
        modelo: () => `handleNavigationClick('marca', ${buildFilterString({ categoria: filtros.categoria })})`,
        version: () => `handleNavigationClick('modelo', ${buildFilterString({ categoria: filtros.categoria, marca: filtros.marca })})`,
        tipoEncendido: () => `handleNavigationClick('version', ${buildFilterString({ categoria: filtros.categoria, marca: filtros.marca, modelo: filtros.modelo })})`,
        generacion: () => `handleNavigationClick('tipoEncendido', ${buildFilterString({ categoria: filtros.categoria, marca: filtros.marca, modelo: filtros.modelo, version: filtros.version })})`,
    };
    if (backLinks[currentNivel]) {
        backFunction = backLinks[currentNivel]();
    }

    // T√≠tulos din√°micos
    if (currentNivel === 'marca') titulo = `Marcas de ${filtros.categoria}`;
    else if (currentNivel === 'modelo') titulo = `Modelos de ${filtros.marca}`;
    else if (currentNivel === 'version') titulo = `Versiones de ${filtros.modelo}`;
    else if (currentNivel === 'tipoEncendido') titulo = `Encendido para ${filtros.version || filtros.modelo}`;
    else if (currentNivel === 'generacion') titulo = `Generaciones para ${filtros.tipoEncendido}`;


    cont.innerHTML = backFunction ? `<span class="backBtn" onclick="${backFunction}">${backSvg} Volver</span><h4>${titulo}</h4>` : `<h4>${titulo}</h4>`;

    const grid = document.createElement("div");
    grid.className = "grid";

    // Si no hay datos, mostrar un mensaje.
    if (!data || data.length === 0) {
        cont.innerHTML += '<p style="text-align:center;">No hay elementos para mostrar en esta secci√≥n.</p>';
        return;
    }

    data.forEach(item => {
        if (currentNivel === 'marca') {
            // Nivel de Marcas: Renderizar como iconos/logos
            const logoCard = document.createElement("div");
            logoCard.className = "logo-card";

            const newFiltros = { ...filtros, marca: item.nombreMarca };
            logoCard.onclick = () => handleNavigationClick(nextNivel, newFiltros);

            const img = document.createElement("img");
            // Usar la URL del logo proporcionada por el backend.
            img.dataset.src = convertirAGoogleThumbnail(item.urlLogo, 'logo');
            // Si no hay logo, se mostrar√° un espacio vac√≠o, pero el nombre ser√° visible.
            img.alt = `Logo de ${item.nombreMarca}`;

            const name = document.createElement("div");
            name.className = "logo-name";
            name.textContent = item.nombreMarca;

            logoCard.appendChild(img);
            logoCard.appendChild(name);
            grid.appendChild(logoCard);

        } else {
            // Otros niveles: Renderizar como tarjetas est√°ndar
            const card = document.createElement("div");
            card.className = "card";

            const newFiltros = { ...filtros };
            // El 'item' puede ser un string (modelo, etc.) o un objeto ({id, label} para generaci√≥n)
            const filterValue = (typeof item === 'object' && item.id) ? item.id : item;
            const currentFilterKey = (currentNivel === 'version') ? 'versionesAplicables' : currentNivel;
             newFiltros[currentNivel] = filterValue;


            card.onclick = () => {
                if (nextNivel === 'final') {
                    // El ID del veh√≠culo final est√° en item.id
                    const vehicle = datosOriginales.find(v => v.id == item.id);
                    if (vehicle) mostrarDetalleModal(vehicle);
                } else {
                    handleNavigationClick(nextNivel, newFiltros);
                }
            };

            const img = document.createElement("img");
            const overlay = document.createElement("div");
            overlay.className = "overlay";

            if (typeof item === 'object' && item.label) { // Nivel de generaci√≥n
                overlay.innerHTML = item.label;
                const vehicle = datosOriginales.find(v => v.id == item.id);
                img.dataset.src = convertirAGoogleThumbnail(vehicle?.imagenVehiculo);
            } else { // Otros niveles (modelo, version, tipoEncendido)
                overlay.innerHTML = item;
                // Encontrar un veh√≠culo de ejemplo para la imagen
                const ejemplo = datosOriginales.find(d => d[currentFilterKey] === item && filtros.marca === d.marca && filtros.categoria === d.categoria);
                img.dataset.src = convertirAGoogleThumbnail(ejemplo?.imagenVehiculo);
            }

            card.appendChild(img);
            card.appendChild(overlay);
            grid.appendChild(card);
        }
    });

    cont.appendChild(grid);
}

function mostrarUltimosAgregados() {
    const cont = document.getElementById("contenido");
    if (!datosOriginales || datosOriginales.length === 0) return;

    const ultimosCortes = [...datosOriginales].sort((a, b) => b.id - a.id).slice(0, 6);

    const section = document.createElement('div');
    section.style.marginTop = '40px';
    const title = document.createElement('h4');
    title.textContent = '√öltimos agregados:';
    section.appendChild(title);

    const grid = document.createElement('div'); grid.className = 'grid';
    ultimosCortes.forEach(item => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleModal(item);
        const img = document.createElement("img"); img.dataset.src = convertirAGoogleThumbnail(item.imagenVehiculo); img.alt = `${item.marca} ${item.modelo}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
        overlay.innerHTML = `<div>${item.marca}</div><div style="font-size:0.8em; opacity:0.8;">${item.modelo} ${yearRange || ''}</div>`;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    section.appendChild(grid);
    cont.appendChild(section);
}


// --- INICIALIZACI√ìN Y L√ìGICA DE PWA ---
let deferredPrompt;
const installButton = document.getElementById('install-button');

window.addEventListener('beforeinstallprompt', (e) => {
    // Prevenir que el navegador muestre el aviso de instalaci√≥n por defecto
    e.preventDefault();
    // Guardar el evento para poder mostrarlo m√°s tarde
    deferredPrompt = e;
    console.log('`beforeinstallprompt` event was fired. App is installable.');

    // L√≥gica para mostrar el bot√≥n de instalaci√≥n
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (!isStandalone) {
        if (isIOS) {
            // En iOS no se dispara 'beforeinstallprompt', manejaremos un bot√≥n personalizado.
            // La l√≥gica para mostrar el bot√≥n de iOS estar√° en inicializarApp.
            installButton.style.display = 'none';
        } else {
            // Para otros dispositivos (Android, Desktop), mostrar el bot√≥n.
            installButton.style.display = 'block';
        }
    }
});

installButton.addEventListener('click', async () => {
    if (deferredPrompt) {
        // Mostrar el aviso de instalaci√≥n
        deferredPrompt.prompt();

        // Esperar a que el usuario responda al aviso
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);

        // Ya no necesitamos el evento, lo reseteamos
        deferredPrompt = null;

        // Ocultar el bot√≥n
        installButton.style.display = 'none';
    }
});

// --- REGISTRO DEL SERVICE WORKER ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(registration => {
            console.log('ServiceWorker registrado con √©xito:', registration.scope);
        }).catch(err => {
            console.log('Fallo en el registro de ServiceWorker:', err);
        });
    });
}

// --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
async function handleSharedLink(seccion, id) {
    appOpenedFromLink = true;

    let data, header, item, mostrarDetalleFn;

    // 1. Determinar qu√© datos buscar y qu√© funci√≥n de modal usar
    const seccionMap = {
        'cortes': { range: RANGE_CORTES, dataSetter: (vals) => datosOriginales = vals, dataRef: () => datosOriginales, modalFn: mostrarDetalleModal },
        'tutoriales': { range: RANGE_TUTORIALES, dataSetter: (vals) => datosTutoriales = vals, dataRef: () => datosTutoriales, modalFn: mostrarDetalleTutorial },
        'relay': { range: RANGE_RELAY, dataSetter: (vals) => datosRelay = vals, dataRef: () => datosRelay, modalFn: mostrarDetalleRelay }
    };

    if (!seccionMap[seccion]) {
        checkSession(); // Secci√≥n no v√°lida, proceder con el inicio normal
        return;
    }

    const { range, dataSetter, dataRef, modalFn } = seccionMap[seccion];

    // 2. Intentar cargar los datos de la secci√≥n y encontrar el √≠tem
    await syncAndFetchData(seccion, range, dataSetter, () => {}, 'contenido');
    data = dataRef();

    if (data && data.length > 1) {
        header = data[0];
        item = data.slice(1).find(fila => fila[header.indexOf("ID")] === id);
    }

    // 3. Solo si el √≠tem es v√°lido, se muestra el modal y se oculta el resto
    if (item) {
        // Ocultar splash y login AHORA que sabemos que tenemos contenido para mostrar
        const splash = document.getElementById('splash-screen');
        splash.style.opacity = '0';
        setTimeout(() => splash.style.display = 'none', 500);
        document.getElementById('login-modal').style.display = 'none';

        // Ocultar el contenedor principal para que solo se vea el modal
        document.querySelector('.container').style.display = 'none';

        mostrarDetalleFn = modalFn;
        mostrarDetalleFn(item, header);

        // Limpiar la URL para que un refresh no vuelva a abrir el modal
        history.replaceState({}, document.title, window.location.pathname);
    } else {
        // 4. Si el √≠tem no se encuentra, proceder al flujo de inicio de sesi√≥n normal
        checkSession();
    }
}


async function inicializarApp() {
    const urlParams = new URLSearchParams(window.location.search);
    const seccion = urlParams.get('seccion');
    const id = urlParams.get('id');

    if (seccion && id) {
        await handleSharedLink(seccion, id);
    } else {
        checkSession();     // Luego, comprueba si hay una sesi√≥n activa
    }

    // L√≥gica para el bot√≥n de instalaci√≥n de iOS
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // --- LAZY LOADING DE IM√ÅGENES ---
    let observer;
    function lazyLoadImages() {
        if (observer) {
            observer.disconnect();
        }

        observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: "0px 0px 200px 0px" }); // Carga im√°genes 200px antes de que entren en pantalla

        const images = document.querySelectorAll('img[data-src]');
        images.forEach(img => {
            observer.observe(img);
        });
    }


    if (!isStandalone && isIOS) {
        // Crear y mostrar un bot√≥n/mensaje espec√≠fico para iOS
        const iosInstallMessage = document.createElement('div');
        iosInstallMessage.id = 'ios-install-message';
        iosInstallMessage.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 1002;
            font-size: 0.9em;
            width: 90%;
            max-width: 400px;
        `;
        iosInstallMessage.innerHTML = `
            Para instalar, pulsa el bot√≥n de Compartir
            <svg style="width:20px; vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M17,14V17A1,1 0 0,1 16,18H8A1,1 0 0,1 7,17V14H5V17A3,3 0 0,0 8,20H16A3,3 0 0,0 19,17V14H17M12,4L7,9H10V15H14V9H17L12,4Z" /></svg>
            y luego "A√±adir a pantalla de inicio".
            <button onclick="this.parentElement.style.display='none'" style="background:none; border:none; color:white; font-size:1.2em; position:absolute; top:5px; right:10px;">&times;</button>
        `;
        document.body.appendChild(iosInstallMessage);
    }
}

// Ocultar el splash screen despu√©s de un tiempo para asegurar que no se quede atascado
window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        const session = localStorage.getItem(SESSION_KEY);
        // Si no hay sesi√≥n, el splash se ocultar√° cuando se muestre el login.
        // Si hay sesi√≥n, el splash se ocultar√° cuando se muestre la app.
        // Este es un fallback por si algo falla.
        if (!session) {
             const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
            }, 500);
        }
    }, 3000); // 3 segundos de tiempo de espera m√°ximo
});


inicializarApp();

// Event listener para el acorde√≥n
document.getElementById('detalleCompleto').addEventListener('click', function(e) {
    const clickedBtn = e.target.closest('.accordion-btn');
    if (!clickedBtn) return;

    const panel = clickedBtn.nextElementSibling;
    const isActive = clickedBtn.classList.contains('active');

    // Cerrar todos los paneles y pausar videos
    this.querySelectorAll('.accordion-btn').forEach(btn => {
        const currentPanel = btn.nextElementSibling;
        const iframe = currentPanel.querySelector('iframe');

        if (btn !== clickedBtn || isActive) {
            btn.classList.remove('active');
            currentPanel.style.maxHeight = null;
            if (iframe) {
                iframe.src = ''; // Detiene el video
            }
        }
    });

    // Abrir el panel clickeado si no estaba ya activo
    if (!isActive) {
        clickedBtn.classList.add('active');
        panel.style.maxHeight = panel.scrollHeight + "px";
        const iframe = panel.querySelector('iframe');
        if (iframe && iframe.dataset.originalSrc) {
            iframe.src = iframe.dataset.originalSrc; // Restaura el video
        }
    }
});

const searchContainer = document.querySelector('.search-container');
const clearSearchBtn = document.getElementById('clear-search-btn');

if (searchInput && searchContainer && clearSearchBtn) {
    searchInput.addEventListener('focus', () => {
        if (!uiState.isSearchActive) {
            // Solo empuja el estado si el campo est√° vac√≠o. Si ya hay texto, no crees un nuevo estado.
            if(searchInput.value.trim() === '') {
                pushState({ search: true });
            }
            uiState.isSearchActive = true;
        }
        document.body.classList.add('search-active');
    });

    searchInput.addEventListener('blur', () => {
        if (uiState.isSearchActive) {
            // No hacemos history.back() al desenfocar para permitir hacer clic en los resultados.
            // La UI se revierte visualmente, pero el estado del historial permanece.
            setTimeout(() => {
                 document.body.classList.remove('search-active');
            }, 200);
        }
    });

    searchInput.addEventListener('input', () => {
        // Muestra u oculta el bot√≥n de limpiar basado en si hay texto
        if (searchInput.value.length > 0) {
            searchContainer.classList.add('has-text');
        } else {
            searchContainer.classList.remove('has-text');
        }
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        // Dispara el evento 'input' para que la l√≥gica de filtrado se ejecute
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        // Mantiene el foco en el input para una nueva b√∫squeda
        searchInput.focus();
    });
}

// --- L√ìGICA DEL MEN√ö HAMBURGUESA ---
const hamburgerBtn = document.getElementById('hamburger-btn');
const sideMenu = document.getElementById('side-menu');
const menuOverlay = document.getElementById('menu-overlay');
const menuUsername = document.getElementById('menu-username');
const sideMenuLogoutBtn = document.getElementById('side-menu-logout-button');

function openSideMenu() {
    const session = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (session && session.Nombre_Usuario) {
        menuUsername.textContent = session.Nombre_Usuario;
    }
    sideMenu.classList.add('open');
    menuOverlay.classList.add('open');
}

function closeSideMenu() {
    sideMenu.classList.remove('open');
    menuOverlay.classList.remove('open');
}

hamburgerBtn.addEventListener('click', openSideMenu);
menuOverlay.addEventListener('click', closeSideMenu);
sideMenuLogoutBtn.addEventListener('click', () => {
    closeSideMenu();
    logout();
});

// Cerrar men√∫ al hacer clic en un enlace (para navegaci√≥n en la misma p√°gina)
document.querySelectorAll('#side-menu .menu-link').forEach(link => {
    link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');
        if (href === '#') { // Es un enlace de la misma p√°gina (ej. 'Cortes')
            e.preventDefault();
            const section = link.id.replace('menu-', '');
            mostrarSeccion(section);
            closeSideMenu();
        }
        // Para enlaces a otras p√°ginas, el men√∫ se cerrar√° autom√°ticamente en la carga de la nueva p√°gina.
    });
});

async function handleLike(vehicleId, corteIndex, buttonElement) {
    const user = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (!user) {
        alert("Debes iniciar sesi√≥n para usar esta funci√≥n.");
        return;
    }
    // Optimistic UI update
    buttonElement.classList.add('pressed');
    buttonElement.disabled = true;
    const countSpan = buttonElement.querySelector('.util-count');
    const currentCount = parseInt(countSpan.textContent.replace(/[\(\)]/g, ''), 10);
    countSpan.textContent = `(${currentCount + 1})`;

    try {
        await postToAction('recordLike', {
            vehicleId,
            corteIndex,
            userId: user.ID,
            userName: user.Nombre_Usuario
        });
    } catch (error) {
        // Revert UI on error
        buttonElement.classList.remove('pressed');
        buttonElement.disabled = false;
        countSpan.textContent = `(${currentCount})`;
    }
}

async function toggleReportSection(vehicleId, corteIndex) {
    const reportSection = document.getElementById(`report-section-${vehicleId}-${corteIndex}`);
    const commentsSection = document.getElementById(`comments-section-${vehicleId}-${corteIndex}`);

    const isVisible = reportSection.style.display === 'block';

    if (!isVisible) {
        reportSection.style.display = 'block';
        // Cargar comentarios solo la primera vez que se abre
        if (!commentsSection.dataset.loaded) {
            await loadComments(vehicleId, corteIndex);
            commentsSection.dataset.loaded = 'true';
        }
    } else {
        reportSection.style.display = 'none';
    }
}

async function handleReportSubmit(vehicleId, corteIndex) {
    const user = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (!user) {
        alert("Debes iniciar sesi√≥n para reportar un problema.");
        return;
    }

    const reportInput = document.getElementById(`report-input-${vehicleId}-${corteIndex}`);
    const problemText = reportInput.value.trim();

    if (!problemText) {
        alert("Por favor, describe el problema.");
        return;
    }

    try {
        await postToAction('reportProblem', {
            vehicleId: vehicleId,
            corteIndex: corteIndex,
            problemText: problemText,
            userId: user.ID,
            userName: user.Nombre_Usuario
        });
        reportInput.value = '';
        // Recargar los comentarios para mostrar el nuevo
        await loadComments(vehicleId, corteIndex);
    } catch (error) {
        // El error ya se maneja en postToAction
    }
}

async function loadComments(vehicleId, corteIndex) {
    const commentsSection = document.getElementById(`comments-section-${vehicleId}-${corteIndex}`);
    commentsSection.innerHTML = '<p>Cargando comentarios...</p>';

    try {
        const result = await postToAction('getComments', { vehicleId });
        if (result.status === 'success' && result.data) {
            commentsSection.innerHTML = '';
            if (result.data.length === 0) {
                commentsSection.innerHTML = '<p>No hay comentarios a√∫n. ¬°S√© el primero!</p>';
                return;
            }

            result.data.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                let html = `<p><span class="user">${comment.user}</span> dice: <span class="text">"${comment.problem}"</span></p>`;

                if (comment.response && comment.responder) {
                    html += `<div class="response">
                               <p><span class="responder">${comment.responder}</span> responde: <span class="text">"${comment.response}"</span></p>
                             </div>`;
                }
                commentDiv.innerHTML = html;
                commentsSection.appendChild(commentDiv);
            });
        } else {
            throw new Error(result.message || 'No se pudieron cargar los comentarios.');
        }
    } catch (error) {
        commentsSection.innerHTML = `<p style="color:red;">Error al cargar comentarios.</p>`;
    }
}

// --- L√ìGICA PARA MODALES DE INFORMACI√ìN ---
function setupInfoModals() {
    const modals = document.querySelectorAll('.info-modal');
    const closeButtons = document.querySelectorAll('.info-close-btn');

    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'flex';
    };

    const closeModal = () => {
        modals.forEach(modal => modal.style.display = 'none');
    };

    // Footer link listeners
    document.getElementById('footer-about-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('about-us-modal');
    });
    document.getElementById('footer-contact-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('contact-modal');
    });
    document.getElementById('footer-faq-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('faq-modal');
    });

    // Close button listeners
    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

    // Close on outside click
    window.addEventListener('click', (event) => {
        modals.forEach(modal => {
            if (event.target === modal) {
                closeModal();
            }
        });
    });

    // Accordion for FAQ
    document.querySelectorAll('#faq-modal .accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const isActive = content.style.maxHeight;
            // Close all others first for a cleaner accordion experience
            document.querySelectorAll('#faq-modal .accordion-content').forEach(c => c.style.maxHeight = null);
            // Open the clicked one if it wasn't already open
            if (!isActive) {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });

    // Contact form submission
    document.getElementById('contact-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('contact-name').value;
        const email = document.getElementById('contact-email').value;
        const message = document.getElementById('contact-message').value;

        try {
            const response = await routeAction('sendContactForm', { name, email, message });
            if (response.status === 'success') {
                alert('¬°Gracias por tu mensaje! Nos pondremos en contacto contigo pronto.');
                closeModal();
                document.getElementById('contact-form').reset();
            } else {
                throw new Error(response.message || 'Error desconocido');
            }
        } catch (error) {
             alert(`Error al enviar el mensaje: ${error.message}`);
        }
    });
}
// Llamar a la configuraci√≥n de los modales de info cuando se inicializa la app.
document.addEventListener('DOMContentLoaded', () => {
    setupInfoModals();
    setupDevTools();
});

function setupDevTools() {
    const devModal = document.getElementById('dev-modal');
    const devConsole = document.getElementById('debug-console');
    const devConsoleContainer = document.getElementById('dev-console-container');
    const openBtn = document.getElementById('dev-tools-btn');
    const closeBtn = devModal.querySelector('.info-close-btn');

    // --- L√ìGICA DEL INBOX DE FEEDBACK ---
    const inboxModal = document.getElementById('inbox-modal');
    const inboxOpenBtn = document.getElementById('menu-inbox');
    const inboxCloseBtn = inboxModal.querySelector('.info-close-btn');

    if (inboxOpenBtn) {
        inboxOpenBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadInbox();
            inboxModal.style.display = 'flex';
            closeSideMenu();
        });
    }

    inboxCloseBtn.addEventListener('click', () => {
        inboxModal.style.display = 'none';
    });

    async function loadInbox() {
        const inboxContent = document.getElementById('inbox-content');
        inboxContent.innerHTML = '<p>Cargando reportes...</p>';
        try {
            const result = await routeAction('getReportedProblems');
            if (result.status === 'success' && result.data) {
                renderInbox(result.data);
            } else {
                inboxContent.innerHTML = `<p style="color:red;">${result.message || 'Error al cargar reportes.'}</p>`;
            }
        } catch (error) {
            inboxContent.innerHTML = `<p style="color:red;">${error.message}</p>`;
        }
    }

    function renderInbox(problems) {
        const inboxContent = document.getElementById('inbox-content');
        inboxContent.innerHTML = '';
        if (problems.length === 0) {
            inboxContent.innerHTML = '<p>No hay reportes pendientes.</p>';
            return;
        }

        problems.forEach(problem => {
            const problemDiv = document.createElement('div');
            problemDiv.className = 'inbox-item';
            problemDiv.innerHTML = `
                <div class="inbox-item-header">
                    <span><strong>Usuario:</strong> ${problem.user}</span>
                    <span><strong>Veh√≠culo ID:</strong> ${problem.vehicleId}</span>
                </div>
                <p>${problem.problem}</p>
                <div class="inbox-item-actions">
                    <textarea id="reply-${problem.id}" placeholder="Escribe una respuesta..."></textarea>
                    <button onclick="replyToProblem('${problem.id}')">Responder</button>
                    <button onclick="resolveProblem('${problem.id}')">Resolver</button>
                    <button class="delete-btn" onclick="deleteProblem('${problem.id}')">Eliminar</button>
                </div>
            `;
            inboxContent.appendChild(problemDiv);
        });
    }

    window.deleteProblem = async function(problemId) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar este reporte permanentemente?')) return;
        try {
            await routeAction('deleteProblem', { problemId });
            loadInbox(); // Recargar
        } catch (error) {
            alert(`Error al eliminar: ${error.message}`);
        }
    }

    window.replyToProblem = async function(problemId) {
        const replyText = document.getElementById(`reply-${problemId}`).value;
        const user = JSON.parse(localStorage.getItem(SESSION_KEY));
        if (!replyText || !user) return;

        try {
            await routeAction('replyToProblem', { problemId, replyText, responderName: user.Nombre_Usuario });
            loadInbox(); // Recargar
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    window.resolveProblem = async function(problemId) {
        if (!confirm('¬øMarcar este problema como resuelto?')) return;
        try {
            await routeAction('resolveProblem', { problemId });
            loadInbox(); // Recargar
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }


    // Mover la consola al modal
    if (devConsole && devConsoleContainer) {
        devConsoleContainer.appendChild(devConsole);
        devConsole.style.position = 'relative';
        devConsole.style.width = '100%';
        devConsole.style.height = '100%';
        devConsole.style.bottom = 'auto';
        devConsole.style.right = 'auto';
    }

    // Abrir modal
    openBtn.addEventListener('click', (e) => {
        e.preventDefault();
        devModal.style.display = 'flex';
        // Mostrar la consola de depuraci√≥n si est√° en modo debug
        if (isDebugMode) {
            devConsole.style.display = 'flex';
        }
        closeSideMenu(); // Cerrar el men√∫ lateral
    });

    // Cerrar modal
    closeBtn.addEventListener('click', () => {
        devModal.style.display = 'none';
    });

    // L√≥gica de los botones de migraci√≥n
    const migrateYearsBtn = document.getElementById('migrate-years-btn');
    const migrateTimestampsBtn = document.getElementById('migrate-timestamps-btn');
    const statusDiv = document.getElementById('migration-status');

    migrateYearsBtn.addEventListener('click', async () => {
        if (!confirm('¬øEst√°s seguro de que quieres ejecutar la migraci√≥n de a√±os? Esta acci√≥n puede modificar datos permanentemente.')) return;

        statusDiv.textContent = 'Migrando a√±os...';
        try {
            const result = await routeAction('migrateYearRanges', { role: 'Desarrollador' }); // Rol requerido por el backend
            statusDiv.textContent = `A√±os: ${result.message}`;
        } catch (error) {
            statusDiv.textContent = `Error: ${error.message}`;
        }
    });

    migrateTimestampsBtn.addEventListener('click', async () => {
        if (!confirm('¬øEst√°s seguro de que quieres ejecutar la migraci√≥n de timestamps? Esta acci√≥n puede modificar datos permanentemente.')) return;

        statusDiv.textContent = 'Migrando timestamps...';
        try {
            const result = await routeAction('migrateTimestamps', { role: 'Desarrollador' }); // Rol requerido por el backend
            statusDiv.textContent = `Timestamps: ${result.message}`;
        } catch (error) {
            statusDiv.textContent = `Error: ${error.message}`;
        }
    });
}

</script>

<footer class="footer" style="display: none;">
  Gpspedia v4.2.0 ¬© 2024 todos los derechos reservados.
  <div class="footer-links">
      <a id="footer-about-link">Sobre Nosotros</a>
      <a id="footer-contact-link">Cont√°ctanos</a>
      <a id="footer-faq-link">Preguntas Frecuentes</a>
  </div>
</footer>

</body>
</html>

<!-- GPSpedia Frontend Component | Version: 4.3.6 -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPSpedia | Cat√°logo T√©cnico</title>
<link rel="icon" href="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w256">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Estilos Globales */
html {
    height: 100%;
}
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: var(--bg-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100%;
    transition: background-color 0.3s, color 0.3s;
}

:root {
    --bg-color: #f4f4f4;
    --text-color: #333;
    --card-bg: #fff;
    --header-color: #333;
    --modal-bg: #fff;
    --modal-text: #000;
    --button-bg: #f0f0f0;
    --button-text: #007bff;
    --menu-bg: #fff;
}

body.dark-mode {
    --bg-color: #121212;
    --text-color: #e0e0e0;
    --card-bg: #1e1e1e;
    --header-color: #e0e0e0;
    --modal-bg: #2c2c2c;
    --modal-text: #e0e0e0;
    --button-bg: #333;
    --button-text: #58a6ff;
    --menu-bg: #1e1e1e;
}

h1,h2,h3,h4 {
    margin: 10px 0;
    color: var(--header-color);
}
h1.app-title {
    color: var(--header-color) !important;
}
.container {
    padding: 20px;
    max-width: 1240px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    flex: 1 0 auto;
}
.backBtn {
    margin-bottom: 15px;
    cursor: pointer;
    color: #007bff;
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}
.backBtn:hover {
    background: #e9f7ff;
}

/* --- ESTILOS DEL ENCABEZADO (Header) --- */
.header-container {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Ajustado para espaciar los elementos */
    flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
    margin-bottom: 20px;
    gap: 15px; /* Espacio entre el logo/t√≠tulo y los controles */
    transition: all 0.35s ease-in-out;
}

.header-branding {
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.35s ease-in-out;
}

.app-logo {
    max-width: 96px;
    height: auto;
    border-radius: 8px;
    /* margin-right ya no es necesario gracias a 'gap' */
    transition: all 0.35s ease-in-out;
}
h1.app-title {
    text-align: left;
    margin: 0;
    font-size: 2.2em;
    color: #333;
    transition: all 0.35s ease-in-out;
}

#header-controls {
    transition: all 0.35s ease-in-out;
}

#install-button {
    display: none; /* Oculto por defecto, JS lo mostrar√° */
    position: fixed; /* Fijo en la pantalla */
    top: 20px;       /* Distancia desde arriba */
    right: 20px;      /* Distancia desde la derecha */
    z-index: 1001;   /* Por encima de otros elementos */
    padding: 10px 20px;
    font-size: 1em;
    font-weight: bold;
    color: #fff;
    background-color: #28a745; /* Verde para la acci√≥n de instalar */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    white-space: nowrap;
}

#install-button:hover {
    background-color: #218838;
    transform: scale(1.05); /* Efecto de zoom ligero */
}

@media (max-width: 680px) {
    .header-container {
        flex-direction: column; /* Apila los elementos verticalmente */
        align-items: center; /* Centra los elementos */
        justify-content: center;
    }
    .header-branding {
        justify-content: center;
        width: 100%;
    }
    h1.app-title {
        font-size: 1.8em;
    }
    #header-controls {
        margin-left: 0; /* Resetea el margen */
        width: 100%;
        justify-content: center; /* Centra los botones */
    }
}

@media (max-width: 480px) {
    #install-button {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.9em;
    }
    #header-controls {
        flex-direction: column; /* Apila el saludo y el bot√≥n de cerrar sesi√≥n */
        align-items: center;
    }
}

/* --- ESTILOS DEL BUSCADOR --- */
.search-container {
    position: relative; /* Contenedor para el bot√≥n de limpiar */
    margin-bottom: 30px;
    padding: 10px 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    transition: all 0.35s ease-in-out;
}

#clear-search-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
}

.search-container.has-text #clear-search-btn {
    opacity: 1;
    pointer-events: all;
}

body.search-active .search-container.has-text #clear-search-btn {
    right: 35px; /* Ajuste de posici√≥n cuando la b√∫squeda est√° activa */
}


.search-container input[type="text"] {
    width: 100%;
    padding: 12px 40px 12px 15px; /* Aumentado padding derecho para el bot√≥n X */
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1em;
    transition: all 0.35s ease-in-out;
}
.search-container input[type="text"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}

/* --- ESTILOS DEL MEN√ö HAMBURGUESA --- */
#hamburger-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #333;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}
#hamburger-btn:hover {
    background-color: #e0e0e0;
}
#side-menu {
    position: fixed;
    top: 0;
    right: -300px; /* Inicia fuera de la pantalla */
    width: 280px;
    height: 100%;
    background-color: #fff;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 2500;
    transition: right 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
}
#side-menu.open {
    right: 0;
}
#menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2400;
}
#menu-overlay.open {
    display: block;
}
#side-menu nav a {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    text-decoration: none;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}
#side-menu nav a:hover {
    background-color: #f7f7f7;
}
#side-menu nav a i {
    width: 20px; /* Ancho fijo para alinear iconos */
    text-align: center;
    color: #007bff;
}
.dark-mode #side-menu, .dark-mode #side-menu nav a {
    background-color: var(--menu-bg);
    color: var(--text-color);
}
.dark-mode .backBtn {
    color: var(--button-text);
}
.dark-mode .card {
    background: var(--card-bg);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
}
.dark-mode .section-btn {
    background-color: var(--button-bg);
    color: var(--text-color);
    border-color: #555;
}
.dark-mode .section-btn.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}
.dark-mode #detalleCompleto {
    background: var(--modal-bg);
    color: var(--modal-text);
}
.dark-mode .info-modal-content {
    background-color: var(--modal-bg);
    color: var(--modal-text);
}
.dark-mode .accordion-btn {
    background-color: var(--button-bg);
    color: var(--button-text);
}
.dark-mode .accordion-btn:hover, .dark-mode .accordion-btn.active {
    background-color: #444;
}
.dark-mode .panel-desplegable {
    background-color: var(--modal-bg);
}
/* Estilo para el switch de modo oscuro */
.theme-switch-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px 20px;
    border-top: 1px solid #f0f0f0;
    margin-top: auto;
}
.dark-mode .theme-switch-wrapper {
    border-top: 1px solid #333;
}
.theme-switch {
    display: inline-block;
    height: 24px;
    position: relative;
    width: 50px;
}
.theme-switch input {
    display:none;
}
.slider {
    background-color: #ccc;
    bottom: 0;
    cursor: pointer;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    transition: .4s;
    border-radius: 24px;
}
.slider:before {
    background-color: #fff;
    bottom: 4px;
    content: "";
    height: 16px;
    left: 4px;
    position: absolute;
    transition: .4s;
    width: 16px;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #007bff;
}
input:checked + .slider:before {
    transform: translateX(26px);
}

/* --- ESTILOS DE B√öSQUEDA ACTIVA --- */
body.search-active .app-title,
body.search-active #header-controls,
body.search-active .section-selector,
body.search-active .footer {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px);
    max-height: 0; /* Colapsa el espacio vertical */
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    border: none !important;
}

body.search-active .container {
    padding-top: 80px; /* Crea espacio para la barra de b√∫squeda fija */
    transition: padding-top 0.35s ease-in-out;
}

body.search-active .search-container {
    position: fixed;
    top: 15px;
    left: 0;
    right: 0;
    padding: 0 20px;
    margin: 0;
    max-width: 100%;
    z-index: 1500;
}

body.search-active #searchInput {
    padding-left: 55px; /* Espacio para el logo */
    height: 48px;
    box-sizing: border-box;
}

body.search-active .app-logo {
    position: fixed;
    top: 22px;       /* 15px (search-container top) + 7px (para centrar) */
    left: 30px;      /* 20px (search-container padding) + 10px (margen interno) */
    max-width: 34px;
    z-index: 1501;   /* Por encima del input */
}


/* --- ESTILOS DE LA SELECCI√ìN DE SECCI√ìN --- */
.section-selector {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    transition: all 0.35s ease-in-out;
    flex-wrap: wrap;
    gap: 10px;
}
.section-btn {
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px 20px;
    margin: 0;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s, color 0.3s;
}
.section-btn.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}
.section-btn:hover:not(.active) {
    background-color: #e0e0e0;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}


/* Estilos de la Cuadr√≠cula */
.grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
}

@media (max-width: 480px) {
    .grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
    }
}

/* Estilos de la Tarjeta (Card) */
@keyframes card-enter {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.card {
    position: relative;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 140px;
    justify-self: center;
    /* Animaci√≥n de entrada */
    opacity: 0; /* Estado inicial para la animaci√≥n */
    animation: card-enter 0.5s ease-out forwards;
}
.animacion-ejecutada .card {
    /* Deshabilita la animaci√≥n si el contenedor ya la ejecut√≥ */
    animation: none;
    opacity: 1; /* Asegura que la tarjeta sea visible */
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* --- ESTILOS PARA LOGOS DE MARCAS (ICONOS) --- */
.brand-logo-item {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 10px !important;
    max-width: 120px;
    justify-self: center;
    align-self: center;
    animation: none !important; /* Override card enter animation */
    opacity: 1 !important;
    overflow: visible !important; /* Allow shadow to be visible */
}
.brand-logo-item:hover {
    transform: scale(1.1);
    box-shadow: none !important;
}
.brand-logo-item img {
    filter: drop-shadow(2px 4px 5px rgba(0,0,0,0.3));
    transition: filter 0.3s ease, transform 0.3s ease;
    width: 100%;
    height: auto;
    max-height: 80px;
    object-fit: contain;
    border-radius: 0 !important;
}
.brand-logo-item:hover img {
    filter: drop-shadow(3px 5px 7px rgba(0,0,0,0.4));
}

/* --- ESTILOS DEL CARRUSEL --- */
.carousel-container {
    position: relative;
    overflow: hidden;
    max-width: 100%;
    margin: 0 auto;
    padding: 0 25px; /* Espacio para que los botones no se superpongan */
}
.carousel-track {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch; /* Para scrolling suave en iOS */
    scrollbar-width: none; /* Ocultar scrollbar en Firefox */
}
.carousel-track::-webkit-scrollbar {
    display: none; /* Ocultar scrollbar en Chrome, Safari, etc. */
}
.carousel-container .card {
    flex: 0 0 140px; /* Ancho fijo para cada tarjeta */
    margin-right: 20px;
}
.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.carousel-btn:hover {
    background: #fff;
}
.carousel-btn.prev {
    left: -5px;
}
.carousel-btn.next {
    right: -5px;
}

/* --- ESTILOS DE SKELETON LOADER --- */
.skeleton-grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, 140px);
    justify-content: center;
    max-width: 1200px;
    margin: 0 auto;
}
.skeleton-card {
    background: #e0e0e0;
    border-radius: 12px;
    width: 140px;
    height: 188px; /* Altura total de la tarjeta real */
    position: relative;
    overflow: hidden;
}
.skeleton-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 150%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: loading-shimmer 1.5s infinite;
}
@keyframes loading-shimmer {
    0% {
        left: -150%;
    }
    100% {
        left: 150%;
    }
}
.card img {
    width: 100%;
    height: 120px;
    object-fit: contain;
    display: block;
    border-radius: 0;
}
.overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
    color: #fff;
    padding: 10px 8px 8px 8px;
    font-size: 0.9em;
    line-height: 1.3;
    font-weight: bold;
    border-radius: 0;
    z-index: 10;
}

/* --- ESTILOS DEL MODAL DE LOGIN --- */
#login-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

#login-modal .modal-content {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 40px;
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    text-align: center;
    color: #f0f0f0;
}

#login-modal h2 {
    margin-bottom: 25px;
    font-size: 2em;
    font-weight: 300;
}

#login-modal .form-group {
    margin-bottom: 20px;
    text-align: left;
}

#login-modal label {
    display: block;
    margin-bottom: 8px;
    font-weight: 300;
    color: #ccc;
}

#login-modal input {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #fff;
    font-size: 1em;
    box-sizing: border-box;
}

#login-modal input:focus {
    outline: none;
    border-color: rgba(0, 123, 255, 0.5);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}

#login-modal button {
    width: 100%;
    padding: 12px;
    background: #007bff;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

#login-modal button:hover {
    background: #0056b3;
}

/* Modal */
#modalDetalle {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background: rgba(0, 0, 0, 0.6); /* Ligeramente m√°s claro */
    color: #000;
    z-index: 1600; /* Aumentado para estar sobre la barra de b√∫squeda */
    display: flex; /* Usar flex para centrar */
    align-items: center;
    justify-content: center;
    /* Transiciones para la aparici√≥n */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#modalDetalle.visible {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
}

#detalleCompleto {
    background: #fff;
    padding: 30px;
    width: 90%;
    max-width: 800px; /* Ancho m√°ximo para el modal */
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    max-height: 90vh;
    overflow-y: auto;
    /* Transici√≥n para el efecto de escalado */
    transform: scale(0.95);
    transition: transform 0.3s ease;
}

#modalDetalle.visible #detalleCompleto {
    transform: scale(1);
}

#detalleCompleto img, .info-modal-content img {
    display: block;
    width: auto;
    max-width: 100%;
    max-height: 300px;
    margin: 2px auto; /* Reducido aun m√°s */
    cursor: pointer;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.img-vehiculo {
    max-height: 200px !important;
}

/* --- ESTILOS PARA LA SECCI√ìN DE FEEDBACK EN MODAL --- */
.image-container-with-feedback {
    position: relative;
    display: inline-block;
    margin: 2px auto; /* Reducido aun m√°s */
}
.feedback-overlay {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: flex;
    flex-direction: row;
    gap: 8px;
}
.feedback-btn-overlay {
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
    font-size: 1.1em;
}
.feedback-btn-overlay:hover {
    background-color: rgba(0, 0, 0, 0.8);
    transform: scale(1.0); /* Efecto de escala reducido al pasar el mouse */
}

.feedback-btn-overlay {
    /* ... otros estilos ... */
    transform: scale(0.9); /* Reducci√≥n del 10% */
}
.feedback-btn-overlay.util-btn.liked {
    background-color: #28a745; /* Verde para indicar que se le dio "like" */
}

#detalleCompleto h4 {
    color: #007bff;
    border-bottom: 2px solid #eee;
    padding-bottom: 4px; /* Reducido */
    margin-top: 8px; /* Reducido aun m√°s */
    margin-bottom: 4px; /* Reducido aun m√°s */
}

#detalleCompleto p {
    margin: 1px 0; /* Reducido aun m√°s */
    line-height: 1.4; /* Mejora legibilidad en espacios compactos */
}

/* --- ESTILOS PARA SECCIONES DESPLEGABLES (ACORDE√ìN) --- */
.accordion-btn {
    background-color: #f0f0f0;
    color: #007bff; /* Color de texto azul */
    cursor: pointer;
    padding: 12px; /* Reducido */
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 1.05em; /* Ligeramente reducido */
    font-weight: bold;
    transition: background-color 0.3s ease;
    border-radius: 8px;
    margin-top: 2px; /* Reducido aun m√°s */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.accordion-btn:hover, .accordion-btn.active {
    background-color: #e0e0e0;
}
.accordion-arrow {
    transition: transform 0.3s ease;
    width: 20px;
    height: 20px;
}
.accordion-btn.active .accordion-arrow {
    transform: rotate(180deg); /* Flecha hacia arriba */
}
.panel-desplegable {
    padding: 0 18px;
    background-color: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    border-bottom: 1px solid #eee;
}

/* Lightbox */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Un poco m√°s suave */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1700; /* Aumentado para estar sobre el modal de detalles */
    /* Transiciones */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.lightbox.visible {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
}

.lightbox img {
    max-width: 95%;
    max-height: 95%;
    border-radius: 8px; /* Bordes redondeados sutiles */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    /* Transici√≥n para el efecto de zoom */
    transform: scale(0.95);
    transition: transform 0.3s ease;
}

.lightbox.visible img {
    transform: scale(1);
}

.footer {
    text-align: center;
    padding: 20px 0;
    margin-top: 40px;
    background-color: #333;
    color: #fff;
    font-size: 0.9em;
    display: none; /* Oculto por defecto */
    width: 100%;
    transition: all 0.35s ease-in-out;
}
.footer-links {
    margin-top: 10px; /* Added margin to separate from copyright */
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}
.footer-links a {
    color: #a0cfff;
    text-decoration: none;
    transition: color 0.2s;
    font-size: 0.8em; /* Adjusted to be smaller than the main footer text */
    cursor: pointer; /* Make it look clickable */
}
/* --- ESTILOS PARA MODALES DE INFORMACI√ìN --- */
.info-modal {
    display: none; position: fixed; z-index: 2100; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    align-items: center; justify-content: center;
}
.info-modal-content {
    background-color: #fff; margin: auto; padding: 25px; border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25); width: 90%; max-width: 700px;
    max-height: 90vh; overflow-y: auto; position: relative;
}
.info-close-btn {
    color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px;
    font-weight: bold; cursor: pointer;
}
/* Estilos para el formulario de contacto */
#contact-form .form-group {
    margin-bottom: 15px;
}
#contact-form label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}
#contact-form input,
#contact-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
#contact-form button {
    background-color: #007bff;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
}
#contact-form button:hover {
    background-color: #0056b3;
}
.footer-links a:hover {
    color: #fff;
    text-decoration: underline;
}
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f4f4f4;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000; /* Por encima de todo */
    transition: opacity 0.5s ease-out;
}
#splash-screen img {
    max-width: 150px;
    border-radius: 15px;
    animation: pulse 1.5s infinite ease-in-out;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* --- ESTILOS DEL TOAST DE ERROR GLOBAL --- */
#error-toast {
    display: none; /* Oculto por defecto */
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #dc3545; /* Rojo de error */
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 4000; /* Por encima de todo */
    font-size: 1em;
    max-width: 90%;
    text-align: center;
}

/* --- ESTILOS DEL TOAST DE NOTIFICACI√ìN --- */
#notification-toast {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #007bff;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 4001;
    font-size: 1em;
    cursor: pointer;
}
</style>
</head>
<body>
<!-- Notificaci√≥n Toast -->
<div id="notification-toast"></div>

<!-- Contenedor de la Consola de Depuraci√≥n -->
<div id="debug-console" style="display: none; position: fixed; bottom: 10px; right: 10px; width: 450px; height: 350px; background-color: rgba(20, 20, 30, 0.9); color: #00ff00; border: 1px solid #00ff00; border-radius: 8px; z-index: 9999; display: flex; flex-direction: column; font-family: 'Courier New', Courier, monospace; box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); backdrop-filter: blur(5px);">
    <div id="debug-header" style="padding: 8px; background-color: #00ff00; color: #14141e; font-weight: bold; cursor: move; border-top-left-radius: 7px; border-top-right-radius: 7px; display: flex; justify-content: space-between; align-items: center;">
        <span>GPSpedia Debug Console</span>
        <div>
            <button id="debug-clear" style="background:none; border:none; color:#14141e; cursor:pointer; font-size: 14px; margin-right: 5px;">[Clear]</button>
            <button id="debug-close" style="background:none; border:none; color:#14141e; cursor:pointer; font-size: 16px;">[X]</button>
        </div>
    </div>
    <div id="debug-log" style="flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 13px; line-height: 1.4;"></div>
    <div id="debug-resize-handle" style="height: 10px; background-color: #00ff00; cursor: ns-resize;"></div>
</div>
<!-- Notificaci√≥n de Error Global -->
<div id="error-toast"></div>

<!-- Side Menu (Hamburger) -->
<div id="menu-overlay"></div>
<div id="side-menu">
    <div style="padding: 20px; border-bottom: 1px solid #eee; text-align: center;">
        <h3 id="menu-username" style="margin: 0; color: #007bff;"></h3>
    </div>
    <nav>
        <a href="#" id="menu-cortes" class="menu-link"><i class="fa-solid fa-car-on"></i> Cortes</a>
        <a href="add_cortes.html" class="menu-link"><i class="fa-solid fa-plus-circle"></i> Agregar Nuevo</a>
        <a href="#" id="menu-tutoriales" class="menu-link"><i class="fa-solid fa-book-open"></i> Tutoriales</a>
        <a href="#" id="menu-relay" class="menu-link"><i class="fa-solid fa-microchip"></i> Configuraci√≥n Relay</a>
        <a href="users.html" class="menu-link"><i class="fa-solid fa-users-cog"></i> Mi Perfil / Usuarios</a>
        <a href="#" id="inbox-btn" class="menu-link" style="display: none;"><i class="fa-solid fa-inbox"></i> Inbox</a>
        <a href="#" id="dev-tools-btn" class="menu-link" style="display: none;"><i class="fa-solid fa-code"></i> Desarrollador</a>
    </nav>
    <div class="theme-switch-wrapper">
        <label style="margin-right: 10px;">Modo Oscuro</label>
        <label class="theme-switch" for="dark-mode-toggle">
            <input type="checkbox" id="dark-mode-toggle" />
            <div class="slider round"></div>
        </label>
    </div>
    <div style="padding: 20px;">
        <button id="side-menu-logout-button" style="width: 100%; background: #dc3545; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">Cerrar Sesi√≥n</button>
    </div>
</div>

<!-- Splash Screen -->
<div id="splash-screen">
    <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=w512" alt="Logo de GPSpedia">
</div>

<!-- Login Modal -->
<div id="login-modal" style="display: none;">
    <div class="modal-content">
        <img src="icon-v3-512x512.png" alt="Logo de GPSpedia" style="max-width: 120px; margin-bottom: 20px;">
        <h2>Iniciar Sesi√≥n</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Usuario</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            <button type="submit">Acceder</button>
            <p id="login-error" style="color: red; display: none;"></p>
        </form>
        <a href="#" id="forgot-password-link" style="color: #a0cfff; text-decoration: none; margin-top: 15px; display: inline-block;">¬øOlvidaste tu contrase√±a?</a>
    </div>
</div>

<div class="container" style="display: none;">

  <div class="header-container">
      <div class="header-branding" style="flex-direction: column; align-items: flex-start;">
          <div style="display: flex; align-items: center;">
              <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
              <h1 class="app-title">GPSpedia</h1>
          </div>
          <div id="welcome-message-container" style="padding-left: 10px;">
             <span id="welcome-message" style="display: none; color: #333; font-weight: bold; font-size: 0.8em;"></span>
          </div>
      </div>
      <div id="header-controls" style="display: flex; align-items: center; gap: 15px;">
          <button id="logout-button" style="display: none; background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">Cerrar Sesi√≥n</button>
      </div>
  </div>

  <!-- El bot√≥n de instalaci√≥n se mueve fuera del header-controls para que no se oculte con la b√∫squeda -->
  <button id="install-button" style="display: none;">Instalar Aplicaci√≥n</button>

  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
      <div class="search-container" style="flex-grow: 1;">
          <input type="text" id="searchInput" placeholder="Buscar Corte..." oninput="filtrarContenido(this.value)">
          <button id="clear-search-btn" title="Limpiar b√∫squeda">&times;</button>
      </div>
      <button id="hamburger-btn"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="section-selector">
      <button id="btn-cortes" class="section-btn active" onclick="mostrarSeccion('cortes')">Cortes</button>
      <button id="btn-tutoriales" class="section-btn" onclick="mostrarSeccion('tutoriales')">Tutoriales</button>
      <button id="btn-relay" class="section-btn" onclick="mostrarSeccion('relay')">Relay</button>
  </div>

  <div id="contenido" class="content-section"></div>
  <div id="contenido-tutoriales" class="content-section" style="display: none;"></div>
  <div id="contenido-relay" class="content-section" style="display: none;"></div>
</div>

<div id="modalDetalle">
  <div id="detalleCompleto"></div>
</div>

<div id="lightbox" class="lightbox" onclick="cerrarLightbox()">
  <img id="lightboxImg" src="">
</div>

<!-- ========= MODAL DE INBOX ========= -->
<div id="inbox-modal" class="info-modal">
    <div class="info-modal-content" style="max-width: 1100px;">
        <span class="info-close-btn">&times;</span>
        <h2><i class="fa-solid fa-inbox"></i> Bandeja de Entrada</h2>
        <div style="display: flex; gap: 20px;">
            <div id="inbox-list" style="flex: 1; height: 60vh; overflow-y: auto; border-right: 1px solid #ccc; padding-right: 15px;">
                <!-- List of items will be rendered here -->
            </div>
            <div id="inbox-detail" style="flex: 2;">
                <!-- Detail of selected item will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- ========= MODAL DE DESARROLLADOR ========= -->
<div id="dev-tools-modal" class="info-modal">
    <div class="info-modal-content" style="max-width: 900px;">
        <span class="info-close-btn">&times;</span>
        <h2><i class="fa-solid fa-code"></i> Herramientas de Desarrollador</h2>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h4>Consola de Depuraci√≥n</h4>
                <div id="dev-console-container" style="height: 400px; border: 1px solid #ccc; border-radius: 8px;">
                    <!-- The existing debug console will be moved here by JS -->
                </div>
            </div>
            <div style="flex: 1;">
                <h4>Acciones de Migraci√≥n</h4>
                <p>Ejecutar scripts de migraci√≥n de datos. Usar con precauci√≥n.</p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="run-migrate-years" class="btn btn-warning">Migrar Rangos de A√±os</button>
                    <button id="run-migrate-timestamps" class="btn btn-warning">Migrar Timestamps</button>
                </div>
                <div id="migration-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; background: #f0f0f0; display: none;"></div>
            </div>
        </div>
    </div>
</div>


<!-- ========= MODALES DE INFORMACI√ìN ========= -->
<div id="about-us-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Sobre Nosotros</h2>
    <p>GPSpedia es una plataforma especializada en la consulta t√©cnica y estandarizada de informaci√≥n vehicular, orientada a t√©cnicos, instaladores y profesionales que trabajan con sistemas de rastreo, seguridad y control vehicular.</p>
    <p>Nuestro objetivo es facilitar el acceso r√°pido y confiable a informaci√≥n pr√°ctica, reduciendo errores en campo y optimizando los tiempos de instalaci√≥n mediante una base de conocimiento clara, visual y en constante evoluci√≥n.</p>
    <p>La informaci√≥n que se presenta en GPSpedia es el resultado de una recopilaci√≥n estructurada de datos t√©cnicos provenientes de m√∫ltiples fuentes de libre acceso, experiencias pr√°cticas y aportes colaborativos. No reclamamos derechos de autor sobre dicha informaci√≥n t√©cnica; su prop√≥sito es educativo, operativo y de apoyo profesional.</p>
    <hr>
    <h4>¬øQu√© ofrece GPSpedia?</h4>
    <p><strong>üîß Informaci√≥n de cortes vehiculares:</strong> Identificaci√≥n de puntos de corte el√©ctrico e ignici√≥n. Detalles claros sobre ubicaci√≥n, color del cable y tipo de corte recomendado.</p>
    <p><strong>üöó Tipos de cortes disponibles:</strong> Paro de motor (apagado remoto) y apertura de puertas.</p>
    <hr>
    <h4>Configuraciones de Relay</h4>
    <p>GPSpedia incluye una secci√≥n dedicada a configuraciones de relay, donde se explican de forma visual y descriptiva la funci√≥n de cada pin, su uso recomendado y diagramas claros para facilitar la correcta conexi√≥n.</p>
    <hr>
    <h4>Tutoriales y gu√≠as visuales</h4>
    <p>Ofrecemos tutoriales paso a paso y gu√≠as visuales para la ubicaci√≥n de m√≥dulos, desarme b√°sico de interiores y reconocimiento de cableado.</p>
    <hr>
    <h4>Enfoque colaborativo y mejora continua</h4>
    <p>GPSpedia evoluciona constantemente gracias a la retroalimentaci√≥n de sus usuarios, lo que permite mejorar la precisi√≥n de la informaci√≥n y ampliar la cobertura de marcas y modelos.</p>
  </div>
</div>

<div id="contact-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Cont√°ctanos</h2>
    <p>Si tienes sugerencias, problemas con la plataforma o necesitas soporte t√©cnico, por favor utiliza este formulario. Tu feedback es importante para nosotros.</p>
    <form id="contact-form">
      <div class="form-group">
        <label for="contact-name">Nombre</label>
        <input type="text" id="contact-name" required>
      </div>
      <div class="form-group">
        <label for="contact-email">Correo Electr√≥nico</label>
        <input type="email" id="contact-email" required>
      </div>
      <div class="form-group">
        <label for="contact-message">Mensaje</label>
        <textarea id="contact-message" rows="4" required></textarea>
      </div>
      <button type="submit" class="btn">Enviar Mensaje</button>
    </form>
  </div>
</div>

<div id="faq-modal" class="info-modal">
  <div class="info-modal-content">
    <span class="info-close-btn">&times;</span>
    <h2>Preguntas Frecuentes (FAQ)</h2>
    <div class="accordion">
      <div class="accordion-item"><div class="accordion-header">¬øGPSpedia es un sistema de rastreo GPS?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>No. GPSpedia no rastrea veh√≠culos ni gestiona dispositivos. Es una plataforma informativa y de consulta t√©cnica.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øLa informaci√≥n tiene derechos de autor?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>La informaci√≥n t√©cnica presentada es una compilaci√≥n de datos de libre acceso y conocimiento pr√°ctico, organizada con fines educativos y profesionales. GPSpedia no reclama autor√≠a exclusiva sobre dicha informaci√≥n.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øPuedo usar esta informaci√≥n en instalaciones reales?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. El contenido est√° pensado para apoyo t√©cnico, pero siempre se recomienda que las instalaciones sean realizadas por personal capacitado y siguiendo buenas pr√°cticas de seguridad el√©ctrica.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øIncluye informaci√≥n para diferentes tipos de veh√≠culos?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. La plataforma contempla distintas categor√≠as vehiculares, como autom√≥viles, camiones, motocicletas y equipos especiales, seg√∫n disponibilidad de informaci√≥n.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øLa informaci√≥n se actualiza?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>S√≠. GPSpedia est√° dise√±ada para crecer y mejorar continuamente, incorporando nuevos datos, correcciones y ampliaciones conforme se valida su uso en campo.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øGPSpedia ense√±a c√≥mo instalar dispositivos?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>GPSpedia no sustituye la capacitaci√≥n profesional, pero ofrece referencias t√©cnicas, diagramas y gu√≠as que facilitan el trabajo de t√©cnicos con experiencia.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øC√≥mo obtengo una cuenta?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>Para solicitar acceso, completa el formulario disponible en la secci√≥n ‚ÄúCont√°ctanos‚Äù. Nuestro equipo revisar√° la solicitud y te brindar√° seguimiento conforme al uso profesional de la plataforma.</p></div></div>
      <div class="accordion-item"><div class="accordion-header">¬øQu√© hacer si no est√° la informaci√≥n de un veh√≠culo?<i class="fas fa-chevron-down"></i></div><div class="accordion-content"><p>Si un veh√≠culo no cuenta a√∫n con informaci√≥n espec√≠fica, GPSpedia ofrece tutoriales descriptivos y material audiovisual que facilitan la identificaci√≥n de cables de corte, puntos de ignici√≥n y configuraciones comunes.</p></div></div>
    </div>
  </div>
</div>

<script src="api-manager.js"></script>
<script>
// --- SISTEMA DE DEPURACI√ìN AVANZADO DEL FRONTEND ---

// La consola de depuraci√≥n ahora se controla √∫nicamente a trav√©s del modal de desarrollador
const isDebugMode = new URLSearchParams(window.location.search).has('debug'); // Se mantiene para debugLog, pero no para visibilidad
const debugConsole = document.getElementById('debug-console');

/**
 * Registra un mensaje en la consola de depuraci√≥n del frontend.
 * @param {string} type - El tipo de log (p.ej., 'API_REQUEST', 'API_RESPONSE', 'ERROR', 'INFO').
 * @param {string} message - El mensaje principal a registrar.
 * @param {object} data - Un objeto con datos adicionales para mostrar.
 */
function debugLog(type, message, data) {
    if (!isDebugMode) return;

    const logEntry = document.createElement('div');
    logEntry.style.marginBottom = '10px';
    logEntry.style.borderBottom = '1px dashed #333';
    logEntry.style.paddingBottom = '10px';

    const timestamp = new Date().toLocaleTimeString();
    let color = '#00ff00'; // Verde por defecto
    if (type.includes('ERROR') || type.includes('FAIL')) {
        color = '#ff4136'; // Rojo para errores
    } else if (type.includes('REQUEST')) {
        color = '#7FDBFF'; // Azul claro para peticiones
    } else if (type.includes('RESPONSE')) {
        color = '#39CCCC'; // Turquesa para respuestas
    }

    let html = `<strong style="color: ${color};">[${type}]</strong> <span style="color: #aaa;">${timestamp}</span><br/>${message}`;

    if (data) {
        // Formatear el objeto de datos como un JSON bonito
        const jsonData = JSON.stringify(data, null, 2);
        html += `<pre style="background-color: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px; margin-top: 5px; color: #fff; white-space: pre-wrap; word-wrap: break-word;">${jsonData}</pre>`;
    }

    logEntry.innerHTML = html;
    const debugLogDiv = document.getElementById('debug-log');
    debugLogDiv.appendChild(logEntry);
    debugLogDiv.scrollTop = debugLogDiv.scrollHeight; // Auto-scroll hacia abajo
}

// L√≥gica para hacer la consola arrastrable y redimensionable
const header = document.getElementById('debug-header');
const resizeHandle = document.getElementById('debug-resize-handle');
const closeButton = document.getElementById('debug-close');
const clearButton = document.getElementById('debug-clear');

let isDragging = false;
let isResizing = false;
let initialX, initialY, initialWidth, initialHeight;
let offsetX, offsetY;

header.addEventListener('mousedown', (e) => {
    isDragging = true;
    const rect = debugConsole.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    document.body.style.userSelect = 'none'; // Evitar seleccionar texto mientras se arrastra
});

resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    initialHeight = debugConsole.offsetHeight;
    initialY = e.clientY;
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        debugConsole.style.left = `${e.clientX - offsetX}px`;
        debugConsole.style.top = `${e.clientY - offsetY}px`;
        // Eliminar bottom y right para que no interfieran con el posicionamiento
        debugConsole.style.bottom = 'auto';
        debugConsole.style.right = 'auto';
    }
    if (isResizing) {
        const newHeight = initialHeight - (e.clientY - initialY);
        debugConsole.style.height = `${newHeight}px`;
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
    isResizing = false;
    document.body.style.userSelect = 'auto';
});

closeButton.addEventListener('click', () => {
    debugConsole.style.display = 'none';
});

clearButton.addEventListener('click', () => {
    document.getElementById('debug-log').innerHTML = '';
});

// Sobrescribir window.onerror para capturar todos los errores de JS
window.onerror = function(message, source, lineno, colno, error) {
    debugLog('JAVASCRIPT_ERROR', `Error no capturado: ${message}`, {
        source: `${source}:${lineno}:${colno}`,
        stack: error ? error.stack : 'No disponible'
    });
    // Devuelve false para que el error tambi√©n se muestre en la consola del navegador
    return false;
};


// --- L√ìGICA DE DEPURACI√ìN REMOTA (SE MANTIENE PERO AHORA TAMBI√âN LOGUEA LOCALMENTE) ---
function remoteLog(level, message, data = {}) {
    // Loguear en la nueva consola de depuraci√≥n local
    debugLog(`REMOTE_${level}`, message, data);

    // Non-blocking call to the backend logger
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'logFrontend', payload: { level, message, data } }),
        keepalive: true // Ensure the request is sent even if the page is closing
    }).catch(error => {
        debugLog('REMOTE_FAIL', 'Fallo al enviar log remoto', { error: error.message });
    });
}

// --- L√ìGICA DE INDEXEDDB ---
// Note: IndexedDB logic is being kept for potential future offline capabilities,
// but the current implementation will prioritize fetching from the Apps Script backend.
const DB_NAME = 'gpsepedia-db';
const DB_VERSION = 1;
const STORES = ['cortes', 'tutoriales', 'relay'];
let db;

// --- L√ìGICA DE DATOS Y API ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpIFH1nX2BZEjAKbpq9HJpEGNlo_0LqD1CwxWsWFo5J0AJDdbfMrKpcsAV4ZFJzFWd/exec";
const SESSION_KEY = 'gpsepedia_session';

// --- L√ìGICA DE AUTENTICACI√ìN Y SESI√ìN ---

function sanitizeInput(input) {
    if (typeof input !== 'string') return '';
    // Prevenir inyecci√≥n de f√≥rmulas de Excel escapando caracteres iniciales peligrosos
    let sanitized = input.trim();
    if (['=', '+', '-', '@', '\t', '\r'].includes(sanitized.charAt(0))) {
        sanitized = "'" + sanitized;
    }
    // La sanitizaci√≥n de SQL se elimin√≥ para evitar la alteraci√≥n de contrase√±as
    // con caracteres especiales, que estaba causando fallos de autenticaci√≥n.
    return sanitized;
}

const SESSION_ID_KEY = 'gpsepedia_session_id';
// La funci√≥n postToAction ahora es reemplazada por routeAction del api-manager.js
async function postToAction(action, payload = {}) {
    debugLog('API_REQUEST', `Ejecutando acci√≥n: ${action}`, payload);

    try {
        // Usamos el nuevo enrutador
        const result = await routeAction(action, payload);
        debugLog('API_RESPONSE', `Respuesta recibida para: ${action}`, result);
        return result;
    } catch (error) {
        debugLog('API_ERROR', `Error en la acci√≥n: ${action}`, {
            name: error.name,
            message: error.message,
            stack: error.stack
        });

        let userMessage = `Error inesperado: ${error.message}`;
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            userMessage = "Fallo de conexi√≥n con el servidor. Por favor, verifica tu conexi√≥n a internet e int√©ntalo de nuevo. Si el problema persiste, contacta al administrador.";
        } else if (error.message.includes('JSON')) {
            userMessage = "La respuesta del servidor no es v√°lida. Por favor, contacta al administrador.";
        } else if (error.message.includes('Credenciales inv√°lidas')) {
            userMessage = "El usuario o la contrase√±a son incorrectos.";
        }

        const loginErrorElement = document.getElementById('login-error');
        if (loginErrorElement && loginErrorElement.offsetParent !== null) {
            // Solo muestra el error en el modal de login si est√° visible
            loginErrorElement.textContent = userMessage;
            loginErrorElement.style.display = 'block';
        } else {
            // Si no, usa el sistema de notificaci√≥n global
            showGlobalError(userMessage);
        }

        throw error; // Re-lanzar el error
    }
}

let errorToastTimeout;
function showGlobalError(message) {
    const toast = document.getElementById('error-toast');
    if (!toast) return;

    toast.textContent = message;
    toast.style.display = 'block';

    // Limpiar cualquier timeout anterior para resetear el timer
    if (errorToastTimeout) {
        clearTimeout(errorToastTimeout);
    }

    // Ocultar el toast despu√©s de 7 segundos
    errorToastTimeout = setTimeout(() => {
        toast.style.display = 'none';
    }, 7000);
}

async function checkSession() {
    remoteLog('INFO', 'checkSession started');
    const sessionData = localStorage.getItem(SESSION_KEY);
    if (sessionData) {
        remoteLog('INFO', 'Session data found in localStorage.');
        try {
            const user = JSON.parse(sessionData);
            remoteLog('INFO', 'Attempting to validate session for user.', { userId: user.ID });
            const result = await postToAction('validateSession', { userId: user.ID, sessionToken: user.SessionToken });

            if (result.valid) {
                remoteLog('INFO', 'Session is valid. Initializing app.');
                await initializeAppData(user);
            } else {
                remoteLog('WARN', 'Session is invalid according to backend. Logging out.');
                logout("Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n de nuevo.");
            }
        } catch (error) {
            remoteLog('ERROR', 'Error during session validation.', { error: error.message, stack: error.stack });
            showLoginHideApp();
        }
    } else {
        remoteLog('INFO', 'No session data found. Showing login.');
        showLoginHideApp();
    }
}

async function login(username, password) {
    try {
        const result = await postToAction('login', { username, password });
        // La respuesta de login ahora contiene el objeto 'user' completo, incluyendo el nuevo SessionToken.
        // Al guardar este objeto, estamos actualizando el token en localStorage autom√°ticamente.
        localStorage.setItem(SESSION_KEY, JSON.stringify(result.user));
        await initializeAppData(result.user);
    } catch (error) {
        // El error ya se muestra en postToAction
    }
}

async function initializeAppData(user) {
    return new Promise(async (resolve, reject) => {
        hideLoginShowApp();
        document.getElementById('welcome-message').textContent = `Bienvenido, ${user.Nombre_Usuario}`;
        document.getElementById('welcome-message').style.display = 'block';

        showSkeletonLoader(document.getElementById('contenido'));

        try {
            const result = await postToAction('getCatalogData');
            datosOriginales = result.data.cortes || [];
            sortedCategoriesList = result.data.sortedCategories || []; // <-- NUEVA L√çNEA
            datosTutoriales = result.data.tutoriales || [];
            datosRelay = result.data.relay || [];
            datosLogos = result.data.logos || [];

            // Notification Logic
            const lastTimestampKey = 'lastKnownTimestamp';
            const lastKnownTimestamp = localStorage.getItem(lastTimestampKey);
            const latestItem = datosOriginales.reduce((latest, item) => {
                return (item.timestamp && item.timestamp > (latest.timestamp || 0)) ? item : latest;
            }, {});

            if (latestItem.timestamp) {
                if (!lastKnownTimestamp || latestItem.timestamp > lastKnownTimestamp) {
                    showNotificationToast(`¬°Nuevo corte agregado para ${latestItem.marca} ${latestItem.modelo}!`);
                }
                localStorage.setItem(lastTimestampKey, latestItem.timestamp);
            }

            mostrarCategorias();
            resolve(); // Resolve the promise after content is rendered
        } catch (error) {
            document.getElementById('contenido').innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar el cat√°logo. ${error.message}</p>`;
            reject(error); // Reject the promise on error
        }
    });
}

function logout(reason = null) {
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem(SESSION_ID_KEY);

    showLoginHideApp(reason);
}

function showLoginHideApp(reason = null) {
    // La l√≥gica de visibilidad es cr√≠tica y debe ejecutarse sin interrupciones.
    try {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.style.display = 'none';

        const container = document.querySelector('.container');
        if (container) container.style.display = 'none';

        const footer = document.querySelector('.footer');
        if (footer) footer.style.display = 'none';

        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) welcomeMsg.style.display = 'none';

        const loginModal = document.getElementById('login-modal');
        if (loginModal) loginModal.style.display = 'flex';

        const loginError = document.getElementById('login-error');
        if (loginError) {
            if (reason) {
                loginError.textContent = reason;
                loginError.style.display = 'block';
            } else {
                loginError.style.display = 'none';
            }
        }

        const usernameInput = document.getElementById('username');
        if (usernameInput) usernameInput.value = '';

        const passwordInput = document.getElementById('password');
        if (passwordInput) passwordInput.value = '';

    } catch (e) {
        // Si incluso la l√≥gica de visibilidad falla, loguear localmente.
        debugLog('CRITICAL_ERROR', 'Fallo al modificar la visibilidad de los elementos base.', { error: e.message, stack: e.stack });
    }

    // El logging es secundario y se a√≠sla para que no interrumpa el renderizado.
    try {
        remoteLog('INFO', 'showLoginHideApp finalizado.', { reason });
    } catch (e) {
        // El fallo de remoteLog ya se captura internamente, no es necesario hacer nada aqu√≠.
    }
}

function hideLoginShowApp() {
    remoteLog('INFO', 'hideLoginShowApp called');
    // Ocultar splash y login
    const splash = document.getElementById('splash-screen');
    splash.style.opacity = '0';
    setTimeout(() => {
        splash.style.display = 'none';
    }, 500); // Coincide con la transici√≥n de opacidad

    document.getElementById('login-modal').style.display = 'none';
    remoteLog('INFO', 'Login modal display style set to none.');

    // Mostrar contenido principal y footer
    document.querySelector('.container').style.display = 'block';
    const footer = document.querySelector('.footer');
    if (footer) footer.style.display = 'block';

    // Cargar nombre de usuario en el men√∫ lateral
    const menuUsername = document.getElementById('menu-username');
    const session = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (menuUsername && session && session.Nombre_Usuario) {
        menuUsername.textContent = session.Nombre_Usuario;
    }

    // Show developer tools button if user has the role
    const devToolsBtn = document.getElementById('dev-tools-btn');
    const userRole = session ? session.Privilegios : '';

    if (devToolsBtn && userRole === 'Desarrollador') {
        devToolsBtn.style.display = 'flex';
    }

    // Show Inbox button for relevant roles
    const inboxBtn = document.getElementById('inbox-btn');
    if (inboxBtn && ['Desarrollador', 'Gefe', 'Supervisor'].includes(userRole)) {
        inboxBtn.style.display = 'flex';
    }
}


document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = sanitizeInput(document.getElementById('username').value);
    const password = document.getElementById('password').value; // Eliminado sanitizeInput
    login(username, password);
});

document.getElementById('forgot-password-link').addEventListener('click', (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const message = encodeURIComponent(`Hola, necesito recuperar mi contrase√±a. Mi nombre de usuario es: ${username}`);
    const whatsappUrl = `https://wa.me/50488422786?text=${message}`;
    window.open(whatsappUrl, '_blank');
});

// Listener para detectar cambios de sesi√≥n en otras pesta√±as
window.addEventListener('storage', (event) => {
    if (event.key === 'session_update' || event.key === SESSION_ID_KEY) {
        checkSession();
    }
});

function showSkeletonLoader(container) {
    let skeletonHTML = '<div class="skeleton-grid">';
    for (let i = 0; i < 10; i++) { // Muestra 10 tarjetas esqueleto
        skeletonHTML += '<div class="skeleton-card"></div>';
    }
    skeletonHTML += '</div>';
    container.innerHTML = skeletonHTML;
}

// --- VARIABLES GLOBALES DE DATOS ---
let datosOriginales = [], sortedCategoriesList = [], datosFiltrados = [], datosTutoriales = [], datosRelay = [];
let estado = { nivel: "categorias", categoria: null, marca: null, modelo: null };
let appOpenedFromLink = false;

const backSvg = '<svg style="width:20px;height:20px;margin-right:5px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>';

// --- Funci√≥n para crear carruseles (Movida al √°mbito global para evitar ReferenceError) ---
const crearCarrusel = (titulo, items, cardGenerator) => {
    const cont = document.getElementById("contenido"); // Asegurarse que el contenedor sea accesible
    if (!items || items.length === 0 || !cont) return;

    const section = document.createElement('div');
    const title = document.createElement('h4');
    title.textContent = titulo;
    title.style.marginTop = '40px';
    section.appendChild(title);

    const carouselContainer = document.createElement('div');
    carouselContainer.className = 'carousel-container';
    const carouselTrack = document.createElement('div');
    carouselTrack.className = 'carousel-track';

    items.forEach(item => {
        const card = cardGenerator(item);
        carouselTrack.appendChild(card);
    });
    carouselContainer.appendChild(carouselTrack);

    // --- L√≥gica de Navegaci√≥n Generalizada ---
    const getVisibleCards = () => {
        const containerWidth = carouselContainer.offsetWidth;
        const cardWidth = 140 + 20; // Ancho de la tarjeta + margen
        return Math.floor(containerWidth / cardWidth) || 1;
    };

    if (items.length > getVisibleCards()) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'carousel-btn prev';
        prevBtn.innerHTML = '&#10094;';
        carouselContainer.appendChild(prevBtn);

        const nextBtn = document.createElement('button');
        nextBtn.className = 'carousel-btn next';
        nextBtn.innerHTML = '&#10095;';
        carouselContainer.appendChild(nextBtn);

        const cardWidth = 140 + 20;

        const updateCarouselButtons = () => {
            const scrollLeft = carouselTrack.scrollLeft;
            const maxScrollLeft = carouselTrack.scrollWidth - carouselTrack.clientWidth;
            prevBtn.style.display = scrollLeft > 0 ? 'flex' : 'none';
            nextBtn.style.display = scrollLeft < maxScrollLeft - 1 ? 'flex' : 'none';
        };

        nextBtn.addEventListener('click', () => {
            carouselTrack.scrollBy({ left: cardWidth * getVisibleCards(), behavior: 'smooth' });
        });

        prevBtn.addEventListener('click', () => {
            carouselTrack.scrollBy({ left: -cardWidth * getVisibleCards(), behavior: 'smooth' });
        });

        carouselTrack.addEventListener('scroll', () => setTimeout(updateCarouselButtons, 150));
        window.addEventListener('resize', () => setTimeout(updateCarouselButtons, 150));
        setTimeout(updateCarouselButtons, 150); // Llamada inicial
    }

    section.appendChild(carouselContainer);
    cont.appendChild(section);
};

// La funci√≥n syncAndFetchData ha sido eliminada. La carga de datos ahora se centraliza en initializeAppData.

function mostrarSeccion(seccion) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput.value !== '') {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));

    const containerId = `contenido${seccion === 'cortes' ? '' : '-' + seccion}`;
    const renderFunction = {
        cortes: mostrarCategorias,
        tutoriales: mostrarContenidoTutoriales,
        relay: mostrarContenidoRelay
    }[seccion];

    document.getElementById(containerId).style.display = 'block';
    document.getElementById(`btn-${seccion}`).classList.add('active');

    if (renderFunction) {
        renderFunction();
    }
}

function irAPaginaPrincipal() {
    mostrarSeccion('cortes');
}

function mostrarContenidoTutoriales() {
    const cont = document.getElementById("contenido-tutoriales");
    cont.innerHTML = "<h4>Tutoriales</h4>";
    const grid = document.createElement("div"); grid.className = "grid";
    if (!datosTutoriales || datosTutoriales.length === 0) {
        cont.innerHTML += "<p>No hay tutoriales disponibles.</p>";
        return;
    }

    datosTutoriales.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarDetalleTutorial(item);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(item.Imagen);
        img.alt = item.Tema;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = item.Tema;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarCategoriasPorMarca(marca) {
    estado = { nivel: "categoriasPorMarca", marca: marca };
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="irAPaginaPrincipal()">${backSvg} Volver</span><h4>Categor√≠as para ${marca}</h4>`;

    const categoriasDeMarca = [...new Set(datosOriginales
        .filter(item => item.marca === marca)
        .map(item => item.categoria))]
        .filter(Boolean).sort();

    const grid = document.createElement("div");
    grid.className = "grid";
    categoriasDeMarca.forEach(cat => {
        const ejemplo = datosOriginales.find(item => item.categoria === cat && item.marca === marca && item.imagenVehiculo);
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarModelos(cat, marca); // Ahora s√≠ se pasa la categor√≠a
        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(ejemplo?.imagenVehiculo);
        img.alt = `Categor√≠a ${cat}`;
        card.appendChild(img);
        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = cat;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarContenidoRelay() {
    const cont = document.getElementById("contenido-relay");
    cont.innerHTML = "<h4>Configuraci√≥n del Relay</h4>";
    const grid = document.createElement("div"); grid.className = "grid";
    if (!datosRelay || datosRelay.length === 0) {
        cont.innerHTML += "<p>No hay configuraciones de relay disponibles.</p>";
        return;
    }

    datosRelay.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarDetalleRelay(item);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(item.imagen);
        img.alt = item.configuracion;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = item.configuracion;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function handleInModalEdit(itemId, fieldName, iconElement) {
    const label = iconElement.parentElement.querySelector('strong').textContent.replace(':', '');
    const newValue = prompt(`Editar valor para "${label}":`);
    if (newValue && newValue.trim() !== '') {
        const parentP = iconElement.parentElement;
        const contentSpan = parentP.querySelector('.field-value');
        contentSpan.textContent = newValue;
        contentSpan.classList.remove('empty-field');
        iconElement.style.color = '#ccc';
        iconElement.style.cursor = 'not-allowed';
        iconElement.onclick = null;
        // NOTE: Backend saving is intentionally skipped as per instructions.
        alert('Valor actualizado visualmente. El guardado en la base de datos no est√° implementado en este paso.');
    }
}

function crearElementoDetalle(label, value, itemId, fieldName) {
    const p = document.createElement("p");
    const hasValue = value && value.trim() !== '';
    const content = hasValue ? value.replace(/\n/g, '<br>') : 'No especificado';
    const contentClass = hasValue ? 'field-value' : 'field-value empty-field';
    const iconStyle = hasValue ? 'color: #ccc; cursor: not-allowed;' : 'color: #007bff; cursor: pointer;';
    const onClickAction = hasValue ? '' : `handleInModalEdit('${itemId}', '${fieldName}', this)`;

    p.innerHTML = `<strong>${label}:</strong> <span class="${contentClass}">${content}</span> <i class="fa-solid fa-pencil edit-icon" style="margin-left: 8px; font-size: 0.8em; ${iconStyle}" onclick="${onClickAction}"></i>`;
    return p;
}

function crearImagenDetalle(label, value, container, { extraClass = '', feedbackActions = null } = {}) {
    if (!value) return;

    const wrapper = document.createElement('div');
    const h = document.createElement("h4");
    h.textContent = label;
    wrapper.appendChild(h);

    const imgContainer = document.createElement('div');
    imgContainer.className = 'image-container-with-feedback';

    const img = document.createElement("img");
    img.src = convertirAGoogleThumbnail(value);
    img.alt = label;
    if (extraClass) img.classList.add(extraClass);
    img.onclick = () => mostrarLightbox(value);
    imgContainer.appendChild(img);

    if (feedbackActions) {
        const overlay = document.createElement('div');
        overlay.className = 'feedback-overlay';
        overlay.appendChild(feedbackActions.util);
        overlay.appendChild(feedbackActions.report);
        imgContainer.appendChild(overlay);
    }

    wrapper.appendChild(imgContainer);
    container.appendChild(wrapper);
}


function crearVideoDetalle(label, value, container) {
    if (!value) return;
    const videoId = extractYouTubeId(String(value).trim());
    if (!videoId) return;

    const h = document.createElement("h4");
    h.textContent = label;
    container.appendChild(h);

    const iframeContainer = document.createElement("div");
    iframeContainer.style.cssText = "position:relative; padding-bottom:56.25%; height:0; margin-bottom:20px;";
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    iframe.title = label;
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.cssText = "border:none; position:absolute; top:0; left:0; width:100%; height:100%;";
    iframe.dataset.originalSrc = iframe.src;
    iframeContainer.appendChild(iframe);
    container.appendChild(iframeContainer);
}

const uiState = { isModalOpen: false, isSearchActive: false };

window.addEventListener('popstate', (event) => {
    const state = event.state || {};
    if (uiState.isModalOpen && !state.modal) {
        cerrarModalVisualmente();
    } else if (uiState.isSearchActive && !state.search) {
        uiState.isSearchActive = false;
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        searchInput.blur();
        document.body.classList.remove('search-active');
    }
});

function pushState(state) {
    history.pushState(state, '');
}

function crearBotonCompartir(seccion, id, titulo) {
    const shareBtn = document.createElement("button");
    shareBtn.textContent = "Compartir";
    shareBtn.className = "shareBtn";
    shareBtn.style.cssText = "color:white; background:#007bff; border:none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;";
    const shareUrl = `${window.location.origin}${window.location.pathname}?seccion=${seccion}&id=${id}`;

    shareBtn.onclick = async () => {
        const shareData = { title: 'GPSpedia Detalle', text: `Mira este detalle: ${titulo}`, url: shareUrl };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                await navigator.clipboard.writeText(shareUrl);
                shareBtn.textContent = '¬°Enlace Copiado!';
                setTimeout(() => { shareBtn.textContent = 'Compartir'; }, 2000);
            }
        } catch (err) {
            console.error('Error al compartir/copiar:', err);
            alert('No se pudo compartir o copiar el enlace.');
        }
    };
    return shareBtn;
}

function mostrarDetalleTutorial(item) {
    pushState({ modal: true, type: 'tutorial', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = "";

    // Header
    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;";
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";
    headerDiv.appendChild(closeBtn);
    headerDiv.appendChild(crearBotonCompartir('tutoriales', item.id, item.tema));
    cont.appendChild(headerDiv);

    const title = document.createElement("h2");
    title.textContent = item.tema;
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "C√≥mo identificarlo", value: item.comoIdentificarlo, field: 'comoIdentificarlo' },
        { label: "D√≥nde encontrarlo", value: item.dondeEncontrarlo, field: 'dondeEncontrarlo' },
        { label: "Detalles", value: item.detalles, field: 'detalles' }
    ];
    campos.forEach(c => {
        cont.appendChild(crearElementoDetalle(c.label, c.value, item.id, c.field));
    });

    crearImagenDetalle("Imagen", item.Imagen, cont);
    crearVideoDetalle("Video Gu√≠a", item.Video, cont);
    document.getElementById("modalDetalle").classList.add("visible");
}

function mostrarDetalleRelay(item) {
    pushState({ modal: true, type: 'relay', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = ""; // Limpiar contenido anterior

    // --- 1. Botones de Cerrar y Compartir ---
    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"; // Reducido el margen
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";
    headerDiv.appendChild(closeBtn);
    headerDiv.appendChild(crearBotonCompartir('relay', item.id, item.configuracion));
    cont.appendChild(headerDiv);

    const title = document.createElement("h2");
    title.textContent = `Detalle de: ${item.configuracion}`;
    title.style.cssText = "color:#007bff; border-bottom:3px solid #007bff; padding-bottom:10px;";
    cont.appendChild(title);

    const campos = [
        { label: "Funci√≥n", value: item.funcion, field: 'funcion' },
        { label: "Veh√≠culo donde se utiliza", value: item.vehiculoDondeSeUtiliza, field: 'vehiculoDondeSeUtiliza' },
        { label: "PIN 30 (entrada)", value: item.pin30Entrada, field: 'pin30Entrada' },
        { label: "PIN 85 (bobina +)", value: item.pin85Bobina, field: 'pin85BobinaPositivo' },
        { label: "PIN 86 (bobina - )", value: item.pin86Bobina, field: 'pin86bobinaNegativo' },
        { label: "PIN 87a (comun cerrado)", value: item.pin87aComunCerrado, field: 'pin87aComunCerrado' },
        { label: "PIN 87 (Comunmente Abierto)", value: item.pin87ComunmenteAbierto, field: 'pin87ComunmenteAbierto' },
        { label: "Observaci√≥n", value: item.observacion, field: 'observacion' }
    ];
    campos.forEach(c => {
        cont.appendChild(crearElementoDetalle(c.label, c.value, item.id, c.field));
    });
    crearImagenDetalle("Diagrama", item.imagen, cont);
    const relayImg = cont.querySelector('img[alt="Imagen"]');
    if (relayImg) {
        relayImg.style.maxHeight = '250px';
    }
    document.getElementById("modalDetalle").classList.add("visible");
}

function getLogoUrlForMarca(marca, categoria) {
    if (!datosLogos || datosLogos.length === 0) return null;
    if (!marca) return null;

    const normalize = (str) => str ? str.toLowerCase().replace(/[^a-z0-9]/g, '') : '';
    const normalizedMarca = normalize(marca);

    const potentialMatches = datosLogos.filter(logo => {
        const normalizedLogoMarca = normalize(logo.nombreMarca);
        return normalizedLogoMarca.startsWith(normalizedMarca);
    });

    if (potentialMatches.length === 0) return null;
    if (potentialMatches.length === 1) return potentialMatches[0].urlLogo;

    // L√≥gica de desambiguaci√≥n para casos como "Honda" y "Honda Motocicletas"
    if (categoria && (normalize(categoria) === 'motocicletas' || normalize(categoria) === 'motos')) {
        const motoMatch = potentialMatches.find(logo => normalize(logo.nombreMarca).includes('motocicletas') || normalize(logo.nombreMarca).includes('motos'));
        if (motoMatch) return motoMatch.urlLogo;
    }

    // Fallback: buscar coincidencia exacta o devolver la primera
    const exactMatch = potentialMatches.find(logo => normalize(logo.nombreMarca) === normalizedMarca);
    return exactMatch ? exactMatch.urlLogo : potentialMatches[0].urlLogo;
}

function convertirAGoogleThumbnail(url) {
    if (!url) return "https://placehold.co/280x200/cccccc/333333?text=Sin+Imagen";

    // Expresi√≥n regular mejorada para capturar el ID de varias URLs de Google Drive:
    // 1. /file/d/ID
    // 2. id=ID
    // 3. /d/ID (para formatos m√°s cortos)
    const idMatch = String(url).match(/file\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)|\/d\/([a-zA-Z0-9_-]+)/);

    // Si se encuentra una coincidencia, construye la URL del thumbnail.
    // Los grupos de captura pueden estar en idMatch[1], idMatch[2], o idMatch[3].
    if (idMatch) {
        const fileId = idMatch[1] || idMatch[2] || idMatch[3];
        return `https://drive.google.com/thumbnail?sz=w1000&id=${fileId}`;
    }

    // Si no es una URL de Google Drive reconocible, devolver la URL original.
    // Esto permite el uso de URLs de im√°genes directas de otras fuentes.
    return url;
}

function mostrarLightbox(src) {
    const lightboxImg = document.getElementById("lightboxImg");
    lightboxImg.src = ""; // Limpiar imagen anterior para evitar parpadeos

    // Usar la funci√≥n robusta 'convertirAGoogleThumbnail' para obtener la URL base
    // y luego ajustar el tama√±o para alta resoluci√≥n.
    let finalUrl = convertirAGoogleThumbnail(src);

    // Si la URL fue convertida a un thumbnail de Google, reemplazar 'sz=w1000' por 'sz=w2000' para mayor calidad.
    // Si no, usar la URL tal cual (para im√°genes que no son de Drive).
    if (finalUrl.includes('drive.google.com/thumbnail')) {
        finalUrl = finalUrl.replace('sz=w1000', 'sz=w2000');
    }

    lightboxImg.src = finalUrl;
    document.getElementById("lightbox").classList.add("visible");
}

function cerrarModal() {
    cerrarModalVisualmente();
    if (history.state && history.state.modal) {
        history.back();
    }
    if (appOpenedFromLink) {
        appOpenedFromLink = false;
        history.pushState({}, '', window.location.pathname);
        checkSession();
    }
}

function cerrarModalVisualmente() {
    const modal = document.getElementById("modalDetalle");
    if (!modal.classList.contains("visible")) return;

    const detalleCont = document.getElementById("detalleCompleto");
    detalleCont.querySelectorAll('iframe').forEach(iframe => { if (iframe.src) iframe.src = ''; });
    modal.classList.remove("visible");
    uiState.isModalOpen = false;
}

function cerrarLightbox() { document.getElementById("lightbox").classList.remove("visible"); }

function extractYouTubeId(url) {
    if (!url) return null;
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

function mostrarDetalleModal(item) {
    pushState({ modal: true, type: 'corte', id: item.id });
    uiState.isModalOpen = true;

    const cont = document.getElementById("detalleCompleto");
    cont.innerHTML = ""; // Limpiar contenido anterior

    // --- 1. Botones de Cerrar y Compartir ---
    const headerDiv = document.createElement("div");
    headerDiv.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;";
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.onclick = () => cerrarModal();
    closeBtn.className = "backBtn";
    closeBtn.style.cssText = "color:white; background:#dc3545; border:none; margin:0;";
    headerDiv.appendChild(closeBtn);
    const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
    const titulo = `${item.marca} ${item.modelo} ${yearRange || ''}`;
    headerDiv.appendChild(crearBotonCompartir('cortes', item.id, titulo));
    cont.appendChild(headerDiv);

    // --- 2. Nuevo Encabezado Detallado ---
    const titleContainer = document.createElement("div");
    titleContainer.style.cssText = "border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 10px;"; // Reducido el padding y margen

    // 2.1 T√≠tulo Principal (Nombre del Modelo y Logo)
    const mainHeaderDiv = document.createElement('div');
    mainHeaderDiv.style.cssText = "display: flex; justify-content: flex-start; align-items: center; gap: 15px;";

    const logoUrl = getLogoUrlForMarca(item.marca, item.categoria);
    if (logoUrl) {
        const logoImg = document.createElement("img");
        logoImg.src = convertirAGoogleThumbnail(logoUrl);
        logoImg.style.cssText = "height: 40px; width: auto; max-width: 100px; object-fit: contain; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; border-radius: 0 !important;";
        mainHeaderDiv.appendChild(logoImg); // Logo primero
    }

    const title = document.createElement("h2");
    title.textContent = item.modelo; // Correcci√≥n: Mostrar solo el modelo
    title.style.cssText = "color:#007bff; margin: 0; padding: 0; flex-grow: 1;";
    mainHeaderDiv.appendChild(title);

    titleContainer.appendChild(mainHeaderDiv);

    // 2.2 Sub-encabezados (Versi√≥n/Encendido, A√±os, Categor√≠a)
    const subHeaderDiv = document.createElement('div');
    subHeaderDiv.style.marginTop = '10px';

    const subHeaderText = document.createElement('p');
    subHeaderText.style.cssText = "margin: 0; padding: 0; color: #555;";

    // Punto 2 y 3: Versi√≥n/Encendido y Rango de A√±os (letra m√°s peque√±a)
    const equipamiento = item.versionesAplicables || item.tipoEncendido || '';
    const yearRangeText = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
    subHeaderText.innerHTML = `<span style="font-size: 0.9em;">${equipamiento} | ${yearRangeText}</span>`;

    // Punto 4: Categor√≠a (letra a√∫n m√°s peque√±a)
    if(item.categoria) {
         subHeaderText.innerHTML += `<br><span style="font-size: 0.8em; color: #777;">${item.categoria}</span>`;
    }

    subHeaderDiv.appendChild(subHeaderText);
    titleContainer.appendChild(subHeaderDiv);
    cont.appendChild(titleContainer);

    // --- 3. Nota Importante (si existe) ---
    if (item.notaImportante) {
        const p = document.createElement("p");
        p.innerHTML = `<strong style="color:red;">Nota Importante:</strong> <span style="color:#cc0000; font-weight: bold;">${item.notaImportante} ‚ö†Ô∏è</span>`;
        cont.appendChild(p);
    }

    // --- 4. Imagen del Veh√≠culo (si existe) ---
    crearImagenDetalle("Veh√≠culo", item.imagenVehiculo, cont, { extraClass: 'img-vehiculo' });
    const vehiculoImg = cont.querySelector('.img-vehiculo');
    if(vehiculoImg) {
        vehiculoImg.style.cssText = "max-height: 122px !important; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4)); background: transparent !important; border: none !important; padding: 0 !important; border-radius: 0 !important; box-shadow: none !important;";
    }


    // --- L√≥gica de Cortes Refactorizada ---
    const crearPanelCorte = (corteIndex, esRecomendado = false) => {
        const tipoCorte = item[`tipoCorte${corteIndex}`];
        if (!tipoCorte) return null;

        const panel = document.createElement("div");
        panel.className = esRecomendado ? "panel-recomendado" : "panel-desplegable";
        if(esRecomendado) {
            panel.style.cssText = "padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background-color: #f9f9f9;";
        }


        // Descripci√≥n (Ubicaci√≥n y Color de Cable)
        const ubicacion = item[`ubicacionCorte${corteIndex}`];
        const colorCable = item[`colorCableCorte${corteIndex}`];
        if (ubicacion || colorCable) {
            let descripcionHTML = '';
            if (ubicacion) descripcionHTML += `<strong>Ubicaci√≥n:</strong> ${ubicacion}<br>`;
            if (colorCable) descripcionHTML += `<strong>Color(es) de Cable:</strong> ${colorCable}`;
            const p = document.createElement("p");
            p.innerHTML = descripcionHTML;
            panel.appendChild(p);
        }

        // Creaci√≥n de botones de feedback
        const utilBtn = document.createElement("button");
        utilBtn.innerHTML = `<i class="fa-solid fa-thumbs-up"></i>`;
        utilBtn.title = `Marcar como √∫til (${item[`utilCorte${corteIndex}`] || 0})`;
        utilBtn.className = "feedback-btn-overlay util-btn";
        utilBtn.onclick = () => handleLike(item.id, corteIndex, utilBtn);

        const reportBtn = document.createElement("button");
        reportBtn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i>`;
        reportBtn.title = "Reportar un problema";
        reportBtn.className = "feedback-btn-overlay report-btn";
        reportBtn.onclick = () => toggleReportSection(item.id, corteIndex);

        // Imagen del Corte con Overlays de Feedback
        crearImagenDetalle("Imagen del Corte", item[`imgCorte${corteIndex}`], panel, {
            feedbackActions: { util: utilBtn, report: reportBtn }
        });
        if(esRecomendado){
             const imgCorte = panel.querySelector('img[alt="Imagen del Corte"]');
             if(imgCorte) imgCorte.style.width = '100%';
        }

        // Link a Configuraci√≥n de Relay (si existe) - ANTES del colaborador
        const configRelay = item[`configRelay${corteIndex}`];
        const relayMatch = datosRelay.find(r => r.configuracion === configRelay);
        if (configRelay && relayMatch) {
            const relayLink = document.createElement("a");
            relayLink.href = "#";
            relayLink.textContent = "Ver Configuraci√≥n de Relay";
            relayLink.style.display = "block";
            relayLink.style.marginTop = "10px";
            relayLink.onclick = (e) => { e.preventDefault(); mostrarDetalleRelayAnidado(configRelay); };
            panel.appendChild(relayLink);
        }

        // Informaci√≥n del Colaborador (fuera del overlay, alineado a la izquierda)
        const collaboratorName = item[`colaboradorCorte${corteIndex}`];
        if (collaboratorName) {
            const collaboratorInfo = document.createElement('p');
            collaboratorInfo.style.cssText = 'text-align: left; font-size: 0.9em; color: #555; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;';
            collaboratorInfo.innerHTML = `Colaborador: <strong>${collaboratorName}</strong>`;
            panel.appendChild(collaboratorInfo);
        }

        // Secci√≥n de Reporte (oculta por defecto)
        const reportSection = document.createElement("div");
        reportSection.id = `report-section-${item.id}-${corteIndex}`;
        reportSection.style.display = 'none';
        reportSection.style.marginTop = '15px';
        reportSection.innerHTML = `<textarea id="report-input-${item.id}-${corteIndex}" placeholder="Describe el problema..." style="width:100%; min-height:60px;"></textarea><button id="submit-report-${item.id}-${corteIndex}" style="margin-top:5px;">Enviar</button>`;
        panel.appendChild(reportSection);

        return panel;
    };

    const allCortes = [];
    for (let i = 1; i <= 3; i++) {
        if (item[`tipoCorte${i}`]) {
            allCortes.push({
                corteIndex: i,
                tipoCorte: item[`tipoCorte${i}`],
                utilCount: parseInt(item[`utilCorte${i}`] || 0, 10)
            });
        }
    }
    allCortes.sort((a, b) => b.utilCount - a.utilCount);

    // --- 5. Corte Recomendado (si hay cortes) ---
    if (allCortes.length > 0) {
        const recomendado = allCortes[0];
        const tituloRecomendado = document.createElement("h4");
        tituloRecomendado.innerHTML = `<i class="fa-solid fa-star" style="color: #ffc107;"></i> Corte Recomendado: ${recomendado.tipoCorte}`;
        cont.appendChild(tituloRecomendado);
        const panelRecomendado = crearPanelCorte(recomendado.corteIndex, true);
        if (panelRecomendado) cont.appendChild(panelRecomendado);
    }

    // --- Contenedor para todas las secciones de acorde√≥n ---
    const accordionContainer = document.createElement('div');
    cont.appendChild(accordionContainer);

    const createAccordionSection = (title, contentGenerator) => {
        const content = contentGenerator();
        if (!content) return; // No crear la secci√≥n si no hay contenido

        const btn = document.createElement("button");
        btn.className = "accordion-btn";
        btn.innerHTML = `${title} <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
        accordionContainer.appendChild(btn);
        accordionContainer.appendChild(content);
    };

    // --- 6. Otros Cortes (si hay m√°s de 1) ---
    if (allCortes.length > 1) {
        const otrosCortes = allCortes.slice(1);
        const tituloOtros = document.createElement("h4");
        tituloOtros.textContent = "Otros Cortes Disponibles";
        tituloOtros.style.marginTop = '25px';
        accordionContainer.appendChild(tituloOtros);

        otrosCortes.forEach(corte => {
            const btn = document.createElement("button");
            btn.className = "accordion-btn";
            btn.innerHTML = `${corte.tipoCorte} <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
            accordionContainer.appendChild(btn);
            const panel = crearPanelCorte(corte.corteIndex, false);
            if (panel) accordionContainer.appendChild(panel);
        });
    }

    // --- REORDENAMIENTO DE SECCIONES SEG√öN ESPECIFICACI√ìN ---

    // --- 1. Detalles de Apertura ---
    createAccordionSection("Detalles de Apertura", () => {
        if (!item.apertura && !item.imgApertura) return null;
        const panel = document.createElement("div");
        panel.className = "panel-desplegable";
        if (item.apertura) panel.appendChild(crearElementoDetalle("Procedimiento", item.apertura));
        crearImagenDetalle("Imagen de Apertura", item.imgApertura, panel);
        return panel;
    });

    // --- 2. Cable de Alimentaci√≥n ---
    createAccordionSection("Cable de Alimentaci√≥n", () => {
        if (!item.cableAlimen && !item.imgCableAlimen) return null;
        const panel = document.createElement("div");
        panel.className = "panel-desplegable";
        if (item.cableAlimen) panel.appendChild(crearElementoDetalle("Ubicaci√≥n y color", item.cableAlimen));
        crearImagenDetalle("Imagen de Alimentaci√≥n", item.imgCableAlimen, panel);
        return panel;
    });

    // --- 3. Video Gu√≠a de Desarme ---
    createAccordionSection("Video Gu√≠a de Desarme", () => {
        if (!item.videoGuiaDesarmeUrl) return null;
        const panel = document.createElement("div");
        panel.className = "panel-desplegable";
        crearVideoDetalle(null, item.videoGuiaDesarmeUrl, panel);
        return panel;
    });

    // --- 4. Notas Personales (ELIMINADO) ---
    // La secci√≥n de notas personales ha sido eliminada seg√∫n las especificaciones.

    document.getElementById("modalDetalle").classList.add("visible");
}

function mostrarDetalleRelayAnidado(configRelay) {
    const relayData = datosRelay.find(r => r.configuracion === configRelay);
    if (!relayData) {
        alert("No se encontraron detalles para esta configuraci√≥n de relay.");
        return;
    }

    // Crear un nuevo modal en lugar de reusar el existente
    const nestedModal = document.createElement('div');
    nestedModal.className = 'info-modal';
    nestedModal.style.display = 'flex';
    nestedModal.style.zIndex = '2200'; // Asegurar que est√© por encima del modal de detalles

    const modalContent = document.createElement('div');
    modalContent.className = 'info-modal-content';

    const closeBtn = document.createElement('span');
    closeBtn.className = 'info-close-btn';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = () => document.body.removeChild(nestedModal);

    modalContent.appendChild(closeBtn);

    const title = document.createElement("h3");
    title.textContent = `Configuraci√≥n de Relay: ${relayData.configuracion}`;
    modalContent.appendChild(title);

    crearImagenDetalle("Diagrama", relayData.imagen, modalContent);
    const relayImg = modalContent.querySelector('img');
    if (relayImg) {
        relayImg.style.maxHeight = '250px';
    }

    nestedModal.appendChild(modalContent);
    document.body.appendChild(nestedModal);
}

function filtrarContenido(textoBusqueda) {
    const busqueda = textoBusqueda.toLowerCase().trim();
    if (!busqueda) {
        datosFiltrados = [];
        estado.nivel = "categorias";
        mostrarCategorias();
        return;
    }
    const palabrasBusqueda = busqueda.split(' ').filter(p => p);
    datosFiltrados = datosOriginales.filter(item => {
        const itemTexto = `${item.categoria} ${item.marca} ${item.modelo} ${item.anoDesde} ${item.anoHasta} ${item.tipoEncendido} ${item.versionesAplicables}`.toLowerCase();
        return palabrasBusqueda.every(palabra => itemTexto.includes(palabra));
    });

    if (datosFiltrados.length > 0) {
        mostrarResultadosBusquedaMarca(busqueda);
    } else {
        document.getElementById("contenido").innerHTML = `<p style="text-align:center; padding: 20px;">No se encontraron resultados para "${textoBusqueda}".</p>`;
    }
    estado.nivel = "busqueda";
}

function mostrarResultadosBusquedaMarca(busquedaTexto) {
    const cont = document.getElementById("contenido");
    if (datosFiltrados.length === 1) {
        mostrarDetalleModal(datosFiltrados[0]);
        const yearRange = datosFiltrados[0].anoHasta ? `${datosFiltrados[0].anoDesde} - ${datosFiltrados[0].anoHasta}` : datosFiltrados[0].anoDesde;
        cont.innerHTML = `<h4>Resultado Exacto Encontrado</h4><p>Abriendo detalle de ${datosFiltrados[0].modelo} ${yearRange || ''}.</p>`;
        return;
    }
    cont.innerHTML = `<h4>Resultados de b√∫squeda para: "${busquedaTexto}"</h4>`;
    const marcasUnicas = [...new Set(datosFiltrados.map(item => item.marca))].sort();

    const grid = document.createElement("div");
    grid.className = "grid";
    grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(120px, 1fr))";
    grid.style.gap = "30px";

    marcasUnicas.forEach(marca => {
        const logoUrl = getLogoUrlForMarca(marca, null);
        const card = document.createElement("div");
        card.className = "card brand-logo-item"; // Usar el estilo de logo
        card.onclick = () => mostrarResultadosBusquedaModelo(busquedaTexto, marca);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(logoUrl);
        img.alt = `Marca ${marca}`;
        img.loading = "lazy";
        card.appendChild(img);

        // Opcional: Agregar un texto sutil debajo del logo si se desea
        const brandName = document.createElement('p');
        brandName.textContent = marca;
        brandName.style.textAlign = 'center';
        brandName.style.marginTop = '8px';
        brandName.style.fontWeight = 'bold';
        brandName.style.fontSize = '0.9em';
        card.appendChild(brandName);

        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaModelo(busquedaTexto, marcaFiltro) {
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaMarca('${busquedaTexto}')">${backSvg} Volver a Marcas</span>
                      <h4>Modelos de ${marcaFiltro} (B√∫squeda: "${busquedaTexto}")</h4>`;
    const modelosFiltrados = datosFiltrados.filter(item => item.marca === marcaFiltro);
    const modelosUnicos = [...new Map(modelosFiltrados.map(item => [item.modelo, item])).values()].sort((a,b) => a.modelo.localeCompare(b.modelo));

    const grid = document.createElement("div"); grid.className = "grid";
    modelosUnicos.forEach(ejemplo => {
        const versiones = modelosFiltrados.filter(item => item.modelo === ejemplo.modelo);
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => (versiones.length === 1) ? mostrarDetalleModal(ejemplo) : mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, ejemplo.modelo);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(ejemplo.imagenVehiculo); img.alt = `Modelo ${ejemplo.modelo}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        if (versiones.length === 1) {
            const yearRange = ejemplo.anoHasta ? `${ejemplo.anoDesde} - ${ejemplo.anoHasta}` : ejemplo.anoDesde;
            overlay.innerHTML = `<div>${ejemplo.modelo}</div><div style="font-size:0.8em; opacity:0.8; font-weight:normal;">${yearRange || ''} ${ejemplo.tipoEncendido || ''}</div>`;
        } else {
            overlay.innerHTML = `<div>${ejemplo.modelo}</div><div style="font-size:0.8em; opacity:0.8; font-weight:normal;">(${versiones.length} cortes)</div>`;
        }
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarResultadosBusquedaVersion(busquedaTexto, marcaFiltro, modeloFiltro) {
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarResultadosBusquedaModelo('${busquedaTexto}', '${marcaFiltro}')">${backSvg} Volver a Modelos (${modeloFiltro})</span>
                      <h4>Cortes/A√±os de ${modeloFiltro}</h4>`;
    const versiones = datosFiltrados.filter(item => item.marca === marcaFiltro && item.modelo === modeloFiltro);
    const grid = document.createElement("div"); grid.className = "grid";
    versiones.forEach(item => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleModal(item);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(item.imagenVehiculo); img.alt = `Corte ${item.anoDesde}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
        overlay.innerHTML = `<div style="font-weight:bold;">${yearRange || modeloFiltro}</div><div style="font-size:0.8em; opacity:0.8;">${item.tipoEncendido || ''}</div>`;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarCategorias() {
    if (document.getElementById("searchInput").value.trim()) return;
    estado = { nivel: "categorias", categoria: null };
    const cont = document.getElementById("contenido");
    cont.innerHTML = ""; // Limpiar contenido

    // 1. Mostrar "√öltimos Agregados"
    mostrarUltimosAgregados();

    // --- ORDEN CORRECTO DE RENDERIZADO ---
    // 1. Carrusel de Categor√≠as
    const categorias = sortedCategoriesList;
    crearCarrusel('B√∫squeda por Categor√≠a', categorias, cat => {
        const ejemplo = datosOriginales.find(item => item.categoria === cat && item.imagenVehiculo);
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarMarcas(cat);
        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(ejemplo?.imagenVehiculo);
        img.alt = `Categor√≠a ${cat}`;
        card.appendChild(img);
        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = cat;
        card.appendChild(overlay);
        return card;
    });

    // 2. Carrusel de Marcas de Veh√≠culos (Excluyendo Motocicletas)
    const marcasVehiculos = [...new Set(datosOriginales
        .filter(item => item.categoria && item.categoria.toLowerCase() !== 'motocicletas')
        .map(item => item.marca))]
        .filter(Boolean).sort();

    crearCarrusel('Marcas de Veh√≠culos', marcasVehiculos, marca => {
        const logoUrl = getLogoUrlForMarca(marca, null);
        const card = document.createElement("div");
        card.className = "card brand-logo-item";
        card.onclick = () => mostrarCategoriasPorMarca(marca);
        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(logoUrl);
        img.alt = `Marca ${marca}`;
        card.appendChild(img);
        return card;
    });

    // 3. Carrusel de Marcas de Motocicletas
    const marcasMotos = [...new Set(datosOriginales
        .filter(item => item.categoria && item.categoria.toLowerCase() === 'motocicletas')
        .map(item => item.marca))]
        .filter(Boolean).sort();

    if (marcasMotos.length > 0) {
        crearCarrusel('Marcas de Motocicletas', marcasMotos, marca => {
            const logoUrl = getLogoUrlForMarca(marca, 'motocicletas');
            const card = document.createElement("div");
            card.className = "card brand-logo-item";
            card.onclick = () => mostrarModelos('motocicletas', marca); // Corregido a min√∫sculas
            const img = document.createElement("img");
            img.src = convertirAGoogleThumbnail(logoUrl);
            img.alt = `Marca ${marca}`;
            card.appendChild(img);
            return card;
        });
    }
}

function mostrarUltimosAgregados() {
    if (!datosOriginales || datosOriginales.length === 0) return;

    const ultimosCortes = [...datosOriginales]
        .sort((a, b) => {
            const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
            const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
            if (dateB - dateA !== 0) return dateB - dateA;
            return b.id - a.id;
        })
        .slice(0, 6);

    if (ultimosCortes.length === 0) return;

    crearCarrusel('√öltimos Agregados', ultimosCortes, item => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.animation = 'none';
        card.style.opacity = '1';
        card.onclick = () => mostrarDetalleModal(item);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(item.imagenVehiculo);
        img.alt = `${item.marca} ${item.modelo}`;
        img.loading = "lazy";
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
        overlay.innerHTML = `<div>${item.marca}</div><div style="font-size:0.8em; opacity:0.8;">${item.modelo} ${yearRange || ''}</div>`;
        card.appendChild(overlay);
        return card;
    });
}

function mostrarMarcas(categoria) {
    estado = { nivel: "marcas", categoria: categoria };
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="irAPaginaPrincipal()">${backSvg} Volver</span><h4>Marcas de ${categoria}</h4>`;
    const itemsInCategory = datosOriginales.filter(item => item.categoria === categoria);
    const marcas = [...new Set(itemsInCategory.map(item => item.marca))].filter(m => m).sort();

    // Adjust grid for logos to be more spacious
    const grid = document.createElement("div");
    grid.className = "grid";
    grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(120px, 1fr))";
    grid.style.gap = "30px";

    marcas.forEach(m => {
        const logoUrl = getLogoUrlForMarca(m, categoria);
        const logoContainer = document.createElement("div");
        logoContainer.className = "card brand-logo-item"; // Apply new style
        logoContainer.onclick = () => mostrarModelos(categoria, m);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(logoUrl) || 'https://placehold.co/120x80/cccccc/333333?text=Sin+Logo';
        img.alt = `Marca ${m}`;
        img.loading = "lazy";

        logoContainer.appendChild(img);
        grid.appendChild(logoContainer);
    });
    cont.appendChild(grid);
}

function mostrarVersionesEquipamiento(categoria, marca) {
    estado = { nivel: "versionesEquipamiento", categoria, marca };
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarMarcas('${categoria}')">${backSvg} Volver</span><h4>Versiones de Equipamiento para ${marca}</h4>`;

    const vehiculosDeMarca = datosOriginales.filter(item => item.categoria === categoria && item.marca === marca);
    const versiones = [...new Set(vehiculosDeMarca.map(item => item.versionesAplicables).filter(v => v))];

    const grid = document.createElement("div");
    grid.className = "grid";

    versiones.forEach(version => {
        const ejemplo = vehiculosDeMarca.find(item => item.versionesAplicables === version && item.imagenVehiculo);
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => mostrarModelos(categoria, marca, version); // Pasamos la versi√≥n para filtrar

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(ejemplo?.imagenVehiculo);
        img.alt = `Versi√≥n ${version}`;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = version;
        card.appendChild(overlay);
        grid.appendChild(card);
    });

    cont.appendChild(grid);
}


function mostrarModelos(categoria, marca, versionEquipamiento = null) {
    estado = { nivel: "modelos", categoria, marca, versionEquipamiento };
    const cont = document.getElementById("contenido");
    const backAction = versionEquipamiento ? `mostrarVersionesEquipamiento('${categoria}', '${marca}')` : `mostrarMarcas('${categoria}')`;
    cont.innerHTML = `<span class="backBtn" onclick="${backAction}">${backSvg} Volver</span><h4>Modelos de ${marca} ${versionEquipamiento || ''}</h4>`;

    let modelosFiltrados = datosOriginales.filter(item => item.categoria && item.categoria.toLowerCase() === categoria.toLowerCase() && item.marca === marca);
    if (versionEquipamiento) {
        modelosFiltrados = modelosFiltrados.filter(item => item.versionesAplicables === versionEquipamiento);
    }

    const modelosUnicos = [...new Map(modelosFiltrados.map(item => [item.modelo, item])).values()].sort((a,b) => a.modelo.localeCompare(b.modelo));

    if (modelosUnicos.length === 1) {
        mostrarTiposEncendido(categoria, marca, versionEquipamiento, modelosUnicos[0].modelo);
        return;
    }

    const grid = document.createElement("div"); grid.className = "grid";
    modelosUnicos.forEach(ejemplo => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarTiposEncendido(categoria, marca, versionEquipamiento, ejemplo.modelo);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(ejemplo.imagenVehiculo); img.alt = `Modelo ${ejemplo.modelo}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        overlay.innerHTML = `<div>${ejemplo.modelo}</div>`;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarTiposEncendido(categoria, marca, versionEquipamiento, modelo) {
     estado = { nivel: "tiposEncendido", categoria, marca, versionEquipamiento, modelo };
    const cont = document.getElementById("contenido");
    const backAction = `mostrarModelos('${categoria}', '${marca}', ${versionEquipamiento ? `'${versionEquipamiento}'` : null})`;
    cont.innerHTML = `<span class="backBtn" onclick="${backAction}">${backSvg} Volver</span><h4>Tipos de Encendido para ${modelo}</h4>`;

    let vehiculos = datosOriginales.filter(item =>
        item.categoria === categoria &&
        item.marca === marca &&
        item.modelo === modelo &&
        (!versionEquipamiento || item.versionesAplicables === versionEquipamiento)
    );

    const tiposEncendido = [...new Set(vehiculos.map(v => v.tipoEncendido).filter(Boolean))];

    if (tiposEncendido.length === 1) {
        mostrarVersiones(vehiculos, categoria, marca, modelo);
        return;
    }

    const grid = document.createElement("div"); grid.className = "grid";
    tiposEncendido.forEach(tipo => {
        const ejemplo = vehiculos.find(v => v.tipoEncendido === tipo);
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarVersiones(vehiculos.filter(v => v.tipoEncendido === tipo), categoria, marca, modelo);

        const img = document.createElement("img");
        img.src = convertirAGoogleThumbnail(ejemplo.imagenVehiculo);
        img.alt = tipo;
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.innerHTML = tipo;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

function mostrarVersiones(filas, categoria, marca, modelo) {
    estado = { nivel: "versiones", categoria, marca, modelo };
    const cont = document.getElementById("contenido");
    cont.innerHTML = `<span class="backBtn" onclick="mostrarModelos('${categoria}','${marca}')">${backSvg} Volver</span><h4>Cortes/A√±os de ${modelo}</h4>`;
    const grid = document.createElement("div"); grid.className = "grid";
    filas.forEach(item => {
        const card = document.createElement("div"); card.className = "card";
        card.onclick = () => mostrarDetalleModal(item);
        const img = document.createElement("img"); img.src = convertirAGoogleThumbnail(item.imagenVehiculo); img.alt = `Corte ${item.anoDesde}`; card.appendChild(img);
        const overlay = document.createElement("div"); overlay.className = "overlay";
        const yearRange = item.anoHasta ? `${item.anoDesde} - ${item.anoHasta}` : item.anoDesde;
        overlay.innerHTML = `<div style="font-weight:bold;">${yearRange || modelo}</div><div style="font-size:0.8em;">${item.tipoEncendido || ''}</div>`;
        card.appendChild(overlay);
        grid.appendChild(card);
    });
    cont.appendChild(grid);
}

// --- L√ìGICA DE NOTIFICACIONES ---
function showNotificationToast(message, duration = 5000) {
    const toast = document.getElementById('notification-toast');
    toast.textContent = message;
    toast.style.display = 'block';
    toast.onclick = () => toast.style.display = 'none';

    setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
}

// --- INICIALIZACI√ìN Y L√ìGICA DE PWA ---
let deferredPrompt;
const installButton = document.getElementById('install-button');

window.addEventListener('beforeinstallprompt', (e) => {
    // Prevenir que el navegador muestre el aviso de instalaci√≥n por defecto
    e.preventDefault();
    // Guardar el evento para poder mostrarlo m√°s tarde
    deferredPrompt = e;
    console.log('`beforeinstallprompt` event was fired. App is installable.');

    // L√≥gica para mostrar el bot√≥n de instalaci√≥n
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (!isStandalone) {
        if (isIOS) {
            // En iOS no se dispara 'beforeinstallprompt', manejaremos un bot√≥n personalizado.
            installButton.style.display = 'none';
        } else {
            // Para otros dispositivos (Android, Desktop), mostrar el bot√≥n.
            installButton.style.display = 'block';
        }
    }
});

installButton.addEventListener('click', async () => {
    if (deferredPrompt) {
        // Mostrar el aviso de instalaci√≥n
        deferredPrompt.prompt();

        // Esperar a que el usuario responda al aviso
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);

        // Ya no necesitamos el evento, lo reseteamos
        deferredPrompt = null;

        // Ocultar el bot√≥n
        installButton.style.display = 'none';
    }
});


// --- REGISTRO DEL SERVICE WORKER ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').then(registration => {
            console.log('ServiceWorker registrado con √©xito:', registration.scope);
        }).catch(err => {
            console.log('Fallo en el registro de ServiceWorker:', err);
        });
    });
}

// --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
async function handleSharedLink(seccion, id) {
    appOpenedFromLink = true;

    let data, header, item, mostrarDetalleFn;

    // 1. Determinar qu√© datos buscar y qu√© funci√≥n de modal usar
    const seccionMap = {
        'cortes': { range: RANGE_CORTES, dataSetter: (vals) => datosOriginales = vals, dataRef: () => datosOriginales, modalFn: mostrarDetalleModal },
        'tutoriales': { range: RANGE_TUTORIALES, dataSetter: (vals) => datosTutoriales = vals, dataRef: () => datosTutoriales, modalFn: mostrarDetalleTutorial },
        'relay': { range: RANGE_RELAY, dataSetter: (vals) => datosRelay = vals, dataRef: () => datosRelay, modalFn: mostrarDetalleRelay }
    };

    if (!seccionMap[seccion]) {
        checkSession(); // Secci√≥n no v√°lida, proceder con el inicio normal
        return;
    }

    const { range, dataSetter, dataRef, modalFn } = seccionMap[seccion];

    // 2. Intentar cargar los datos de la secci√≥n y encontrar el √≠tem
    await syncAndFetchData(seccion, range, dataSetter, () => {}, 'contenido');
    data = dataRef();

    if (data && data.length > 1) {
        header = data[0];
        item = data.slice(1).find(fila => fila[header.indexOf("ID")] === id);
    }

    // 3. Solo si el √≠tem es v√°lido, se muestra el modal y se oculta el resto
    if (item) {
        // Ocultar splash y login AHORA que sabemos que tenemos contenido para mostrar
        const splash = document.getElementById('splash-screen');
        splash.style.opacity = '0';
        setTimeout(() => splash.style.display = 'none', 500);
        document.getElementById('login-modal').style.display = 'none';

        // Ocultar el contenedor principal para que solo se vea el modal
        document.querySelector('.container').style.display = 'none';

        mostrarDetalleFn = modalFn;
        mostrarDetalleFn(item, header);

        // Limpiar la URL para que un refresh no vuelva a abrir el modal
        history.replaceState({}, document.title, window.location.pathname);
    } else {
        // 4. Si el √≠tem no se encuentra, proceder al flujo de inicio de sesi√≥n normal
        checkSession();
    }
}


async function inicializarApp() {
    const urlParams = new URLSearchParams(window.location.search);
    const seccion = urlParams.get('seccion');
    const id = urlParams.get('id');

    if (seccion && id) {
        await handleSharedLink(seccion, id);
    } else {
        checkSession();     // Luego, comprueba si hay una sesi√≥n activa
    }

    // L√≥gica para el bot√≥n de instalaci√≥n de iOS
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (!isStandalone && isIOS) {
        // Crear y mostrar un bot√≥n/mensaje espec√≠fico para iOS
        const iosInstallMessage = document.createElement('div');
        iosInstallMessage.id = 'ios-install-message';
        iosInstallMessage.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 1002;
            font-size: 0.9em;
            width: 90%;
            max-width: 400px;
        `;
        iosInstallMessage.innerHTML = `
            Para instalar, pulsa el bot√≥n de Compartir
            <svg style="width:20px; vertical-align:middle;" viewBox="0 0 24 24"><path fill="currentColor" d="M17,14V17A1,1 0 0,1 16,18H8A1,1 0 0,1 7,17V14H5V17A3,3 0 0,0 8,20H16A3,3 0 0,0 19,17V14H17M12,4L7,9H10V15H14V9H17L12,4Z" /></svg>
            y luego "A√±adir a pantalla de inicio".
            <button onclick="this.parentElement.style.display='none'" style="background:none; border:none; color:white; font-size:1.2em; position:absolute; top:5px; right:10px;">&times;</button>
        `;
        document.body.appendChild(iosInstallMessage);
    }
}

// Ocultar el splash screen despu√©s de un tiempo para asegurar que no se quede atascado
window.addEventListener('load', () => {
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        const session = localStorage.getItem(SESSION_KEY);
        // Si no hay sesi√≥n, el splash se ocultar√° cuando se muestre el login.
        // Si hay sesi√≥n, el splash se ocultar√° cuando se muestre la app.
        // Este es un fallback por si algo falla.
        if (!session) {
             const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
            }, 500);
        }
    }, 3000); // 3 segundos de tiempo de espera m√°ximo
});


inicializarApp();

// Event listener para el acorde√≥n
document.getElementById('detalleCompleto').addEventListener('click', function(e) {
    const clickedBtn = e.target.closest('.accordion-btn');
    if (!clickedBtn) return;

    const panel = clickedBtn.nextElementSibling;
    const isActive = clickedBtn.classList.contains('active');

    // Cerrar todos los paneles y pausar videos
    this.querySelectorAll('.accordion-btn').forEach(btn => {
        const currentPanel = btn.nextElementSibling;
        const iframe = currentPanel.querySelector('iframe');

        if (btn !== clickedBtn || isActive) {
            btn.classList.remove('active');
            currentPanel.style.maxHeight = null;
            if (iframe) {
                iframe.src = ''; // Detiene el video
            }
        }
    });

    // Abrir el panel clickeado si no estaba ya activo
    if (!isActive) {
        clickedBtn.classList.add('active');
        panel.style.maxHeight = panel.scrollHeight + "px";
        const iframe = panel.querySelector('iframe');
        if (iframe && iframe.dataset.originalSrc) {
            iframe.src = iframe.dataset.originalSrc; // Restaura el video
        }
    }
});

const searchContainer = document.querySelector('.search-container');
const clearSearchBtn = document.getElementById('clear-search-btn');

if (searchInput && searchContainer && clearSearchBtn) {
    searchInput.addEventListener('focus', () => {
        if (!uiState.isSearchActive) {
            // Solo empuja el estado si el campo est√° vac√≠o. Si ya hay texto, no crees un nuevo estado.
            if(searchInput.value.trim() === '') {
                pushState({ search: true });
            }
            uiState.isSearchActive = true;
        }
        document.body.classList.add('search-active');
    });

    searchInput.addEventListener('blur', () => {
        if (uiState.isSearchActive) {
            // No hacemos history.back() al desenfocar para permitir hacer clic en los resultados.
            // La UI se revierte visualmente, pero el estado del historial permanece.
            setTimeout(() => {
                 document.body.classList.remove('search-active');
            }, 200);
        }
    });

    searchInput.addEventListener('input', () => {
        // Muestra u oculta el bot√≥n de limpiar basado en si hay texto
        if (searchInput.value.length > 0) {
            searchContainer.classList.add('has-text');
        } else {
            searchContainer.classList.remove('has-text');
        }
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        // Dispara el evento 'input' para que la l√≥gica de filtrado se ejecute
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        // Mantiene el foco en el input para una nueva b√∫squeda
        searchInput.focus();
    });
}

// --- L√ìGICA DEL MEN√ö HAMBURGUESA ---
const hamburgerBtn = document.getElementById('hamburger-btn');
const sideMenu = document.getElementById('side-menu');
const menuOverlay = document.getElementById('menu-overlay');
const menuUsername = document.getElementById('menu-username');
const sideMenuLogoutBtn = document.getElementById('side-menu-logout-button');

function openSideMenu() {
    const session = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (session && session.Nombre_Usuario) {
        menuUsername.textContent = session.Nombre_Usuario;
    }
    sideMenu.classList.add('open');
    menuOverlay.classList.add('open');
}

function closeSideMenu() {
    sideMenu.classList.remove('open');
    menuOverlay.classList.remove('open');
}

hamburgerBtn.addEventListener('click', openSideMenu);
menuOverlay.addEventListener('click', closeSideMenu);
sideMenuLogoutBtn.addEventListener('click', () => {
    closeSideMenu();
    logout();
});

// Cerrar men√∫ al hacer clic en un enlace (para navegaci√≥n en la misma p√°gina)
document.querySelectorAll('#side-menu .menu-link').forEach(link => {
    link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');
        if (href === '#') { // Es un enlace de la misma p√°gina (ej. 'Cortes')
            e.preventDefault();
            const section = link.id.replace('menu-', '');
            mostrarSeccion(section);
            closeSideMenu();
        }
        // Para enlaces a otras p√°ginas, el men√∫ se cerrar√° autom√°ticamente en la carga de la nueva p√°gina.
    });
});

async function handleLike(vehicleId, corteIndex, buttonElement) {
    const user = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (!user || !user.ID || !user.Nombre_Usuario) {
        alert("Debes iniciar sesi√≥n para usar esta funci√≥n.");
        return;
    }

    // Disable button to prevent multiple clicks
    buttonElement.disabled = true;
    buttonElement.style.cursor = 'default';

    // Optimistic UI update based on the title attribute and CSS class
    const originalTitle = buttonElement.title;
    const currentCountMatch = originalTitle.match(/\((\d+)\)/);
    const currentCount = currentCountMatch ? parseInt(currentCountMatch[1], 10) : 0;
    buttonElement.title = `Marcar como √∫til (${currentCount + 1})`;
    buttonElement.classList.add('liked');

    try {
        await postToAction('recordLike', {
            vehicleId: vehicleId,
            corteIndex: corteIndex,
            userId: user.ID,
            userName: user.Nombre_Usuario
        });

        // After successful like, prompt for year suggestion
        const suggestedYearRaw = prompt("¬°Gracias por tu feedback! ¬øEste corte tambi√©n aplica para otro a√±o? Si es as√≠, ingr√©salo aqu√≠ (ej: 2023). Si no, cancela.");

        if (suggestedYearRaw && suggestedYearRaw.trim() !== "") {
            const year = parseInt(suggestedYearRaw.trim(), 10);
            if (!isNaN(year) && year > 1980 && year < 2050) {
                try {
                    const result = await postToAction('suggestYear', {
                        vehicleId: vehicleId,
                        newYear: year, // Corrected parameter name
                        userId: user.ID, // Pass userId as required by backend
                        userName: user.Nombre_Usuario
                    });
                    alert(result.message || "Sugerencia enviada. ¬°Gracias por tu colaboraci√≥n!");
                } catch (error) {
                    // Error is handled globally by postToAction, no extra alert needed.
                }
            } else {
                alert("Por favor, ingresa un a√±o v√°lido (ej: 2023).");
            }
        }
    } catch (error) {
        // Revert UI on error
        buttonElement.title = originalTitle;
        buttonElement.classList.remove('liked');
        // The error message is shown globally by postToAction.
    } finally {
        // Re-enable the button after operation is complete
        buttonElement.disabled = false;
        buttonElement.style.cursor = 'pointer';
    }
}


function toggleReportSection(vehicleId, corteIndex) {
    const reportSection = document.getElementById(`report-section-${vehicleId}-${corteIndex}`);
    const submitBtn = document.getElementById(`submit-report-${vehicleId}-${corteIndex}`);

    if (reportSection.style.display === 'none') {
        reportSection.style.display = 'block';
        submitBtn.onclick = () => handleReportSubmit(vehicleId, corteIndex);
    } else {
        reportSection.style.display = 'none';
    }
}

async function handleReportSubmit(vehicleId, corteIndex) {
    const user = JSON.parse(localStorage.getItem(SESSION_KEY));
    if (!user || !user.Nombre_Usuario) {
        alert("Debes iniciar sesi√≥n para reportar un problema.");
        return;
    }

    const reportInput = document.getElementById(`report-input-${vehicleId}-${corteIndex}`);
    const problemText = reportInput.value.trim();

    if (!problemText) {
        alert("Por favor, describe el problema.");
        return;
    }

    try {
        await postToAction('reportProblem', {
            vehicleId: vehicleId,
            corteIndex: corteIndex,
            problemText: problemText,
            userId: user.ID,
            userName: user.Nombre_Usuario
        });
        alert("Gracias por tu reporte. Lo revisaremos pronto.");
        reportInput.value = '';
        toggleReportSection(vehicleId, corteIndex);
    } catch (error) {
        // Error is handled by postToAction
    }
}

// --- L√ìGICA PARA MODALES DE INFORMACI√ìN ---
function setupInfoModals() {
    const modals = document.querySelectorAll('.info-modal');
    const closeButtons = document.querySelectorAll('.info-close-btn');

    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'flex';
    };

    const closeModal = () => {
        modals.forEach(modal => modal.style.display = 'none');
    };

    // Footer link listeners
    document.getElementById('footer-about-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('about-us-modal');
    });
    document.getElementById('footer-contact-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('contact-modal');
    });
    document.getElementById('footer-faq-link').addEventListener('click', (e) => {
        e.preventDefault();
        openModal('faq-modal');
    });

    // Inbox Modal
    const inboxBtn = document.getElementById('inbox-btn');
    if (inboxBtn) {
        inboxBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openModal('inbox-modal');
            loadInboxItems();
            closeSideMenu();
        });
    }

    // Developer tools modal
    const devToolsBtn = document.getElementById('dev-tools-btn');
    if (devToolsBtn) {
        devToolsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const devModal = document.getElementById('dev-tools-modal');
            const debugConsole = document.getElementById('debug-console');
            const devConsoleContainer = document.getElementById('dev-console-container');

            // Move debug console into the modal
            if (debugConsole && devConsoleContainer) {
                devConsoleContainer.appendChild(debugConsole);
                debugConsole.style.position = 'relative';
                debugConsole.style.width = '100%';
                debugConsole.style.height = '100%';
                debugConsole.style.bottom = 'auto';
                debugConsole.style.right = 'auto';
                debugConsole.style.display = 'flex'; // Asegura que la consola sea visible dentro del modal
            }

            openModal('dev-tools-modal');
            closeSideMenu();
        });
    }


    // Close button listeners
    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

    // Close on outside click
    window.addEventListener('click', (event) => {
        modals.forEach(modal => {
            if (event.target === modal) {
                closeModal();
            }
        });
    });

    // Accordion for FAQ
    document.querySelectorAll('#faq-modal .accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const isActive = content.style.maxHeight;
            // Close all others first for a cleaner accordion experience
            document.querySelectorAll('#faq-modal .accordion-content').forEach(c => c.style.maxHeight = null);
            // Open the clicked one if it wasn't already open
            if (!isActive) {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });

    // Contact form submission
    document.getElementById('contact-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('contact-name').value;
        const email = document.getElementById('contact-email').value;
        const message = document.getElementById('contact-message').value;

        try {
            const response = await routeAction('sendContactForm', { name, email, message });
            if (response.status === 'success') {
                alert('¬°Gracias por tu mensaje! Nos pondremos en contacto contigo pronto.');
                closeModal();
                document.getElementById('contact-form').reset();
            } else {
                throw new Error(response.message || 'Error desconocido');
            }
        } catch (error) {
             alert(`Error al enviar el mensaje: ${error.message}`);
        }
    });
}
// --- INBOX LOGIC ---
let inboxItems = [];

async function loadInboxItems() {
    const listContainer = document.getElementById('inbox-list');
    listContainer.innerHTML = '<p>Cargando mensajes...</p>';

    try {
        const result = await routeAction('getFeedbackItems', {}, 'FEEDBACK');
        inboxItems = result.data; // La respuesta ahora es un array unificado

        // Ordenar: no resueltos primero, luego por ID descendente
        inboxItems.sort((a, b) => {
            const aResolved = a.isResolved === true;
            const bResolved = b.isResolved === true;
            if (aResolved !== bResolved) {
                return aResolved ? 1 : -1;
            }
            return b.id - a.id;
        });

        renderInboxList();
    } catch (error) {
        listContainer.innerHTML = `<p style="color: red;">Error al cargar mensajes: ${error.message}</p>`;
    }
}

function renderInboxList() {
    const listContainer = document.getElementById('inbox-list');
    listContainer.innerHTML = '';

    if (inboxItems.length === 0) {
        listContainer.innerHTML = '<p>No hay mensajes.</p>';
        return;
    }

    inboxItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 5px;';
        if (item.isResolved) {
            itemDiv.style.opacity = '0.6';
        }

        const typeLabel = item.type === 'problem_report' ? 'Reporte' : 'Contacto';

        itemDiv.innerHTML = `
            <strong>${typeLabel} #${item.id}</strong><br>
            <small>${item.subject}</small>
        `;
        itemDiv.onclick = () => renderInboxDetail(item.id, item.type);
        listContainer.appendChild(itemDiv);
    });
}

function renderInboxDetail(itemId, itemType) {
    const detailContainer = document.getElementById('inbox-detail');
    const item = inboxItems.find(i => i.id == itemId && i.type === itemType);

    if (!item) {
        detailContainer.innerHTML = '<p>Selecciona un item para ver los detalles.</p>';
        return;
    }

    const typeLabel = item.type === 'problem_report' ? 'Reporte de Problema' : 'Formulario de Contacto';
    let content = `<h3>${item.subject}</h3>`;

    content += `<p><strong>De:</strong> ${item.user} | <strong>Tipo:</strong> ${typeLabel}</p>`;
    if (item.vehicleId) {
        content += `<p><strong>ID Veh√≠culo:</strong> ${item.vehicleId}</p>`;
    }
    content += `<div style="background: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 10px;"><p>${item.content.replace(/\n/g, '<br>')}</p></div>`;

    content += `
        <hr>
        <h4>Responder</h4>
        <textarea id="reply-textarea" style="width: 100%; height: 100px; margin-bottom: 10px;" placeholder="Escribe tu respuesta...">${item.reply || ''}</textarea>
        <button id="reply-btn" class="btn btn-primary">Enviar Respuesta</button>
    `;

    if(item.type === 'problem_report' && !item.isResolved) {
        content += `<button id="resolve-btn" class="btn btn-success" style="margin-left: 10px;">Marcar como Resuelto</button>`;
    }

    detailContainer.innerHTML = content;

    document.getElementById('reply-btn').onclick = async () => {
        const replyText = document.getElementById('reply-textarea').value;
        const session = JSON.parse(localStorage.getItem(SESSION_KEY));
        await routeAction('replyToFeedback', { itemId, itemType, replyText, responderName: session.Nombre_Usuario }, 'FEEDBACK');
        alert('Respuesta enviada.');
        loadInboxItems(); // Refresh
    };

    if(document.getElementById('resolve-btn')) {
        document.getElementById('resolve-btn').onclick = async () => {
            await routeAction('markAsResolved', { itemId }, 'FEEDBACK');
            alert('Marcado como resuelto.');
            loadInboxItems(); // Refresh
        };
    }
}


// Llamar a la configuraci√≥n de los modales de info cuando se inicializa la app.
document.addEventListener('DOMContentLoaded', () => {
    setupInfoModals();

        // --- L√ìGICA DE MODO OSCURO ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        const enableDarkMode = () => {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            darkModeToggle.checked = true;
        };

        const disableDarkMode = () => {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
            darkModeToggle.checked = false;
        };

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        });

        // Aplicar el tema al cargar la p√°gina
        const preferredTheme = localStorage.getItem('theme');
        if (preferredTheme === 'dark') {
            enableDarkMode();
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && preferredTheme !== 'light') {
             // Si el usuario no ha elegido, pero su sistema lo prefiere, activarlo
            enableDarkMode();
        }

    const migrateYearsBtn = document.getElementById('run-migrate-years');
    const migrateTimestampsBtn = document.getElementById('run-migrate-timestamps');
    const statusDiv = document.getElementById('migration-status');
    const session = JSON.parse(localStorage.getItem(SESSION_KEY));

    const runMigration = async (action, btn) => {
        if (!confirm(`¬øEst√°s seguro de que quieres ejecutar la acci√≥n '${action}'? Esta operaci√≥n puede modificar una gran cantidad de datos y no se puede deshacer.`)) {
            return;
        }

        btn.disabled = true;
        statusDiv.style.display = 'block';
        statusDiv.textContent = `Ejecutando ${action}...`;
        statusDiv.style.backgroundColor = '#e2e3e5';

        try {
            // CORRECCI√ìN: Enviar el objeto de sesi√≥n completo en el payload.
            const result = await routeAction(action, { session: session }, 'UTILITIES');
            statusDiv.textContent = `√âxito: ${result.message}`;
            statusDiv.style.backgroundColor = '#d4edda';
        } catch (error) {
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.style.backgroundColor = '#f8d7da';
        } finally {
            btn.disabled = false;
        }
    };

    if(migrateYearsBtn) {
        migrateYearsBtn.addEventListener('click', () => runMigration('migrateYearRanges', migrateYearsBtn));
    }
    if(migrateTimestampsBtn) {
        migrateTimestampsBtn.addEventListener('click', () => runMigration('migrateTimestamps', migrateTimestampsBtn));
    }
});

</script>

<footer class="footer" style="display: none;">
  Gpspedia v4.3.6 ¬© 2025 todos los derechos reservados.
  <div class="footer-links">
      <a id="footer-about-link">Sobre Nosotros</a>
      <a id="footer-contact-link">Cont√°ctanos</a>
      <a id="footer-faq-link">Preguntas Frecuentes</a>
  </div>
</footer>

</body>
</html>
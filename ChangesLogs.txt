**v4.2.6 (05/01/2024)**
*   **INFRA (api-manager.js):** Actualizadas las URLs de los microservicios `AUTH`, `CATALOG` y `FEEDBACK` a sus últimas versiones desplegadas.
    *   Se han reemplazado las URLs en el objeto `API_ENDPOINTS` para `AUTH`, `CATALOG` y `FEEDBACK` para apuntar a los nuevos despliegues que contienen las correcciones de estabilidad críticas. (Líneas 10, 11, 14).

**v4.2.5 (05/01/2024)**
*   **FIX (services/auth/auth.js):** Corregido un bug crítico que causaba la pérdida de sesión al recargar la página.
    *   **Causa Raíz:** La función `handleValidateSession` lanzaba un error no controlado si la hoja "ActiveSessions" no existía, provocando que el backend fallara en lugar de devolver una respuesta JSON válida (`{valid: false}`). El frontend no manejaba este error inesperado y reiniciaba el estado de la sesión.
    *   **Solución:** Se ha modificado la función para que, en caso de no encontrar la hoja, se registre el error internamente y se devuelva `{valid: false}`. Esto asegura que el frontend siempre reciba una respuesta con la que puede trabajar, previniendo el reinicio de la sesión. (Líneas 224-227).
*   **FIX (services/catalog/catalog.js):** Corregido un bug crítico que mostraba el error "No se pudo cargar el catálogo" si la hoja de datos "Cortes" no estaba presente.
    *   **Causa Raíz:** Al igual que en el servicio de autenticación, la función `handleGetNavigationData` intentaba leer la hoja "Cortes" sin verificar primero su existencia, causando un crash en el backend.
    *   **Solución:** Se ha añadido una comprobación al inicio de la función. Si la hoja "Cortes" no se encuentra, la función ahora devuelve una respuesta válida con un array de datos vacío (`{data: []}`), evitando el error en el frontend. (Líneas 319-323).
*   **FIX (services/feedback/feedback.js):** Corregido un bug que impedía la carga de notificaciones si la hoja "Notificaciones" no existía.
    *   **Causa Raíz:** La función `handleGetUnreadNotifications` fallaba con el error `cannot read properties of null (reading 'getDataRange')` por no comprobar la existencia de la hoja antes de intentar leerla.
    *   **Solución:** Se ha añadido una comprobación. Si la hoja "Notificaciones" no existe, la función ahora devuelve una respuesta válida con un array de notificaciones vacío, previniendo el crash. (Líneas 518-522).

**v4.2.4 (05/01/2024)**
*   **INFRA (api-manager.js):** Actualizadas las URLs de los microservicios `CATALOG` y `WRITE` a sus últimas versiones desplegadas para reflejar las correcciones de bugs y nuevas funcionalidades.
    *   Se han reemplazado las URLs en el objeto `API_ENDPOINTS` para `CATALOG` y `WRITE`. (Líneas 11-12).

**v4.2.3 (05/01/2024)**
*   **FIX (services/catalog/catalog.js):** Corregido un bug crítico que impedía la carga de opciones en los formularios.
    *   **Causa Raíz:** La función `handleGetDropdownData` devolvía un objeto JSON con una estructura (`{data: ...}`) y claves (`categorias`) que no coincidían con las que esperaba el frontend (`{dropdowns: ...}` y `categoria`).
    *   **Solución:** Se ha modificado la estructura del objeto de respuesta y los nombres de las claves para alinearlos con los requisitos del frontend (`add_cortes.html`). (Líneas 275-285).
*   **FIX (api-manager.js, add_cortes.html):** Reparado el flujo completo de envío de datos, que estaba totalmente inoperativo.
    *   **Causa Raíz:** El frontend (`add_cortes.html`) llamaba a una acción genérica `addCorte` que no existía en el backend. El backend (`write.js`) esperaba una secuencia de llamadas a acciones específicas (`checkVehicle`, `addOrUpdateCut`, `addSupplementaryInfo`).
    *   **Solución:**
        1.  **`api-manager.js`:** Se actualizó el `ACTION_TO_SERVICE_MAP`. Se eliminó la acción `addCorte` y se añadieron `addOrUpdateCut` y `addSupplementaryInfo`, ambas mapeadas al servicio `WRITE`. Se corrigió `checkVehicle` para que apunte a `WRITE` en lugar de `CATALOG`. (Líneas 27-34).
        2.  **`add_cortes.html`:** Se refactorizó la lógica de envío de formularios para que llame a las acciones correctas (`addOrUpdateCut` y `addSupplementaryInfo`) con la estructura de `payload` que el backend espera. (Líneas 227-285).
*   **REFACTOR (services/catalog/catalog.js):** Eliminado código redundante para mejorar la mantenibilidad.
    *   Se ha eliminado la función `handleCheckVehicle` y su llamada en el `doPost`, ya que esta funcionalidad es manejada exclusivamente por el servicio `WRITE`. (Líneas 104-107, 290-329).
*   **FEAT (services/write/write.js):** Añadida validación de datos en el lado del servidor.
    *   La función `handleAddOrUpdateCut` ahora comprueba que los campos obligatorios (`tipoCorte1`, `marca`, `modelo`, etc.) no estén vacíos antes de procesar la solicitud, mejorando la integridad de los datos. (Líneas 167-170, 182-185).

**v4.2.2 (04/01/2024)**
*   **INFRA (api-manager.js):** Actualizada la URL del microservicio `GPSpedia-Auth` a su última versión desplegada para incorporar la corrección de persistencia de sesión.
    *   Se ha reemplazado la URL en el objeto `API_ENDPOINTS` para `AUTH`. (Línea 10).

**v4.2.1 (04/01/2024)**
*   **FIX (services/auth/auth.js):** Corregido un error crítico de lógica que causaba el cierre inesperado de sesiones.
    *   **Causa Raíz:** La función `handleValidateSession` estaba validando los tokens de sesión contra la hoja `Users`, que solo almacena el token más reciente, en lugar de la hoja `ActiveSessions`, que contiene todos los tokens válidos.
    *   **Solución:** Se ha refactorizado `handleValidateSession` para que ahora consulte la hoja `ActiveSessions`, asegurando que todas las sesiones activas y válidas (dentro de los límites de rol) sean reconocidas correctamente. (Líneas 221-243).
*   **CHORE (services/auth/auth.js):** Actualizados los límites de sesión por rol para alinearlos con los nuevos requisitos.
    *   'jefe': 3 -> 5
    *   'supervisor': 2 -> 3
    (Líneas 36-37).

**v4.2.0 (04/01/2024)**
*   **FEAT (services/utilities/utilities.js):** Creado el nuevo microservicio `GPSpedia-Utilities` que faltaba.
    *   Implementadas las funciones `migrateYearRanges` y `migrateTimestamps` para la migración de datos.
    *   Añadida una capa de seguridad para que estas funciones solo puedan ser ejecutadas por usuarios con el rol 'Desarrollador'.
*   **FEAT (services/feedback/feedback.js):** Implementada la lógica de expansión de rango de años.
    *   La nueva función `suggestYear` permite a los usuarios sugerir un año nuevo para un vehículo.
    *   Incluye una lógica "anti-colisión" para evitar que los rangos de años de diferentes generaciones de vehículos se solapen.
*   **FEAT (services/feedback/feedback.js, api-manager.js, index.html):** Implementado el sistema de "Inbox de Reportes".
    *   **Backend:** Añadidas nuevas funciones (`getReportedProblems`, `replyToProblem`, `resolveProblem`) a `feedback.js`.
    *   **API:** Actualizado `api-manager.js` para enrutar las nuevas acciones del inbox.
    *   **Frontend:** Añadido un nuevo modal en `index.html` para el inbox, con su CSS y JavaScript correspondiente. El enlace al inbox solo es visible para roles de 'Supervisor', 'Jefe' y 'Desarrollador'.
*   **FIX (index.html):** Solucionado el bug crítico en el modal de detalle del vehículo.
    *   La función `mostrarDetalleModal` ha sido refactorizada para mostrar correctamente los datos de los tres cortes posibles.
    *   Las imágenes suplementarias (`imgApertura`, `imgCableAlimen`) y el logo de la marca ahora se cargan y muestran correctamente.
    *   El corte recomendado se muestra de forma destacada, y los cortes alternativos en acordeones desplegables.
*   **STYLE (index.html):** Aplicadas múltiples mejoras de UI/UX.
    *   Reorganizadas las secciones de la página principal para que "Últimos Agregados" aparezca primero.
    *   Rediseñados los logos de las marcas en la lista para que se muestren como iconos sin fondo.
    *   Ajustado el estilo de los botones de feedback ("Útil" y "Reportar") para que coincidan con el diseño especificado.
*   **PERF (index.html):** Implementada la carga progresiva (lazy loading) de imágenes en todo el catálogo para mejorar el rendimiento inicial.
*   **CHORE (Project-wide):** Actualizadas las versiones de los componentes en todos los archivos modificados.

**v4.1.0 (03/01/2024)**
*   **CHORE & FIX (Project-wide):** Se revirtió una entrega anterior para restaurar múltiples funcionalidades y se aplicaron nuevas características.
    *   **Restauraciones:**
        *   **`users.html`:** Corregido el error `undefined` en la tabla de usuarios al alinear el acceso a propiedades con el esquema del backend (ej. `Nombre_Usuario`). Restaurado el CSS (`table-layout: fixed`) para prevenir el desbordamiento de la tabla.
        *   **`services/users/users.js`:** Corregida la regresión en la función `handleChangePassword` para que la comparación de la contraseña actual sea insensible a mayúsculas y minúsculas, alineándose con la lógica de login.
        *   **`api-manager.js`:** Restaurada la ruta para la acción `sendContactForm` en el `ACTION_TO_SERVICE_MAP`, reactivando el formulario de contacto.
        *   **`index.html`:** Restaurado el diseño de la cuadrícula (`.grid`) a un formato de 3 columnas responsivo.
*   **FEAT (index.html, api-manager.js):** Se implementó una nueva consola de desarrollador.
    *   La consola de depuración ahora está oculta por defecto y se accede a través de un nuevo botón "Desarrollador" en el menú lateral.
    *   Se creó un modal de desarrollador que contiene la consola y un panel de control.
    *   El panel de control incluye botones para ejecutar los scripts de migración de datos (`migrateYearRanges`, `migrateTimestamps`) desde el frontend. Se añadieron las rutas correspondientes en `api-manager.js`.
*   **STYLE (index.html, users.html):** Se aplicaron ajustes generales de la interfaz de usuario para un diseño más compacto.
    *   **`index.html`:** Reducido el tamaño de los encabezados (h2, h3, h4) y el `padding` de los botones. Añadido el logo de GPSpedia al menú lateral.
    *   **`users.html`:** Reducido el tamaño de los encabezados y botones para optimizar el espacio.
*   **INFRA (api-manager.js):** Se actualizaron las URLs de todos los microservicios (`AUTH`, `CATALOG`, `FEEDBACK`, `USERS`, `WRITE`) a sus últimas versiones desplegadas.
**v4.0.0 (02/01/2026)**
*   **FIX CRÍTICO (services/catalog/catalog.js):** Se ha solucionado el error `cannot read properties of undefined (reading 'categoria')` que impedía la carga de datos del catálogo y de los formularios. Se implementó la función `mapRowToObject` que faltaba y se corrigió `handleGetDropdownData` para leer dinámicamente las opciones de "Categoría" desde las reglas de validación de la hoja de cálculo.
*   **FIX CRÍTICO (services/users/users.js):** Se ha reparado el servicio de gestión de usuarios, que fallaba en todas sus operaciones (`Failed to fetch`). El error se debía a que la función `doPost` no retornaba ninguna respuesta. Se corrigió la función para asegurar que todas las acciones devuelvan un resultado al frontend.
*   **REFACTOR & FEAT (index.html):** Se ha eliminado la página `info.html` y su contenido se ha integrado directamente en `index.html` como modales.
    *   Las secciones "Sobre Nosotros", "Contáctanos" y "Preguntas Frecuentes" ahora se abren como pop-ups sin necesidad de recargar la página.
    *   Se ha añadido el nuevo contenido extendido a estas secciones.
    *   Se añadió un pequeño margen al CSS del pie de página para mejorar la separación visual de los enlaces.
*   **FIX (index.html):** Se ha corregido el envío del formulario de contacto, que fallaba por un error tipográfico en el nombre de la acción (`sendContacForm` -> `sendContactForm`).
*   **CHORE (project):** Se han actualizado los números de versión en todos los archivos modificados a `4.0.0` (global) y a las versiones de componente correspondientes.

**v3.9.3 (01/01/2026)**
*   **REFACTOR (services/auth/auth.js):** Mejorada la lógica de gestión de sesiones en `handleLogin`. El sistema ahora elimina correctamente las sesiones más antiguas cuando se alcanza el límite por rol, en lugar de borrar sesiones al azar. Se asegura también que cada nuevo login genere un token de sesión único, invalidando el anterior. (Líneas 140-198).
*   **FIX (index.html):** Corregido el diseño del pie de página. Los enlaces de "Sobre Nosotros", "Contáctanos", etc., ahora se muestran correctamente debajo del aviso de derechos de autor. (Líneas 2248-2254).
*   **REFACTOR & FEAT (info.html):** La página de información ha sido completamente rediseñada.
    *   Ahora utiliza una estructura de modales individuales para cada sección ("Sobre Nosotros", "Contáctanos", "FAQ").
    *   Un nuevo script permite enlazar directamente a una sección específica (ej. `info.html#contact`) abriendo el modal correspondiente al cargar la página.
    *   Se ha ampliado el contenido de las secciones "Sobre Nosotros" y "Preguntas Frecuentes" con información más detallada y útil.

**v3.9.2 (27/12/2025)**
*   **FIX CRÍTICO (services/catalog/catalog.js):** Solucionado un error `Cannot read properties of undefined (reading 'utilCorte1')` que ocurría al procesar los datos del catálogo. Se añadió un filtro para ignorar filas vacías en la hoja de cálculo "Cortes", preveniendo que el backend falle al encontrar datos incompletos.
*   **DOCS (Auditoria.txt):** Se agregó la Auditoría v11.0 detallando el análisis y la solución para el error de procesamiento de filas vacías.
**v3.9.1 (26/12/2025)**
*   **FIX CRÍTICO (services/catalog/catalog.js):** Se implementó la función `doPost(e)` que estaba completamente vacía. Esta era la causa raíz de los errores "Failed to fetch" que impedían la carga de cualquier dato del catálogo. La nueva función ahora actúa como un router, procesando las acciones (`getCatalogData`, etc.) y devolviendo los datos correctamente.
*   **DOCS (Auditoria.txt):** Se agregó la Auditoría v10.0 detallando el descubrimiento y la solución del bug crítico en la función `doPost`.

=================================================
 NORMAS OBLIGATORIAS PARA EL REGISTRO DE CAMBIOS
=================================================

**IMPORTANTE:** Antes de registrar un nuevo cambio, asegúrese de haber seguido todas las normas de desarrollo descritas en `README.md` y `INSTRUCTIVO.TXT`.

1.  **Actualizar Versión:** Confirme que el número de versión (`vX.X.X`) es correcto y ha sido actualizado en los archivos correspondientes (`index.html`, servicios `.js`/`.gs`).
2.  **Documentación Interna:** Verifique que `README.md` y `INSTRUCTIVO.TXT` han sido actualizados para reflejar los cambios realizados.
3.  **Formato Detallado:**
    *   **Archivo y Línea:** Cada cambio listado debe especificar el nombre del archivo modificado y el número de línea exacto.
    *   **Comentarios de Código:** Confirme que las líneas de código nuevas o modificadas tienen comentarios explicativos.
    *   **Claridad:** Describa el "qué" y el "porqué" del cambio de manera clara y concisa.

-------------------------------------------------

# Registro de Cambios del Proyecto GPSpedia

## v3.8.1 - 21/08/2024
- **INFRAESTRUCTURA: ACTUALIZACIÓN DE ENDPOINT DE SERVICIO `WRITE`.**
  - **Contexto:** Se ha actualizado la URL del microservicio `GPSpedia-Write` a su última versión desplegada.
  - **Acción (`api-manager.js`):**
    - Se ha reemplazado la URL en el objeto `API_ENDPOINTS` para `WRITE`. (Línea 11).

## v3.8.0 - 21/08/2024
- **FEAT: IMPLEMENTACIÓN DE LÓGICA DE LOGOS AUTOMÁtica Y MEJORAS DE UI.**
  - **Contexto:** Se han implementado mejoras significativas en la interfaz de usuario según los requisitos pendientes.
  - **Acciones Realizadas:**
    1.  **Implementación de Lógica de Logos Automática (`services/write/write.js`):**
        - Se ha creado la función `getLogoForMarca` que busca automáticamente el logo de una marca en la hoja `LogosMarca`.
        - La función maneja la lógica especial para la categoría "Motos", buscando `marcaMotocicletas` o `marcaVehiculos` según corresponda. (Líneas 134-159).
    2.  **Mejoras de UI en `index.html`:**
        - Se ha corregido la sección "Últimos Agregados" para que muestre 6 elementos en lugar de 5. (Línea 1755).
        - Se ha ajustado el layout del modal de detalles para posicionar correctamente el nombre del colaborador. (Líneas 1612-1622).
        - Se ha implementado la visualización del logo de la marca en el modal de detalles y en la lista de marcas. (Líneas 1561-1567, 1819-1825).
        - Se ha limitado la altura de la imagen en el modal de Relay a 250px. (Líneas 1481-1484).
- **INFRAESTRUCTURA: ACTUALIZACIÓN DE ENDPOINTS DE SERVICIOS (`api-manager.js`).**
  - Se han actualizado las URLs de los microservicios `Auth`, `Catalog`, `Feedback` y `Users` a sus últimas versiones. (Líneas 9-13).

## v3.7.0 - 20/08/2024
- **REFACTORIZACIÓN CRÍTICA: ALINEACIÓN COMPLETA DEL ESQUEMA DE DATOS EN TODO EL SISTEMA.**
  - **Contexto:** Se detectó que la causa raíz de la inestabilidad persistente era una discrepancia fundamental entre el esquema de datos real en Google Sheets y el esquema que los componentes de software esperaban. Esta versión corrige todas las desviaciones y unifica el sistema a una única fuente de verdad.
  - **Acciones Realizadas:**
    1.  **Actualización de Endpoints (`api-manager.js`):**
        - Se actualizó la URL del microservicio `GPSpedia-Auth` a su último despliegue. (Línea 9).
    2.  **Alineación de Esquemas del Backend:**
        - **`services/auth/auth.js`:** Se corrigieron los mapas de columnas para `Users` y `ActiveSessions`. Se ajustó la lógica de `handleLogin` para escribir correctamente en la hoja de sesiones y para devolver un objeto `user` que coincide 1:1 con el esquema de la base de datos (ej. `Nombre_Usuario`), eliminando el formato `PascalCase` incorrecto. (Líneas 16-36, 124-184).
        - **`services/catalog/catalog.js`:** Se corrigieron y completaron los mapas de columnas para `Cortes`, `Tutorial`, y `Relay`. Se añadió el mapa para `LogosMarca` y se actualizó la lógica para incluir los logos en la respuesta de `getCatalogData`. (Líneas 21-88, 98-138).
        - **`services/feedback/feedback.js`:** Se corrigió el mapa de `Feedbacks` y se añadieron los mapas para `Contactanos` y `ActividadUsuario`. Se implementó la función `logUserActivity` para registrar acciones del usuario. (Líneas 21-70, y adición de `logUserActivity` y su integración).
        - **`services/users/users.js`:** Se corrigió el mapa de `Users` para usar la nomenclatura exacta de la hoja de cálculo (`Nombre_Usuario`, etc.). Se refactorizó todo el servicio para usar este nuevo mapa. (Líneas 25-33, y múltiples ajustes en las funciones `handle...`).
        - **`services/write/write.js`:** Se verificó que el mapa de `Cortes` ya era correcto y no requirió cambios.
    3.  **Alineación del Frontend (`index.html`):**
        - Se refactorizó todo el código JavaScript para que consuma los datos con la nueva estructura correcta. Se corrigió el acceso a las propiedades del objeto de usuario (ahora `user.Nombre_Usuario`) y a todos los campos del catálogo. (Múltiples líneas afectadas, ej. 1093, 1187, 2100).
    4.  **Sincronización de la Documentación:**
        - **`README.md` y `Instrucciones.txt`:** Se han actualizado las secciones de "Arquitectura de la Base de Datos" para que reflejen el esquema final y oficial de las 10 hojas de cálculo, sirviendo como la fuente de verdad para el proyecto.
... (rest of the file remains the same)

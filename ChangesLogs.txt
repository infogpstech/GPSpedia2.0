**V6.4.0 - (FIX) - 05/01/2026**
**A. FIX DE INICIALIZACIÓN DE DATOS (FRONTEND):** Se solucionó un `TypeError` que ocurría durante la carga inicial de datos, impidiendo que la aplicación se renderizara después de un login exitoso.

**B. Causa Raíz:**
    - La función `handleLoginSuccess` en `auth.js` intentaba acceder a `catalogData.cortes`, pero la respuesta del backend (`catalog-service`) anida los datos dentro de una propiedad `data`. La estructura correcta de la respuesta es `{ status: 'success', data: { cortes: [...] } }`.
    - Este desajuste en el acceso a la estructura de datos provocaba el error `TypeError: Cannot read properties of undefined (reading 'reduce')`.

**C. Cambios Implementados:**
    1.  **`auth.js` (Líneas 21, 31):** Se corrigió el acceso a los datos para que apunte a la propiedad `data` anidada.
        - Se cambió `catalogData.cortes.reduce` a `catalogData.data.cortes.reduce`.
        - Se actualizó el `setState` para que utilice el spread operator sobre `catalogData.data` en lugar de `catalogData`.

**D. Impacto:**
    - Se restaura el flujo de inicio de sesión y la carga de datos de la aplicación.
    - El frontend ahora maneja correctamente la estructura de respuesta anidada del `catalog-service`, eliminando el error de `TypeError` y permitiendo que la UI se renderice como se esperaba.

**V6.3.0 - (UI FIX) - 05/01/2026**
**A. CORRECCIÓN DEFINITIVA DE VISIBILIDAD DE CONSOLA DE DEPURACIÓN:** Se solucionó de forma permanente el bug que causaba que la consola de depuración fuera visible por defecto al cargar la aplicación.

**B. Causa Raíz:**
    - Un error en el `index.html` incluía dos propiedades `display` conflictivas (`display: none` y `display: flex`) en el estilo en línea del `div#debug-console`. Aunque se había corregido previamente, el error reapareció, indicando un problema de persistencia en el flujo de trabajo.

**C. Cambios Implementados:**
    1.  **`index.html` (Línea 18):** Se eliminó una vez más la propiedad `display: flex;` conflictiva, dejando únicamente `display: none;` para asegurar que la consola esté oculta por defecto.

**D. Impacto:**
    - Se garantiza que la consola de depuración permanezca oculta al iniciar la aplicación, mejorando la experiencia de usuario y evitando la exposición de herramientas de desarrollo.

**V6.2.0 - (INFRA) - 05/01/2026**
**A. ACTUALIZACIÓN DE ENDPOINT DE SERVICIO:** Se actualizó la URL del microservicio `CATALOG` en la configuración del frontend.

**B. Causa Raíz:**
    - El `CATALOG` service fue redesplegado en una nueva URL de Google Apps Script, y el frontend (`api.js`) aún apuntaba al endpoint antiguo.

**C. Cambios Implementados:**
    1.  **`api.js` (Línea 9):** Se reemplazó la URL obsoleta del servicio `CATALOG` por el nuevo endpoint proporcionado.

**D. Impacto:**
    - Se asegura que el frontend se comunique con la versión más reciente del `catalog-service`, permitiendo que las correcciones de bugs y nuevas funcionalidades (como el fix de Tarea 30) tengan efecto en la aplicación.

**V6.1.0 - (CRITICAL FIX) - 05/01/2026**
**A. FIX CRÍTICO DE ARRANQUE (FULL-STACK):** Se solucionó el error crítico que impedía la inicialización de la aplicación, cumpliendo con la TAREA 30.

**B. Causa Raíz:**
    1.  **Backend (`services/catalog/catalog.js`):** La función `handleGetDropdownData` no verificaba si una regla de validación de datos existía antes de intentar usarla, causando un `TypeError` fatal si la regla faltaba en la hoja de cálculo.
    2.  **Frontend (`auth.js`):** El manejador de errores en `handleLoginSuccess` capturaba el error controlado del backend pero no lo registraba en la consola del navegador, mostrando solo un mensaje genérico y ocultando la causa raíz.

**C. Cambios Implementados:**
    1.  **`services/catalog/catalog.js` (Línea 365):** Se añadió una verificación de nulidad (`null check`) para asegurar que el código no falle si la regla de validación de datos no existe, devolviendo un array vacío como fallback seguro.
    2.  **`auth.js` (Línea 38):** Se añadió `console.error(error)` al bloque `catch` para asegurar que cualquier error futuro durante la carga de datos sea visible en la consola del navegador, facilitando la depuración.

**D. Impacto:**
    - Se restaura la capacidad de la aplicación para arrancar correctamente, incluso si la configuración de la hoja de cálculo es imperfecta.
    - Se mejora la robustez del backend ante datos de configuración inesperados.
    - Se mejora la capacidad de depuración del frontend al hacer visibles los errores controlados del backend.

**V5.8.0 - (CRITICAL FIX) - 05/01/2026**
**A. FIX CRÍTICO DE CORS Y ESTABILIDAD EN `feedback-service`:** Se solucionó un bug crítico que impedía el funcionamiento de toda la funcionalidad de feedback y contacto (ej. Inbox, reportar problema) debido a un error de CORS, y se resolvió una inestabilidad severa causada por código duplicado.

**B. Causa Raíz:**
    1.  **Error de `MimeType`:** La función `doGet` del servicio `services/feedback/feedback.js` devolvía `ContentService.MimeType.JSON`, violando el requisito de la arquitectura de usar `ContentService.MimeType.TEXT` para todas las respuestas y causando fallos de CORS en el frontend.
    2.  **Código Duplicado:** Durante la auditoría se encontraron dos implementaciones completas de las funciones `handleRecordLike` y `handleSuggestYear`, creando un riesgo alto de comportamiento inconsistente y errores de mantenimiento.

**C. Cambios Implementados:**
    1.  **`services/feedback/feedback.js` (Línea 85):** Se corrigió el `MimeType` en la función `doGet`, alineándolo a `ContentService.MimeType.TEXT`.
    2.  **`services/feedback/feedback.js` (Líneas 141-174 y 332-348 eliminadas):** Se eliminaron las implementaciones duplicadas y obsoletas de `handleRecordLike` y `handleSuggestYear`, conservando las versiones más robustas que incluyen el registro de actividad del usuario.

**D. Impacto:**
    -   Se restaura la funcionalidad completa del sistema de feedback, reportes y contacto.
    -   Se elimina una fuente crítica de inestabilidad y bugs futuros al resolver la duplicación de código.
    -   El servicio `feedback-service` es ahora más estable, predecible y cumple con los estándares de la arquitectura.

**V5.7.0 - (CRITICAL ALIGNMENT) - 04/01/2026**
**A. FIX CRÍTICO DE INCONSISTENCIA ARQUITECTÓNICA (FRONTEND-BACKEND):** Se solucionó una ruptura crítica en la arquitectura que impedía el funcionamiento de la carga progresiva del catálogo.

**B. Causa Raíz:**
    -   Un commit anterior había actualizado el frontend (`api-manager.js`, `main.js`) para que llamara a una nueva acción `getNavigationData` con el objetivo de optimizar el rendimiento.
    -   Sin embargo, esta acción nunca fue implementada en el backend (`services/catalog/catalog.js`), resultando en un error fatal que impedía la carga de la aplicación.

**C. Cambios Implementados:**
    1.  **`services/catalog/catalog.js`:**
        -   **Implementación Faltante:** Se implementó la acción `getNavigationData` en el backend.
        -   **Router:** Se añadió el `case 'getNavigationData'` al router `doPost` para manejar la nueva acción.
        -   **Handler:** Se creó la función `handleGetNavigationData`, que ahora devuelve un payload ligero con los datos esenciales para el render inicial (`categoryCounts`, `sortedCategories`, `marcas`, `logos`), cumpliendo con lo que el frontend esperaba.

**D. Impacto:**
    -   Se restaura la funcionalidad de la aplicación, que estaba completamente rota debido a esta inconsistencia.
    -   El backend ahora cumple con el contrato esperado por el frontend, habilitando la carga progresiva y mejorando significativamente el tiempo de carga percibido por el usuario.
    -   Se resuelve la discrepancia entre el historial de commits y el estado real del código.

**V5.6.0 - (CRITICAL HOTFIX) - 05/01/2026**
**A. FIX CRÍTICO DE ESTABILIDAD (BACKEND):** Se solucionó un error fatal en producción ("Argumento demasiado grande") que causaba la caída total del `catalog-service` e impedía la carga del catálogo en la aplicación.

**B. Causa Raíz:**
    -   El `catalog-service` intentaba guardar en `CacheService` el objeto JSON completo del catálogo, el cual excedía el límite de 100 KB por objeto, provocando un error no capturado que detenía la ejecución.

**C. Cambios Implementados:**
    1.  **`services/catalog/catalog.js`:**
        -   **Remediación:** Se deshabilitó por completo la escritura del catálogo en la caché (`cache.put`) para resolver inmediatamente el error.
        -   **Endurecimiento:** Se envolvió la operación de lectura de caché (`cache.get`) en un bloque `try...catch` para que cualquier futuro error de caché no interrumpa el servicio.
    2.  **`services/image/image.js`:**
        -   **Endurecimiento Preventivo:** Aunque no era la causa del error, se envolvió toda la lógica de `cache.get` y `cache.put` en bloques `try...catch` para aumentar la resiliencia del servicio de imágenes ante posibles fallos de la caché.

**D. Actualización de Documentación:**
    -   Se añadió una nueva sección en `README.md` (`5.4. Reglas Críticas de Uso de CacheService`) para documentar las limitaciones y el uso correcto del servicio de caché.
    -   Se registró esta tarea crítica en `Instrucciones.txt` como "Tarea 29".

**E. Impacto:**
    -   Se restaura la funcionalidad del catálogo en producción.
    -   La arquitectura backend es ahora más resiliente a fallos de `CacheService`, previniendo futuras caídas por esta causa.


**V5.5.0 - (CRITICAL FIX) - 05/01/2026**
**A. FIX CRÍTICO DE ARQUITECTURA (FULL-STACK):** Se solucionó de manera definitiva el bug que impedía la carga intermitente de imágenes en producción. El problema residía en dos puntos de la nueva arquitectura:
    1.  **Backend ():**
        -   **Error de MimeType:** Se eliminó la función  que fallaba al inferir el tipo de contenido, causando que el servicio devolviera un MimeType incorrecto y el navegador rechazara la imagen. Se reemplazó por una llamada directa a , que es 100% fiable.
        -   **Error de Caché:** Se añadió un control para evitar guardar en caché imágenes de más de 90KB, previniendo exceder los límites de Google Apps Script y asegurando la estabilidad del servicio.
    2.  **Frontend ():**
        -   **Error de Codificación de URL:** La función  no codificaba correctamente el  antes de añadirlo como parámetro en la URL. Caracteres especiales en los IDs (como guiones bajos) podían ser malinterpretados, rompiendo la llamada al . Se solucionó aplicando  al .

**B. Archivos Modificados:**
    -   : Líneas 45-55, 65-75.
    -   : Línea 112.

**C. Impacto:**
    -   La arquitectura de imágenes es ahora robusta, segura y funcional en todo el stack.
    -   Se garantiza la carga fiable de todas las imágenes de Google Drive a través del proxy.
    -   El sistema de caché del  es ahora seguro y no causará fallos inesperados.

**v5.4.0 (05/01/2026)**
*   **FINALIZE (services/catalog/catalog.js):** Se completó el endurecimiento y la formalización final del `catalog-service` para su puesta en producción.
    *   **Contrato de Datos Formalizado:** Se añadieron comentarios JSDoc explícitos (`@const`) para los `IMAGE_FIELDS_*`, documentando formalmente el "Contrato de Imagen". Esto garantiza que cualquier mantenedor futuro entienda la regla de que el servicio solo debe devolver `fileId` o `null` para estos campos.
    *   **Logging Controlado:** Se introdujo una bandera global `LOG_INVALID_IDS`. Cuando se establece en `true`, la función `normalizeAndValidateImageId` registrará en la consola de Apps Script cualquier valor de imagen que no pueda ser validado, permitiendo una depuración de la calidad de los datos sin contaminar los logs de producción.
    -   **Modo Diagnóstico:** Se implementó un modo de diagnóstico no invasivo activado con el parámetro `?diagnostics=true` en la URL de la solicitud. En este modo, la respuesta JSON se envuelve en un objeto `diagnostics` que incluye metadatos de ejecución (tiempo de respuesta) y una lista de todos los IDs de imagen inválidos encontrados durante la solicitud, facilitando la monitorización y el mantenimiento proactivo.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.3.0 (05/01/2026)**
*   **HARDENING (services/catalog/catalog.js):** Se finalizó el robustecimiento del servicio de catálogo para asegurar la integridad de los datos de imágenes y el cumplimiento estricto de la arquitectura.
    *   **Causa Raíz:** El servicio no validaba ni normalizaba los datos de imágenes provenientes de la hoja de cálculo. Esto permitía que URLs completas o datos malformados se propagaran al frontend, causando inestabilidad y violando la regla de que solo el `image-service` debe manejar URLs.
    *   **Solución:** Se implementó una nueva función `normalizeAndValidateImageId`. Esta función centraliza la lógica de validación: toma cualquier valor (URL completa, ID limpio, o `null`), extrae y devuelve un `fileId` válido o `null`. Se refactorizó la función `mapRowToObject` para que *todos* los campos de imagen (`imagenDelVehiculo`, `imgCorte`, `logoUrl`, etc.) pasen obligatoriamente por esta validación antes de ser enviados al frontend.
    *   **Resultado:** El `catalog-service` ahora garantiza que solo enviará `fileId` limpios, eliminando la causa raíz de los bugs de renderización de imágenes desde el backend y cumpliendo con su rol arquitectónico.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.2.0 (04/01/2026)**
*   **FIX (Arquitectura):** Se solucionó la causa raíz del bug que impedía la carga de imágenes del catálogo.
    *   **Causa Raíz:** Se descubrió una violación arquitectónica en `services/catalog/catalog.js`. Este servicio estaba transformando incorrectamente los `fileId` de las imágenes a URLs completas de Google Drive, en lugar de enviar solo los IDs al frontend.
    *   **Solución (Backend):** Se eliminó por completo la función `convertirAGoogleThumbnail` y todas sus llamadas dentro de `services/catalog/catalog.js`. El servicio ahora cumple estrictamente con su responsabilidad de servir datos crudos, enviando únicamente los `fileId`.
    *   **Solución (Frontend):** Se robusteció la función `getImageUrl` en `main.js`. Se eliminó la lógica de parsing de URLs, ya que ahora solo recibe `fileId` limpios, haciendo el código más simple y eficiente.
    *   **Archivos Modificados:** `services/catalog/catalog.js`, `main.js`.
*   **DOCS (README.md):** Se actualizó la documentación con un diagrama y una explicación detallada del flujo de carga de imágenes final y correcto, reflejando la arquitectura verificada.
    *   **Archivos Modificados:** `README.md`.

**v5.1.0 (05/01/2026)**
*   **PERF (services/catalog/catalog.js):** Se implementó un mecanismo de caché en el backend para mejorar radicalmente el rendimiento de la aplicación.
    *   **Causa Raíz:** La carga inicial de datos (`getCatalogData`) era lenta debido a que leía y procesaba toda la información de la hoja de cálculo en cada solicitud.
    *   **Solución:** Se utilizó `CacheService` de Google Apps Script para almacenar en caché el objeto de datos del catálogo completo durante 1 hora. Las solicitudes posteriores ahora leen directamente de la caché, evitando accesos innecesarios a la hoja de cálculo y reduciendo los tiempos de carga de segundos a milisegundos.
    *   **Verificación:** Se añadió un nuevo endpoint de depuración (`?debug=true`) que muestra el estado actual de la caché, permitiendo verificar si los datos se están sirviendo desde la caché o desde una lectura nueva.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.0.0 (05/01/2026)**
*   **REFACTOR (Arquitectura):** Se completó una reestructuración arquitectónica mayor para alinear el proyecto con la especificación `v4` del `README.md`.
    *   **Modularización del Frontend:** Se desacopló el archivo monolítico `index.html`. El CSS y el JavaScript fueron extraídos a archivos externos (`style.css` y `main.js`), mejorando la mantenibilidad y claridad del código.
        *   **Archivos Creados:** `style.css`, `main.js`.
        *   **Archivos Modificados:** `index.html`.
    *   **Nuevo Microservicio de Imágenes:** Se creó el nuevo `GPSpedia-Image` (`services/image/image.js`), que actúa como un proxy seguro para servir imágenes desde Google Drive. Esto elimina la exposición directa de URLs de Drive en el frontend, mejorando la seguridad y centralizando la lógica de acceso a imágenes.
        *   **Archivos Creados:** `services/image/image.js`.
    *   **Refactorización del Frontend para el Servicio de Imágenes:** Se refactorizó todo el código JavaScript del frontend (`main.js`) para eliminar la lógica de conversión de URLs de Google Drive (`convertirAGoogleThumbnail`). Todas las solicitudes de imágenes ahora se enrutan a través del nuevo `GPSpedia-Image`.
        *   **Archivos Modificados:** `main.js`.
    *   **Actualización del API Manager:** Se registró el endpoint del nuevo servicio `IMAGE` en `api-manager.js` para hacerlo accesible al frontend. Se actualizó la URL con el endpoint desplegado proporcionado por el usuario.
        *   **Archivos Modificados:** `api-manager.js`.

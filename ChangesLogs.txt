**V5.7.0 - (CRITICAL ALIGNMENT) - 04/01/2026**
**A. FIX CRÍTICO DE INCONSISTENCIA ARQUITECTÓNICA (FRONTEND-BACKEND):** Se solucionó una ruptura crítica en la arquitectura que impedía el funcionamiento de la carga progresiva del catálogo.

**B. Causa Raíz:**
    -   Un commit anterior había actualizado el frontend (`api-manager.js`, `main.js`) para que llamara a una nueva acción `getNavigationData` con el objetivo de optimizar el rendimiento.
    -   Sin embargo, esta acción nunca fue implementada en el backend (`services/catalog/catalog.js`), resultando en un error fatal que impedía la carga de la aplicación.

**C. Cambios Implementados:**
    1.  **`services/catalog/catalog.js`:**
        -   **Implementación Faltante:** Se implementó la acción `getNavigationData` en el backend.
        -   **Router:** Se añadió el `case 'getNavigationData'` al router `doPost` para manejar la nueva acción.
        -   **Handler:** Se creó la función `handleGetNavigationData`, que ahora devuelve un payload ligero con los datos esenciales para el render inicial (`categoryCounts`, `sortedCategories`, `marcas`, `logos`), cumpliendo con lo que el frontend esperaba.

**D. Impacto:**
    -   Se restaura la funcionalidad de la aplicación, que estaba completamente rota debido a esta inconsistencia.
    -   El backend ahora cumple con el contrato esperado por el frontend, habilitando la carga progresiva y mejorando significativamente el tiempo de carga percibido por el usuario.
    -   Se resuelve la discrepancia entre el historial de commits y el estado real del código.

**V5.6.0 - (CRITICAL HOTFIX) - 05/01/2026**
**A. FIX CRÍTICO DE ESTABILIDAD (BACKEND):** Se solucionó un error fatal en producción ("Argumento demasiado grande") que causaba la caída total del `catalog-service` e impedía la carga del catálogo en la aplicación.

**B. Causa Raíz:**
    -   El `catalog-service` intentaba guardar en `CacheService` el objeto JSON completo del catálogo, el cual excedía el límite de 100 KB por objeto, provocando un error no capturado que detenía la ejecución.

**C. Cambios Implementados:**
    1.  **`services/catalog/catalog.js`:**
        -   **Remediación:** Se deshabilitó por completo la escritura del catálogo en la caché (`cache.put`) para resolver inmediatamente el error.
        -   **Endurecimiento:** Se envolvió la operación de lectura de caché (`cache.get`) en un bloque `try...catch` para que cualquier futuro error de caché no interrumpa el servicio.
    2.  **`services/image/image.js`:**
        -   **Endurecimiento Preventivo:** Aunque no era la causa del error, se envolvió toda la lógica de `cache.get` y `cache.put` en bloques `try...catch` para aumentar la resiliencia del servicio de imágenes ante posibles fallos de la caché.

**D. Actualización de Documentación:**
    -   Se añadió una nueva sección en `README.md` (`5.4. Reglas Críticas de Uso de CacheService`) para documentar las limitaciones y el uso correcto del servicio de caché.
    -   Se registró esta tarea crítica en `Instrucciones.txt` como "Tarea 29".

**E. Impacto:**
    -   Se restaura la funcionalidad del catálogo en producción.
    -   La arquitectura backend es ahora más resiliente a fallos de `CacheService`, previniendo futuras caídas por esta causa.


**V5.5.0 - (CRITICAL FIX) - 05/01/2026**
**A. FIX CRÍTICO DE ARQUITECTURA (FULL-STACK):** Se solucionó de manera definitiva el bug que impedía la carga intermitente de imágenes en producción. El problema residía en dos puntos de la nueva arquitectura:
    1.  **Backend ():**
        -   **Error de MimeType:** Se eliminó la función  que fallaba al inferir el tipo de contenido, causando que el servicio devolviera un MimeType incorrecto y el navegador rechazara la imagen. Se reemplazó por una llamada directa a , que es 100% fiable.
        -   **Error de Caché:** Se añadió un control para evitar guardar en caché imágenes de más de 90KB, previniendo exceder los límites de Google Apps Script y asegurando la estabilidad del servicio.
    2.  **Frontend ():**
        -   **Error de Codificación de URL:** La función  no codificaba correctamente el  antes de añadirlo como parámetro en la URL. Caracteres especiales en los IDs (como guiones bajos) podían ser malinterpretados, rompiendo la llamada al . Se solucionó aplicando  al .

**B. Archivos Modificados:**
    -   : Líneas 45-55, 65-75.
    -   : Línea 112.

**C. Impacto:**
    -   La arquitectura de imágenes es ahora robusta, segura y funcional en todo el stack.
    -   Se garantiza la carga fiable de todas las imágenes de Google Drive a través del proxy.
    -   El sistema de caché del  es ahora seguro y no causará fallos inesperados.

**v5.4.0 (05/01/2026)**
*   **FINALIZE (services/catalog/catalog.js):** Se completó el endurecimiento y la formalización final del `catalog-service` para su puesta en producción.
    *   **Contrato de Datos Formalizado:** Se añadieron comentarios JSDoc explícitos (`@const`) para los `IMAGE_FIELDS_*`, documentando formalmente el "Contrato de Imagen". Esto garantiza que cualquier mantenedor futuro entienda la regla de que el servicio solo debe devolver `fileId` o `null` para estos campos.
    *   **Logging Controlado:** Se introdujo una bandera global `LOG_INVALID_IDS`. Cuando se establece en `true`, la función `normalizeAndValidateImageId` registrará en la consola de Apps Script cualquier valor de imagen que no pueda ser validado, permitiendo una depuración de la calidad de los datos sin contaminar los logs de producción.
    *   **Modo Diagnóstico:** Se implementó un modo de diagnóstico no invasivo activado con el parámetro `?diagnostics=true` en la URL de la solicitud. En este modo, la respuesta JSON se envuelve en un objeto `diagnostics` que incluye metadatos de ejecución (tiempo de respuesta) y una lista de todos los IDs de imagen inválidos encontrados durante la solicitud, facilitando la monitorización y el mantenimiento proactivo.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.3.0 (05/01/2026)**
*   **HARDENING (services/catalog/catalog.js):** Se finalizó el robustecimiento del servicio de catálogo para asegurar la integridad de los datos de imágenes y el cumplimiento estricto de la arquitectura.
    *   **Causa Raíz:** El servicio no validaba ni normalizaba los datos de imágenes provenientes de la hoja de cálculo. Esto permitía que URLs completas o datos malformados se propagaran al frontend, causando inestabilidad y violando la regla de que solo el `image-service` debe manejar URLs.
    *   **Solución:** Se implementó una nueva función `normalizeAndValidateImageId`. Esta función centraliza la lógica de validación: toma cualquier valor (URL completa, ID limpio, o `null`), extrae y devuelve un `fileId` válido o `null`. Se refactorizó la función `mapRowToObject` para que *todos* los campos de imagen (`imagenDelVehiculo`, `imgCorte`, `logoUrl`, etc.) pasen obligatoriamente por esta validación antes de ser enviados al frontend.
    *   **Resultado:** El `catalog-service` ahora garantiza que solo enviará `fileId` limpios, eliminando la causa raíz de los bugs de renderización de imágenes desde el backend y cumpliendo con su rol arquitectónico.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.2.0 (04/01/2026)**
*   **FIX (Arquitectura):** Se solucionó la causa raíz del bug que impedía la carga de imágenes del catálogo.
    *   **Causa Raíz:** Se descubrió una violación arquitectónica en `services/catalog/catalog.js`. Este servicio estaba transformando incorrectamente los `fileId` de las imágenes a URLs completas de Google Drive, en lugar de enviar solo los IDs al frontend.
    *   **Solución (Backend):** Se eliminó por completo la función `convertirAGoogleThumbnail` y todas sus llamadas dentro de `services/catalog/catalog.js`. El servicio ahora cumple estrictamente con su responsabilidad de servir datos crudos, enviando únicamente los `fileId`.
    *   **Solución (Frontend):** Se robusteció la función `getImageUrl` en `main.js`. Se eliminó la lógica de parsing de URLs, ya que ahora solo recibe `fileId` limpios, haciendo el código más simple y eficiente.
    *   **Archivos Modificados:** `services/catalog/catalog.js`, `main.js`.
*   **DOCS (README.md):** Se actualizó la documentación con un diagrama y una explicación detallada del flujo de carga de imágenes final y correcto, reflejando la arquitectura verificada.
    *   **Archivos Modificados:** `README.md`.

**v5.1.0 (05/01/2026)**
*   **PERF (services/catalog/catalog.js):** Se implementó un mecanismo de caché en el backend para mejorar radicalmente el rendimiento de la aplicación.
    *   **Causa Raíz:** La carga inicial de datos (`getCatalogData`) era lenta debido a que leía y procesaba toda la información de la hoja de cálculo en cada solicitud.
    *   **Solución:** Se utilizó `CacheService` de Google Apps Script para almacenar en caché el objeto de datos del catálogo completo durante 1 hora. Las solicitudes posteriores ahora leen directamente de la caché, evitando accesos innecesarios a la hoja de cálculo y reduciendo los tiempos de carga de segundos a milisegundos.
    *   **Verificación:** Se añadió un nuevo endpoint de depuración (`?debug=true`) que muestra el estado actual de la caché, permitiendo verificar si los datos se están sirviendo desde la caché o desde una lectura nueva.
    *   **Archivos Modificados:** `services/catalog/catalog.js`.

**v5.0.0 (05/01/2026)**
*   **REFACTOR (Arquitectura):** Se completó una reestructuración arquitectónica mayor para alinear el proyecto con la especificación `v4` del `README.md`.
    *   **Modularización del Frontend:** Se desacopló el archivo monolítico `index.html`. El CSS y el JavaScript fueron extraídos a archivos externos (`style.css` y `main.js`), mejorando la mantenibilidad y claridad del código.
        *   **Archivos Creados:** `style.css`, `main.js`.
        *   **Archivos Modificados:** `index.html`.
    *   **Nuevo Microservicio de Imágenes:** Se creó el nuevo `GPSpedia-Image` (`services/image/image.js`), que actúa como un proxy seguro para servir imágenes desde Google Drive. Esto elimina la exposición directa de URLs de Drive en el frontend, mejorando la seguridad y centralizando la lógica de acceso a imágenes.
        *   **Archivos Creados:** `services/image/image.js`.
    *   **Refactorización del Frontend para el Servicio de Imágenes:** Se refactorizó todo el código JavaScript del frontend (`main.js`) para eliminar la lógica de conversión de URLs de Google Drive (`convertirAGoogleThumbnail`). Todas las solicitudes de imágenes ahora se enrutan a través del nuevo `GPSpedia-Image`.
        *   **Archivos Modificados:** `main.js`.
    *   **Actualización del API Manager:** Se registró el endpoint del nuevo servicio `IMAGE` en `api-manager.js` para hacerlo accesible al frontend. Se actualizó la URL con el endpoint desplegado proporcionado por el usuario.
        *   **Archivos Modificados:** `api-manager.js`.

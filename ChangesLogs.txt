**V8.1.2 - (CRITICAL HOTFIX) - 09/01/2024**
**A. RESUMEN GENERAL:** Se corrigió un error de configuración de despliegue en el servicio de catálogo (`services/catalog/catalog.js`) que era la causa raíz de la falla persistente en las solicitudes `POST`, lo que impedía la carga de datos de la aplicación después del inicio de sesión.

**B. Corrección Crítica (Backend):**
    1.  **Inconsistencia de `Content-Type`:** Se identificó y corrigió una inconsistencia crítica donde la función `doGet` del servicio devolvía respuestas con `ContentService.MimeType.JSON`, mientras que la función `doPost` devolvía `ContentService.MimeType.TEXT`.
    2.  **Impacto del Error:** En Google Apps Script, mezclar los `Content-Type` en un mismo servicio provoca un comportamiento indefinido en el entorno de despliegue, resultando comúnmente en el fallo silencioso de todas las solicitudes `POST`, aunque las `GET` (como las pruebas con `curl`) funcionen correctamente. Este fue el motivo por el cual el error de inicio de sesión persistió a pesar de correcciones de lógica anteriores.
    3.  **Solución:** Se estandarizaron todas las rutas de respuesta en la función `doGet` para que devuelvan `ContentService.MimeType.TEXT`, alineándola con el comportamiento de `doPost` y garantizando una configuración de despliegue consistente y funcional.

**C. Cambios Técnicos Implementados:**
    - **`services/catalog/catalog.js`:** Se modificó la función `doGet` para que todas sus respuestas utilicen `ContentService.MimeType.TEXT`, eliminando el conflicto de `Content-Type`. Se incrementó la versión del componente a `2.4.2`.

**D. Impacto:**
    -   **Resuelve la Causa Raíz:** Esta corrección aborda el problema de fondo a nivel de despliegue que impedía que el frontend se comunicara correctamente con el backend a través de `POST`.
    -   **Desbloquea la Aplicación:** Con esta corrección, se espera que el flujo de inicio de sesión y carga de datos funcione según lo previsto.
    -   **Mejora la Estabilidad del Backend:** Asegura que el servicio de catálogo se comporte de manera predecible y estable en el entorno de producción de Google Apps Script.

**V8.1.1 - (CONFIG) - 09/01/2024**
**A. RESUMEN GENERAL:** Se actualizó la URL del endpoint del microservicio de catálogo (`GPSpedia-Catalog`) en la configuración del frontend para apuntar a la última versión desplegada.

**B. Cambio de Configuración (Frontend):**
    1.  **Actualización de Endpoint:** Se modificó la constante `API_ENDPOINTS.CATALOG` en `api.js` para reemplazar la URL de despliegue antigua por la nueva proporcionada por el equipo de backend.

**C. Cambios Técnicos Implementados:**
    - **`api.js`:** Se actualizó la URL del servicio `CATALOG`.

**D. Impacto:**
    -   Asegura que el frontend se comunique con la versión más reciente y corregida del servicio de catálogo, previniendo errores de datos obsoletos o de lógica de negocio antigua.
    -   Completa el ciclo de despliegue del hotfix `V8.1.0`.

**V8.1.0 - (CRITICAL HOTFIX) - 09/01/2024**
**A. RESUMEN GENERAL:** Se corrigió un error crítico en el servicio de catálogo (`services/catalog/catalog.js`) que impedía la carga inicial de datos de la aplicación y bloqueaba el inicio de sesión de los usuarios.

**B. Corrección Crítica (Backend):**
    1.  **`TypeError` en `handleGetDropdownData`:** Se solucionó un `TypeError` fatal que ocurría al procesar reglas de validación de datos de tipo "Lista de un intervalo" en Google Sheets. La función `getCriteriaValues()` devolvía un objeto `Range` en lugar de un array, causando un error al llamar a `.flat()`.
    2.  **Impacto del Error:** Este error, aunque estaba en una función no llamada directamente al iniciar sesión (`handleGetDropdownData`), desestabilizaba todo el servicio de catálogo, provocando que la llamada principal para obtener los datos de la aplicación (`handleGetCatalogData`) fallara y, en consecuencia, impidiendo que los usuarios pudieran pasar de la pantalla de login.
    3.  **Solución:** Se implementó una lógica robusta que verifica si el valor devuelto es un objeto `Range` (y llama a `.getValues()` si es necesario) o un array, asegurando un manejo correcto de ambos casos y restaurando la estabilidad del servicio.

**C. Cambios Técnicos Implementados:**
    - **`services/catalog/catalog.js`:** Se modificó la función `handleGetDropdownData` para manejar correctamente los diferentes tipos de retorno de `getCriteriaValues()`, eliminando la causa raíz del `TypeError`. Se incrementó la versión del componente a `2.4.1`.

**D. Impacto:**
    -   **Desbloquea completamente la aplicación:** Los usuarios ahora pueden iniciar sesión y cargar los datos de la aplicación sin errores.
    -   **Mejora la robustez del backend:** El servicio de catálogo ahora es más resistente a diferentes configuraciones de validación de datos en la hoja de cálculo.
    -   **Restaura la funcionalidad completa para todos los usuarios.**

**V8.0.0 - (FEATURE & CONSOLIDATED FIXES) - 09/01/2024**
**A. RESUMEN GENERAL:** Se implementaron nuevas functionalities críticas para administradores (Inbox y Herramientas de Desarrollador) y se consolidaron correcciones a regresiones de frontend y vulnerabilidades de backend en un solo despliegue para asegurar la estabilidad, seguridad y funcionalidad del sistema.

**B. Nuevas Funcionalidades (Frontend):**
    1.  **Sistema de Inbox Completo (Tarea 18):** Se implementó un modal de "Inbox" completamente funcional para la gestión centralizada del feedback de usuarios. Esto incluyó la UI, la integración con la API del backend (`getFeedbackItems`, `replyToFeedback`, `markAsResolved`) y la lógica de visibilidad por roles.
    2.  **Modal de Herramientas de Desarrollador (Tarea 19):** Se implementó la estructura inicial del modal, accesible solo para el rol `Desarrollador`, como base para futuras herramientas de mantenimiento.
    3.  **Corrección de Ruteo de API:** Se corrigió un bug crítico en `api.js` donde faltaban las acciones `replyToFeedback` y `markAsResolved` en el `ACTION_TO_SERVICE_MAP`.

**C. Consolidación de Correcciones Críticas (Full-Stack):**
    1.  **Restauración de Frontend:** Se corrigió la lógica de renderizado para restaurar las secciones "Últimos Agregados" y "Marcas de Motocicletas", se repararon los modales de detalle para mostrar correctamente videos/imágenes y se ajustó el layout del modal de vehículo.
    2.  **Parchado de Vulnerabilidades de Sesión:** Se corrigió una vulnerabilidad de seguridad crítica en `auth.js` y `utilities.js` para que la validación de sesiones consulte la hoja `ActiveSessions`.
    3.  **Prevención de Condición de Carrera:** Se implementó `LockService` en la función `handleRecordLike` de `feedback.js` para prevenir la pérdida de datos por concurrencia.
    4.  **Alineación Arquitectónica:** Se estandarizó el `Content-Type` de las respuestas de error a `text/plain` en los servicios `auth`, `feedback`, y `imagen`.
    5.  **Limpieza de Código:** Se eliminaron funciones de migración obsoletas y código muerto de `utilities.js`.

**D. Cambios Técnicos Implementados:**
    - **`main.js`:** Añadidos `event listeners` para los nuevos modales.
    - **`ui.js`:** Implementadas funciones para gestionar los modales (`openInbox`, `openDevTools`), renderizar su contenido y reestructurar los modales de detalle.
    - **`api.js`:** Añadidas funciones para el inbox y corregido el `ACTION_TO_SERVICE_MAP`.
    - **`style.css`:** Ajustados los estilos del overlay de feedback.
    - **`services/auth/auth.js` & `services/utilities/utilities.js`:** Refactorizada la lógica de autorización y sesión.
    - **`services/feedback/feedback.js`:** Añadido `LockService` y corregido `Content-Type`.
    - **`services/imagen/image.js`:** Corregido `Content-Type`.
    - **`services/catalog/catalog.js`:** Ajustada la lógica de `handleGetCatalogData`.

**E. Impacto:**
    - Entrega nuevas funcionalidades críticas para la administración del sistema.
    - Restaura la funcionalidad completa de la UI y mejora significativamente la seguridad y fiabilidad de la plataforma.
    - Alinea múltiples componentes con los estándares arquitectónicos del proyecto.

**V7.2.0 - (AUDIT & DOCUMENTATION) - 19/07/2024**
**A. AUDITORÍA TÉCNICA FORENSE (DOCUMENTACIÓN):** Se realizó una auditoría exhaustiva de todo el código fuente de la aplicación GPSpedia para establecer una base de referencia clara del estado del proyecto, identificar riesgos y proponer mejoras estratégicas.

**B. Resumen de la Auditoría:**
    1.  **Análisis Integral:** Se analizaron todos los componentes del sistema, incluyendo los 6 microservicios del backend (`Auth`, `Catalog`, `Write`, `Users`, `Feedback`, `Utilities`), los 6 módulos JavaScript del frontend (`main`, `ui`, `navigation`, `api`, `auth`, `state`) y los 3 archivos HTML (`index`, `users`, `add_cortes`).
    2.  **Creación de Reporte:** Los hallazgos se consolidaron en un nuevo documento maestro, `Auditoria.txt`, que ahora sirve como la fuente de verdad sobre la arquitectura, debilidades y estado actual del código.
    3.  **Principales Hallazgos:**
        *   **Riesgo Crítico:** Fuerte acoplamiento con la estructura de Google Sheets y lógica de autorización duplicada e inconsistente entre servicios.
        *   **Performance:** Desempeño degradado debido a la deshabilitación de la caché en el servicio de catálogo.
        *   **Mantenibilidad:** Alta complejidad y mezcla de responsabilidades en el frontend, especialmente en `index.html`.

**C. Cambios Implementados:**
    1.  **`Auditoria.txt`:** Se creó y se escribió el reporte completo de la auditoría técnica en este archivo.

**D. Impacto:**
    -   Proporciona una visibilidad sin precedentes sobre la salud técnica del proyecto.
    -   Establece una base documentada para futuras decisiones de refactorización y desarrollo.
    -   Permite al equipo de desarrollo priorizar la deuda técnica y los riesgos de seguridad de manera informada.

**V7.1.0 - (CRITICAL HOTFIX) - 07/01/2026**
**A. FIX CRÍTICO DE PRÁCTICA DE DESARROLLO (GENERAL):** Se eliminó una mala práctica de desarrollo que consistía en resumir código no modificado con el placeholder `// ... (sin cambios)`. Esta práctica causaba que los archivos se sobrescribieran de forma incompleta durante el proceso de pull request, destruyendo funcionalidades.

**B. Resumen de la Corrección:**
    1.  **Auditoría y Corrección:** Se realizó una auditoría en todo el repositorio para detectar la presencia del texto `... (sin cambios)`.
    2.  **Restauración de `services/users/users.js`:** El archivo `services/users/users.js` fue identificado como el único afectado. Se restauró su contenido íntegro y funcional, eliminando los placeholders y asegurando que todas sus funciones (`doGet`, `doPost`, `handleGetUsers`, `generateUniqueUsername`, etc.) estén completas.

**C. Cambios Técnicos Implementados:**
    1.  **`services/users/users.js`:** Se sobrescribió el archivo con su contenido completo para garantizar que no se pierda código durante los merges. Se incrementó la versión a `2.4.1`.

**D. Impacto:**
    -   Se elimina una causa raíz de regresiones y fallos de despliegue.
    -   Se alinea el proceso de desarrollo con la nueva regla de no resumir código, mejorando la fiabilidad de las futuras entregas.
    -   Se restaura la funcionalidad completa del servicio de usuarios que estaba en riesgo.

**V7.0.0 - (FEATURE & STABILITY) - 07/01/2026**
**A. IMPLEMENTACIÓN DEL FLUJO DE ESCRITURA Y CORRECCIONES CRÍTICAS (FULL-STACK):** Se completó la implementación del nuevo flujo de trabajo para agregar cortes (`add_cortes.html`) y se solucionaron bugs críticos de corrupción de datos y de funcionalidad en los servicios de `write` y `users`.

**B. Resumen de Nuevas Funcionalidades y Correcciones:**
    1.  **Nuevo Flujo de "Agregar Cortes" (Tarea 27):** Se reconstruyó por completo el frontend y el backend para el formulario de agregar nuevos registros, siguiendo la especificación del `README.md`.
        *   **Frontend (`add_cortes.html`):** Se implementó una nueva interfaz multi-paso (verificación, agregar corte, info. suplementaria) con lógica de renderizado condicional y un diseño basado en "accordions" para una mejor UX.
        *   **Backend (`services/write/write.js`):**
            *   Se implementó la búsqueda anti-duplicados avanzada con lógica flexible para marca/modelo y exacta para año/encendido.
            *   Se añadió la funcionalidad "Quizás quisiste decir..." (`getSuggestion`) usando el algoritmo de distancia de Levenshtein para asistir al usuario.
            *   Se implementó la lógica para manejar las 3 fases del formulario, incluyendo la creación de carpetas y el renombrado estandarizado de imágenes en Google Drive.
    2.  **Unificación de Lógica de Backend (Tarea 17):** Se eliminó la función duplicada `handleCheckVehicle` del `services/catalog/catalog.js`, centralizando la responsabilidad de esta verificación únicamente en `services/write/write.js`.
    3.  **Corrección de Corrupción de IDs (Tareas 22 y 23):** Se solucionó un bug crítico en `services/write/write.js` y `services/users/users.js` que impedía la correcta herencia de las fórmulas de autogeneración de IDs (`V-` y `U-`). Ambos servicios ahora utilizan el método `copyTo` para garantizar la integridad de los datos.
    4.  **Reparación de Gestión de Usuarios (Tarea 23):**
        *   Se corrigió el bug que impedía que el botón "Cambiar Contraseña" en `users.html` funcionara, conectándolo correctamente al backend.
        *   Se solucionó el fallo subyacente en la creación de nuevos usuarios.

**C. Cambios Técnicos Implementados:**
    1.  **`add_cortes.html`:** Reescritura completa del archivo para implementar la nueva interfaz y la lógica de frontend para el flujo de 3 pasos.
    2.  **`services/write/write.js`:** Se refactorizó `handleCheckVehicle`, se añadieron `handleGetSuggestion` y `handleAddSupplementaryInfo`, y se corrigió `handleAddOrUpdateCut` para usar `copyTo` y `setValues`.
    3.  **`services/users/users.js`:** Se refactorizó `handleCreateUser` para usar el método `copyTo` y `setValues`, solucionando el bug de creación e IDs.
    4.  **`users.html`:** Se corrigió el payload en `handleChangePasswordSubmit` para enviar el ID de usuario correcto.
    5.  **`services/catalog/catalog.js`:** Se eliminó código muerto (`handleCheckVehicle`).

**D. Impacto:**
    -   Se entrega una funcionalidad core de la aplicación (agregar nuevos cortes) que es robusta, intuitiva y a prueba de duplicados.
    -   Se elimina una fuente importante de corrupción de datos al asegurar la correcta generación de IDs.
    -   Se restauran funciones críticas de la administración de usuarios.

**V6.1.0 - (CRITICAL DATA INTEGRITY HOTFIX) - 06/01/2026**
**A. FIX CRÍTICO DE INTEGRIDAD DE DATOS (BACKEND):** Se solucionó un bug crítico introducido en la versión anterior que causaba la corrupción de datos en los reportes de problemas.

**B. Resumen de la Corrección:**
    1.  **Corrupción de Datos en Reportes (Tarea 21):** Se corrigió un bug en la función `handleReportProblem` de `services/feedback/feedback.js`. La función estaba sobrescribiendo incorrectamente el `userName` del reportador con su `userId`, resultando en la pérdida del nombre de usuario en la hoja de "Feedbacks". El bug ha sido eliminado y el `userName` ahora se guarda correctamente.

**C. Cambios Técnicos Implementados:**
    1.  **`services/feedback/feedback.js`:** Se eliminó la línea de código redundante y errónea que causaba la sobrescritura del dato `userName`.

**D. Nota de Revisión de Código:**
    - La revisión de código inicial para V6.0.0 indicó incorrectamente una vulnerabilidad de seguridad en `services/users/users.js` (Tarea 14). Una auditoría posterior confirmó que las medidas de seguridad basadas en `sessionToken` ya estaban implementadas correctamente en dicha versión, por lo que no se requirieron cambios en ese servicio.

**E. Impacto:**
    - Se restaura la integridad de los datos para todos los nuevos reportes de problemas.
    - Se asegura que los administradores puedan ver correctamente qué usuario ha enviado cada reporte.

**V6.0.0 - (SECURITY & DATA INTEGRITY) - 06/01/2026**
**A. FIX CRÍTICO DE SEGURIDAD Y DE INTEGRIDAD DE DATOS (BACKEND & FRONTEND):** Se implementaron correcciones a múltiples vulnerabilidades de seguridad y bugs de corrupción de datos en los servicios de backend y se corrigió un bug de renderizado en el frontend.

**B. Resumen de Correcciones Críticas:**
    1.  **Vulnerabilidad de Escalada de Privilegios (Tarea 14):** Se parchó una vulnerabilidad crítica en `services/users/users.js`. Las funciones `handleCreateUser`, `handleUpdateUser`, y `handleDeleteUser` ahora ignoran el rol enviado por el cliente y en su lugar verifican la autoridad del usuario a través de un `sessionToken` validado en el backend, previniendo la escalada de privilegios.
    2.  **Bugs de Integridad de Datos (Tarea 21):** Se solucionaron múltiples bugs en `services/feedback/feedback.js` que causaban corrupción de datos. Las funciones `handleReportProblem` y `handleSendContactForm` ahora guardan correctamente el `userId` y utilizan un método robusto para la creación de filas que preserva las fórmulas de autogeneración de IDs.
    3.  **Inconsistencia en Cambio de Contraseña (Tarea 15):** Se implementó la lógica faltante en la función `handleChangePassword` de `services/users/js` y se aseguró que la comparación de la contraseña actual sea `case-insensitive`, alineándola con el comportamiento del login.
    4.  **Bug de Mapeo de Datos en UI (Tarea 7):** Se corrigió el bug de renderizado en `users.html` al limpiar comentarios obsoletos que indicaban un problema de mapeo de datos que ya había sido resuelto, mejorando la claridad del código.

**C. Cambios Técnicos Implementados:**
    1.  **`services/users/users.js`:** Se implementó la función `getVerifiedRole` y se refactorizaron las funciones de CRUD para usar `sessionToken`. Se completó la función `handleChangePassword` con la lógica correcta. Se incrementó la versión a `2.4.0`.
    2.  **`services/feedback/feedback.js`:** Se refactorizaron las funciones de creación de reportes y contactos para guardar `userId` y usar un método de inserción de filas seguro. Se incrementó la versión a `2.3.0`.
    3.  **`users.html`:** Se eliminaron comentarios `FIX:` obsoletos para reflejar el estado correcto del código. Se incrementó la versión a `3.8.0`.

**D. Impacto:**
    -   Se mejora significativamente la seguridad del sistema al eliminar una vulnerabilidad crítica.
    -   Se restaura la integridad de los datos en el sistema de feedback.
    -   Se mejora la experiencia de usuario al solucionar un bug frustrante en el cambio de contraseña y se clarifica el código del frontend.
